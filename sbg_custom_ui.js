// ==UserScript==
// @name         SBG CUI
// @namespace    https://3d.sytes.net/
// @version      1.2.7
// @downloadURL  https://raw.githubusercontent.com/nicko-v/sbg-cui/main/sbg_custom_ui.js
// @updateURL    https://raw.githubusercontent.com/nicko-v/sbg-cui/main/sbg_custom_ui.js
// @description  SBG Custom UI
// @author       NV
// @match        https://3d.sytes.net/*
// @grant        none
// ==/UserScript==

async function main(){"use strict";if(document.querySelector('script[src="/intel.js"]'))return;const e="0.2.9",t=matchMedia("(prefers-color-scheme: dark)").matches,n={0:0,1:500,2:750,3:1e3,4:1500,5:2e3,6:2500,7:3500,8:4e3,9:5250,10:6500},i={0:0,1:6,2:6,3:6,4:3,5:3,6:2,7:2,8:1,9:1,10:1},s=[1500,5e3,12500,25e3,6e4,125e3,35e4,675e3,1e6,1/0],a={1:{eng:"cores",rus:"ядра"},2:{eng:"catalysers",rus:"катализаторы"},3:{eng:"refs",rus:"рефы"}},o={maxAmountInBag:{cores:{I:-1,II:-1,III:-1,IV:-1,V:-1,VI:-1,VII:-1,VIII:-1,IX:-1,X:-1},catalysers:{I:-1,II:-1,III:-1,IV:-1,V:-1,VI:-1,VII:-1,VIII:-1,IX:-1,X:-1},refs:{allied:-1,hostile:-1}},autoSelect:{deploy:"min",upgrade:"min",attack:"max"},mapFilters:{invert:t?1:0,hueRotate:t?180:0,brightness:t?.75:1,grayscale:t?1:0,sepia:0,blur:0},tinting:{map:1,point:"level",profile:1},vibration:{buttons:1,notifications:1},ui:{pointBgImage:1,pointBtnsRtl:0,pointBgImageBlur:0}};class r extends window.XMLHttpRequest{get responseText(){let e=this.response,t=this.responseURL.match(/\/api\/(discover)/);if(!t)return super.responseText;try{switch(e=JSON.parse(e),t[1]){case"discover":if(Object.values(p).every((e=>1==e)))break;0==p.refs?e.loot=e.loot.filter((e=>3!=e.t)):0==p.loot&&(e.loot=[]);break}e=JSON.stringify(e)}catch(e){}return e}send(e){this.addEventListener("load",(t=>{let n=this.responseURL.match(/\/api\/(point|deploy|attack2|discover)(?:.*?&(status=1))?/),i=this.response;if(n)try{switch(i=JSON.parse(i),n[1]){case"point":"data"in i&&!n[2]&&(M=new l(i.data));break;case"deploy":"data"in i?(M.update(i.data.co,i.data.l),M.selectCore(u.autoSelect.deploy)):"c"in i&&(M.update([i.c],i.l),M.selectCore(u.autoSelect.upgrade,i.c.l));break;case"attack2":J=JSON.parse(e).guid,localStorage.setItem("sbgcui_lastUsedCatalyser",J);break;case"discover":if("loot"in i){let e=[];0==p.refs?e=i.loot.filter((e=>3==e.t)).map((e=>({guid:e.g,type:e.t,amount:e.a}))):0==p.loot&&(e=i.loot.map((e=>({guid:e.g,type:e.t,amount:e.a})))),e.length&&U(e).then((e=>{if(e[0].error||!e[0].status.match(/success/i))throw e[0].error||e[0].status})).catch((e=>{let t=W("Ошибка при фильтрации лута.");t.options.className="error-toast",t.showToast()}))}if("burnout"in i||"cooldown"in i){let t,n,s=Date.now();if(i.burnout<=20)t=i.burnout;else if(i.cooldown<=90||i.burnout<s)break;try{n=JSON.parse(e).guid}catch{n=new URLSearchParams(e).get("guid")}if(n in ie){if(t){ie[n].discoveriesLeft=t;break}if(ie[n].hasActiveCooldown)break;let e=i.burnout||s+1e3*i.cooldown;ie[n].cooldown=e,ie.save()}}break}}catch(e){}})),super.send(e)}}class c{constructor(e,t){this.loot=e,this.refs=t}}class l{constructor(e){this.guid=e.g,this.level=e.l,this.team=e.te,this.lines={in:e.li.i,out:e.li.o},this.cores={},this.image=`https://lh3.googleusercontent.com/${e.i}`,this.update(e.co)}get emptySlots(){return 6-Object.keys(this.cores)}get isEmptySlots(){return this.emptySlots>0}get playerCores(){let e={};for(let t in this.cores){let n=this.cores[t];n.owner==Q.name&&(n.level in e?e[n.level]+=1:e[n.level]=1)}return e}update(e,t){e.forEach((e=>{this.cores[e.g]={level:e.l,owner:e.o}})),this.level=t}selectCore(e,t){let n,s=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>1==e.t)).sort(((e,t)=>e.l-t.l)),a=this.playerCores;switch(e){case"min":n=t?s.find((e=>e.l>t&&(a[e.l]||0)<i[e.l]&&e.l<=Q.level)):s.find((e=>(a[e.l]||0)<i[e.l]&&e.l<=Q.level));break;case"max":n=s.findLast((e=>e.l<=Q.level&&(a[e.l]||0)<i[e.l]));break}H(h.querySelector(`[data-guid="${n?.g}"]:not(.is-active)`))}}class d{#e;constructor(e,t,n){this.guid=e,this.name=n||e,this.cooldown=t,this.discoveriesLeft=void 0,this.timeoutID=void 0,this.isActive=1,n||this.#t()}#t(){R(this.guid).then((e=>{this.name=e.t})).catch((e=>{}))}#n(){if(!this.isActive)return;let e=`"${this.name}": точка остыла.`;if(!X()&&"Notification"in window&&"granted"==Notification.permission){new Notification(e,{icon:"/icons/icon_512.png"})}else{let t=W(e,"top left",-1);t.options.className="sbgcui_toast-selection",t.showToast(),"vibrate"in window.navigator&&u.vibration.notifications&&(window.navigator.vibrate(0),window.navigator.vibrate([500,300,500,300,500]))}}#i(e){let t=e-Date.now();clearTimeout(this.timeoutID),this.timeoutID=setTimeout(function(){this.#n(),this.cooldown=null}.bind(this),t)}toJSON(){return this.cooldown>Date.now()?this.cooldown:null}get hasActiveCooldown(){return this.cooldown-Date.now()>0}get cooldown(){return this.#e}get timer(){if(!this.cooldown)return"";let e=new Date(this.cooldown-Date.now());if(e<0)return"";return new Intl.DateTimeFormat("ru-RU",{hour:"numeric",minute:"numeric",second:"numeric",timeZone:"UTC"}).format(e)}set cooldown(e){this.#e=e>Date.now()?e:null,this.#e&&(this.discoveriesLeft=void 0,this.#i(this.#e))}}let u;if(localStorage.getItem("sbgcui_config"))u=JSON.parse(localStorage.getItem("sbgcui_config"),((e,t)=>isNaN(+t)?t:+t)),u={...o,...u},function e(t,n){for(let i in n)typeof n[i]!=typeof t[i]?t[i]=n[i]:"object"==typeof n[i]&&e(t[i],n[i])}(u,o),localStorage.setItem("sbgcui_config",JSON.stringify(u));else{u=o,localStorage.setItem("sbgcui_config",JSON.stringify(u));let e=W("Сохранённые настройки не найдены. <br>Загружена стандартная конфигурация.");e.options.className="error-toast",e.showToast()}let p,m=document.documentElement,g=document.querySelector("#attack-menu"),b=document.querySelector(".attack-slider-wrp"),h=document.querySelector("#cores-list"),f=document.querySelector("#discover"),v=document.querySelector("#ops"),_=document.querySelector("#self-info__inv"),y=document.querySelector(".i-stat__cores"),w=document.querySelector("#i-image"),L=document.querySelector(".i-image-box"),S=document.querySelector("#i-level"),E=document.querySelector("#i-stat__owner"),x=document.querySelector("#i-title"),k=document.querySelector(".info.popup"),I=document.querySelector(".info.popup > .popup-close"),T=document.querySelector("#pr-name"),$=document.querySelector(".profile.popup"),N=document.querySelector(".profile.popup > .popup-close"),C=document.querySelector("#self-info__exp"),O=document.querySelector("#self-info__explv"),q=document.querySelector("#self-info__name"),A=document.querySelector(".xp-diff"),P=document.querySelector(".ol-zoom"),B=!$.classList.contains("hidden"),D=!k.classList.contains("hidden"),M={},J=localStorage.getItem("sbgcui_lastUsedCatalyser"),V={I:1,II:2,III:3,IV:4,V:5,VI:6,VII:7,VIII:8,IX:9,X:10,toDecimal(e){return this[e]},toRoman(e){return Object.keys(this).find((t=>this[t]==e))}};async function F(e){return fetch(`/api/profile?guid=${e}`,{headers:{authorization:`Bearer ${localStorage.getItem("auth")}`},method:"GET"}).then((e=>e.json())).then((e=>e.data)).catch((e=>{}))}async function R(e){return fetch(`/api/point?guid=${e}&status=1`,{headers:{authorization:`Bearer ${Q.auth}`},method:"GET"}).then((e=>e.json())).then((e=>e.data))}async function j(e,t=!1){let n=u.maxAmountInBag;(async function(){return fetch("/api/inventory",{headers:{authorization:`Bearer ${Q.auth}`},method:"GET"}).then((e=>e.json())).then((e=>e.i))})().then((e=>{let i=e.reduce(((e,t)=>e+t.a),0);if(!t&&3e3-i>=100)throw{silent:!0};if(-1==n.refs.allied&&-1==n.refs.hostile)return[e,[]];if(0==n.refs.allied&&0==n.refs.hostile)return[e,[]];let s=e.map((e=>3==e.t?R(e.l):void 0)).filter((e=>e));return Promise.all([e,...s])})).then((([e,...t])=>{let i={};t.forEach((e=>{i[e.g]={team:e.te}}));let s=e.map((({t:e,l:t,a:s,g:o})=>{if(!e in a)return;let r=-1,c=0,l=a[e].eng;if("refs"==l){if(-1==n.refs.allied&&-1==n.refs.hostile)r=-1;else if(0==n.refs.allied&&0==n.refs.hostile)r=0;else if(Object.keys(i).length){let e=i[t].team==Q.team?"allied":"hostile";r=n[l][e]}}else r=n[l][V.toRoman(t)];return-1!=r&&s>r&&(c=s-r),{guid:o,type:e,amount:c}})).filter((e=>e?.amount>0));return Promise.all([s,U(s)])})).then((([e,t])=>{if(!e.length)return;let n=t.reduce(((e,t)=>t.count.total<e?t.count.total:e),1/0);isFinite(n)&&(_.innerText=n),v.style.color.match("accent")&&(v.style.color=""),z(e),e=e.reduce(((e,t)=>(e.hasOwnProperty(t.type)||(e[t.type]=0),e[t.type]+=t.amount,e)),{});let i="";for(let t in e)i+=`<br><span style="background: var(--team-${Q.team}); margin-right: 5px;" class="item-icon type-${t}"></span>x${e[t]} ${a[t].eng}`;W(`Удалено: ${i}`).showToast()})).catch((e=>{if(e.silent)return;let t=W(`Ошибка при проверке или очистке инвентаря. <br>${e.message}`);t.options.className="error-toast",t.showToast()}))}async function U(e){let t=e.reduce(((e,t)=>(e.hasOwnProperty(t.type)||(e[t.type]={}),e[t.type][t.guid]=t.amount,e)),{});return Promise.all(Object.keys(t).map((async e=>fetch("/api/inventory",{headers:{authorization:`Bearer ${Q.auth}`,"content-type":"application/json"},body:JSON.stringify({selection:t[e],tab:e}),method:"DELETE"}).then((e=>e.json())))))}function X(){return"maxTouchPoints"in window.navigator?window.navigator.maxTouchPoints>0:"msMaxTouchPoints"in window.navigator?window.navigator.msMaxTouchPoints>0:"orientation"in window||/\b(BlackBerry|webOS|iPhone|IEMobile|Android|Windows Phone|iPad|iPod)\b/i.test(window.navigator.userAgent)}function z(e){let t=JSON.parse(localStorage.getItem("inventory-cache"))||[];e.forEach((e=>{let n=t.find((t=>t.g==e.guid));n&&(n.a-=e.amount)})),t=t.filter((e=>e.a>0)),localStorage.setItem("inventory-cache",JSON.stringify(t))}function G(){let{mapFilters:e,ui:t}=u;for(let t in e){let n="blur"==t?"px":"hueRotate"==t?"deg":"";m.style.setProperty(`--sbgcui-${t}`,`${e[t]}${n}`)}m.style.setProperty("--sbgcui-point-btns-rtl",t.pointBtnsRtl?"rtl":"ltr"),m.style.setProperty("--sbgcui-point-image-blur",t.pointBgImageBlur?"2px":"0px"),!+u.tinting.map||D||B||Y("map"),document.querySelector(".sbgcui_settings").classList.add("sbgcui_hidden"),document.querySelectorAll(".sbgcui_settings > details").forEach((e=>{e.open=!1})),document.querySelectorAll('.sbgcui_settings input:not([type="hidden"])').forEach((e=>{let t=e.name.split("_").reduce(((e,t)=>e[t]),u);switch(e.type){case"number":case"range":e.value=+t;break;case"checkbox":e.checked=+t;break;case"radio":e.checked=e.value==t;break}}))}function H(e){let t=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0}),n=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0}),i=new MouseEvent("click",{bubbles:!0,cancelable:!0});e?.dispatchEvent(t),e?.dispatchEvent(n),e?.dispatchEvent(i)}function W(e="",t="top left",n=4e3,i=null){let s=t.split(/\s+/),a=Toastify({text:e,duration:n,gravity:s[0],position:s[1],escapeMarkup:!1,className:"interaction-toast",selector:i});return a.options.id=Math.round(1e5*Math.random()),a.options.onClick=()=>a.hideToast(),a}function Y(e){let t,n=/ya-title=.*?,\sya-dock=.*?(?=,|$)/;switch(e){case"map":t=getComputedStyle(q).color;break;case"profile":t=getComputedStyle(T).color,$.style.borderColor=t;break;case"point_level":t=getComputedStyle(S).color,k.style.borderColor=t,x.style.color=t;break;case"point_team":t=getComputedStyle(E).color,k.style.borderColor=t,x.style.color=t;break;default:t="";break}var i;t=(i=t)?`#${i.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map((e=>parseInt(e,10).toString(16).padStart(2,"0"))).join("")}`:"",ee.content=t,te.content.match(n)?te.content=te.content.replace(n,`ya-title=${t}, ya-dock=${t}`):te.content+=`, ya-title=${t}, ya-dock=${t}`}function Z(e){let t=document.createElement("span");t.classList.add("sbgcui_xpdiff"),t.innerText=`+${e}xp`,ne.appendChild(t),setTimeout((e=>{t.classList.add("sbgcui_xpdiff-out")}),100),setTimeout((e=>{ne.removeChild(t)}),3e3)}window.XMLHttpRequest=r;{let e=document.createElement("script");e.setAttribute("src","https://kit.fontawesome.com/babc27ae2f.js"),e.setAttribute("crossorigin","anonymous"),document.head.appendChild(e)}var K=await async function(){return fetch("/api/self",{headers:{authorization:`Bearer ${localStorage.getItem("auth")}`},method:"GET"}).then((e=>Promise.all([e.headers.get("SBG-Version"),e]))).then((e=>Promise.all([e[0],e[1].json()]))).then((([e,t])=>({name:t.n,team:t.t,exp:t.x,lvl:t.l,guid:t.g,version:e}))).catch((e=>{}))}();if(e!=K.version){let e=+localStorage.getItem("sbgcui_version_warns");if(e<2){let t=W(`Текущая версия игры (${K.version}) не соответствует последней известной версии (0.2.9). Возможна некорректная работа.`);t.options.className="error-toast",t.showToast(),localStorage.setItem("sbgcui_version_warns",e+1)}}else localStorage.setItem("sbgcui_version_warns",0);var Q={name:K.name,team:K.team,exp:{total:K.exp,current:K.exp-s.slice(0,K.lvl-1).reduce(((e,t)=>t+e),0),goal:s[K.lvl-1],get percentage(){return this.current/this.goal*100},set string(e){[this.current,this.goal]=e.replaceAll(",","").split(" / ")}},auth:localStorage.getItem("auth"),guid:K.guid,get level(){return this._level},set level(e){this._level=+e.split("").filter((e=>e.match(/[0-9]/))).join("")},_level:K.lvl};new MutationObserver(((e,t)=>{t.disconnect(),Q.level=O.textContent,O.innerText=(Q.level<=9?"0":"")+Q.level,t.observe(O,{childList:!0})})).observe(O,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointLevelChanged",{bubbles:!0});S.dispatchEvent(t)})).observe(S,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointOwnerChanged",{bubbles:!0});E.dispatchEvent(t)})).observe(E,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointCoresUpdated",{bubbles:!0});y.dispatchEvent(t)})).observe(y,{childList:!0}),new MutationObserver((e=>{let t;e[0].target.classList.contains("hidden")?(t=new Event("pointPopupClosed"),D=!1):e[0].oldValue?.includes("hidden")&&(t=new Event("pointPopupOpened"),D=!0),t&&e[0].target.dispatchEvent(t)})).observe(k,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),new MutationObserver((e=>{B=!e[0].target.classList.contains("hidden");let t=new Event(B?"profilePopupOpened":"profilePopupClosed",{bubbles:!0});e[0].target.dispatchEvent(t)})).observe($,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{let t=e[0].target.classList.contains("hidden"),n=new Event(t?"attackSliderClosed":"attackSliderOpened",{bubbles:!0});e[0].target.dispatchEvent(n)})).observe(b,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{e.forEach((e=>{if(e.oldValue.indexOf("loading")>-1&&e.target.classList.contains("loaded")){let t=e.target.querySelector(".inventory__item-descr").childNodes[4].nodeValue;e.target.querySelector(".inventory__item-title").style.color.indexOf(`team-${Q.team}`)>-1&&(e.target.style.setProperty("--sbgcui-energy",`${t}%`),t<100&&e.target.style.setProperty("--sbgcui-display-r-button","flex"))}}))})).observe(document.querySelector(".inventory__content"),{subtree:!0,attributes:!0,attributeFilter:["class"],attributeOldValue:!0}),new MutationObserver((e=>{Z(e.find((e=>e.addedNodes.length)).addedNodes[0].data.match(/\d+/)[0])})).observe(A,{childList:!0});f.addEventListener("click",(e=>{e.target==f&&j()})),g.addEventListener("click",(e=>{g.classList.toggle("sbgcui_attack-menu-rotate")})),k.addEventListener("pointPopupOpened",(()=>{let e=JSON.parse(localStorage.getItem("settings"))||{};u.ui.pointBgImage?(m.style.setProperty("--sbgcui-point-image",e.imghid?"":`url("${M.image}")`),k.classList.add("sbgcui_point-popup-bg"),w.classList.add("sbgcui_no_bg_image")):(m.style.setProperty("--sbgcui-point-image",""),k.style.backgroundImage="",k.classList.remove("sbgcui_point-popup-bg"),w.classList.remove("sbgcui_no_bg_image"))})),document.addEventListener("backbutton",(()=>(D?H(I):B&&H(N),!1)));{let e=u.mapFilters,t=u.ui,n=document.createElement("style"),i=document.createElement("link");n.innerHTML=`\n      :root {\n        --sbgcui-player-team: var(--team-${Q.team});\n        --sbgcui-player-exp-percentage: ${Q.exp.percentage}%;\n        --sbgcui-inventory-limit: " / 3000";\n        --sbgcui-invert: ${e.invert};\n        --sbgcui-hueRotate: ${e.hueRotate}deg;\n        --sbgcui-brightness: ${e.brightness};\n        --sbgcui-grayscale: ${e.grayscale};\n        --sbgcui-sepia: ${e.sepia};\n        --sbgcui-blur: ${e.blur}px;\n        --sbgcui-point-bg: #ccc;\n        --sbgcui-point-image: '';\n        --sbgcui-point-image-blur: ${t.pointBgImageBlur?2:0}px;\n        --sbgcui-point-btns-rtl: ${t.pointBtnsRtl?"rtl":"ltr"};\n      }\n  `,i.setAttribute("rel","stylesheet"),i.setAttribute("href","https://nicko-v.github.io/sbg-cui/styles-min.css"),document.head.append(n,i)}{let e=document.querySelector("#ops"),t=document.querySelector("#toggle-follow"),n=document.querySelector(".bottomleft-container"),i=document.querySelector(".ol-rotate"),s=document.querySelector("#inventory__close"),a=document.querySelector("#layers");document.querySelectorAll("#attack-slider-close").forEach((e=>{e.remove()})),document.querySelectorAll(".self-info__entry, #attack-menu").forEach((e=>{e.childNodes.forEach((e=>{3==e.nodeType&&e.remove()}))})),s.innerText="[x]",a.innerText="",a.classList.add("fa-solid","fa-layer-group"),P.append(i,t,a),t.innerText="",t.classList.add("fa-solid","fa-location-crosshairs"),n.appendChild(e),e.replaceChildren("INVENTORY",_),O.innerText=(Q.level<=9?"0":"")+Q.level}{let e=document.createElement("div"),t=document.createElement("div"),n=document.querySelector("#self-info__exp");new MutationObserver((()=>{Q.exp.string=n.textContent,m.style.setProperty("--sbgcui-player-exp-percentage",`${Q.exp.percentage}%`)})).observe(n,{childList:!0}),e.classList.add("sbgcui_xpProgressBar"),t.classList.add("sbgcui_xpProgressBarFiller"),n.parentElement.prepend(e),e.append(n,t)}b.addEventListener("attackSliderOpened",(e=>{H(function(e){let t,n=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>2==e.t&&e.l<=Q.level)).sort(((e,t)=>e.l-t.l));switch(e){case"latest":if(t=b.querySelector(`[data-guid="${J}"]`),t)break;case"max":t=b.querySelector(`[data-guid="${n[n.length-1].g}"]`);break}return t}(u.autoSelect.attack))})),k.addEventListener("pointPopupOpened",(e=>{M.selectCore(u.autoSelect.deploy)})),y.addEventListener("click",(e=>{if(e.target.classList.contains("selected")){let t=e.target.innerText.match(/^[0-9]{1,2}$/)?+e.target.innerText:V.toDecimal(e.target.innerText);M.selectCore(u.autoSelect.upgrade,t)}}));document.querySelector(".inventory__content").addEventListener("click",(e=>{if(!e.currentTarget.matches('.inventory__content[data-type="3"]'))return;if(!e.target.closest(".inventory__item-controls"))return;if(!e.target.closest(".inventory__item.loaded"))return;if(e.offsetX<50)return;let t=e.target.closest(".inventory__item")?.dataset.ref;(async function(e){return fetch("/api/repair",{headers:{authorization:`Bearer ${Q.auth}`,"content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`guid=${e}&position%5B%5D=0.0&position%5B%5D=0.0`,method:"POST"}).then((e=>e.json()))})(t).then((i=>{if(i.error)throw new Error(i.error);if(i.data){let[a,o]=i.data.co.reduce(((e,t)=>[e[0]+t.e,e[1]+n[t.l]]),[0,0]),r=document.querySelector(`.inventory__item[data-ref="${t}"] .inventory__item-left`).querySelector(".inventory__item-descr").childNodes[4],c=Math.floor(a/o*100),l=e.target.closest(".inventory__item");l.style.setProperty("--sbgcui-energy",`${c}%`),l.style.setProperty("--sbgcui-display-r-button",100==c?"none":"flex"),r&&(r.nodeValue=c),function(e){let t=new Intl.NumberFormat("en-GB"),n=0;for(let i=0;i<s.length;i+=1)if(n+=s[i],n>e)return C.innerText=n!=1/0?`${t.format(e-(n-s[i]))} / ${t.format(s[i])}`:t.format(e),void(O.innerText=i+1)}(i.xp.cur),Z(i.xp.diff)}})).catch((e=>{let t=W(`Ошибка при зарядке. <br>${e.message}`);t.options.className="error-toast",t.showToast()}))}));{let e=document.querySelector(".settings.popup"),t=document.querySelector(".settings-content"),n=function(){function e(e,t){let n=document.createElement("details");n.classList.add("sbgcui_settings-section");let i=document.createElement("summary");i.classList.add("sbgcui_settings-title"),i.innerText=e;let s=document.createElement("h6");return s.classList.add("sbgcui_settings-subtitle"),s.innerHTML=t,n.appendChild(i),n.appendChild(s),n}function t(e,t,n,i,s){let a="checkbox"==e,o=document.createElement("div"),r=document.createElement("label"),c=document.createElement("input");if(o.classList.add("sbgcui_settings-input_wrp"),c.id=a?t:t+Math.random().toString().slice(2),c.name=t,c.type=e,c.value=a?1:s,c.checked=n,r.htmlFor=c.id,r.innerText=i,a){let e=document.createElement("input");e.name=t,e.type="hidden",e.value=0,o.appendChild(e)}return o.append(c,r),o}function n(e,t=[]){let n=document.createElement("h5"),i=document.createElement("div"),s=document.createElement("div");return n.classList.add("sbgcui_settings-radio_group-title"),i.classList.add("sbgcui_settings-inputs_group"),s.classList.add("sbgcui_settings-radio_group"),n.innerText=e,t.forEach((e=>{i.appendChild(e)})),s.append(n,i),s}let i=document.createElement("form");i.classList.add("sbgcui_settings","sbgcui_hidden");let s=document.createElement("span");s.classList.add("sbgcui_settings-version"),s.innerText="v1.2.7";let a=document.createElement("h3");a.classList.add("sbgcui_settings-header"),a.innerText="Настройки";let o=document.createElement("button");o.innerText="Сохранить";let r=document.createElement("button");r.innerText="Закрыть",r.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),G()}));let c=document.createElement("div");c.classList.add("sbgcui_settings-buttons_wrp"),c.append(o,r);let l=[function(t){let n=e("Автоудаление",'Когда в инвентаре останется меньше 100 мест, будут удалены предметы, превышающие указанное количество. <br>Значение "-1" предотвращает удаление.'),i=document.createElement("button");i.classList.add("sbgcui_settings-forceclear"),i.innerText="Очистить сейчас",i.addEventListener("click",(function(e){e.preventDefault(),confirm("Произвести очистку инвентаря согласно настройкам?")&&j(0,!0)})),n.appendChild(i);for(let e in t){let i=document.createElement("section"),s=document.createElement("h4"),a=document.createElement("div");i.classList.add("sbgcui_settings-subsection"),s.classList.add("sbgcui_settings-title"),a.classList.add("sbgcui_settings-maxamounts"),s.innerText="cores"==e?"Ядра":"catalysers"==e?"Катализаторы":"refs"==e?"Рефы":"N/D";for(let n in t[e]){let i=document.createElement("div"),s=document.createElement("label"),o=document.createElement("input");i.classList.add("sbgcui_settings-amount_input_wrp"),s.classList.add("sbgcui_settings-amount_label"),o.classList.add("sbgcui_settings-amount_input"),"refs"==e?(s.innerText="allied"==n?"Свои:":"Чужие:",s.classList.add(`sbgcui_settings-amount_label_${n}`)):(s.innerText=n+":",s.style.color=`var(--level-${V.toDecimal(n)})`),o.name=`maxAmountInBag_${e}_${n}`,o.type="number",o.min=-1,o.value=t[e][n],i.append(s,o),a.appendChild(i)}i.append(s,a),n.appendChild(i)}return n}(u.maxAmountInBag),function(i){let s=e("Автовыбор","Можно автоматически выбирать самый мощный катализатор при атаке, самое маленькое ядро при деплое или следующий уровень ядра при каждом апгрейде."),a=document.createElement("section"),o=t("radio","autoSelect_attack","max"==i.attack,"Самый мощный","max"),r=t("radio","autoSelect_attack","latest"==i.attack,"Последний использованный","latest"),c=t("radio","autoSelect_deploy","min"==i.deploy,"Наименьшее","min"),l=t("radio","autoSelect_deploy","max"==i.deploy,"Наибольшее","max"),d=t("radio","autoSelect_deploy","off"==i.deploy,"Вручную","off"),u=t("radio","autoSelect_upgrade","min"==i.upgrade,"Наименьшее","min"),p=t("radio","autoSelect_upgrade","max"==i.upgrade,"Наибольшее","max"),m=t("radio","autoSelect_upgrade","off"==i.upgrade,"Вручную","off"),g=n("Катализатор при атаке:",[o,r]),b=n("Ядро при деплое:",[c,l,d]),h=n("Ядро при апгрейде:",[u,p,m]);return a.classList.add("sbgcui_settings-subsection"),a.append(g,b,h),s.appendChild(a),s}(u.autoSelect),function(t){function n(e,t,n,i,s,a,o){let r=document.createElement("div"),c=document.createElement("label"),l=document.createElement("input");return r.classList.add("sbgcui_settings-mapfilters_input_wrp"),l.type=e,l.name=t,l.min=n,l.max=i,l.step=s,l.value=a,c.innerText=o,l.addEventListener("input",(e=>{!function(e,t){let n=e.split("_")[1],i="blur"==n?"px":"hueRotate"==n?"deg":"";m.style.setProperty(`--sbgcui-${n}`,`${t}${i}`)}(t,e.target.value)})),r.append(c,l),r}let i=e("Цветовая схема","Настройте оттенок карты."),s=document.createElement("section"),a=n("range","mapFilters_invert",0,1,.01,+t.invert,"Инверсия"),o=n("range","mapFilters_hueRotate",0,360,1,+t.hueRotate,"Цветность"),r=n("range","mapFilters_brightness",0,5,.01,+t.brightness,"Яркость"),c=n("range","mapFilters_grayscale",0,1,.01,+t.grayscale,"Оттенок серого"),l=n("range","mapFilters_sepia",0,1,.01,+t.sepia,"Сепия"),d=n("range","mapFilters_blur",0,4,.1,+t.blur,"Размытие");return s.classList.add("sbgcui_settings-subsection"),s.append(a,o,r,c,l,d),i.appendChild(s),i}(u.mapFilters),function(i){let s=e("Тонирование","Интерфейс браузера будет окрашиваться в зависимости от того, что происходит на экране."),a=document.createElement("section"),o=t("checkbox","tinting_map",+i.map,"При просмотре карты"),r=t("checkbox","tinting_profile",+i.profile,"При просмотре профиля"),c=t("radio","tinting_point","level"==i.point,"Цвет уровня","level"),l=t("radio","tinting_point","team"==i.point,"Цвет команды","team"),d=t("radio","tinting_point","off"==i.point,"Нет","off");o.addEventListener("change",(e=>{e.target.checked?Y("map"):Y("")}));let u=n("При просмотре точки:",[c,l,d]);return a.classList.add("sbgcui_settings-subsection"),a.append(o,r,u),s.appendChild(a),s}(u.tinting),function(n){let i=e("Вибрация","Устройство будет откликаться на ваши действия. Может потребоваться выдача соответствующего разрешения в браузере или системе."),s=document.createElement("section"),a=t("checkbox","vibration_buttons",+n.buttons,"При нажатии кнопок"),o=t("checkbox","vibration_notifications",+n.notifications,"При уведомлениях");return s.classList.add("sbgcui_settings-subsection"),s.append(a,o),i.appendChild(s),"vibrate"in window.navigator||i.classList.add("sbgcui_hidden"),i}(u.vibration),function(n){let i=e("Интерфейс","Некоторые аспекты дизайна можно отключить или изменить для большего удобства."),s=document.createElement("section"),a=t("checkbox","ui_pointBgImage",+n.pointBgImage,"Фото точки вместо фона"),o=t("checkbox","ui_pointBgImageBlur",+n.pointBgImageBlur,"Размытие фонового фото"),r=t("checkbox","ui_pointBtnsRtl",+n.pointBtnsRtl,"Отразить кнопки в карточке точки");return a.addEventListener("click",(e=>{"ui_pointBgImage"==e.target.id&&(e.target.checked?o.childNodes[1].removeAttribute("disabled"):(o.childNodes[1].checked=0,o.childNodes[1].setAttribute("disabled","")))})),s.classList.add("sbgcui_settings-subsection"),s.append(a,o,r),i.appendChild(s),i}(u.ui)];return l.forEach((e=>{e.addEventListener("click",(e=>{l.forEach((t=>{e.currentTarget!=t&&t.removeAttribute("open")}))}))})),i.append(s,a,...l,c),i.addEventListener("submit",(e=>{e.preventDefault();try{let t=new FormData(e.target),n=Object.fromEntries(t);for(let e in n){let t=e.split("_");if("maxAmountInBag"==t[0])u.maxAmountInBag[t[1]][t[2]]=Number.isInteger(+n[e])?n[e]:-1;else if(t[0].match(/autoSelect|mapFilters|tinting|vibration|ui/)){let i=n[e];u[t[0]][t[1]]=isNaN(+i)?i:+i}}localStorage.setItem("sbgcui_config",JSON.stringify(u)),W("Настройки сохранены").showToast()}catch(e){let t=W(`Ошибка при сохранении настроек. <br>${e.message}`);t.options.className="error-toast",t.showToast()}})),i}();document.querySelector(".topleft-container").appendChild(n);let i=document.createElement("button");i.classList.add("sbgcui_settings_button"),i.innerText="Настройки SBG CUI",i.addEventListener("click",(t=>{e.classList.add("hidden"),n.classList.toggle("sbgcui_hidden")})),t.appendChild(i),document.body.addEventListener("click",(e=>{n.classList.contains("sbgcui_hidden")||e.target.closest(".sbgcui_settings")||e.target.closest(".sbgcui_settings_button")||G()}))}{var ee=document.createElement("meta"),te=document.querySelector('meta[name="viewport"]');ee.name="theme-color",document.head.appendChild(ee);let e=u.tinting;+e.map&&Y("map"),$.addEventListener("profilePopupOpened",(t=>{+e.profile?Y("profile"):Y("")})),k.addEventListener("pointPopupOpened",(t=>{"off"!=e.point?Y(`point_${e.point}`):Y("")})),S.addEventListener("pointLevelChanged",(t=>{"level"==e.point&&Y("point_level")})),E.addEventListener("pointOwnerChanged",(t=>{"team"==e.point&&Y("point_team")})),k.addEventListener("pointPopupClosed",(t=>{B?+e.profile&&Y("profile"):+e.map?Y("map"):Y(""),k.style.borderColor="",x.style.color=""})),$.addEventListener("profilePopupClosed",(t=>{D?"off"!=e.point&&Y(`point_${e.point}`):+e.map?Y("map"):Y(""),$.style.borderColor=""}))}var ne=document.createElement("div");ne.classList.add("sbgcui_xpdiff-wrapper"),document.body.appendChild(ne);{let e=document.createElement("div"),t=document.createElement("button"),n=document.createElement("button"),i=document.createElement("span"),s=document.querySelector(".pr-stats"),a=JSON.parse(localStorage.getItem("sbgcui_stats"),((e,t)=>"date"==e?new Date(t):t));t.innerText="Записать",n.innerText="Сравнить",t.addEventListener("click",(e=>{confirm("Сохранить вашу статистику на текущий момент? \nЭто действие перезапишет сохранённую ранее статистику.")&&F(Q.guid).then((e=>{let t=new Date;localStorage.setItem("sbgcui_stats",JSON.stringify({date:t,stats:e})),i.innerText=`Последняя запись: \n${t.toLocaleString()}`}))})),n.addEventListener("click",(e=>{let t=JSON.parse(localStorage.getItem("sbgcui_stats"),((e,t)=>"date"==e?new Date(t):t));if(!t){let e=W("Вы ещё не сохраняли свою статистику.");return e.options.className="error-toast",void e.showToast()}F(Q.guid).then((e=>{let n=new Date-t.date,i=["day","hr","min","sec"],s="",a="";[864e5,36e5,6e4,1e3].forEach(((e,t)=>{let a=Math.trunc(n/e);a&&(s+=`${s.length?", ":""}${a} ${i[t]+(a>1?"s":"")}`,n-=a*e)}));for(let n in e){let i=e[n]-t.stats[n];if(i){let e,t=i>0;switch(n){case"discoveries":case"captures":case"level":case"cores_deployed":case"cores_destroyed":case"lines_destroyed":case"unique_captures":case"unique_visits":case"owned_points":e=n.charAt(0).toUpperCase()+n.slice(1).replace("_"," ");break;case"xp":e="XP";break;case"guard_line":e="Longest line ownership";break;case"guard_point":e="Longest point ownership";break;case"lines":e="Lines drawn";break;case"max_line":e="Longest drawn line (m)";break;case"neutralizes":e="Points neutralized";break;default:n.match(/created_at|name|player|team/)||(e=n)}e&&(a+=`\n                <p class="sbgcui_compare_stats-diff-wrp">\n                  <span>${e}:</span>\n                  <span class="sbgcui_compare_stats-diff-value${t?"Pos":"Neg"}">\n                    ${t?"+":""}${i}\n                  </span>\n                </p>\n              `)}}let o=W(a.length?`Ваша статистика с ${t.date.toLocaleString()}<br>(${s})<br>${a}`:"Ничего не изменилось с прошлого сохранения.","bottom center",2e4);o.options.className="sbgcui_compare_stats-toast",o.showToast()}))})),a&&(i.innerText=`Последнее сохранение: \n${a.date.toLocaleString()}`),i.classList.add("sbgcui_compare_stats-timestamp"),e.classList.add("sbgcui_compare_stats"),e.append(i,t,n),$.insertBefore(e,s),$.addEventListener("profilePopupOpened",(t=>{T.innerText==Q.name?e.classList.remove("sbgcui_hidden"):e.classList.add("sbgcui_hidden")}))}if(window.navigator.userAgent.toLowerCase().includes("wv")){let e=document.querySelector(".game-menu"),t=document.createElement("button");t.innerText="Reload",t.addEventListener("click",(e=>{window.location.reload()})),e.appendChild(t)}w.addEventListener("click",(e=>{if(w.hasAttribute("sbgcui_clicks")){let e=+w.getAttribute("sbgcui_clicks");if(e+1==5){let e=document.querySelector(".i-stat"),t=document.querySelector(".info.popup").dataset.guid,n=document.createElement("span");n.innerText=`GUID: ${t}`,n.addEventListener("click",(e=>{window.navigator.clipboard.writeText(`https://3d.sytes.net/?point=${t}`).then((e=>{W("Ссылка на точку скопирована в буфер обмена.").showToast()}))})),e.prepend(n),k.addEventListener("pointPopupClosed",(e=>{n.remove(),w.setAttribute("sbgcui_clicks",0)}))}w.setAttribute("sbgcui_clicks",e+1)}else w.setAttribute("sbgcui_clicks",1)})),"vibrate"in window.navigator&&document.body.addEventListener("click",(e=>{u.vibration.buttons&&"BUTTON"==e.target.nodeName&&(window.navigator.vibrate(0),window.navigator.vibrate(50))}));{function e(e,t){return e?new d(e,t):t}var ie=JSON.parse(localStorage.getItem("sbgcui_favorites"),e)||{};Object.defineProperty(ie,"save",{value:function(){let e={};for(let t in this)this[t].isActive&&(e[t]=this[t]);localStorage.setItem("sbgcui_favorites",JSON.stringify(e))}});{let e=JSON.parse(localStorage.getItem("sbgcui_pointsSubscriptions")),t=JSON.parse(localStorage.getItem("sbgcui_reminders"));if(e){for(let n of e){let e=t[n];ie[n]=new d(n,e)}ie.save(),localStorage.removeItem("sbgcui_pointsSubscriptions"),localStorage.removeItem("sbgcui_reminders")}}{let e=document.createElement("button"),t=k.dataset.guid;e.classList.add("sbgcui_button_reset","sbgcui_point_star","fa-"+(ie[t]?.isActive?"solid":"regular"),"fa-star"),e.addEventListener("click",(t=>{let n=k.dataset.guid,i=x.innerText;if(e.classList.contains("fa-solid"))ie[n].isActive=0,e.classList.replace("fa-solid","fa-regular");else{if(n in ie)ie[n].isActive=1;else{let e=JSON.parse(localStorage.getItem("cooldowns"))||{},t=0==e[n]?.c?e[n].t:null;ie[n]=new d(n,t,i)}e.classList.replace("fa-regular","fa-solid"),!X()&&"Notification"in window&&"default"==Notification.permission&&Notification.requestPermission()}ie.save()})),k.addEventListener("pointPopupOpened",(t=>{let n=k.dataset.guid;ie[n]?.isActive?e.classList.replace("fa-regular","fa-solid"):e.classList.replace("fa-solid","fa-regular")})),L.appendChild(e)}{let e=document.createElement("button"),t=document.createElement("div"),n=document.createElement("h3"),i=document.createElement("ul"),s=!1;function a(){let e=[];if(i.innerHTML="",0!=Object.keys(ie).length){for(let t in ie)if(ie[t].isActive){let n=document.createElement("li"),i=document.createElement("a"),a=document.createElement("button");i.setAttribute("href",`/?point=${t}`),i.innerText=ie[t].name,a.classList.add("sbgcui_button_reset","sbgcui_favs-li-delete","fa-solid","fa-circle-xmark"),a.addEventListener("click",(e=>{ie[t].isActive=0,ie.save(),n.removeAttribute("sbgcui_active",""),n.classList.add("sbgcui_hidden")})),n.classList.add("sbgcui_favs-li"),n.setAttribute("sbgcui_active","");let o=ie[t].isActive&&ie[t].cooldown,r=ie[t].discoveriesLeft;if(o){i.setAttribute("sbgcui_cooldown",ie[t].timer),i.sbgcuiCooldown=ie[t].cooldown;let e=setInterval((()=>{s&&ie[t].isActive&&ie[t].cooldown?i.setAttribute("sbgcui_cooldown",ie[t].timer):clearInterval(e)}),1e3)}else r&&(i.setAttribute("sbgcui_discoveries",r),i.discoveriesLeft=r);n.append(a,i),e.push(n)}e.sort(((e,t)=>(e=e.childNodes[1].sbgcuiCooldown||e.childNodes[1].discoveriesLeft,t=t.childNodes[1].sbgcuiCooldown||t.childNodes[1].discoveriesLeft,null==e?1:null==t?-1:e-t))),i.append(...e)}}t.classList.add("sbgcui_favs","sbgcui_hidden"),n.classList.add("sbgcui_favs-header"),i.classList.add("sbgcui_favs-content"),n.innerText="Избранные точки",t.append(n,i),e.classList.add("sbgcui_button_reset","sbgcui_favs_star","fa-solid","fa-star"),e.addEventListener("click",(()=>{a(),t.classList.toggle("sbgcui_hidden"),s=!s})),document.body.addEventListener("click",(e=>{!s||e.target.closest(".sbgcui_favs")||e.target.closest(".sbgcui_favs_star")||(t.classList.add("sbgcui_hidden"),s=!1)})),P.prepend(e),document.body.appendChild(t)}}document.querySelector(".inventory__content").addEventListener("click",(e=>{if(!e.target.classList.contains("inventory__ic-view"))return;let t=e.target.closest(".inventory__item").dataset.ref;t&&confirm("Открыть карточку точки?")&&(location.href=`/?point=${t}`)}));{function e(e){let t=JSON.parse(localStorage.getItem("inventory-cache"))||[],n=k.dataset.guid,i=t.filter((e=>e.l==n))[0],s={guid:i.g,type:i.t,amount:-1==e?i.a:e};U([s]).then((e=>{if(e[0].error||!e[0].status.match(/success/i))throw e[0].error||e[0].status;let t=document.querySelector("#i-ref");t.innerText=t.innerText.replace(/[0-9]{1,}(?=\/[0-9]{1,})/,e[0].count.item),t.setAttribute("data-has",e[0].count.item?1:0),_.innerText=e[0].count.total,z([s])})).catch((e=>{let t=W("Ошибка при удалении рефов.");t.options.className="error-toast",t.showToast()}))}let t,n,i=document.createElement("button");i.classList.add("sbgcui_button_reset","sbgcui_point_trash","fa-solid","fa-trash-can"),i.addEventListener("touchstart",(i=>{t=Date.now(),n=setTimeout((t=>{confirm("Удалить все рефы от этой точки из инвентаря?")&&e(-1)}),1e3)})),i.addEventListener("touchend",(i=>{if(!(Date.now()-t<1e3))return;clearTimeout(n);let s=prompt('Сколько рефов удалить из инвентаря? \n\nВведите "-1" или удерживайте кнопку с корзиной, чтобы удалить всё.');null!=s&&(isNaN(s)||s<-1||0==s?alert('Указано некорректное количество. \n\nВведите "-1" или удерживайте кнопку с корзиной, чтобы удалить всё.'):e(s))})),L.appendChild(i)}{let e=document.createElement("span"),t=document.createElement("span");e.classList.add("sbgcui_no_loot","fa-solid","fa-droplet-slash"),t.classList.add("sbgcui_no_refs","fa-solid","fa-link-slash"),f.append(e,t),f.addEventListener("click",(e=>{if(e.target==f)p=new c(1,1);else{let t=!e.target.classList.contains("sbgcui_no_loot"),n=!e.target.classList.contains("sbgcui_no_refs");p=new c(t,n)}}))}}window.addEventListener("load",(()=>setTimeout(main,1e3)),!1);