// ==UserScript==
// @name         SBG CUI
// @namespace    https://sbg-game.ru/app/
// @version      1.11.10
// @downloadURL  https://nicko-v.github.io/sbg-cui/index.min.js
// @updateURL    https://nicko-v.github.io/sbg-cui/index.min.js
// @description  SBG Custom UI
// @author       NV
// @match        https://sbg-game.ru/app/*
// @run-at       document-idle
// @grant        none
// ==/UserScript==
!function(){"use strict";const e="0.4.2",t="https://nicko-v.github.io/sbg-cui",n=window.innerHeight/2*.7,i=matchMedia("(prefers-color-scheme: dark)").matches,o="cdb"==JSON.parse(localStorage.getItem("settings"))?.base,s={0:0,1:500,2:750,3:1e3,4:1500,5:2e3,6:2500,7:3500,8:4e3,9:5250,10:6500},a={0:0,1:6,2:6,3:6,4:3,5:3,6:2,7:2,8:1,9:1,10:1},r=[1500,5e3,12500,25e3,6e4,125e3,35e4,675e3,1e6,1/0],c={1:{eng:"cores",rus:"ядра"},2:{eng:"catalysers",rus:"катализаторы"},3:{eng:"refs",rus:"рефы"},4:{eng:"brooms",rus:"веники"}},l={region:125,line:45,core:10},d={maxAmountInBag:{cores:{I:-1,II:-1,III:-1,IV:-1,V:-1,VI:-1,VII:-1,VIII:-1,IX:-1,X:-1},catalysers:{I:-1,II:-1,III:-1,IV:-1,V:-1,VI:-1,VII:-1,VIII:-1,IX:-1,X:-1},refs:{allied:-1,hostile:-1}},autoSelect:{deploy:"max",upgrade:"min",attack:"latest"},mapFilters:{invert:i&&!o?1:0,hueRotate:i?180:0,brightness:i?.75:1,grayscale:i?1:0,sepia:1,blur:0,branding:"default",brandingColor:"#CCCCCC"},tinting:{map:1,point:"level",profile:1},vibration:{buttons:1,notifications:1},ui:{doubleClickZoom:0,pointBgImage:1,pointBtnsRtl:0,pointBgImageBlur:1,pointDischargeTimeout:1,speedometer:1},pointHighlighting:{inner:"uniqc",outer:"off",outerTop:"cores",outerBottom:"highlevel",text:"refsAmount",innerColor:"#E87100",outerColor:"#E87100",outerTopColor:"#EB4DBF",outerBottomColor:"#28C4F4"},drawing:{minDistance:-1,maxDistance:-1}};let u,g,m;async function p(){const i=Intl.NumberFormat(i18next.language).formatToParts(1111)[1].value,o=Intl.NumberFormat(i18next.language).formatToParts(1.1)[1].value;class p{constructor(e,t){this.loot=e,this.refs=t}get isActive(){return!(this.loot&&this.refs)}}class h{constructor(e){this.coords=e.c,this.guid=e.g,this.level=e.l,this.team=e.te,this.lines={in:e.li.i,out:e.li.o},this.regionsAmount=e.r,this.cores={},this.image=`https://lh3.googleusercontent.com/${e.i}`,this.update(e.co)}get emptySlots(){return 6-Object.keys(this.cores)}get isEmptySlots(){return this.emptySlots>0}get playerCores(){let e={};for(let t in this.cores){let n=this.cores[t];n.owner==Te.name&&(n.level in e?e[n.level]+=1:e[n.level]=1)}return e}get energy(){if(0==Object.keys(this.cores).length)return 0;let e=0,t=0;for(let n in this.cores)e+=s[this.cores[n].level],t+=this.cores[n].energy;return t/e*100}get energyFormatted(){return de.format(this.energy)}get mostChargedCatalyserEnergy(){let e=Math.max(...Object.values(this.cores).map((e=>e.energy/s[e.level]*100)));return isFinite(e)?e:null}get dischargeTimeout(){const e=this.mostChargedCatalyserEnergy,t=new Intl.RelativeTimeFormat(i18next.language,{style:"short"});if(null==e)return"";let n=e/.6*60*60*1e3,i=["day","hour"],o="";return[864e5,36e5].forEach(((e,s)=>{const a=Math.trunc(n/e),r=t.formatToParts(a,i[s]),c=`${r[1].value}${r[2].value}`;a&&(o+=`${o.length?", ":""}${c}`,n-=a*e)})),o}get coresAmount(){return Object.keys(this.cores).length}get linesAmount(){return this.lines.in+this.lines.out}get destroyReward(){return l.core*this.coresAmount+l.line*this.linesAmount+l.region*this.regionsAmount}update(e){e.forEach((e=>{this.cores[e.g]={energy:e.e,level:e.l,owner:e.o}}));const t=new Event("pointRepaired");j.dispatchEvent(t)}selectCore(e,t){let n,i=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>1==e.t&&!ae.has(e.g))).sort(((e,t)=>e.l-t.l)),o=this.playerCores;switch(e){case"min":n=t?i.find((e=>e.l>t&&(o[e.l]||0)<a[e.l]&&e.l<=Te.level)):i.find((e=>(o[e.l]||0)<a[e.l]&&e.l<=Te.level));break;case"max":n=i.findLast((e=>e.l<=Te.level&&(o[e.l]||0)<a[e.l]));break}_e(k.querySelector(`[data-guid="${n?.g}"]:not(.is-active)`))}}class f extends ol.control.Control{#e=document.createElement("button");#t=!1;#n=document.createElement("div");constructor(e){const t=document.createElement("div"),n="true"==localStorage.getItem(e);t.classList.add("ol-unselectable","ol-control","sbgcui_toolbar-control"),super({element:t}),this.name=e,this.#e.classList.add("fa","fa-solid-angle-up"),this.#e.addEventListener("click",this.handleExpand.bind(this)),this.#n.classList.add("sbgcui_toolbar"),n?this.expand():this.collapse(),t.append(this.#n,this.#e)}addItem(e,t){e.style.order=t,this.#n.appendChild(e)}collapse(){this.#e.classList.remove("fa-rotate-180"),this.#e.style.opacity=1,this.#n.classList.add("sbgcui_hidden"),this.#t=!1,localStorage.setItem(this.name,!1)}expand(){this.#e.classList.add("fa-rotate-180"),this.#e.style.opacity=.5,this.#n.classList.remove("sbgcui_hidden"),this.#t=!0,localStorage.setItem(this.name,!0)}handleExpand(){this.#t?this.collapse():this.expand()}}class b{#i;constructor(e,t,n){this.guid=e,this.name=n||e,this.cooldown=t,this.discoveriesLeft=void 0,this.timeoutID=void 0,this.isActive=1,n||this.#o()}#o(){me(this.guid).then((e=>{this.name=e.t})).catch((e=>{}))}#s(){if(!this.isActive)return;let e=`"${this.name}": точка остыла.`;if(!ve()&&"Notification"in window&&"granted"==Notification.permission){new Notification(e,{icon:"/icons/icon_512.png"})}else{let t=we(e,"top left",-1);t.options.className="sbgcui_toast-selection",t.showToast(),"vibrate"in window.navigator&&v.vibration.notifications&&(window.navigator.vibrate(0),window.navigator.vibrate([500,300,500,300,500]))}}#a(e){let t=e-Date.now();clearTimeout(this.timeoutID),this.timeoutID=setTimeout(function(){this.#s(),this.cooldown=null}.bind(this),t)}toJSON(){return this.cooldown>Date.now()?this.cooldown:null}get hasActiveCooldown(){return this.cooldown-Date.now()>0}get cooldown(){return this.#i}get timer(){if(!this.cooldown)return"";let e=new Date(this.cooldown-Date.now());if(e<0)return"";return new Intl.DateTimeFormat("ru-RU",{hour:"numeric",minute:"numeric",second:"numeric",timeZone:"UTC"}).format(e)}set cooldown(e){this.#i=e>Date.now()?e:null,this.#i&&(this.discoveriesLeft=void 0,this.#a(this.#i))}}let v;if(localStorage.getItem("sbgcui_config"))v=JSON.parse(localStorage.getItem("sbgcui_config"),((e,t)=>isNaN(+t)?t:+t)),v={...d,...v},function e(t,n){for(let i in n)typeof n[i]!=typeof t[i]?t[i]=n[i]:"object"==typeof n[i]&&e(t[i],n[i])}(v,d),localStorage.setItem("sbgcui_config",JSON.stringify(v));else{v=d,localStorage.setItem("sbgcui_config",JSON.stringify(v));let e=we("Сохранённые настройки не найдены. <br>Загружена стандартная конфигурация.");e.options.className="error-toast",e.showToast()}let y=window.fetch;window.fetch=async function(e,t){return new Promise(((n,i)=>{const o=new URL(window.location.origin+e);switch(o.pathname){case"/api/attack2":const e=JSON.parse(t.body).guid,i=void 0!==JSON.parse(localStorage.getItem("inventory-cache")).find((t=>4==t.t&&t.g==e)),s=`Использовать "${i18next.t("items.brooms_one")}"?`;if(i&&!confirm(s))return n(),void L.dispatchEvent(new Event("attackSliderOpened"));break;case"/api/inview":let a=Object.values(v.pointHighlighting).find((e=>e.match(/uniqc|uniqv/)));if(a){const e="uniqc"==a?4:2;o.searchParams.set("h",e)}const r=JSON.parse(localStorage.getItem("map-config")),c=Bitfield.from(r.l);c.change(1,1),c.change(2,1),o.searchParams.set("l",c.toString());break}y(o.pathname+o.search,t).then((async e=>{if(!o.pathname.match(/^\/api\//))return void n(e);e.clone().json().then((async i=>{switch(o.pathname){case"/api/point":"data"in i&&null==o.searchParams.get("status")&&(oe=new h(i.data));break;case"/api/deploy":"data"in i?(oe.update(i.data.co,i.data.l),oe.selectCore(v.autoSelect.deploy)):"c"in i&&(oe.update([i.c],i.l),oe.selectCore(v.autoSelect.upgrade,i.c.l));break;case"/api/attack2":se=JSON.parse(t.body).guid,localStorage.setItem("sbgcui_lastUsedCatalyser",se);break;case"/api/discover":if("loot"in i&&_.isActive){let t=i.loot.filter((e=>_.refs?3!=e.t&&4!=e.t:3==e.t)).map((e=>({guid:e.g,type:e.t,amount:e.a})));if(0==t.length)return;try{(await he(t)).forEach((e=>{if("error"in e)throw e.error})),i.loot=i.loot.filter((e=>_.refs?3==e.t:3!=e.t));const o=be(i,e);n(o)}catch(e){let t=we("Ошибка при фильтрации лута.");t.options.className="error-toast",t.showToast()}}if("burnout"in i||"cooldown"in i){let e,n,o=Date.now();if(i.burnout<=20)e=i.burnout;else if(i.cooldown<=90||i.burnout<o)break;try{n=JSON.parse(t.body).guid}catch{n=new URLSearchParams(t.body).get("guid")}if(n in Fe){if(e){Fe[n].discoveriesLeft=e;break}if(Fe[n].hasActiveCooldown)break;let t=i.burnout||o+1e3*i.cooldown;Fe[n].cooldown=t,Fe.save()}}break;case"/api/inview":const s=i.p,a=i.r,r=JSON.parse(localStorage.getItem("map-config")),c=o.searchParams.get("l");if(le=a.map((e=>e.c[0].slice(0,3))),r.l==c)n(e);else{const t=Bitfield.from(r.l);0==t.get(1)&&(i.l=[]),0==t.get(2)&&(i.r=[]);const o=be(i,e);n(o)}const l=o.searchParams.get("h"),d=null!=l,u=null!=Object.values(v.pointHighlighting).find((e=>e.match(/cores|highlevel|level/)));if(!s)break;if(u){let e=s.filter((e=>(!e.t&&delete ce[e.g],0!=e.t)));if(e.length<=100){(e.map((e=>e.g))||[]).forEach((e=>{Date.now()-ce[e]?.timestamp<7e3||me(e).then((t=>{ce[e]={cores:t.co,lines:{in:t.li.i,out:t.li.o,get sum(){return this.in+this.out}},energy:t.e,level:t.l,timestamp:Date.now()}})).catch((()=>{ce[e]={timestamp:Date.now()}}))}))}}d&&s?.forEach((e=>{const t=4==l?"c":"v";e.h?re[t].add(e.g):re[t].delete(e.g)}));break;case"/api/draw":if(!1 in i)break;let{minDistance:g,maxDistance:m}=v.drawing;if(g=-1==g?-1/0:+g,m=-1==m?1/0:+m,ie&&ne&&ne.guid!=j.dataset.guid&&"get"==t.method){const t=i.data.find((e=>e.p==ne.guid)),o=i.data.length-(t?1:0);if(i.data=t?[t]:[],o>0){const e=we(`Точк${1==o?"а":"и"} (${o}) скрыт${1==o?"а":"ы"}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tиз списка, так как вы находитесь в режиме рисования "Звезда".`,"top left");e.options.className="sbgcui_toast-selection",e.showToast()}const s=be(i,e);n(s);break}if(isFinite(g)||isFinite(m)){const t=i.data.filter((e=>e.d<=m&&e.d>=g)),o=i.data.length-t.length;if(o>0){const e=we(`Точк${1==o?"а":"и"} (${o}) скрыт${1==o?"а":"ы"}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tиз списка согласно настройкам ограничения дальности рисования\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(${isFinite(g)?"мин. "+g+" м":""}${isFinite(g+m)?", ":""}${isFinite(m)?"макс. "+m+" м":""}).`,"top left");e.options.className="sbgcui_toast-selection",e.showToast(),i.data=t}const s=be(i,e);n(s)}break;case"/api/profile":"data"in i&&z.style.setProperty("--sbgcui-reg-date",Ce(i.data.created_at));break;case"/api/repair":"data"in i&&Q&&oe.update(i.data);break;default:return void n(e)}})).catch((e=>{})).finally((()=>{n(e)}))})).catch((e=>{i(e)}))}))};let _,w=document.documentElement,E=document.querySelector("#attack-menu"),L=document.querySelector(".attack-slider-wrp"),x=document.querySelector(".draw-slider-wrp"),S=document.querySelector("#catalysers-list"),k=document.querySelector("#cores-list"),C=document.querySelector("#refs-list"),I=document.querySelector("#discover"),T=document.querySelector("#ops"),$=document.querySelector("#inventory__close"),P=document.querySelector(".inventory__content"),q=document.querySelector(".inventory.popup"),O=document.querySelector("#self-info__inv"),A=document.querySelector(".i-stat__cores"),N=document.querySelector("#i-image"),M=document.querySelector(".i-image-box"),F=document.createElement("span"),B=document.querySelector("#i-level"),D=document.querySelector("#i-stat__owner"),R=document.querySelector("#i-title"),j=document.querySelector(".info.popup"),V=document.querySelector(".info.popup > .popup-close"),J=document.querySelector("#pr-name"),H=document.querySelector(".profile.popup"),G=document.querySelector(".profile.popup > .popup-close"),z=document.querySelector(".pr-stat__age > .pr-stat-val"),X=document.querySelector("#self-info__exp"),U=document.querySelector("#self-info__explv"),W=document.querySelector("#self-info__name"),Z=document.querySelector("#toggle-follow"),Y=document.querySelector(".xp-diff"),K=!q.classList.contains("hidden"),Q=!j.classList.contains("hidden"),ee=!H.classList.contains("hidden"),te=!L.classList.contains("hidden"),ne=JSON.parse(localStorage.getItem("sbgcui_starModeTarget")),ie=1==localStorage.getItem("sbgcui_isStarMode")&&null!=ne,oe={},se=localStorage.getItem("sbgcui_lastUsedCatalyser"),ae=new Set(JSON.parse(localStorage.getItem("sbgcui_excludedCores"))),re={c:new Set,v:new Set},ce={},le=[],de=new Intl.NumberFormat(i18next.language,{maximumFractionDigits:1}),ue={I:1,II:2,III:3,IV:4,V:5,VI:6,VII:7,VIII:8,IX:9,X:10,toDecimal(e){return this[e]},toRoman(e){return Object.keys(this).find((t=>this[t]==e))}};async function ge(e,t){return fetch("/api/profile?"+(e?"guid="+e:"name="+t),{headers:{authorization:`Bearer ${localStorage.getItem("auth")}`},method:"GET"}).then((e=>e.json())).then((e=>e.data)).catch((e=>{}))}async function me(e,t=!0){return fetch(`/api/point?guid=${e}${t?"&status=1":""}`,{headers:{authorization:`Bearer ${Te.auth}`},method:"GET"}).then((e=>e.json())).then((e=>e.data))}async function pe(e,t=!1){let n=v.maxAmountInBag;(async function(){return fetch("/api/inventory",{headers:{authorization:`Bearer ${Te.auth}`},method:"GET"}).then((e=>e.json())).then((e=>e.i))})().then((e=>{let i=e.reduce(((e,t)=>e+t.a),0);if(!t&&3e3-i>=100)throw{silent:!0};if(-1==n.refs.allied&&-1==n.refs.hostile)return[e,[]];if(0==n.refs.allied&&0==n.refs.hostile)return[e,[]];let o=e.map((e=>3==e.t?me(e.l):void 0)).filter((e=>e));return Promise.all([e,...o])})).then((([e,...t])=>{let i={};t.forEach((e=>{i[e.g]={team:e.te}}));let o=e.map((({t:e,l:t,a:o,g:s})=>{if(!e in c)return;let a=-1,r=0,l=c[e].eng;if("refs"==l){if(ie&&t==ne?.guid)a=-1;else if(-1==n.refs.allied&&-1==n.refs.hostile)a=-1;else if(0==n.refs.allied&&0==n.refs.hostile)a=0;else if(Object.keys(i).length){let e=i[t].team==Te.team?"allied":"hostile";a=n[l][e]}}else a=n[l]?.[ue.toRoman(t)];return-1!=a&&o>a&&(r=o-a),{guid:s,type:e,amount:r}})).filter((e=>e?.amount>0));return Promise.all([o,he(o)])})).then((([e,t])=>{if(!e.length)return;let n=t.reduce(((e,t)=>t.count.total<e?t.count.total:e),1/0);isFinite(n)&&(O.innerText=n),T.style.color.match("accent")&&(T.style.color=""),function(e){let t=JSON.parse(localStorage.getItem("inventory-cache"))||[];e.forEach((e=>{let n=t.find((t=>t.g==e.guid));n&&(n.a-=e.amount)})),t=t.filter((e=>e.a>0)),localStorage.setItem("inventory-cache",JSON.stringify(t))}(e),e=e.reduce(((e,t)=>(e.hasOwnProperty(t.type)||(e[t.type]=0),e[t.type]+=t.amount,e)),{});let i="";for(let t in e)i+=`<br><span style="background: var(--sbgcui-branding-color); margin-right: 5px;" class="item-icon type-${t}"></span>x${e[t]} ${c[t].eng}`;we(`Удалено: ${i}`).showToast()})).catch((e=>{if(e.silent)return;let t=we(`Ошибка при проверке или очистке инвентаря. <br>${e.message}`);t.options.className="error-toast",t.showToast()}))}async function he(e){let t=e.reduce(((e,t)=>(e.hasOwnProperty(t.type)||(e[t.type]={}),e[t.type][t.guid]=t.amount,e)),{});return Promise.all(Object.keys(t).map((async e=>fetch("/api/inventory",{headers:{authorization:`Bearer ${Te.auth}`,"content-type":"application/json"},body:JSON.stringify({selection:t[e],tab:e}),method:"DELETE"}).then((e=>e.json())))))}async function fe(e){return fetch(`${t}/assets/html/${e}.html`).then((t=>{if(200!=t.status)throw new Error(`Ошибка при загрузке ресурса "${e}.html" (${t.status})`);return t.text()})).then((e=>(new DOMParser).parseFromString(e,"text/html").body.firstChild))}function be(e,t){const n=JSON.stringify(e),i={status:t.status,statusText:t.statusText,headers:t.headers},o=new Response(n,i);return Object.defineProperty(o,"url",{value:t.url,enumerable:!0}),o}function ve(){return"maxTouchPoints"in window.navigator?window.navigator.maxTouchPoints>0:"msMaxTouchPoints"in window.navigator?window.navigator.msMaxTouchPoints>0:"orientation"in window||/\b(BlackBerry|webOS|iPhone|IEMobile|Android|Windows Phone|iPad|iPod)\b/i.test(window.navigator.userAgent)}function ye(){let{mapFilters:e,ui:t}=v;for(let t in e){let n="blur"==t?"px":"hueRotate"==t?"deg":"";w.style.setProperty(`--sbgcui-${t}`,`${e[t]}${n}`)}w.style.setProperty("--sbgcui-point-btns-rtl",t.pointBtnsRtl?"rtl":"ltr"),w.style.setProperty("--sbgcui-point-image-blur",t.pointBgImageBlur?"2px":"0px"),w.style.setProperty("--sbgcui-show-speedometer",t.speedometer),w.style.setProperty("--sbgcui-branding-color","custom"==e.branding?e.brandingColor:Te.teamColor),window.TeamColors[Te.team].fill=`${"custom"==e.branding?e.brandingColor:Se(Te.teamColor)}80`,window.TeamColors[Te.team].stroke="custom"==e.branding?xe(e.brandingColor):Te.teamColor,Pe.setActive(Boolean(t.doubleClickZoom)),!+v.tinting.map||Q||ee||Ee("map"),document.querySelector(".sbgcui_settings").classList.add("sbgcui_hidden"),document.querySelectorAll(".sbgcui_settings > details").forEach((e=>{e.open=!1})),document.querySelectorAll('.sbgcui_settings input:not([type="hidden"]), .sbgcui_settings select').forEach((e=>{let t=e.name.split("_").reduce(((e,t)=>e[t]),v);switch(e.type){case"number":case"range":e.value=+t;break;case"color":e.value=t;break;case"checkbox":e.checked=+t;break;case"radio":e.checked=e.value==t;break;case"select-one":e.value=t;break}}))}function _e(e){let t=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0}),n=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0}),i=new MouseEvent("click",{bubbles:!0,cancelable:!0});e?.dispatchEvent(t),e?.dispatchEvent(n),e?.dispatchEvent(i)}function we(e="",t="top left",n=3e3,i="interaction-toast"){let o=t.split(/\s+/),s=Toastify({text:e,duration:n,gravity:o[0],position:o[1],escapeMarkup:!1,className:i});return s.options.id=Math.round(1e5*Math.random()),s.options.onClick=()=>s.hideToast(),s}function Ee(e){let t,n=/ya-title=.*?,\sya-dock=.*?(?=,|$)/;switch(e){case"map":t=getComputedStyle(W).color;break;case"profile":t=getComputedStyle(J).color,H.style.borderColor=t;break;case"point_level":t=getComputedStyle(B).color,j.style.borderColor=t,R.style.color=t;break;case"point_team":t=getComputedStyle(D).color,j.style.borderColor=t,R.style.color=t;break;default:t="";break}var i;t=(i=t)?`#${i.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map((e=>parseInt(e,10).toString(16).padStart(2,"0"))).join("")}`:"",Ae.content=t,Ne.content.match(n)?Ne.content=Ne.content.replace(n,`ya-title=${t}, ya-dock=${t}`):Ne.content+=`, ya-title=${t}, ya-dock=${t}`}function Le(e){if(0==e)return;let t=document.createElement("span");t.classList.add("sbgcui_xpdiff"),t.innerText=`+${e}xp`,Me.appendChild(t),setTimeout((e=>{t.classList.add("sbgcui_xpdiff-out")}),100),setTimeout((e=>{Me.removeChild(t)}),3e3)}function xe(e,t=!0){return t?`#${[...e].filter(((e,t)=>t%2)).join("")}`:`#${[...e].map(((e,t,n)=>t%2?e:n[t-1])).join("")}`}function Se(e){return[...e].map((e=>"#"==e?e:e+e)).join("")}function ke(e,t){return e*(t=t||1/ol.proj.getPointResolution("EPSG:3857",1,g.getCenter(),"m"))}function Ce(e){const t=Date.parse(e),n=Date.now();return Math.trunc((n-t)/1e3/60/60/24)}var Ie=await async function(){return fetch("/api/self",{headers:{authorization:`Bearer ${localStorage.getItem("auth")}`},method:"GET"}).then((e=>e.json().then((t=>({version:e.headers.get("SBG-Version"),name:t.n,team:t.t,exp:t.x,lvl:t.l,guid:t.g}))))).catch((e=>{}))}();if(e!=Ie.version){let e=+localStorage.getItem("sbgcui_version_warns");if(e<2){let t=we(`Текущая версия игры (${Ie.version}) не соответствует последней известной версии (0.4.2). Возможна некорректная работа.`);t.options.className="error-toast",t.showToast(),localStorage.setItem("sbgcui_version_warns",e+1)}}else localStorage.setItem("sbgcui_version_warns",0);var Te={name:Ie.name,team:Ie.team,exp:{total:Ie.exp,current:Ie.exp-r.slice(0,Ie.lvl-1).reduce(((e,t)=>t+e),0),goal:r[Ie.lvl-1],get percentage(){return this.goal==1/0?100:this.current/this.goal*100},set string(e){[this.current,this.goal=1/0]=e.replace(/\s|,/g,"").split("/")}},auth:localStorage.getItem("auth"),guid:Ie.guid,feature:m,teamColor:getComputedStyle(w).getPropertyValue(`--team-${Ie.team}`),get level(){return this._level},set level(e){this._level=+e.split("").filter((e=>e.match(/[0-9]/))).join("")},_level:Ie.lvl};"NickolayV"==Te.name&&v==d&&(v.maxAmountInBag={cores:{I:0,II:0,III:0,IV:0,V:0,VI:120,VII:120,VIII:120,IX:120,X:-1},catalysers:{I:0,II:0,III:0,IV:0,V:0,VI:0,VII:0,VIII:1e3,IX:-1,X:-1},refs:{allied:-1,hostile:-1}},v.autoSelect.upgrade="max",v.mapFilters.branding="custom",v.mapFilters.brandingColor="#4433DD",localStorage.setItem("sbgcui_config",JSON.stringify(v)));{let{mapFilters:e,ui:n}=v,i=document.createElement("style"),o=document.createElement("link"),s=document.createElement("link"),a=document.createElement("link");i.innerHTML=`\n      :root {\n        --sbgcui-player-exp-percentage: ${Te.exp.percentage}%;\n        --sbgcui-inventory-limit: " / 3000";\n        --sbgcui-invert: ${e.invert};\n        --sbgcui-hueRotate: ${e.hueRotate}deg;\n        --sbgcui-brightness: ${e.brightness};\n        --sbgcui-grayscale: ${e.grayscale};\n        --sbgcui-sepia: ${e.sepia};\n        --sbgcui-blur: ${e.blur}px;\n        --sbgcui-point-bg: #ccc;\n        --sbgcui-point-image: '';\n        --sbgcui-point-image-blur: ${n.pointBgImageBlur?2:0}px;\n        --sbgcui-point-btns-rtl: ${n.pointBtnsRtl?"rtl":"ltr"};\n\t\t\t\t--sbgcui-show-speedometer: ${n.speedometer};\n\t\t\t\t--sbgcui-branding-color: ${"custom"==e.branding?e.brandingColor:Te.teamColor};\n\t\t\t\t--team-${Te.team}: var(--sbgcui-branding-color);\n      }\n  \t`,"custom"==e.branding&&(window.TeamColors[Te.team].fill=e.brandingColor+"80",window.TeamColors[Te.team].stroke=xe(e.brandingColor)),[o,s,a].forEach((e=>e.setAttribute("rel","stylesheet"))),o.setAttribute("href",`${t}/styles.min.css`),s.setAttribute("href",`${t}/assets/fontawesome/css/fa.min.css`),a.setAttribute("href",`${t}/assets/fontawesome/css/fa-svg.min.css`),document.head.append(i,s,a,o)}new MutationObserver(((e,t)=>{t.disconnect(),Te.level=U.textContent,U.innerText=(Te.level<=9?"0":"")+Te.level,t.observe(U,{childList:!0})})).observe(U,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointLevelChanged",{bubbles:!0});B.dispatchEvent(t)})).observe(B,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointOwnerChanged",{bubbles:!0});D.dispatchEvent(t)})).observe(D,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointCoresUpdated",{bubbles:!0});A.dispatchEvent(t)})).observe(A,{childList:!0}),new MutationObserver((e=>{let t;e[0].target.classList.contains("hidden")?(t=new Event("pointPopupClosed"),Q=!1):e[0].oldValue?.includes("hidden")&&(t=new Event("pointPopupOpened"),Q=!0),t&&e[0].target.dispatchEvent(t)})).observe(j,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),new MutationObserver((e=>{ee=!e[0].target.classList.contains("hidden");let t=new Event(ee?"profilePopupOpened":"profilePopupClosed",{bubbles:!0});e[0].target.dispatchEvent(t)})).observe(H,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{K=!e[0].target.classList.contains("hidden");let t=new Event(K?"inventoryPopupOpened":"inventoryPopupClosed");e[0].target.dispatchEvent(t)})).observe(q,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{let t=e[0].target.classList.contains("hidden"),n=new Event(t?"attackSliderClosed":"attackSliderOpened",{bubbles:!0});e[0].target.dispatchEvent(n),te=!t})).observe(L,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{let t=e[0].target.classList.contains("hidden"),n=new Event(t?"drawSliderClosed":"drawSliderOpened",{bubbles:!0});e[0].target.dispatchEvent(n)})).observe(x,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{Le(e.find((e=>e.addedNodes.length)).addedNodes[0].data.match(/\d+/)[0])})).observe(Y,{childList:!0}),new MutationObserver((()=>{if(Array.from(document.querySelectorAll('.inventory__content[data-tab="3"] > .inventory__item')).every((e=>e.classList.contains("loaded")))){let e=new Event("refsListLoaded");P.dispatchEvent(e)}})).observe(P,{subtree:!0,attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{if(te&&[...e].filter((e=>e.oldValue.includes("is-active")&&!e.target.classList.contains("is-active"))).length){let e=new Event("activeSlideChanged");S.dispatchEvent(e)}})).observe(S,{subtree:!0,attributes:!0,attributeFilter:["class"],attributeOldValue:!0}),new MutationObserver((e=>{let t=new Event("coresListUpdated");k.dispatchEvent(t)})).observe(k,{childList:!0});I.addEventListener("click",(e=>{e.target==I&&pe()})),E.addEventListener("click",(e=>{E.classList.toggle("sbgcui_attack-menu-rotate")})),j.addEventListener("pointPopupOpened",(()=>{let e=JSON.parse(localStorage.getItem("settings"))||{};v.ui.pointBgImage?(w.style.setProperty("--sbgcui-point-image",e.imghid?"":`url("${oe.image}")`),j.classList.add("sbgcui_point-popup-bg"),N.classList.add("sbgcui_no_bg_image")):(w.style.setProperty("--sbgcui-point-image",""),j.style.backgroundImage="",j.classList.remove("sbgcui_point-popup-bg"),N.classList.remove("sbgcui_no_bg_image")),F.innerText=`${oe.energyFormatted}% @ ${oe.coresAmount}`})),j.addEventListener("pointRepaired",(()=>{F.innerText=`${oe.energyFormatted}% @ ${oe.coresAmount}`})),document.addEventListener("backbutton",(()=>(ee?_e(V):Q&&_e(G),!1))),document.querySelector('.inventory__tab[data-tab="3"]').addEventListener("click",(e=>{let t=document.querySelector('.inventory__tab[data-tab="3"] > .inventory__tab-counter'),n=JSON.parse(localStorage.getItem("inventory-cache")).reduce(((e,t)=>3==t.t?e+t.a:e),0),i=P.childNodes.length;t.innerText=i,setTimeout((()=>{t.innerText=n}),1e3)})),Z.addEventListener("touchstart",(()=>{let e=Date.now(),t=setTimeout((()=>{g.set("animationInProgress",!0),g.animate({center:Te.feature.getGeometry().getCoordinates()},{zoom:17},{rotation:0},(()=>{g.set("animationInProgress",!1)}))}),500);this.addEventListener("touchend",(()=>{Date.now()-e<1e3&&clearTimeout(t)}),{once:!0})})),Z.addEventListener("click",(()=>{$e.setActive("false"==Z.dataset.active)}));{let e=document.querySelector("#ops"),t=document.querySelector(".bottom-container"),n=document.querySelector(".ol-rotate"),i=document.querySelector("#layers"),o=document.querySelector("#notifs-menu"),s=document.querySelector("#attack-slider-close"),a=document.querySelector(".ol-zoom"),r=document.createElement("div"),c=document.createElement("span"),l=document.querySelector("#i-stat__owner").parentElement;document.querySelectorAll('[data-i18n="self-info.name"], [data-i18n="self-info.xp"], [data-i18n="units.pts-xp"], [data-i18n="self-info.inventory"], [data-i18n="self-info.position"]').forEach((e=>{e.remove()})),document.querySelectorAll(".self-info__entry").forEach((e=>{let t=[];e.childNodes.forEach((e=>{3==e.nodeType&&t.push(e)})),t.forEach((e=>{e.remove()}))})),s.remove(),E.childNodes[0].remove(),$.innerText="[x]",i.innerText="",i.classList.add("fa","fa-solid-layer-group"),o.innerText="",o.classList.add("fa","fa-solid-envelope"),a.append(n,Z,o,i),Z.innerText="",Z.classList.add("fa","fa-solid-location-crosschairs"),t.appendChild(e),e.replaceChildren("INVENTORY",O),U.innerText=(Te.level<=9?"0":"")+Te.level,r.classList.add("i-stat__entry"),c.innerText=i18next.t("info.energy"),F.id="i-stat__energy",r.append(c,": ",F),l.after(r)}{let e,t;var $e,Pe,qe,Oe=new f("sbgcui_main_toolbar");const n=u.getControls();u.getInteractions().forEach((e=>{switch(e.constructor){case ol.interaction.DragPan:$e=e;break;case ol.interaction.DoubleClickZoom:Pe=e;break;case ol.interaction.PinchRotate:qe=e;break}})),$e.setActive("false"==localStorage.getItem("follow")),Pe.setActive(Boolean(v.ui.doubleClickZoom)),n.forEach((n=>{switch(n.constructor){case ol.control.Attribution:e=n;break;case ol.control.Rotate:t=n;break}})),u.removeControl(e),u.removeControl(t),u.addControl(Oe);const i=document.createElement("label"),o=document.createElement("input"),s=document.createElement("span"),a="stadia"==JSON.parse(localStorage.getItem("settings")).base;i.classList.add("layers-config__entry"),o.type="radio",o.name="baselayer",o.value="stadia",o.checked=a,s.innerText="Stamen Watercolor",i.append(o,s),document.querySelector('input[value="osm"]').parentElement.after(i)}{let e=document.createElement("div"),t=document.createElement("div"),n=document.querySelector("#self-info__exp");new MutationObserver((()=>{Te.exp.string=n.textContent,w.style.setProperty("--sbgcui-player-exp-percentage",`${Te.exp.percentage}%`)})).observe(n,{childList:!0}),e.classList.add("sbgcui_xpProgressBar"),t.classList.add("sbgcui_xpProgressBarFiller"),n.parentElement.prepend(e),e.append(n,t)}L.addEventListener("attackSliderOpened",(e=>{_e(function(e){let t,n=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>2==e.t&&e.l<=Te.level)).sort(((e,t)=>e.l-t.l));switch(e){case"latest":if(t=L.querySelector(`[data-guid="${se}"]`),t)break;case"max":t=L.querySelector(`[data-guid="${n[n.length-1].g}"]`);break}return t}(v.autoSelect.attack))})),j.addEventListener("pointPopupOpened",(e=>{oe.selectCore(v.autoSelect.deploy)})),A.addEventListener("click",(e=>{if(e.target.classList.contains("selected")){let t=e.target.innerText.match(/^[0-9]{1,2}$/)?+e.target.innerText:ue.toDecimal(e.target.innerText);oe.selectCore(v.autoSelect.upgrade,t)}})),k.addEventListener("touchstart",(e=>{let t=e.target.closest(".is-active.splide__slide");if(null==t)return;let n=Date.now(),i=t.dataset.guid,o=setTimeout((()=>{let e;ae.has(i)?(ae.delete(i),t.removeAttribute("sbgcui-excluded-core"),e=we("Теперь ядро доступно для автовыбора.")):(ae.add(i),t.setAttribute("sbgcui-excluded-core",""),e=we("Ядро больше не участвует в автовыборе.")),e.showToast(),localStorage.setItem("sbgcui_excludedCores",JSON.stringify([...ae]))}),1e3);t.addEventListener("touchend",(()=>{Date.now()-n<1e3&&clearTimeout(o)}),{once:!0})})),k.addEventListener("coresListUpdated",(()=>{k.childNodes.forEach((e=>{ae.has(e.dataset.guid)&&e.setAttribute("sbgcui-excluded-core","")}))}));{function e(e,t,n){return t.te==Te.team&&(e.style.setProperty("--sbgcui-energy",`${t.e}%`),t.e<100&&e.style.setProperty("--sbgcui-display-r-button","flex")),n(e,t)}window.makeEntryDec=e,P.addEventListener("click",(e=>{if(!e.currentTarget.matches('.inventory__content[data-tab="3"]'))return;if(!e.target.closest(".inventory__item-controls"))return;if(!e.target.closest(".inventory__item.loaded"))return;if(e.offsetX<50)return;let t=e.target.closest(".inventory__item")?.dataset.ref;(async function(e){return fetch("/api/repair",{headers:{authorization:`Bearer ${Te.auth}`,"content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`guid=${e}&position%5B%5D=0.0&position%5B%5D=0.0`,method:"POST"}).then((e=>e.json()))})(t).then((n=>{if(n.error)throw new Error(n.error);if(n.data){let[i,o]=n.data.reduce(((e,t)=>[e[0]+t.e,e[1]+s[t.l]]),[0,0]),a=document.querySelector(`.inventory__item[data-ref="${t}"] .inventory__item-left`).querySelector(".inventory__item-descr").childNodes[4],c=Math.floor(i/o*100),l=JSON.parse(localStorage.getItem("refs-cache")),d=e.target.closest(".inventory__item");d.style.setProperty("--sbgcui-energy",`${c}%`),d.style.setProperty("--sbgcui-display-r-button",100==c?"none":"flex"),a&&(a.nodeValue=c),function(e){let t=new Intl.NumberFormat("en-GB"),n=0;for(let i=0;i<r.length;i+=1)if(n+=r[i],n>e)return X.innerText=n!=1/0?`${t.format(e-(n-r[i]))} / ${t.format(r[i])}`:t.format(e),void(U.innerText=i+1)}(n.xp.cur),Le(n.xp.diff),l[t]&&(l[t].e=c,localStorage.setItem("refs-cache",JSON.stringify(l)))}})).catch((e=>{if(e.message.match(/полностью|fully/))return;let t=we(`Ошибка при зарядке. <br>${e.message}`);t.options.className="error-toast",t.showToast()}))}))}{let e=!1,t=function(){function e(e,t){let n=document.createElement("details");n.classList.add("sbgcui_settings-section");let i=document.createElement("summary");i.classList.add("sbgcui_settings-title"),i.innerText=e;let o=document.createElement("h6");return o.classList.add("sbgcui_settings-subtitle"),o.innerHTML=t,n.appendChild(i),n.appendChild(o),n}function t(e,t,n,i,o){let s="checkbox"==e,a=document.createElement("div"),r=document.createElement("label"),c=document.createElement("input");if(a.classList.add("sbgcui_settings-input_wrp"),c.id=s?t:t+Math.random().toString().slice(2),c.name=t,c.type=e,c.value=s?1:o,c.checked=n,r.htmlFor=c.id,r.innerText=i,s){let e=document.createElement("input");e.name=t,e.type="hidden",e.value=0,a.appendChild(e)}return a.append(c,r),a}function n(e,t){let n=document.createElement("input");return n.type="color",n.name=e,n.value=t,n}function i(e,t=[],n,i){let o=document.createElement("h5"),s=document.createElement("select"),a=document.createElement("div");return o.classList.add("sbgcui_settings-dropdown-title"),o.innerText=e,t.forEach((e=>{let t=document.createElement("option");t.innerText=e[0],t.value=e[1],s.appendChild(t)})),s.name=n,s.value=i,a.classList.add("sbgcui_settings-dropdown_wrapper"),a.append(o,s),a}function o(e,t,n){let i=document.createElement("h5"),o=document.createElement("input"),s=document.createElement("div");return i.classList.add("sbgcui_settings-textfield-title"),i.innerText=e,o.name=t,o.type="number",o.min=-1,o.value=n,s.classList.add("sbgcui_settings-textfield_wrapper"),s.append(i,o),s}let s=document.createElement("form");s.classList.add("sbgcui_settings","sbgcui_hidden");let a=document.createElement("span");a.classList.add("sbgcui_settings-version"),a.innerText="v1.11.10";let r=document.createElement("h3");r.classList.add("sbgcui_settings-header"),r.innerText="Настройки";let c=document.createElement("button");c.innerText="Сохранить";let l=document.createElement("button");l.innerText="Закрыть",l.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),ye()}));let d=document.createElement("div");d.classList.add("sbgcui_settings-buttons_wrp"),d.append(c,l);let u=[function(t){let n=e("Автоудаление",'Когда в инвентаре останется меньше 100 мест, будут удалены предметы, превышающие указанное количество. <br>Значение "-1" предотвращает удаление.'),i=document.createElement("button");i.classList.add("sbgcui_settings-forceclear"),i.innerText="Очистить сейчас",i.addEventListener("click",(function(e){e.preventDefault(),confirm("Произвести очистку инвентаря согласно настройкам?")&&pe(0,!0)})),n.appendChild(i);for(let e in t){let i=document.createElement("section"),o=document.createElement("h4"),s=document.createElement("div");i.classList.add("sbgcui_settings-subsection"),o.classList.add("sbgcui_settings-title"),s.classList.add("sbgcui_settings-maxamounts"),o.innerText="cores"==e?"Ядра":"catalysers"==e?"Катализаторы":"refs"==e?"Рефы":"N/D";for(let n in t[e]){let i=document.createElement("div"),o=document.createElement("label"),a=document.createElement("input");i.classList.add("sbgcui_settings-amount_input_wrp"),o.classList.add("sbgcui_settings-amount_label"),a.classList.add("sbgcui_settings-amount_input"),"refs"==e?(o.innerText="allied"==n?"Свои:":"Чужие:",o.classList.add(`sbgcui_settings-amount_label_${n}`)):(o.innerText=n+":",o.style.color=`var(--level-${ue.toDecimal(n)})`),a.name=`maxAmountInBag_${e}_${n}`,a.type="number",a.min=-1,a.value=t[e][n],i.append(o,a),s.appendChild(i)}i.append(o,s),n.appendChild(i)}return n}(v.maxAmountInBag),function(t){let n=e("Автовыбор","Можно автоматически выбирать самый мощный катализатор при атаке, самое маленькое ядро при деплое или следующий уровень ядра при каждом апгрейде. Вы можете исключить конкретное ядро из автовыбора: нажмите на него в карусели и удерживайте 1 секунду до появления уведомления."),o=document.createElement("section"),s=i("Катализатор при атаке:",[["Самый мощный","max"],["Последний использованный","latest"]],"autoSelect_attack",t.attack),a=i("Ядро при деплое:",[["Наименьшее","min"],["Наибольшее","max"],["Вручную","off"]],"autoSelect_deploy",t.deploy),r=i("Ядро при апгрейде:",[["Наименьшее","min"],["Наибольшее","max"],["Вручную","off"]],"autoSelect_upgrade",t.upgrade);return o.classList.add("sbgcui_settings-subsection"),o.append(s,a,r),n.appendChild(o),n}(v.autoSelect),function(t){function o(e,t,n,i,o,s,a){let r=document.createElement("div"),c=document.createElement("label"),l=document.createElement("input");return r.classList.add("sbgcui_settings-mapfilters_input_wrp"),l.type=e,l.name=t,l.min=n,l.max=i,l.step=o,l.value=s,c.innerText=a,l.addEventListener("input",(e=>{!function(e,t){let n=e.split("_")[1],i="blur"==n?"px":"hueRotate"==n?"deg":"";w.style.setProperty(`--sbgcui-${n}`,`${t}${i}`)}(t,e.target.value)})),r.append(c,l),r}let s=e("Цветовая схема","Настройте цвет своей команды и оттенок карты."),a=document.createElement("section"),r=o("range","mapFilters_invert",0,1,.01,+t.invert,"Инверсия"),c=o("range","mapFilters_hueRotate",0,360,1,+t.hueRotate,"Цветность"),l=o("range","mapFilters_brightness",0,5,.01,+t.brightness,"Яркость"),d=o("range","mapFilters_grayscale",0,1,.01,+t.grayscale,"Оттенок серого"),u=o("range","mapFilters_sepia",0,1,.01,+t.sepia,"Сепия"),g=o("range","mapFilters_blur",0,4,.1,+t.blur,"Размытие"),m=i("Цвет вашей команды:",[["Стандартный","default"],["Собственный","custom"]],"mapFilters_branding",t.branding),p=n("mapFilters_brandingColor","custom"==t.branding?t.brandingColor:Se(Te.teamColor)),h=m.querySelector("select");return h.addEventListener("change",(e=>{"default"==e.target.value?(p.value=Se(Te.teamColor),w.style.setProperty("--sbgcui-branding-color",Te.teamColor)):(p.value=t.brandingColor,w.style.setProperty("--sbgcui-branding-color",t.brandingColor))})),p.addEventListener("input",(e=>{"default"==h.value&&(h.value="custom"),w.style.setProperty("--sbgcui-branding-color",xe(e.target.value))})),p.addEventListener("change",(()=>{p.value=xe(p.value,!1)})),m.appendChild(p),a.classList.add("sbgcui_settings-subsection"),a.append(m,r,c,l,d,u,g),s.appendChild(a),s}(v.mapFilters),function(n){let o=e("Тонирование","Интерфейс браузера будет окрашиваться в зависимости от того, что происходит на экране."),s=document.createElement("section"),a=t("checkbox","tinting_map",+n.map,"При просмотре карты"),r=t("checkbox","tinting_profile",+n.profile,"При просмотре профиля");a.addEventListener("change",(e=>{e.target.checked?Ee("map"):Ee("")}));let c=i("При просмотре точки:",[["Цвет уровня","level"],["Цвет команды","team"],["Нет","off"]],"tinting_point",n.point);return s.classList.add("sbgcui_settings-subsection"),s.append(a,r,c),o.appendChild(s),o}(v.tinting),function(n){let i=e("Вибрация","Устройство будет откликаться на ваши действия. Может потребоваться выдача соответствующего разрешения в браузере или системе."),o=document.createElement("section"),s=t("checkbox","vibration_buttons",+n.buttons,"При нажатии кнопок"),a=t("checkbox","vibration_notifications",+n.notifications,"При уведомлениях");return o.classList.add("sbgcui_settings-subsection"),o.append(s,a),i.appendChild(o),"vibrate"in window.navigator||i.classList.add("sbgcui_hidden"),i}(v.vibration),function(n){let i=e("Интерфейс","Некоторые аспекты дизайна можно отключить или изменить для большего удобства."),o=document.createElement("section"),s=t("checkbox","ui_doubleClickZoom",+n.doubleClickZoom,"Зум карты по двойному нажатию"),a=t("checkbox","ui_pointBgImage",+n.pointBgImage,"Фото точки вместо фона"),r=t("checkbox","ui_pointBgImageBlur",+n.pointBgImageBlur,"Размытие фонового фото"),c=t("checkbox","ui_pointBtnsRtl",+n.pointBtnsRtl,"Отразить кнопки в карточке точки"),l=t("checkbox","ui_pointDischargeTimeout",+n.pointDischargeTimeout,"Показывать примерное время разрядки точки"),d=t("checkbox","ui_speedometer",+n.speedometer,"Показывать скорость движения");return a.addEventListener("click",(e=>{"ui_pointBgImage"==e.target.id&&(e.target.checked?r.childNodes[1].removeAttribute("disabled"):(r.childNodes[1].checked=0,r.childNodes[1].setAttribute("disabled","")))})),o.classList.add("sbgcui_settings-subsection"),o.append(s,a,r,c,l,d),i.appendChild(o),i}(v.ui),function(t){function o(e,t){e.forEach((e=>{switch(t){case"uniqc":"uniqv"==e.value&&(e.value="off");break;case"uniqv":"uniqc"==e.value&&(e.value="off");break;default:e.value="off"}}))}let s=e("Подсветка точек","Точки на карте могут отображать несколько маркеров, например кольцо снаружи точки, кружок внутри неё или текст рядом. Выберите, что будет обозначать каждый из них."),a=document.createElement("section"),r=n("pointHighlighting_innerColor",t.innerColor),c=n("pointHighlighting_outerColor",t.outerColor),l=n("pointHighlighting_outerTopColor",t.outerTopColor),d=n("pointHighlighting_outerBottomColor",t.outerBottomColor),u=[["Нет","off"],["Уровень 8+","highlevel"],["Избранная","fav"],["Имеется реф","ref"],["Не захвачена","uniqc"],["Не исследована","uniqv"],["Полностью проставлена","cores"]],g=i("Внутренний маркер (точка):",u,"pointHighlighting_inner",t.inner),m=i("Наружный маркер (кольцо):",u,"pointHighlighting_outer",t.outer),p=i("Наружный маркер (верхнее полукольцо):",u,"pointHighlighting_outerTop",t.outerTop),h=i("Наружный маркер (нижнее полукольцо):",u,"pointHighlighting_outerBottom",t.outerBottom),f=i("Текстовый маркер:",[["Нет","off"],["Уровень","level"],["Энергия","energy"],["Линии вх. + исх.","lines"],["Количество рефов","refsAmount"]],"pointHighlighting_text",t.text),b=g.querySelector("select"),v=m.querySelector("select"),y=p.querySelector("select"),_=h.querySelector("select"),w=[b,v,y,_];return w.forEach((e=>{e.addEventListener("change",(t=>{switch(t.target){case v:o([y,_]);break;case y:case _:o([v]);break}["uniqc","uniqv"].includes(t.target.value)&&o(w.filter((t=>t!=e)),t.target.value)}))})),g.appendChild(r),m.appendChild(c),p.appendChild(l),h.appendChild(d),a.classList.add("sbgcui_settings-subsection"),a.append(g,m,p,h,f),s.appendChild(a),s}(v.pointHighlighting),function(t){const n=e("Рисование",'Настройки, касающиеся рисования линий. Значение "-1" в текстовом поле отключает ограничение.'),i=document.createElement("section"),s=o("Скрывать рефы ближе, чем (м):","drawing_minDistance",t.minDistance),a=o("Скрывать рефы дальше, чем (м):","drawing_maxDistance",t.maxDistance);return i.classList.add("sbgcui_settings-subsection"),i.append(s,a),n.appendChild(i),n}(v.drawing)];return u.forEach((e=>{e.addEventListener("click",(e=>{u.forEach((t=>{e.currentTarget!=t&&t.removeAttribute("open")}))}))})),s.append(a,r,...u,d),s.addEventListener("submit",(e=>{e.preventDefault();try{let t=new FormData(e.target),n=Object.fromEntries(t);for(let e in n){let t=e.split("_");if("maxAmountInBag"==t[0])v.maxAmountInBag[t[1]][t[2]]=Number.isInteger(+n[e])?n[e]:-1;else if(t[0].match(/autoSelect|mapFilters|tinting|vibration|ui|pointHighlighting|drawing/)){let i=n[e];v[t[0]][t[1]]=isNaN(+i)?i:+i}}localStorage.setItem("sbgcui_config",JSON.stringify(v)),we("Настройки сохранены").showToast()}catch(e){let t=we(`Ошибка при сохранении настроек. <br>${e.message}`);t.options.className="error-toast",t.showToast()}})),s}();document.querySelector(".topleft-container").appendChild(t);let n=document.createElement("button");n.classList.add("fa","fa-solid-gears"),n.addEventListener("click",(()=>{t.classList.toggle("sbgcui_hidden"),e=!e})),Oe.addItem(n,1),document.body.addEventListener("click",(t=>{e&&t.target!=n&&!t.target.closest(".sbgcui_settings")&&(ye(),e=!1)}))}{var Ae=document.createElement("meta"),Ne=document.querySelector('meta[name="viewport"]');Ae.name="theme-color",document.head.appendChild(Ae);let e=v.tinting;+e.map&&Ee("map"),H.addEventListener("profilePopupOpened",(t=>{+e.profile?Ee("profile"):Ee("")})),j.addEventListener("pointPopupOpened",(t=>{"off"!=e.point?Ee(`point_${e.point}`):Ee("")})),B.addEventListener("pointLevelChanged",(t=>{"level"==e.point&&Ee("point_level")})),D.addEventListener("pointOwnerChanged",(t=>{"team"==e.point&&Ee("point_team")})),j.addEventListener("pointPopupClosed",(t=>{ee?+e.profile&&Ee("profile"):+e.map?Ee("map"):Ee(""),j.style.borderColor="",R.style.color=""})),H.addEventListener("profilePopupClosed",(t=>{Q?"off"!=e.point&&Ee(`point_${e.point}`):+e.map?Ee("map"):Ee(""),H.style.borderColor=""}))}var Me=document.createElement("div");Me.classList.add("sbgcui_xpdiff-wrapper"),document.body.appendChild(Me);{function e(){const e=J.innerText,t=e==Te.name;confirm(`Сохранить ${t?"вашу ":""}статистику ${t?"":"игрока "}на текущий момент? \nЭто действие перезапишет сохранённую ранее статистику.`)&&ge(null,e).then((t=>{const n=new Date;localStorage.setItem(`sbgcui_stats_${e}`,JSON.stringify({date:n,stats:t})),a.innerText=`Последнее сохранение: \n${n.toLocaleString()}`}))}function t(){const e=J.innerText,t=e==Te.name,n=JSON.parse(localStorage.getItem(`sbgcui_stats_${e}`),((e,t)=>"date"==e?new Date(t):t));if(!n){const e=we(`Вы ещё не сохраняли ${t?"свою ":""}статистику${t?"":" этого игрока"}.`);return e.options.className="error-toast",void e.showToast()}ge(null,e).then((e=>{let i=new Date-n.date,o=["day","hr","min","sec"],s="",a="";[864e5,36e5,6e4,1e3].forEach(((e,t)=>{let n=Math.trunc(i/e);n&&(s+=`${s.length?", ":""}${n} ${o[t]+(n>1?"s":"")}`,i-=n*e)}));for(let t in e){let i=e[t]-n.stats[t];if(i){let e,n=i>0;switch(t){case"max_region":case"regions_area":e=i18next.t(`profile.stats.${t}`),i=i<1?i18next.t("units.sqm",{count:1e6*i}):i18next.t("units.sqkm",{count:i});break;case"xp":e=i18next.t("profile.stats.total-xp");break;case"level":e=i18next.t("profile.level");break;default:e=i18next.t(`profile.stats.${t}`)}e&&(a+=`\n                <p class="sbgcui_compare_stats-diff-wrp">\n                  <span>${e}:</span>\n                  <span class="sbgcui_compare_stats-diff-value${n?"Pos":"Neg"}">\n                    ${n?"+":""}${i}\n                  </span>\n                </p>\n              `)}}let r=we(a.length?`${t?"Ваша с":"С"}татистика ${t?"":"игрока "}с ${n.date.toLocaleString()}<br>(${s})<br>${a}`:"Ничего не изменилось с прошлого сохранения.","bottom center",-1,"sbgcui_compare_stats-toast");r.showToast(),r.toastElement.style.setProperty("--sbgcui-toast-color",`var(--team-${e.team})`)}))}function n(){const e=J.innerText,t=JSON.parse(localStorage.getItem(`sbgcui_stats_${e}`),((e,t)=>"date"==e?new Date(t):t));a.innerText=t?`Последнее сохранение: \n${t.date.toLocaleString()}`:""}let i=document.createElement("div"),o=document.createElement("button"),s=document.createElement("button"),a=document.createElement("span"),r=document.querySelector(".pr-stats");o.innerText="Записать",s.innerText="Сравнить",a.classList.add("sbgcui_compare_stats-timestamp"),i.classList.add("sbgcui_compare_stats"),i.append(a,o,s),H.insertBefore(i,r),o.addEventListener("click",e),s.addEventListener("click",t),H.addEventListener("profilePopupOpened",n)}if(window.navigator.userAgent.toLowerCase().includes("wv")){let e=document.querySelector(".game-menu"),t=document.createElement("button");t.classList.add("fa","fa-solid-rotate"),t.addEventListener("click",(e=>{window.location.reload()})),e.appendChild(t)}N.addEventListener("click",(e=>{if(N.hasAttribute("sbgcui_clicks")){let e=+N.getAttribute("sbgcui_clicks");if(e+1==5){let e=document.querySelector(".i-stat"),t=j.dataset.guid,n=document.createElement("span");n.innerText=`GUID: ${t}`,n.addEventListener("click",(e=>{window.navigator.clipboard.writeText(`${window.location.origin+window.location.pathname}?point=${t}`).then((e=>{we("Ссылка на точку скопирована в буфер обмена.").showToast()}))})),j.insertBefore(n,e),j.addEventListener("pointPopupClosed",(e=>{n.remove(),N.setAttribute("sbgcui_clicks",0)}))}N.setAttribute("sbgcui_clicks",e+1)}else N.setAttribute("sbgcui_clicks",1)})),"vibrate"in window.navigator&&document.body.addEventListener("click",(e=>{v.vibration.buttons&&"BUTTON"==e.target.nodeName&&(window.navigator.vibrate(0),window.navigator.vibrate(50))}));{function e(e,t){return e?new b(e,t):t}var Fe=JSON.parse(localStorage.getItem("sbgcui_favorites"),e)||{};Object.defineProperty(Fe,"save",{value:function(){let e={};for(let t in this)this[t].isActive&&(e[t]=this[t]);localStorage.setItem("sbgcui_favorites",JSON.stringify(e))}});{let e=document.createElement("button"),t=j.dataset.guid;e.classList.add("sbgcui_button_reset","sbgcui_point_star","fa",`fa-${Fe[t]?.isActive?"solid":"regular"}-star`),e.addEventListener("click",(t=>{let n=j.dataset.guid,i=R.innerText;if(e.classList.contains("fa-solid-star"))Fe[n].isActive=0,e.classList.replace("fa-solid-star","fa-regular-star");else{if(n in Fe)Fe[n].isActive=1;else{let e=JSON.parse(localStorage.getItem("cooldowns"))||{},t=0==e[n]?.c?e[n].t:null;Fe[n]=new b(n,t,i)}e.classList.replace("fa-regular-star","fa-solid-star"),!ve()&&"Notification"in window&&"default"==Notification.permission&&Notification.requestPermission()}Fe.save()})),j.addEventListener("pointPopupOpened",(t=>{let n=j.dataset.guid;Fe[n]?.isActive?e.classList.replace("fa-regular-star","fa-solid-star"):e.classList.replace("fa-solid-star","fa-regular-star")})),M.appendChild(e)}{let e=document.createElement("button"),t=document.createElement("div"),n=document.createElement("h3"),i=document.createElement("ul"),o=!1;function s(){let e=[];if(i.innerHTML="",0!=Object.keys(Fe).length){for(let t in Fe)if(Fe[t].isActive){let n=document.createElement("li"),i=document.createElement("a"),s=document.createElement("span"),a=document.createElement("button"),r=document.createElement("div");s.innerText=Fe[t].name,i.appendChild(s),i.setAttribute("href",`/?point=${t}`),a.classList.add("sbgcui_button_reset","sbgcui_favs-li-delete","fa","fa-solid-circle-xmark"),a.addEventListener("click",(e=>{Fe[t].isActive=0,Fe.save(),n.removeAttribute("sbgcui_active",""),n.classList.add("sbgcui_hidden")})),r.classList.add("sbgcui_favs-li-data"),n.classList.add("sbgcui_favs-li"),n.setAttribute("sbgcui_active","");let c=Fe[t].isActive&&Fe[t].cooldown,l=Fe[t].discoveriesLeft;if(c){i.setAttribute("sbgcui_cooldown",Fe[t].timer),i.sbgcuiCooldown=Fe[t].cooldown;let e=setInterval((()=>{o&&Fe[t].isActive&&Fe[t].cooldown?i.setAttribute("sbgcui_cooldown",Fe[t].timer):clearInterval(e)}),1e3)}else l&&(i.setAttribute("sbgcui_discoveries",l),i.discoveriesLeft=l);n.append(a,i,r),e.push(n),me(t).then((e=>{e&&(s.innerText=`[${e.l}] ${i.innerText}`,i.style.color=e.te==Te.team?"var(--sbgcui-branding-color)":`var(--team-${e.te})`,r.innerHTML=`${Math.round(e.e)}% @ ${e.co}<br>${e.li.i}↓ ${e.li.o}↑`)}))}e.sort(((e,t)=>(e=e.childNodes[1].sbgcuiCooldown||e.childNodes[1].discoveriesLeft,t=t.childNodes[1].sbgcuiCooldown||t.childNodes[1].discoveriesLeft,null==e?1:null==t?-1:e-t))),i.append(...e)}}t.classList.add("sbgcui_favs","sbgcui_hidden"),n.classList.add("sbgcui_favs-header"),i.classList.add("sbgcui_favs-content"),n.innerText="Избранные точки",t.append(n,i),e.classList.add("fa","fa-solid-star","sbgcui_favs_star"),e.addEventListener("click",(()=>{s(),t.classList.toggle("sbgcui_hidden"),o=!o})),document.body.addEventListener("click",(e=>{!o||e.target.closest(".sbgcui_favs")||e.target.closest(".sbgcui_favs_star")||(t.classList.add("sbgcui_hidden"),o=!1)})),Oe.addItem(e,2),document.body.appendChild(t)}}P.addEventListener("click",(e=>{if(!e.target.classList.contains("inventory__ic-view"))return;let t=e.target.closest(".inventory__item").dataset.ref;t&&confirm('Открыть карточку точки? Нажмите "Отмена" для перехода к месту на карте.')&&(window.location.href=`/?point=${t}`)}));{let e=document.createElement("span"),t=document.createElement("span");e.classList.add("sbgcui_no_loot","fa","fa-solid-droplet-slash"),t.classList.add("sbgcui_no_refs","fa","fa-solid-link-slash"),I.append(e,t),I.addEventListener("click",(e=>{if(e.target==I)_=new p(1,1);else{let t=!e.target.classList.contains("sbgcui_no_loot"),n=!e.target.classList.contains("sbgcui_no_refs");_=new p(t,n)}}))}{function e(e){return e.every((e=>e.classList.contains("loaded")))}function t(e){let t=JSON.parse(localStorage.getItem("refs-cache"))||{};return e.every((e=>t[e.dataset.ref]?.t>Date.now()))}function n(e,t){let n;switch(t){case"name":return n=new RegExp(/\(x[0-9]{1,}\)\s(?:"|«)?([\s\S]+)/i),e.querySelector(".inventory__item-title").innerText.match(n)[1];case"level":return n=new RegExp(/level-([0-9]{1,2})/),+e.querySelector(".inventory__item-descr > span").style.color.match(n)?.[1]||0;case"team":return n=new RegExp(/team-([1-3])/),+e.querySelector(".inventory__item-title").style.color.match(n)?.[1]||0;case"energy":return+e.querySelector(".inventory__item-descr").childNodes[4].nodeValue.replace(",",".");case"distance":n=new RegExp(`([0-9]+?(?:${i}[0-9]+)?(?:\\${o}[0-9]+)?)\\s(cm|m|km|см|м|км)`,"i");let t=e.querySelector(".inventory__item-descr").lastChild.textContent,[s,a,r]=t.match(n);return a=a.replace(i,"").replace(o,"."),parseFloat(a)/(["cm","см"].includes(r)?1e5:["m","м"].includes(r)?1e3:1);case"amount":return n=new RegExp(/^\(x([0-9]{1,})\)\s/i),+e.querySelector(".inventory__item-title").innerText.match(n)[1]}}function s(e,t){let i=n(e,"name"),o=n(t,"name");return i.localeCompare(o)}function a(e,t){e.sort(((e,i)=>{let o=n(e,t),a=n(i,t);switch(t){case"name":return o.localeCompare(a);case"team":return o==a?s(e,i):o==Te.team?-1:a==Te.team?1:o-a;case"energy":let t=n(e,"team"),r=n(i,"team");return t==r?o==a?s(e,i):o-a:t==Te.team?-1:r==Te.team?1:o==a?s(e,i):o-a;default:return o-a}}))}function r(){if(a(u,g),P.replaceChildren(...u),h.removeAttribute("disabled"),P.classList.remove("sbgcui_refs_list-blur"),_){let e;performance.mark(v),e=we(`Загрузка и сортировка заняли ${+(performance.measure(y,b,v).duration/1e3).toFixed(1)} сек. <br><br>Уникальных рефов: ${P.childNodes.length}.`,"top left",-1),e.options.className="sbgcui_toast-selection",e.showToast(),l()}}function c(e){e.isTrusted&&(clearInterval(d),P.removeEventListener("refsListLoaded",r),h.value="none",h.removeAttribute("disabled"),P.classList.remove("sbgcui_refs_list-blur"))}function l(){_=!1,performance.clearMarks(b),performance.clearMarks(v),performance.clearMeasures(y),$.removeAttribute("sbgcui_measurement_mode")}let d,u,g,m=document.querySelector(".inventory__controls"),p=document.querySelector("#inventory-delete"),h=document.createElement("select"),f=document.createElement("button"),b="sbgcui_refs_sort_begin",v="sbgcui_refs_sort_end",y="sbgcui_refs_sort_measure",_=!1;f.classList.add("fa","fa-solid-sort","sbgcui_button_reset","sbgcui_refs-sort-button"),h.classList.add("sbgcui_refs-sort-select"),[["Сортировка","none"],["По названию","name"],["По уровню","level"],["По команде","team"],["По заряду","energy"],["По дистанции","distance"],["По количеству","amount"]].forEach((e=>{let t=document.createElement("option");t.innerText=e[0],t.value=e[1],h.appendChild(t)})),h.addEventListener("change",(n=>{let i=new Event("scroll");if(Object.defineProperty(i,"target",{value:{scrollTop:0,clientHeight:P.clientHeight}}),u=Array.from(P.children),g=n.target.value,"none"!=g)if(P.scrollTop=0,P.classList.remove("sbgcui_refs-reverse"),h.setAttribute("disabled",""),!g.match(/name|amount/)&&!e(u)||_){let n=.9*P.offsetHeight;if(P.classList.add("sbgcui_refs_list-blur"),_&&(e(u)&&document.querySelector('.inventory__tab[data-tab="3"]')?.click(),localStorage.removeItem("refs-cache"),performance.mark(b)),t(u))for(let e=0;e<=P.scrollHeight;e+=P.offsetHeight/2)i.target.scrollTop=e,P.dispatchEvent(i);else d=setInterval((()=>{i.target.scrollTop<=P.scrollHeight?(i.target.scrollTop+=n,P.dispatchEvent(i)):(clearInterval(d),i.target.scrollTop=P.scrollHeight,P.dispatchEvent(i))}),10);P.addEventListener("refsListLoaded",r,{once:!0})}else a(u,g),P.replaceChildren(...u),h.removeAttribute("disabled")})),document.querySelector(".inventory__tabs").addEventListener("click",c),$.addEventListener("click",c),q.addEventListener("inventoryPopupOpened",l),$.addEventListener("touchstart",(()=>{let e=Date.now(),t=setTimeout((()=>{let e;e=we("Режим измерения производительности. <br><br>\n\t\t\t\t\t\tВыберите тип сортировки для измерения скорости загрузки данных. <br><br>\n\t\t\t\t\t\tКэш рефов будет очищен. <br><br>\n\t\t\t\t\t\tДля отмены операции закройте инвентарь.","bottom center",-1),e.options.className="sbgcui_toast-selection",e.showToast(),_=!0,$.setAttribute("sbgcui_measurement_mode","")}),2e3);$.addEventListener("touchend",(()=>{Date.now()-e<1e3&&clearTimeout(t)}),{once:!0})})),f.addEventListener("click",(()=>{P.classList.toggle("sbgcui_refs-reverse"),P.scrollTop=-P.scrollHeight})),m.insertBefore(h,p),m.appendChild(f)}{class e extends ol.Feature{constructor(e){super(e),this.addEventListener("change",(()=>{if(!this.id_||!this.style_)return;let{inner:e,outer:t,outerTop:n,outerBottom:i,text:o}=v.pointHighlighting,s=this.style_;this.addStyle(s,"inner",1,this.isMarkerNeeded(e)),this.addStyle(s,"outer",2,this.isMarkerNeeded(t)),this.addStyle(s,"outerTop",3,this.isMarkerNeeded(n)),this.addStyle(s,"outerBottom",4,this.isMarkerNeeded(i)),this.addStyle(s,null,5,!1,this.textToRender(o))}))}isMarkerNeeded(e){switch(e){case"fav":return this.id_ in Fe;case"ref":return this.cachedRefsGuids.includes(this.id_);case"uniqc":return re.c.has(this.id_);case"uniqv":return re.v.has(this.id_);case"cores":return 6==ce[this.id_]?.cores;case"highlevel":return ce[this.id_]?.level>=8;default:return!1}}textToRender(e){switch(e){case"energy":let e=ce[this.id_]?.energy;return e>0?String(Math.round(10*e)/10):null;case"level":let t=ce[this.id_]?.level;return"number"==typeof t?String(t):null;case"lines":let n=ce[this.id_]?.lines.sum;return n>0?String(n):null;case"refsAmount":let i=this.cachedRefsAmounts[this.id_];return i>0?String(i):null;default:return null}}addStyle(e,t,n,i,o){1==i?(e[n]=e[0].clone(),e[n].renderer_=this[`${t}MarkerRenderer`]):(e[n]=new ol.style.Style({}),e[n].text_=o?new ol.style.Text({font:"14px Manrope",offsetY:e[1].renderer_?-20:0,text:o,fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#FFF",width:3})}):void 0)}innerMarkerRenderer(e,t){const n=t.context,[[i,o],[s,a]]=e,r=Math.sqrt((s-i)**2+(a-o)**2)/3;n.fillStyle=v.pointHighlighting.innerColor,n.beginPath(),n.arc(i,o,r,0,2*Math.PI),n.fill()}outerMarkerRenderer(e,t){const n=t.context,[[i,o],[s,a]]=e,r=1.3*Math.sqrt((s-i)**2+(a-o)**2);n.lineWidth=4,n.strokeStyle=v.pointHighlighting.outerColor,n.beginPath(),n.arc(i,o,r,0,2*Math.PI),n.stroke()}outerTopMarkerRenderer(e,t){const n=t.context,[[i,o],[s,a]]=e,r=1.3*Math.sqrt((s-i)**2+(a-o)**2);n.lineWidth=4,n.strokeStyle=v.pointHighlighting.outerTopColor,n.beginPath(),n.arc(i,o,r,Math.PI/180*195,Math.PI/180*345),n.stroke()}outerBottomMarkerRenderer(e,t){const n=t.context,[[i,o],[s,a]]=e,r=1.3*Math.sqrt((s-i)**2+(a-o)**2);n.lineWidth=4,n.strokeStyle=v.pointHighlighting.outerBottomColor,n.beginPath(),n.arc(i,o,r,Math.PI/180*15,Math.PI/180*165),n.stroke()}get cachedRefsGuids(){return JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>3==e.t)).map((e=>e.l))}get cachedRefsAmounts(){return Object.fromEntries(JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>3==e.t)).map((e=>[e.l,e.a])))}}ol.Feature=e}{function e(){let e=[...S.children].find((e=>e.classList.contains("is-active"))),t=(JSON.parse(localStorage.getItem("inventory-cache"))||[]).find((t=>t.g==e.dataset.guid)),i=t.l,o=2==t.t?window.Catalysers[i].range:4==t.t?45:0;m.getStyle()[3].getGeometry().setRadius(ke(o)),m.getStyle()[3].getStroke().setColor(`${v.mapFilters.brandingColor}70`),m.changed(),g.fit(m.getStyle()[3].getGeometry(),{duration:300,size:u.getSize(),padding:[0,0,n,0]})}function t(){m.getStyle()[3].getGeometry().setRadius(0),m.changed(),g.animate({zoom:17})}S.addEventListener("activeSlideChanged",e),L.addEventListener("attackSliderOpened",e),L.addEventListener("attackSliderClosed",t)}{function e(){g.setCenter([0,0]),setTimeout((()=>{g.setCenter(m.getGeometry().getCoordinates())}),1)}let t=document.createElement("button");t.classList.add("fa","fa-solid-rotate"),t.addEventListener("click",e),Oe.addItem(t,3),e()}{const e=new ol.Geolocation({projection:g.getProjection(),tracking:!0,trackingOptions:{enableHighAccuracy:!0}}),t=document.createElement("span");t.classList.add("sbgcui_speed"),document.querySelector(".self-info").appendChild(t),e.on("change:speed",(()=>{const n=e.getSpeed()||0;t.innerText=(3.6*n).toFixed(2)+" km/h"}))}{const e=document.createElement("button"),t="conic-gradient(\n\t\t\t#0000 var(--sbgcui-cluster-cooldown, 100%),\n\t\t\tvar(--sbgcui-cluster-team, #000) var(--sbgcui-cluster-cooldown, 100%) calc(var(--sbgcui-cluster-cooldown, 100%) + 1%),\n\t\t\t#0007 var(--sbgcui-cluster-cooldown, 100%) 100%\n\t\t\t)",n=document.createElement("div"),i=document.createElement("div"),o=u.getListeners("click")[0],s=200;let a,r,c=!1,l=[],d=[];function g(e){if(!c)return;const t=e.target.getAttribute("sbgcui_guid"),n=a.find((e=>e.getId()==t));n.set("sbgcui_chosenFeature",!0,!0),m(),setTimeout((()=>{r.pixel=u.getPixelFromCoordinate(n.getGeometry().getCoordinates()),o(r)}),s)}function m(){n.childNodes.forEach((e=>{e.classList.remove("sbgcui_cluster-iconWrapper-fullWidth")})),i.classList.remove("sbgcui_cluster-overlay-blur"),setTimeout((()=>{i.classList.add("sbgcui_hidden"),d.forEach((e=>{clearInterval(e)})),c=!1}),s)}function p(e){r=e,a=u.getFeaturesAtPixel(r.pixel,{hitTolerance:15,layerFilter:e=>"points"==e.get("name")});let t=a.slice();t.length<=1||r.isSilent?(t[0]?.set("sbgcui_chosenFeature",!0,!0),o(r)):(b(t),t.length>8&&(t=t.reduceRight(h,[])),v(t),f(),l=t)}function h(e,t,n){const i=8-e.length<=n,o=e.length<8,s=l.includes(t);return o?(s&&i||e.push(t),e):e}function f(){i.classList.remove("sbgcui_hidden"),setTimeout((()=>{i.classList.add("sbgcui_cluster-overlay-blur"),c=!0}),10),d=[]}function b(e){const t=e.map((e=>e.getGeometry().getCoordinates())),n=[t.reduce(((e,t)=>e+t[0]),0)/t.length,t.reduce(((e,t)=>e+t[1]),0)/t.length];e.sort((function(e,t){const i=e.getGeometry().getCoordinates(),o=t.getGeometry().getCoordinates();let s=Math.atan2(i[1]-n[1],i[0]-n[0]),a=Math.atan2(o[1]-n[1],o[0]-n[0]);return s<0&&(s+=2*Math.PI),a<0&&(a+=2*Math.PI),s=(2.5*Math.PI-s)%(2*Math.PI),a=(2.5*Math.PI-a)%(2*Math.PI),s-a}))}function v(e){const i=360/e.length;n.innerHTML="",e.forEach(((e,o)=>{const s=e.getId(),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),l=JSON.parse(localStorage.getItem("cooldowns"))?.[s]?.t;if(l){y(a,l);const e=setInterval((()=>{y(a,l,e)}),1e3);d.push(e),a.style.backgroundImage=t}me(s,!1).then((e=>{const t=`url("https://lh3.googleusercontent.com/${e.i}=s60")`;a.style.backgroundImage+=a.style.backgroundImage.length?", ":"",a.style.backgroundImage+=t,a.style.borderColor=`var(--team-${e.te||0})`,a.style.boxShadow=`0 0 20px 3px var(--team-${e.te||0}), 0 0 5px 2px black`,a.style.setProperty("--sbgcui-point-title",`"${e.t.replaceAll('"',"\\22 ")}"`),a.style.setProperty("--sbgcui-point-level",`"${e.l}"`),a.style.setProperty("--sbgcui-cluster-team",`var(--team-${e.te})`)})),c.classList.add("sbgcui_cluster-iconWrapper"),a.classList.add("sbgcui_cluster-icon"),r.classList.add("sbgcui_cluster-line"),c.style.transform=`rotate(${i*o}deg)`,a.style.transform=`rotate(${-i*o}deg)`,c.append(a,r),n.appendChild(c),setTimeout((()=>{c.classList.add("sbgcui_cluster-iconWrapper-fullWidth")}),10),a.setAttribute("sbgcui_guid",s),a.addEventListener("click",g)}))}function y(e,t,n){const i=(t-Date.now())/1e3,o=Math.trunc(100-i/90*100);i<=90&&i>=0?e.style.setProperty("--sbgcui-cluster-cooldown",`${o}%`):(clearInterval(n),e.style.removeProperty("--sbgcui-cluster-cooldown"))}e.classList.add("sbgcui_button_reset","sbgcui_cluster-close","fa","fa-solid-circle-xmark"),n.classList.add("sbgcui_cluster-center"),i.classList.add("sbgcui_cluster-overlay","sbgcui_hidden"),i.append(n,e),document.body.appendChild(i),e.addEventListener("click",m),u.un("click",o),u.on("click",p)}{const e=document.createElement("button");function t(){const t=`Использовать предыдущую сохранённую точку "${ne?.name}" в качестве центра звезды?`;let i;ie=!ie,localStorage.setItem("sbgcui_isStarMode",+ie),ie?(e.style.opacity=1,e.classList.add("fa-fade"),ne&&confirm(t)?(e.classList.remove("fa-fade"),i=`Включён режим рисования "Звезда". <br /><br />\n\t\t\t\t\t\t\t\t\t\tТочка "<span style="color: var(--selection)">${ne.name}</span>" будет считаться центром звезды. <br /><br />\n\t\t\t\t\t\t\t\t\t\tРефы от прочих точек будут скрыты в списке рисования.`):(j.addEventListener("pointPopupOpened",n,{once:!0}),i='Включён режим рисования "Звезда". <br /><br />\n\t\t\t\t\t\t\t\t\tСледующая открытая точка будет считаться центром звезды. <br /><br />\n\t\t\t\t\t\t\t\t\tРефы от прочих точек будут скрыты в списке рисования.')):(e.style.opacity=.5,e.classList.remove("fa-fade"),j.removeEventListener("pointPopupOpened",n),i='Режим рисования "Звезда" отключён.');const o=we(i,"top left",ie?6e3:void 0);o.options.className="sbgcui_toast-selection",o.showToast()}function n(){ne={guid:j.dataset.guid,name:R.innerText},localStorage.setItem("sbgcui_starModeTarget",JSON.stringify(ne)),e.classList.remove("fa-fade");const t=we(`Точка "<span style="color: var(--selection)">${R.innerText}</span>" выбрана центром для рисования звезды.`,"top left");t.options.className="sbgcui_toast-selection",t.showToast()}e.classList.add("fa","fa-solid-asterisk"),e.style.opacity=ie?1:.5,e.addEventListener("click",t),Oe.addItem(e,4)}{const e=document.createElement("i"),t=new Set;let n=[];function i(e){const t=m.getGeometry().getCoordinates(),n=e.getGeometry().getCoordinates();return Math.sqrt(Math.pow(n[0]-t[0],2)+Math.pow(n[1]-t[1],2))<ke(45)}function o(){const e=m.getGeometry().getCoordinates(),t=u.getPixelFromCoordinate(e),n=g.getResolution(),o=ke(45)/n;return u.getFeaturesAtPixel(t,{hitTolerance:o,layerFilter:e=>"points"==e.get("name")}).filter(i)}function s(){m.un("change",r)}function a(){r(),m.on("change",r)}function r(){o().length>1?e.classList.remove("sbgcui_hidden"):e.classList.add("sbgcui_hidden")}function c(){if(Object.isSealed(n)||0==n.length)return;if(!n.every(((e,t,n)=>e.x<=n[t-1]?.x||0==t)))return;const e=n.map((e=>e.x)),i=n.map((e=>e.y)),s=Math.min(...e),a=Math.max(...e),r=Math.min(...i);if(Math.max(...i)-r>70)return;if(a-s<50)return;const c=o();c.every((e=>t.has(e.getId())))&&t.clear(),c.every((e=>!t.has(e.getId())))&&t.clear();const l=c.find((e=>e.getId()!==oe.guid&&!t.has(e.getId())));if(null==l)return;t.add(l.getId());const d={type:"click"};d.pixel=u.getPixelFromCoordinate(l.getGeometry().getCoordinates()),d.originalEvent={},d.isSilent=!0,l.set("sbgcui_chosenFeature",!0,!0),j.classList.add("hidden"),u.dispatchEvent(d)}function l(e){if(Object.isSealed(n))return;const{clientX:t,clientY:i}=e.touches.item(0);n.push({x:t,y:i})}function d(e){n=[],(e.touches.length>1||null!==e.touches.item(0).target.closest(".deploy-slider-wrp"))&&Object.seal(n)}e.classList.add("sbgcui_swipe-cards-arrow","fa","fa-solid-angles-left"),document.querySelector(".i-stat").appendChild(e),j.addEventListener("pointPopupOpened",a),j.addEventListener("pointPopupClosed",s),j.addEventListener("touchstart",d),j.addEventListener("touchmove",l),j.addEventListener("touchend",c)}{const e=document.querySelector(".pr-buttons"),t=document.createElement("button");async function n(){const e=await ge(null,J.innerText),n=await ge(null,Te.name),o=i18next.getResourceBundle(i18next.resolvedLanguage).profile.stats,s=document.querySelectorAll(".pr-stat-title");t.toggleAttribute("sbgcui_self_stats"),t.classList.toggle("fa-solid-scale-unbalanced"),t.classList.toggle("fa-solid-scale-unbalanced-flip"),s.forEach((s=>{const a=s.innerText;let r=Object.entries(o).find((e=>e[1]==a))[0];if(r=r.replace("total-xp","xp").replace("playing-since","created_at"),t.hasAttribute("sbgcui_self_stats")){const t="created_at"==r?Date.parse(n[r])-Date.parse(e[r]):e[r]-n[r],o=t>0?"red":t<0?"green":"";s.nextSibling.innerText=i(r,n[r]),s.nextSibling.style.setProperty("--sbgcui-diff-color",o)}else s.nextSibling.innerText=i(r,e[r]),s.nextSibling.style.removeProperty("--sbgcui-diff-color")})),z.style.setProperty("--sbgcui-reg-date",Ce(t.hasAttribute("sbgcui_self_stats")?n.created_at:e.created_at))}function i(e,t){const n=i18next.resolvedLanguage,i=new Intl.NumberFormat(n);if(/^guard_/.test(e))return i18next.t("units.n-days",{count:t});switch(e){case"max_line":return t<1e3?i18next.t("units.m",{count:t}):i18next.t("units.km",{count:t/1e3});case"max_region":case"regions_area":return t<1?i18next.t("units.sqm",{count:1e6*t}):i18next.t("units.sqkm",{count:t});case"xp":return`${i.format(t)} ${i18next.t("units.pts-xp")}`;case"created_at":return new Date(t).toLocaleDateString(n,{day:"numeric",month:"long",year:"numeric"});default:return i.format(t)}}function o(){Te.name==J.innerText?t.classList.add("sbgcui_hidden"):t.classList.remove("sbgcui_hidden"),t.removeAttribute("sbgcui_self_stats")}function s(){const e=document.querySelectorAll(".pr-stat-val");t.removeAttribute("sbgcui_self_stats"),t.classList.replace("fa-solid-scale-unbalanced-flip","fa-solid-scale-unbalanced"),e.forEach((e=>{e.style.removeProperty("--sbgcui-diff-color")}))}t.classList.add("fa","fa-solid-scale-unbalanced","sbgcui_profile-compare"),t.addEventListener("click",n),H.addEventListener("profilePopupOpened",o),H.addEventListener("profilePopupClosed",s),e.appendChild(t)}{function e(){const e=[...C.childNodes].reverse();C.replaceChildren(...e),window.draw_slider.refresh(),n.classList.toggle("fa-solid-arrow-down-short-wide"),n.classList.toggle("fa-solid-arrow-down-wide-short")}function t(){n.classList.replace("fa-solid-arrow-down-wide-short","fa-solid-arrow-down-short-wide")}const n=document.createElement("button"),i=document.querySelector(".draw-slider-buttons"),o=document.querySelector("#draw-slider-close");n.classList.add("fa","fa-solid-arrow-down-short-wide","fa-rotate-270","sbgcui_drawslider_sort"),n.addEventListener("click",e),x.addEventListener("drawSliderOpened",t),i.insertBefore(n,o)}{function e(){i.innerText=`${o}: ${s.format(oe.destroyReward)} ${i18next.t("units.pts-xp")}`}const t=document.querySelector(".info.popup .i-buttons"),n=document.querySelector(".info.popup .i-stat"),i=document.createElement("div"),o="ru-RU"==i18next.language?"Награда":"Reward",s=new Intl.NumberFormat(i18next.language);i.classList.add("i-stat__entry"),n.insertBefore(i,t),j.addEventListener("pointPopupOpened",e)}{const e=new ol.source.Vector,t=new ol.layer.Vector({source:e,name:"sbgcui_points",minZoom:15,className:"ol-layer__sbgcui_points",zIndex:9});try{const t=await fe("zero-point-info"),n=new ol.Feature({geometry:new ol.geom.Point([0,0])});t.addEventListener("click",(()=>{t.classList.add("sbgcui_hidden"),setTimeout((()=>{t.style.zIndex=0}),100)})),document.body.appendChild(t),n.setId("sbgcui_zeroPoint"),n.setStyle(new ol.style.Style({geometry:new ol.geom.Circle([0,0],30),fill:new ol.style.Fill({color:"#BB7100"}),stroke:new ol.style.Stroke({color:window.TeamColors[3].stroke,width:5}),text:new ol.style.Text({font:"30px Manrope",text:"?",fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#FFF",width:3})})})),u.on("click",(e=>{u.getFeaturesAtPixel(e.pixel,{layerFilter:e=>"sbgcui_points"==e.get("name")}).includes(n)&&(t.classList.remove("sbgcui_hidden"),setTimeout((()=>{t.style.zIndex=9}),100))})),e.addFeature(n)}catch(e){}u.addLayer(t)}{function e(){const e=we("Нажмите на регион чтобы узнать, сколько их в этом месте.");e.options.className="sbgcui_toast-selection",e.showToast(),u.un("click",t),u.once("click",t)}function t(e){const t=u.getFeaturesAtPixel(e.pixel,{layerFilter:e=>"regions"==e.get("name")}),n=t.map((e=>ol.sphere.getArea(e.getGeometry()))),i=Math.min(...n),o=Math.max(...n),s=i<1e6?i18next.t("units.sqm",{count:i}):i18next.t("units.sqkm",{count:i/1e6}),a=o<1e6?i18next.t("units.sqm",{count:o}):i18next.t("units.sqkm",{count:o/1e6});let r=`Количество регионов в точке: ${t.length}.`;1==t.length&&(r+=`\n\nПлощадь региона: ${a}.`),t.length>1&&(r+=`\n\nПлощадь самого большого региона: ${a}.\nПлощадь самого маленького региона: ${s}.`),alert(r)}const n=document.createElement("button");n.classList.add("fa","fa-brands-stack-overflow"),n.addEventListener("click",e),Oe.addItem(n,5)}{function e(){v.ui.pointDischargeTimeout&&(t.innerText=`~${oe.dischargeTimeout}`)}const t=document.createElement("span");t.classList.add("sbgcui_discharge_timeout"),F.after(t),j.addEventListener("pointPopupOpened",e),j.addEventListener("pointRepaired",e)}{let e=["true",null].includes(localStorage.getItem("sbgcui_isRotationLocked")),t=null,n=[];const i=document.createElement("button"),o=document.getElementById("map");function s(e,t){const n=u.getPixelFromCoordinate(g.getCenter()),i=Math.atan2(e[1]-n[1],e[0]-n[0]),o=Math.atan2(t[1]-n[1],t[0]-n[0]),s=u.getCoordinateFromPixel(n);g.adjustRotation(o-i,s)}function a(){g.set("animationInProgress",!0),g.animate({rotation:0},(e=>{e?g.set("animationInProgress",!1):a()}))}function r(t){t&&(e=!e),e&&a(),qe.setActive(!e),i.setAttribute("sbgcui_locked",e),localStorage.setItem("sbgcui_isRotationLocked",e)}function c(i){const o="true"==Z.dataset.active;e||o&&"CANVAS"==i.target.nodeName&&(i.targetTouches.length>1||(t=[i.targetTouches[0].clientX,i.targetTouches[0].clientY],n=[]))}function l(e){if(e.preventDefault(),null==t)return;const i=[e.targetTouches[0].clientX,e.targetTouches[0].clientY];s(t,i),t=i,n.push(i)}function d(){0!=n.length&&window.requestEntities(),t=null}function p(){"true"==localStorage.getItem("follow")&&1!=g.get("animationInProgress")&&g.setCenter(m.getGeometry().getCoordinates()),i.style.setProperty("--sbgcui_angle",180*g.getRotation()/Math.PI+"deg")}r(),i.classList.add("fa","fa-solid-compass","sbgcui_lock_rotation"),i.addEventListener("click",r),Z.before(i),o.addEventListener("touchstart",c),o.addEventListener("touchmove",l),o.addEventListener("touchend",d),g.on("change:rotation",p)}try{if(window.navigator.userAgent.toLowerCase().includes("wv"))throw new Error;function e(e,t){const[n,i]=ol.proj.toLonLat(m.getGeometry().getCoordinates()),[o,s]=oe.coords;let a;switch(e){case"yamaps":a=`yandexmaps://maps.yandex.ru/?rtext=${i},${n}~${s},${o}&rtt=${t}`;break;case"yanavi":a=`yandexnavi://build_route_on_map?lat_from=${i}&lon_from=${n}&lat_to=${s}&lon_to=${o}`;break;case"dgis":a=`dgis://2gis.ru/routeSearch/rsType/${t}/from/${n},${i}/to/${o},${s}`;break;case"gmaps":a=`comgooglemaps://?saddr=${i},${n}&daddr=${s},${o}&directionsmode=${t}`;break}return a}function t(e){const t=e.currentTarget.dataset.app,n=e.target.dataset.routetype;if("LI"==e.target.nodeName){if(e.target.hasAttribute("data-selected"))return delete e.target.dataset.selected,delete l.dataset.app,void delete l.dataset.routetype;o.querySelectorAll("li[data-selected]").forEach((e=>{delete e.dataset.selected})),e.target.dataset.selected="",l.dataset.app=t,l.dataset.routetype=n}}function n(){o.classList.add("sbgcui_hidden")}function i(){o.classList.toggle("sbgcui_hidden")}const o=await fe("navigate"),s=o.querySelector(".sbgcui_navigate-coords"),a=o.querySelector("form"),r=o.querySelectorAll("menu"),[c,l]=o.querySelectorAll(".sbgcui_navigate-form-buttons > button"),d=document.createElement("button");d.classList.add("fa","fa-solid-route","sbgcui_button_reset","sbgcui_navbutton"),d.addEventListener("click",i),j.appendChild(d),j.addEventListener("pointPopupOpened",(()=>{s.innerText=oe.coords.slice().reverse().join(", ")})),s.addEventListener("click",(()=>{window.navigator.clipboard.writeText(s.innerText).then((()=>{we("Координаты скопированы в буфер обмена.").showToast()}))})),a.addEventListener("submit",(e=>{e.preventDefault()})),r.forEach((e=>{e.addEventListener("click",t)})),c.addEventListener("click",n),l.addEventListener("click",(()=>{const t=e(l.dataset.app,l.dataset.routetype);null!=t&&(window.location.href=t,n())})),V.addEventListener("click",n),document.body.appendChild(o)}catch(e){}{const e=m.getStyle()[0].getImage();DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission&&(document.body.addEventListener("click",(()=>{DeviceOrientationEvent.requestPermission()}),{once:!0}),window.addEventListener("deviceorientation",(t=>{e.setRotation(t.webkitCompassHeading*Math.PI/180+g.getRotation()),m.changed()})))}window.view=g,window.map=u,window.pf=m,window.cuiStatus="loaded"}window.location.pathname.startsWith("/login")||document.querySelector('script[src="/intel.js"]')||(window.stop(),window.cuiStatus="loading",fetch("/app").then((e=>e.text())).then((e=>{e=(e=e.replace(/<script class="mobile-check">.+?<\/script>/,"")).replace(/(<script src="https:\/\/cdn.jsdelivr.net\/npm\/ol@.+?)(>)/,"$1 onload=\"window.dispatchEvent(new Event('olReady'))\"$2"),document.open(),window.addEventListener("olReady",(()=>{!function(){class e extends ol.Map{constructor(e){super(e),u=this,window.dispatchEvent(new Event("mapReady"))}forEachFeatureAtPixel(e,t,n={}){const i=t.toString().includes("piv.push");if(n.hitTolerance=isFinite(n.hitTolerance)?n.hitTolerance:15,i){const i=(e,n)=>{e.get("sbgcui_chosenFeature")&&(t(e,n),e.unset("sbgcui_chosenFeature",!0))};super.forEachFeatureAtPixel(e,i,n)}else super.forEachFeatureAtPixel(e,t,n)}}class t extends ol.Feature{constructor(e){super(e)}setStyle(e){if(e&&null==m&&3==e.length&&e[0].image_?.iconImage_.src_.match(/\/assets\/player/)){let t=e[1].getGeometry().setCenter;e[1].getGeometry().setCenter=n=>{t.call(e[1].getGeometry(),n),e[3].getGeometry().setCenter(n)},e[3]=new ol.style.Style({geometry:new ol.geom.Circle(ol.proj.fromLonLat([0,0]),0),stroke:new ol.style.Stroke({color:"#CCCCCC33",width:4})}),m=this}super.setStyle(e)}}class i extends ol.View{constructor(e){e.padding=[n,0,0,0],super(e),g=this}}ol.Map=e,ol.Feature=t,ol.View=i}(),fetch("/app/script.js").then((e=>e.text())).then((e=>{let t=document.createElement("script");DeviceOrientationEvent&&(e=e.replace("function initCompass() {","function initCompass() {return;")),e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace("if (zoom % 1 != 0)","//if (zoom % 1 != 0)")).replace("const Catalysers = [","window.Catalysers = [")).replace("const TeamColors = [","window.TeamColors = [")).replace("const persist = [","const persist = [/^sbgcui_/, ")).replace("const draw_slider =","window.draw_slider =")).replace("class Bitfield","window.requestEntities = requestEntities; window.Bitfield = class Bitfield")).replace("if (type == 'osm') {","if (type == 'stadia') { source=new ol.source.StadiaMaps({ layer:'stamen_watercolor' })} else if (type == 'osm') {")).replace("$('[name=\"baselayer\"]').on('change', e","$('.layers-config__list').on('change', '[name=\"baselayer\"]', e")).replaceAll(/makeEntry\(e,\sdata\)(?!\s{)/g,"window.makeEntryDec(e, data, makeEntry)")).replaceAll("view.calculateExtent(map.getSize()",`view.calculateExtent([map.getSize()[0], map.getSize()[1] + ${n}]`),t.textContent=e,document.head.appendChild(t)})).catch((e=>{alert(`Произошла ошибка при загрузке основного скрипта. ${e.message}`)}))})),window.addEventListener("mapReady",p),document.write(e),document.close()})))}();