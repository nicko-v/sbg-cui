// ==UserScript==
// @name         SBG CUI [U]
// @namespace    https://3d.sytes.net/
// @version      0.0.8
// @downloadURL  https://nicko-v.github.io/sbg-cui/unstable/index.min.js
// @updateURL    https://nicko-v.github.io/sbg-cui/unstable/index.min.js
// @description  SBG Custom UI [Unstable]
// @author       NV
// @match        https://3d.sytes.net/*
// @run-at       document-start
// @grant        none
// ==/UserScript==
const USERSCRIPT_VERSION="0.0.8",LATEST_KNOWN_VERSION="0.3.0",HOME_DIR="https://nicko-v.github.io/sbg-cui/unstable",INVENTORY_LIMIT=3e3,MIN_FREE_SPACE=100,DISCOVERY_COOLDOWN=90,HIT_TOLERANCE=15,MAX_DISPLAYED_CLUSTER=8,INVIEW_POINTS_DATA_TTL=7e3,INVIEW_POINTS_LIMIT=100,HIGHLEVEL_MARKER=8,IS_DARK=matchMedia("(prefers-color-scheme: dark)").matches,CORES_ENERGY={0:0,1:500,2:750,3:1e3,4:1500,5:2e3,6:2500,7:3500,8:4e3,9:5250,10:6500},CORES_LIMITS={0:0,1:6,2:6,3:6,4:3,5:3,6:2,7:2,8:1,9:1,10:1},LEVEL_TARGETS=[1500,5e3,12500,25e3,6e4,125e3,35e4,675e3,1e6,1/0],ITEMS_TYPES={1:{eng:"cores",rus:"ядра"},2:{eng:"catalysers",rus:"катализаторы"},3:{eng:"refs",rus:"рефы"}},DEFAULT_CONFIG={maxAmountInBag:{cores:{I:-1,II:-1,III:-1,IV:-1,V:-1,VI:-1,VII:-1,VIII:-1,IX:-1,X:-1},catalysers:{I:-1,II:-1,III:-1,IV:-1,V:-1,VI:-1,VII:-1,VIII:-1,IX:-1,X:-1},refs:{allied:-1,hostile:-1}},autoSelect:{deploy:"max",upgrade:"min",attack:"latest"},mapFilters:{invert:IS_DARK?1:0,hueRotate:IS_DARK?180:0,brightness:IS_DARK?.75:1,grayscale:IS_DARK?1:0,sepia:1,blur:0,branding:"default",brandingColor:"#CCCCCC"},tinting:{map:1,point:"level",profile:1},vibration:{buttons:1,notifications:1},ui:{doubleClickZoom:0,pointBgImage:1,pointBtnsRtl:0,pointBgImageBlur:1,pointDischargeTimeout:1},pointHighlighting:{inner:"uniqc",outer:"off",outerTop:"cores",outerBottom:"highlevel",text:"refsAmount",innerColor:"#E87100",outerColor:"#E87100",outerTopColor:"#EB4DBF",outerBottomColor:"#28C4F4"}};let map,playerFeature,originalAppend=Element.prototype.append;async function main(){"use strict";if(document.querySelector('script[src="/intel.js"]'))return;const e=Intl.NumberFormat(i18next.language).formatToParts(1111)[1].value,t=Intl.NumberFormat(i18next.language).formatToParts(1.1)[1].value;class n{constructor(e,t){this.loot=e,this.refs=t}get isActive(){return!(this.loot&&this.refs)}}class i{constructor(e){this.guid=e.g,this.level=e.l,this.team=e.te,this.lines={in:e.li.i,out:e.li.o},this.cores={},this.image=`https://lh3.googleusercontent.com/${e.i}`,this.update(e.co)}get emptySlots(){return 6-Object.keys(this.cores)}get isEmptySlots(){return this.emptySlots>0}get playerCores(){let e={};for(let t in this.cores){let n=this.cores[t];n.owner==oe.name&&(n.level in e?e[n.level]+=1:e[n.level]=1)}return e}get energy(){if(0==Object.keys(this.cores).length)return 0;let e=0,t=0;for(let n in this.cores)e+=CORES_ENERGY[this.cores[n].level],t+=this.cores[n].energy;return t/e*100}get mostChargedCatalyserEnergy(){let e=Math.max(...Object.values(this.cores).map((e=>e.energy/CORES_ENERGY[e.level]*100)));return isFinite(e)?e:null}get dischargeTimeout(){let e=this.mostChargedCatalyserEnergy;if(null==e)return"";let t=e/.6*60*60*1e3,n=["d","hr"],i="";return[864e5,36e5].forEach(((e,s)=>{let o=Math.trunc(t/e);o&&(i+=`${i.length?", ":"~"}${o}${n[s]}`,t-=o*e)})),i}update(e){e.forEach((e=>{this.cores[e.g]={energy:e.e,level:e.l,owner:e.o}}))}selectCore(e,t){let n,i=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>1==e.t&&!H.has(e.g))).sort(((e,t)=>e.l-t.l)),s=this.playerCores;switch(e){case"min":n=t?i.find((e=>e.l>t&&(s[e.l]||0)<CORES_LIMITS[e.l]&&e.l<=oe.level)):i.find((e=>(s[e.l]||0)<CORES_LIMITS[e.l]&&e.l<=oe.level));break;case"max":n=i.findLast((e=>e.l<=oe.level&&(s[e.l]||0)<CORES_LIMITS[e.l]));break}Z(p.querySelector(`[data-guid="${n?.g}"]:not(.is-active)`))}}class s extends ol.control.Control{#e=document.createElement("button");#t=!1;#n=document.createElement("div");constructor(){let e=document.createElement("div");e.classList.add("ol-unselectable","ol-control","sbgcui_toolbar-control"),super({element:e}),this.#e.classList.add("fa-solid","fa-angle-up"),this.#e.addEventListener("click",this.handleExpand.bind(this)),this.#n.classList.add("sbgcui_toolbar"),this.collapse(),e.append(this.#n,this.#e)}addItem(e,t){e.style.order=t,this.#n.appendChild(e)}collapse(){this.#e.classList.remove("fa-rotate-180"),this.#e.style.opacity=1,this.#n.classList.add("sbgcui_hidden"),this.#t=!1}expand(){this.#e.classList.add("fa-rotate-180"),this.#e.style.opacity=.5,this.#n.classList.remove("sbgcui_hidden"),this.#t=!0}handleExpand(){this.#t?this.collapse():this.expand()}}class o{#i;constructor(e,t,n){this.guid=e,this.name=n||e,this.cooldown=t,this.discoveriesLeft=void 0,this.timeoutID=void 0,this.isActive=1,n||this.#s()}#s(){W(this.guid).then((e=>{this.name=e.t})).catch((e=>{}))}#o(){if(!this.isActive)return;let e=`"${this.name}": точка остыла.`;if(!z()&&"Notification"in window&&"granted"==Notification.permission){new Notification(e,{icon:"/icons/icon_512.png"})}else{let t=Q(e,"top left",-1);t.options.className="sbgcui_toast-selection",t.showToast(),"vibrate"in window.navigator&&r.vibration.notifications&&(window.navigator.vibrate(0),window.navigator.vibrate([500,300,500,300,500]))}}#r(e){let t=e-Date.now();clearTimeout(this.timeoutID),this.timeoutID=setTimeout(function(){this.#o(),this.cooldown=null}.bind(this),t)}toJSON(){return this.cooldown>Date.now()?this.cooldown:null}get hasActiveCooldown(){return this.cooldown-Date.now()>0}get cooldown(){return this.#i}get timer(){if(!this.cooldown)return"";let e=new Date(this.cooldown-Date.now());if(e<0)return"";return new Intl.DateTimeFormat("ru-RU",{hour:"numeric",minute:"numeric",second:"numeric",timeZone:"UTC"}).format(e)}set cooldown(e){this.#i=e>Date.now()?e:null,this.#i&&(this.discoveriesLeft=void 0,this.#r(this.#i))}}let r;if(localStorage.getItem("sbgcui_config"))r=JSON.parse(localStorage.getItem("sbgcui_config"),((e,t)=>isNaN(+t)?t:+t)),r={...DEFAULT_CONFIG,...r},function e(t,n){for(let i in n)typeof n[i]!=typeof t[i]?t[i]=n[i]:"object"==typeof n[i]&&e(t[i],n[i])}(r,DEFAULT_CONFIG),localStorage.setItem("sbgcui_config",JSON.stringify(r));else{r=DEFAULT_CONFIG,localStorage.setItem("sbgcui_config",JSON.stringify(r));let e=Q("Сохранённые настройки не найдены. <br>Загружена стандартная конфигурация.");e.options.className="error-toast",e.showToast()}let a=window.fetch;window.fetch=async function(e,t){return new Promise(((n,s)=>{if(e.match(/\/api\/inview(?!.+?&unique=)/)){let t=Object.values(r.pointHighlighting).find((e=>e.match(/uniqc|uniqv/)));t&&(e+="&unique="+("uniqc"==t?"c":"v"))}a(e,t).then((async s=>{let o=s.clone(),a=e.match(/\/api\/(point|deploy|attack2|discover|inview)(?:.*?&(status=1))?(?:.*?&unique=(c|v))?/);null!=a?o.json().then((async e=>{switch(a[1]){case"point":"data"in e&&!a[2]&&(D=new i(e.data));break;case"deploy":"data"in e?(D.update(e.data.co,e.data.l),D.selectCore(r.autoSelect.deploy)):"c"in e&&(D.update([e.c],e.l),D.selectCore(r.autoSelect.upgrade,e.c.l));break;case"attack2":V=JSON.parse(t.body).guid,localStorage.setItem("sbgcui_lastUsedCatalyser",V);break;case"discover":if("loot"in e&&l.isActive){let t=e.loot.filter((e=>l.refs?3!=e.t:3==e.t)).map((e=>({guid:e.g,type:e.t,amount:e.a})));if(0==t.length)return;try{(await Y(t)).forEach((e=>{if("error"in e)throw e.error})),e.loot=e.loot.filter((e=>l.refs?3==e.t:3!=e.t));let i=JSON.stringify(e),o={status:s.status,statusText:s.statusText,headers:s.headers},r=new Response(i,o);Object.defineProperty(r,"url",{value:s.url,enumerable:!0}),n(r)}catch(e){let t=Q("Ошибка при фильтрации лута.");t.options.className="error-toast",t.showToast()}}if("burnout"in e||"cooldown"in e){let n,i,s=Date.now();if(e.burnout<=20)n=e.burnout;else if(e.cooldown<=90||e.burnout<s)break;try{i=JSON.parse(t.body).guid}catch{i=new URLSearchParams(t.body).get("guid")}if(i in ge){if(n){ge[i].discoveriesLeft=n;break}if(ge[i].hasActiveCooldown)break;let t=e.burnout||s+1e3*e.cooldown;ge[i].cooldown=t,ge.save()}}break;case"inview":let o=null!=a[3],c=null!=Object.values(r.pointHighlighting).find((e=>e.match(/cores|highlevel|level/))),d=e.data?.points;if(!d)break;if(c){let e=d.filter((e=>(!e.t&&delete j[e.g],0!=e.t)));if(e.length<=100){(e.map((e=>e.g))||[]).forEach((e=>{Date.now()-j[e]?.timestamp<7e3||W(e).then((t=>{j[e]={cores:t.co,lines:{in:t.li.i,out:t.li.o,get sum(){return this.in+this.out}},energy:t.e,level:t.l,timestamp:Date.now()}})).catch((()=>{j[e]={timestamp:Date.now()}}))}))}}o&&d?.forEach((e=>{e.u?G[a[3]].delete(e.g):G[a[3]].add(e.g)}));break}})).catch((e=>{})).finally((()=>{n(s)})):n(s)})).catch((e=>{s(e)}))}))};let l,c=document.documentElement,d=document.querySelector("#attack-menu"),u=document.querySelector(".attack-slider-wrp"),g=document.querySelector("#catalysers-list"),p=document.querySelector("#cores-list"),m=document.querySelector("#discover"),h=document.querySelector("#ops"),b=document.querySelector("#inventory__close"),f=document.querySelector(".inventory__content"),v=document.querySelector(".inventory.popup"),y=document.querySelector("#self-info__inv"),_=document.querySelector(".i-stat__cores"),E=document.querySelector("#i-image"),w=document.querySelector(".i-image-box"),S=document.querySelector("#i-stat__energy"),L=document.querySelector("#i-level"),I=document.querySelector("#i-stat__owner"),C=document.querySelector("#i-title"),x=document.querySelector(".info.popup"),T=document.querySelector(".info.popup > .popup-close"),k=document.querySelector("#pr-name"),O=document.querySelector(".profile.popup"),N=document.querySelector(".profile.popup > .popup-close"),$=document.querySelector("#self-info__exp"),A=document.querySelector("#self-info__explv"),q=document.querySelector("#self-info__name"),P=document.querySelector("#toggle-follow"),M=document.querySelector(".xp-diff"),R=!v.classList.contains("hidden"),F=!x.classList.contains("hidden"),B=!O.classList.contains("hidden"),D={},V=localStorage.getItem("sbgcui_lastUsedCatalyser"),H=new Set(JSON.parse(localStorage.getItem("sbgcui_excludedCores"))),G={c:new Set,v:new Set},j={},J={I:1,II:2,III:3,IV:4,V:5,VI:6,VII:7,VIII:8,IX:9,X:10,toDecimal(e){return this[e]},toRoman(e){return Object.keys(this).find((t=>this[t]==e))}};async function U(e){return fetch(`/api/profile?guid=${e}`,{headers:{authorization:`Bearer ${localStorage.getItem("auth")}`},method:"GET"}).then((e=>e.json())).then((e=>e.data)).catch((e=>{}))}async function W(e,t=!0){return fetch(`/api/point?guid=${e}${t?"&status=1":""}`,{headers:{authorization:`Bearer ${oe.auth}`},method:"GET"}).then((e=>e.json())).then((e=>e.data))}async function X(e,t=!1){let n=r.maxAmountInBag;(async function(){return fetch("/api/inventory",{headers:{authorization:`Bearer ${oe.auth}`},method:"GET"}).then((e=>e.json())).then((e=>e.i))})().then((e=>{let i=e.reduce(((e,t)=>e+t.a),0);if(!t&&3e3-i>=100)throw{silent:!0};if(-1==n.refs.allied&&-1==n.refs.hostile)return[e,[]];if(0==n.refs.allied&&0==n.refs.hostile)return[e,[]];let s=e.map((e=>3==e.t?W(e.l):void 0)).filter((e=>e));return Promise.all([e,...s])})).then((([e,...t])=>{let i={};t.forEach((e=>{i[e.g]={team:e.te}}));let s=e.map((({t:e,l:t,a:s,g:o})=>{if(!e in ITEMS_TYPES)return;let r=-1,a=0,l=ITEMS_TYPES[e].eng;if("refs"==l){if(-1==n.refs.allied&&-1==n.refs.hostile)r=-1;else if(0==n.refs.allied&&0==n.refs.hostile)r=0;else if(Object.keys(i).length){let e=i[t].team==oe.team?"allied":"hostile";r=n[l][e]}}else r=n[l][J.toRoman(t)];return-1!=r&&s>r&&(a=s-r),{guid:o,type:e,amount:a}})).filter((e=>e?.amount>0));return Promise.all([s,Y(s)])})).then((([e,t])=>{if(!e.length)return;let n=t.reduce(((e,t)=>t.count.total<e?t.count.total:e),1/0);isFinite(n)&&(y.innerText=n),h.style.color.match("accent")&&(h.style.color=""),function(e){let t=JSON.parse(localStorage.getItem("inventory-cache"))||[];e.forEach((e=>{let n=t.find((t=>t.g==e.guid));n&&(n.a-=e.amount)})),t=t.filter((e=>e.a>0)),localStorage.setItem("inventory-cache",JSON.stringify(t))}(e),e=e.reduce(((e,t)=>(e.hasOwnProperty(t.type)||(e[t.type]=0),e[t.type]+=t.amount,e)),{});let i="";for(let t in e)i+=`<br><span style="background: var(--sbgcui-branding-color); margin-right: 5px;" class="item-icon type-${t}"></span>x${e[t]} ${ITEMS_TYPES[t].eng}`;Q(`Удалено: ${i}`).showToast()})).catch((e=>{if(e.silent)return;let t=Q(`Ошибка при проверке или очистке инвентаря. <br>${e.message}`);t.options.className="error-toast",t.showToast()}))}async function Y(e){let t=e.reduce(((e,t)=>(e.hasOwnProperty(t.type)||(e[t.type]={}),e[t.type][t.guid]=t.amount,e)),{});return Promise.all(Object.keys(t).map((async e=>fetch("/api/inventory",{headers:{authorization:`Bearer ${oe.auth}`,"content-type":"application/json"},body:JSON.stringify({selection:t[e],tab:e}),method:"DELETE"}).then((e=>e.json())))))}function z(){return"maxTouchPoints"in window.navigator?window.navigator.maxTouchPoints>0:"msMaxTouchPoints"in window.navigator?window.navigator.msMaxTouchPoints>0:"orientation"in window||/\b(BlackBerry|webOS|iPhone|IEMobile|Android|Windows Phone|iPad|iPod)\b/i.test(window.navigator.userAgent)}function K(){let{mapFilters:e,ui:t}=r;for(let t in e){let n="blur"==t?"px":"hueRotate"==t?"deg":"";c.style.setProperty(`--sbgcui-${t}`,`${e[t]}${n}`)}c.style.setProperty("--sbgcui-point-btns-rtl",t.pointBtnsRtl?"rtl":"ltr"),c.style.setProperty("--sbgcui-point-image-blur",t.pointBgImageBlur?"2px":"0px"),c.style.setProperty("--sbgcui-branding-color","custom"==e.branding?e.brandingColor:oe.teamColor),window.TeamColors[oe.team].fill=`${"custom"==e.branding?e.brandingColor:ie(oe.teamColor)}80`,window.TeamColors[oe.team].stroke="custom"==e.branding?ne(e.brandingColor):oe.teamColor,ae?.setActive(Boolean(t.doubleClickZoom)),!+r.tinting.map||F||B||ee("map"),document.querySelector(".sbgcui_settings").classList.add("sbgcui_hidden"),document.querySelectorAll(".sbgcui_settings > details").forEach((e=>{e.open=!1})),document.querySelectorAll('.sbgcui_settings input:not([type="hidden"]), .sbgcui_settings select').forEach((e=>{let t=e.name.split("_").reduce(((e,t)=>e[t]),r);switch(e.type){case"number":case"range":e.value=+t;break;case"color":e.value=t;break;case"checkbox":e.checked=+t;break;case"radio":e.checked=e.value==t;break;case"select-one":e.value=t;break}}))}function Z(e){let t=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0}),n=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0}),i=new MouseEvent("click",{bubbles:!0,cancelable:!0});e?.dispatchEvent(t),e?.dispatchEvent(n),e?.dispatchEvent(i)}function Q(e="",t="top left",n=4e3,i=null){let s=t.split(/\s+/),o=Toastify({text:e,duration:n,gravity:s[0],position:s[1],escapeMarkup:!1,className:"interaction-toast",selector:i});return o.options.id=Math.round(1e5*Math.random()),o.options.onClick=()=>o.hideToast(),o}function ee(e){let t,n=/ya-title=.*?,\sya-dock=.*?(?=,|$)/;switch(e){case"map":t=getComputedStyle(q).color;break;case"profile":t=getComputedStyle(k).color,O.style.borderColor=t;break;case"point_level":t=getComputedStyle(L).color,x.style.borderColor=t,C.style.color=t;break;case"point_team":t=getComputedStyle(I).color,x.style.borderColor=t,C.style.color=t;break;default:t="";break}var i;t=(i=t)?`#${i.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map((e=>parseInt(e,10).toString(16).padStart(2,"0"))).join("")}`:"",ce.content=t,de.content.match(n)?de.content=de.content.replace(n,`ya-title=${t}, ya-dock=${t}`):de.content+=`, ya-title=${t}, ya-dock=${t}`}function te(e){let t=document.createElement("span");t.classList.add("sbgcui_xpdiff"),t.innerText=`+${e}xp`,ue.appendChild(t),setTimeout((e=>{t.classList.add("sbgcui_xpdiff-out")}),100),setTimeout((e=>{ue.removeChild(t)}),3e3)}function ne(e,t=!0){return t?`#${[...e].filter(((e,t)=>t%2)).join("")}`:`#${[...e].map(((e,t,n)=>t%2?e:n[t-1])).join("")}`}function ie(e){return[...e].map((e=>"#"==e?e:e+e)).join("")}var se=await async function(){return fetch("/api/self",{headers:{authorization:`Bearer ${localStorage.getItem("auth")}`},method:"GET"}).then((e=>e.json().then((t=>({version:e.headers.get("SBG-Version"),name:t.n,team:t.t,exp:t.x,lvl:t.l,guid:t.g}))))).catch((e=>{}))}();if("0.3.0"!=se.version){let e=+localStorage.getItem("sbgcui_version_warns");if(e<2){let t=Q(`Текущая версия игры (${se.version}) не соответствует последней известной версии (0.3.0). Возможна некорректная работа.`);t.options.className="error-toast",t.showToast(),localStorage.setItem("sbgcui_version_warns",e+1)}}else localStorage.setItem("sbgcui_version_warns",0);var oe={name:se.name,team:se.team,exp:{total:se.exp,current:se.exp-LEVEL_TARGETS.slice(0,se.lvl-1).reduce(((e,t)=>t+e),0),goal:LEVEL_TARGETS[se.lvl-1],get percentage(){return this.goal==1/0?100:this.current/this.goal*100},set string(e){[this.current,this.goal=1/0]=e.replace(/\s|,/g,"").split("/")}},auth:localStorage.getItem("auth"),guid:se.guid,feature:playerFeature,teamColor:getComputedStyle(c).getPropertyValue(`--team-${se.team}`),get level(){return this._level},set level(e){this._level=+e.split("").filter((e=>e.match(/[0-9]/))).join("")},_level:se.lvl};"NickolayV"==oe.name&&r==DEFAULT_CONFIG&&(r.maxAmountInBag={cores:{I:100,II:100,III:100,IV:100,V:100,VI:150,VII:150,VIII:120,IX:-1,X:-1},catalysers:{I:0,II:0,III:0,IV:0,V:0,VI:0,VII:0,VIII:1e3,IX:-1,X:-1},refs:{allied:20,hostile:10}},localStorage.setItem("sbgcui_config",JSON.stringify(r)));{let{mapFilters:e,ui:t}=r,n=document.createElement("style"),i=document.createElement("link"),s=document.createElement("link"),o=document.createElement("link"),a=document.createElement("link");n.innerHTML=`\n      :root {\n        --sbgcui-player-exp-percentage: ${oe.exp.percentage}%;\n        --sbgcui-inventory-limit: " / 3000";\n        --sbgcui-invert: ${e.invert};\n        --sbgcui-hueRotate: ${e.hueRotate}deg;\n        --sbgcui-brightness: ${e.brightness};\n        --sbgcui-grayscale: ${e.grayscale};\n        --sbgcui-sepia: ${e.sepia};\n        --sbgcui-blur: ${e.blur}px;\n        --sbgcui-point-bg: #ccc;\n        --sbgcui-point-image: '';\n        --sbgcui-point-image-blur: ${t.pointBgImageBlur?2:0}px;\n        --sbgcui-point-btns-rtl: ${t.pointBtnsRtl?"rtl":"ltr"};\n\t\t\t\t--sbgcui-branding-color: ${"custom"==e.branding?e.brandingColor:oe.teamColor};\n\t\t\t\t--team-${oe.team}: var(--sbgcui-branding-color);\n      }\n  \t`,"custom"==e.branding&&(window.TeamColors[oe.team].fill=e.brandingColor+"80",window.TeamColors[oe.team].stroke=ne(e.brandingColor)),[i,s,o,a].forEach((e=>e.setAttribute("rel","stylesheet"))),i.setAttribute("href",`${HOME_DIR}/styles.min.css`),s.setAttribute("href",`${HOME_DIR}/assets/fontawesome/css/fontawesome.min.css`),o.setAttribute("href",`${HOME_DIR}/assets/fontawesome/css/regular.min.css`),a.setAttribute("href",`${HOME_DIR}/assets/fontawesome/css/solid.min.css`),document.head.append(n,s,o,a,i)}new MutationObserver(((e,t)=>{t.disconnect(),oe.level=A.textContent,A.innerText=(oe.level<=9?"0":"")+oe.level,t.observe(A,{childList:!0})})).observe(A,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointLevelChanged",{bubbles:!0});L.dispatchEvent(t)})).observe(L,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointOwnerChanged",{bubbles:!0});I.dispatchEvent(t)})).observe(I,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointCoresUpdated",{bubbles:!0});_.dispatchEvent(t)})).observe(_,{childList:!0}),new MutationObserver((e=>{let t;e[0].target.classList.contains("hidden")?(t=new Event("pointPopupClosed"),F=!1):e[0].oldValue?.includes("hidden")&&(t=new Event("pointPopupOpened"),F=!0),t&&e[0].target.dispatchEvent(t)})).observe(x,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),new MutationObserver((e=>{B=!e[0].target.classList.contains("hidden");let t=new Event(B?"profilePopupOpened":"profilePopupClosed",{bubbles:!0});e[0].target.dispatchEvent(t)})).observe(O,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{R=!e[0].target.classList.contains("hidden");let t=new Event(R?"inventoryPopupOpened":"inventoryPopupClosed");e[0].target.dispatchEvent(t)})).observe(v,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{let t=e[0].target.classList.contains("hidden"),n=new Event(t?"attackSliderClosed":"attackSliderOpened",{bubbles:!0});e[0].target.dispatchEvent(n)})).observe(u,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{e.forEach((e=>{if(e.oldValue.indexOf("loading")>-1&&e.target.classList.contains("loaded")){let t=e.target.querySelector(".inventory__item-descr").childNodes[4].nodeValue.replace(",",".");e.target.querySelector(".inventory__item-title").style.color.indexOf(`team-${oe.team}`)>-1&&(e.target.style.setProperty("--sbgcui-energy",`${t}%`),t<100&&e.target.style.setProperty("--sbgcui-display-r-button","flex"))}}))})).observe(f,{subtree:!0,attributes:!0,attributeFilter:["class"],attributeOldValue:!0}),new MutationObserver((e=>{te(e.find((e=>e.addedNodes.length)).addedNodes[0].data.match(/\d+/)[0])})).observe(M,{childList:!0}),new MutationObserver((()=>{if(Array.from(document.querySelectorAll('.inventory__content[data-type="3"] > .inventory__item')).every((e=>e.classList.contains("loaded")))){let e=new Event("refsListLoaded");f.dispatchEvent(e)}})).observe(f,{subtree:!0,attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{if([...e].filter((e=>e.oldValue.includes("is-active")&&!e.target.classList.contains("is-active"))).length){let e=new Event("activeSlideChanged");g.dispatchEvent(e)}})).observe(g,{subtree:!0,attributes:!0,attributeFilter:["class"],attributeOldValue:!0}),new MutationObserver((e=>{let t=new Event("coresListUpdated");p.dispatchEvent(t)})).observe(p,{childList:!0});m.addEventListener("click",(e=>{e.target==m&&X()})),d.addEventListener("click",(e=>{d.classList.toggle("sbgcui_attack-menu-rotate")})),x.addEventListener("pointPopupOpened",(()=>{let e=JSON.parse(localStorage.getItem("settings"))||{};if(r.ui.pointBgImage?(c.style.setProperty("--sbgcui-point-image",e.imghid?"":`url("${D.image}")`),x.classList.add("sbgcui_point-popup-bg"),E.classList.add("sbgcui_no_bg_image")):(c.style.setProperty("--sbgcui-point-image",""),x.style.backgroundImage="",x.classList.remove("sbgcui_point-popup-bg"),E.classList.remove("sbgcui_no_bg_image")),r.ui.pointDischargeTimeout){let e=D.dischargeTimeout;if(0!=e.length){let t=document.createElement("span");t.style.color="var(--text-disabled)",t.innerText=` (${e})`,S.appendChild(t)}}})),document.addEventListener("backbutton",(()=>(B?Z(T):F&&Z(N),!1))),document.querySelector('.inventory__tab[data-type="3"]').addEventListener("click",(e=>{let t=document.querySelector('.inventory__tab[data-type="3"] > .inventory__tab-counter'),n=JSON.parse(localStorage.getItem("inventory-cache")).reduce(((e,t)=>3==t.t?e+t.a:e),0),i=f.childNodes.length;t.innerText=i,setTimeout((()=>{t.innerText=n}),1e3)})),P.addEventListener("touchstart",(()=>{let e=Date.now(),t=setTimeout((()=>{map.getView().animate({center:oe.feature.getGeometry().getCoordinates()},{zoom:17})}),500);this.addEventListener("touchend",(()=>{Date.now()-e<1e3&&clearTimeout(t)}),{once:!0})})),P.addEventListener("click",(()=>{re?.setActive("false"==P.dataset.active)}));{let e=document.querySelector("#ops"),t=document.querySelector(".bottomleft-container"),n=document.querySelector(".ol-rotate"),i=document.querySelector("#layers"),s=document.querySelector("#attack-slider-close"),o=document.querySelector(".ol-zoom");document.querySelectorAll('[data-i18n="self-info.name"], [data-i18n="self-info.xp"], [data-i18n="units.pts-xp"], [data-i18n="self-info.inventory"], [data-i18n="self-info.position"]').forEach((e=>{e.remove()})),document.querySelectorAll(".self-info__entry").forEach((e=>{let t=[];e.childNodes.forEach((e=>{3==e.nodeType&&t.push(e)})),t.forEach((e=>{e.remove()}))})),s.remove(),d.childNodes[0].remove(),b.innerText="[x]",i.innerText="",i.classList.add("fa-solid","fa-layer-group"),o.append(n,P,i),P.innerText="",P.classList.add("fa-solid","fa-location-crosshairs"),t.appendChild(e),e.replaceChildren("INVENTORY",y),A.innerText=(oe.level<=9?"0":"")+oe.level}{var re,ae,le=new s;map.getInteractions().forEach((e=>{switch(e.constructor){case ol.interaction.DragPan:re=e;break;case ol.interaction.DoubleClickZoom:ae=e;break}})),re?.setActive("false"==localStorage.getItem("follow")),ae?.setActive(Boolean(r.ui.doubleClickZoom));let e=new ol.Geolocation({projection:map.getView().getProjection(),tracking:!0,trackingOptions:{enableHighAccuracy:!0}}),t=document.createElement("span");document.querySelector(".self-info").appendChild(t),e.on("change:speed",(()=>{let n=e.getSpeed()||0;t.innerText=(3.6*n).toFixed(2)+" km/h"})),map.addControl(le)}{let e=document.createElement("div"),t=document.createElement("div"),n=document.querySelector("#self-info__exp");new MutationObserver((()=>{oe.exp.string=n.textContent,c.style.setProperty("--sbgcui-player-exp-percentage",`${oe.exp.percentage}%`)})).observe(n,{childList:!0}),e.classList.add("sbgcui_xpProgressBar"),t.classList.add("sbgcui_xpProgressBarFiller"),n.parentElement.prepend(e),e.append(n,t)}u.addEventListener("attackSliderOpened",(e=>{Z(function(e){let t,n=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>2==e.t&&e.l<=oe.level)).sort(((e,t)=>e.l-t.l));switch(e){case"latest":if(t=u.querySelector(`[data-guid="${V}"]`),t)break;case"max":t=u.querySelector(`[data-guid="${n[n.length-1].g}"]`);break}return t}(r.autoSelect.attack))})),x.addEventListener("pointPopupOpened",(e=>{D.selectCore(r.autoSelect.deploy)})),_.addEventListener("click",(e=>{if(e.target.classList.contains("selected")){let t=e.target.innerText.match(/^[0-9]{1,2}$/)?+e.target.innerText:J.toDecimal(e.target.innerText);D.selectCore(r.autoSelect.upgrade,t)}})),p.addEventListener("touchstart",(e=>{let t=e.target.closest(".is-active.splide__slide");if(null==t)return;let n=Date.now(),i=t.dataset.guid,s=setTimeout((()=>{let e;H.has(i)?(H.delete(i),t.removeAttribute("sbgcui-excluded-core"),e=Q("Теперь ядро доступно для автовыбора.")):(H.add(i),t.setAttribute("sbgcui-excluded-core",""),e=Q("Ядро больше не участвует в автовыборе.")),e.showToast(),localStorage.setItem("sbgcui_excludedCores",JSON.stringify([...H]))}),1e3);t.addEventListener("touchend",(()=>{Date.now()-n<1e3&&clearTimeout(s)}),{once:!0})})),p.addEventListener("coresListUpdated",(()=>{p.childNodes.forEach((e=>{H.has(e.dataset.guid)&&e.setAttribute("sbgcui-excluded-core","")}))})),f.addEventListener("click",(e=>{if(!e.currentTarget.matches('.inventory__content[data-type="3"]'))return;if(!e.target.closest(".inventory__item-controls"))return;if(!e.target.closest(".inventory__item.loaded"))return;if(e.offsetX<50)return;let t=e.target.closest(".inventory__item")?.dataset.ref;(async function(e){return fetch("/api/repair",{headers:{authorization:`Bearer ${oe.auth}`,"content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`guid=${e}&position%5B%5D=0.0&position%5B%5D=0.0`,method:"POST"}).then((e=>e.json()))})(t).then((n=>{if(n.error)throw new Error(n.error);if(n.data){let[i,s]=n.data.co.reduce(((e,t)=>[e[0]+t.e,e[1]+CORES_ENERGY[t.l]]),[0,0]),o=document.querySelector(`.inventory__item[data-ref="${t}"] .inventory__item-left`).querySelector(".inventory__item-descr").childNodes[4],r=Math.floor(i/s*100),a=JSON.parse(localStorage.getItem("refs-cache")),l=e.target.closest(".inventory__item");l.style.setProperty("--sbgcui-energy",`${r}%`),l.style.setProperty("--sbgcui-display-r-button",100==r?"none":"flex"),o&&(o.nodeValue=r),function(e){let t=new Intl.NumberFormat("en-GB"),n=0;for(let i=0;i<LEVEL_TARGETS.length;i+=1)if(n+=LEVEL_TARGETS[i],n>e)return $.innerText=n!=1/0?`${t.format(e-(n-LEVEL_TARGETS[i]))} / ${t.format(LEVEL_TARGETS[i])}`:t.format(e),void(A.innerText=i+1)}(n.xp.cur),te(n.xp.diff),a[t].e=r,localStorage.setItem("refs-cache",JSON.stringify(a))}})).catch((e=>{let t=Q(`Ошибка при зарядке. <br>${e.message}`);t.options.className="error-toast",t.showToast()}))}));{let e=!1,t=function(){function e(e,t){let n=document.createElement("details");n.classList.add("sbgcui_settings-section");let i=document.createElement("summary");i.classList.add("sbgcui_settings-title"),i.innerText=e;let s=document.createElement("h6");return s.classList.add("sbgcui_settings-subtitle"),s.innerHTML=t,n.appendChild(i),n.appendChild(s),n}function t(e,t,n,i,s){let o="checkbox"==e,r=document.createElement("div"),a=document.createElement("label"),l=document.createElement("input");if(r.classList.add("sbgcui_settings-input_wrp"),l.id=o?t:t+Math.random().toString().slice(2),l.name=t,l.type=e,l.value=o?1:s,l.checked=n,a.htmlFor=l.id,a.innerText=i,o){let e=document.createElement("input");e.name=t,e.type="hidden",e.value=0,r.appendChild(e)}return r.append(l,a),r}function n(e,t){let n=document.createElement("input");return n.type="color",n.name=e,n.value=t,n}function i(e,t=[],n,i){let s=document.createElement("h5"),o=document.createElement("select"),r=document.createElement("div");return s.classList.add("sbgcui_settings-dropdown-title"),s.innerText=e,t.forEach((e=>{let t=document.createElement("option");t.innerText=e[0],t.value=e[1],o.appendChild(t)})),o.name=n,o.value=i,r.classList.add("sbgcui_settings-dropdown_wrapper"),r.append(s,o),r}let s=document.createElement("form");s.classList.add("sbgcui_settings","sbgcui_hidden");let o=document.createElement("span");o.classList.add("sbgcui_settings-version"),o.innerText="v0.0.8";let a=document.createElement("h3");a.classList.add("sbgcui_settings-header"),a.innerText="Настройки";let l=document.createElement("button");l.innerText="Сохранить";let d=document.createElement("button");d.innerText="Закрыть",d.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),K()}));let u=document.createElement("div");u.classList.add("sbgcui_settings-buttons_wrp"),u.append(l,d);let g=[function(t){let n=e("Автоудаление",'Когда в инвентаре останется меньше 100 мест, будут удалены предметы, превышающие указанное количество. <br>Значение "-1" предотвращает удаление.'),i=document.createElement("button");i.classList.add("sbgcui_settings-forceclear"),i.innerText="Очистить сейчас",i.addEventListener("click",(function(e){e.preventDefault(),confirm("Произвести очистку инвентаря согласно настройкам?")&&X(0,!0)})),n.appendChild(i);for(let e in t){let i=document.createElement("section"),s=document.createElement("h4"),o=document.createElement("div");i.classList.add("sbgcui_settings-subsection"),s.classList.add("sbgcui_settings-title"),o.classList.add("sbgcui_settings-maxamounts"),s.innerText="cores"==e?"Ядра":"catalysers"==e?"Катализаторы":"refs"==e?"Рефы":"N/D";for(let n in t[e]){let i=document.createElement("div"),s=document.createElement("label"),r=document.createElement("input");i.classList.add("sbgcui_settings-amount_input_wrp"),s.classList.add("sbgcui_settings-amount_label"),r.classList.add("sbgcui_settings-amount_input"),"refs"==e?(s.innerText="allied"==n?"Свои:":"Чужие:",s.classList.add(`sbgcui_settings-amount_label_${n}`)):(s.innerText=n+":",s.style.color=`var(--level-${J.toDecimal(n)})`),r.name=`maxAmountInBag_${e}_${n}`,r.type="number",r.min=-1,r.value=t[e][n],i.append(s,r),o.appendChild(i)}i.append(s,o),n.appendChild(i)}return n}(r.maxAmountInBag),function(t){let n=e("Автовыбор","Можно автоматически выбирать самый мощный катализатор при атаке, самое маленькое ядро при деплое или следующий уровень ядра при каждом апгрейде. Вы можете исключить конкретное ядро из автовыбора: нажмите на него в карусели и удерживайте 1 секунду до появления уведомления."),s=document.createElement("section"),o=i("Катализатор при атаке:",[["Самый мощный","max"],["Последний использованный","latest"]],"autoSelect_attack",t.attack),r=i("Ядро при деплое:",[["Наименьшее","min"],["Наибольшее","max"],["Вручную","off"]],"autoSelect_deploy",t.deploy),a=i("Ядро при апгрейде:",[["Наименьшее","min"],["Наибольшее","max"],["Вручную","off"]],"autoSelect_upgrade",t.upgrade);return s.classList.add("sbgcui_settings-subsection"),s.append(o,r,a),n.appendChild(s),n}(r.autoSelect),function(t){function s(e,t,n,i,s,o,r){let a=document.createElement("div"),l=document.createElement("label"),d=document.createElement("input");return a.classList.add("sbgcui_settings-mapfilters_input_wrp"),d.type=e,d.name=t,d.min=n,d.max=i,d.step=s,d.value=o,l.innerText=r,d.addEventListener("input",(e=>{!function(e,t){let n=e.split("_")[1],i="blur"==n?"px":"hueRotate"==n?"deg":"";c.style.setProperty(`--sbgcui-${n}`,`${t}${i}`)}(t,e.target.value)})),a.append(l,d),a}let o=e("Цветовая схема","Настройте цвет своей команды и оттенок карты."),r=document.createElement("section"),a=s("range","mapFilters_invert",0,1,.01,+t.invert,"Инверсия"),l=s("range","mapFilters_hueRotate",0,360,1,+t.hueRotate,"Цветность"),d=s("range","mapFilters_brightness",0,5,.01,+t.brightness,"Яркость"),u=s("range","mapFilters_grayscale",0,1,.01,+t.grayscale,"Оттенок серого"),g=s("range","mapFilters_sepia",0,1,.01,+t.sepia,"Сепия"),p=s("range","mapFilters_blur",0,4,.1,+t.blur,"Размытие"),m=i("Цвет вашей команды:",[["Стандартный","default"],["Собственный","custom"]],"mapFilters_branding",t.branding),h=n("mapFilters_brandingColor","custom"==t.branding?t.brandingColor:ie(oe.teamColor)),b=m.querySelector("select");return b.addEventListener("change",(e=>{"default"==e.target.value?(h.value=ie(oe.teamColor),c.style.setProperty("--sbgcui-branding-color",oe.teamColor)):(h.value=t.brandingColor,c.style.setProperty("--sbgcui-branding-color",t.brandingColor))})),h.addEventListener("input",(e=>{"default"==b.value&&(b.value="custom"),c.style.setProperty("--sbgcui-branding-color",ne(e.target.value))})),h.addEventListener("change",(()=>{h.value=ne(h.value,!1)})),m.appendChild(h),r.classList.add("sbgcui_settings-subsection"),r.append(m,a,l,d,u,g,p),o.appendChild(r),o}(r.mapFilters),function(n){let s=e("Тонирование","Интерфейс браузера будет окрашиваться в зависимости от того, что происходит на экране."),o=document.createElement("section"),r=t("checkbox","tinting_map",+n.map,"При просмотре карты"),a=t("checkbox","tinting_profile",+n.profile,"При просмотре профиля");r.addEventListener("change",(e=>{e.target.checked?ee("map"):ee("")}));let l=i("При просмотре точки:",[["Цвет уровня","level"],["Цвет команды","team"],["Нет","off"]],"tinting_point",n.point);return o.classList.add("sbgcui_settings-subsection"),o.append(r,a,l),s.appendChild(o),s}(r.tinting),function(n){let i=e("Вибрация","Устройство будет откликаться на ваши действия. Может потребоваться выдача соответствующего разрешения в браузере или системе."),s=document.createElement("section"),o=t("checkbox","vibration_buttons",+n.buttons,"При нажатии кнопок"),r=t("checkbox","vibration_notifications",+n.notifications,"При уведомлениях");return s.classList.add("sbgcui_settings-subsection"),s.append(o,r),i.appendChild(s),"vibrate"in window.navigator||i.classList.add("sbgcui_hidden"),i}(r.vibration),function(n){let i=e("Интерфейс","Некоторые аспекты дизайна можно отключить или изменить для большего удобства."),s=document.createElement("section"),o=t("checkbox","ui_doubleClickZoom",+n.doubleClickZoom,"Зум карты по двойному нажатию"),r=t("checkbox","ui_pointBgImage",+n.pointBgImage,"Фото точки вместо фона"),a=t("checkbox","ui_pointBgImageBlur",+n.pointBgImageBlur,"Размытие фонового фото"),l=t("checkbox","ui_pointBtnsRtl",+n.pointBtnsRtl,"Отразить кнопки в карточке точки"),c=t("checkbox","ui_pointDischargeTimeout",+n.pointDischargeTimeout,"Показывать примерное время разрядки точки");return r.addEventListener("click",(e=>{"ui_pointBgImage"==e.target.id&&(e.target.checked?a.childNodes[1].removeAttribute("disabled"):(a.childNodes[1].checked=0,a.childNodes[1].setAttribute("disabled","")))})),s.classList.add("sbgcui_settings-subsection"),s.append(o,r,a,l,c),i.appendChild(s),i}(r.ui),function(t){function s(e,t){e.forEach((e=>{switch(t){case"uniqc":"uniqv"==e.value&&(e.value="off");break;case"uniqv":"uniqc"==e.value&&(e.value="off");break;default:e.value="off"}}))}let o=e("Подсветка точек","Точки на карте могут отображать несколько маркеров, например кольцо снаружи точки, кружок внутри неё или текст рядом. Выберите, что будет обозначать каждый из них."),r=document.createElement("section"),a=n("pointHighlighting_innerColor",t.innerColor),l=n("pointHighlighting_outerColor",t.outerColor),c=n("pointHighlighting_outerTopColor",t.outerTopColor),d=n("pointHighlighting_outerBottomColor",t.outerBottomColor),u=[["Нет","off"],["Уровень 8+","highlevel"],["Избранная","fav"],["Имеется реф","ref"],["Не захвачена","uniqc"],["Не исследована","uniqv"],["Полностью проставлена","cores"]],g=i("Внутренний маркер (точка):",u,"pointHighlighting_inner",t.inner),p=i("Наружный маркер (кольцо):",u,"pointHighlighting_outer",t.outer),m=i("Наружный маркер (верхнее полукольцо):",u,"pointHighlighting_outerTop",t.outerTop),h=i("Наружный маркер (нижнее полукольцо):",u,"pointHighlighting_outerBottom",t.outerBottom),b=i("Текстовый маркер:",[["Нет","off"],["Уровень","level"],["Энергия","energy"],["Линии вх. + исх.","lines"],["Количество рефов","refsAmount"]],"pointHighlighting_text",t.text),f=g.querySelector("select"),v=p.querySelector("select"),y=m.querySelector("select"),_=h.querySelector("select"),E=[f,v,y,_];return E.forEach((e=>{e.addEventListener("change",(t=>{switch(t.target){case v:s([y,_]);break;case y:case _:s([v]);break}["uniqc","uniqv"].includes(t.target.value)&&s(E.filter((t=>t!=e)),t.target.value)}))})),g.appendChild(a),p.appendChild(l),m.appendChild(c),h.appendChild(d),r.classList.add("sbgcui_settings-subsection"),r.append(g,p,m,h,b),o.appendChild(r),o}(r.pointHighlighting)];return g.forEach((e=>{e.addEventListener("click",(e=>{g.forEach((t=>{e.currentTarget!=t&&t.removeAttribute("open")}))}))})),s.append(o,a,...g,u),s.addEventListener("submit",(e=>{e.preventDefault();try{let t=new FormData(e.target),n=Object.fromEntries(t);for(let e in n){let t=e.split("_");if("maxAmountInBag"==t[0])r.maxAmountInBag[t[1]][t[2]]=Number.isInteger(+n[e])?n[e]:-1;else if(t[0].match(/autoSelect|mapFilters|tinting|vibration|ui|pointHighlighting/)){let i=n[e];r[t[0]][t[1]]=isNaN(+i)?i:+i}}localStorage.setItem("sbgcui_config",JSON.stringify(r)),Q("Настройки сохранены").showToast()}catch(e){let t=Q(`Ошибка при сохранении настроек. <br>${e.message}`);t.options.className="error-toast",t.showToast()}})),s}();document.querySelector(".topleft-container").appendChild(t);let n=document.createElement("button");n.classList.add("fa-solid","fa-gears"),n.addEventListener("click",(()=>{t.classList.toggle("sbgcui_hidden"),e=!e})),le.addItem(n,1),document.body.addEventListener("click",(t=>{e&&t.target!=n&&!t.target.closest(".sbgcui_settings")&&(K(),e=!1)}))}{var ce=document.createElement("meta"),de=document.querySelector('meta[name="viewport"]');ce.name="theme-color",document.head.appendChild(ce);let e=r.tinting;+e.map&&ee("map"),O.addEventListener("profilePopupOpened",(t=>{+e.profile?ee("profile"):ee("")})),x.addEventListener("pointPopupOpened",(t=>{"off"!=e.point?ee(`point_${e.point}`):ee("")})),L.addEventListener("pointLevelChanged",(t=>{"level"==e.point&&ee("point_level")})),I.addEventListener("pointOwnerChanged",(t=>{"team"==e.point&&ee("point_team")})),x.addEventListener("pointPopupClosed",(t=>{B?+e.profile&&ee("profile"):+e.map?ee("map"):ee(""),x.style.borderColor="",C.style.color=""})),O.addEventListener("profilePopupClosed",(t=>{F?"off"!=e.point&&ee(`point_${e.point}`):+e.map?ee("map"):ee(""),O.style.borderColor=""}))}var ue=document.createElement("div");ue.classList.add("sbgcui_xpdiff-wrapper"),document.body.appendChild(ue);{let e=document.createElement("div"),t=document.createElement("button"),n=document.createElement("button"),i=document.createElement("span"),s=document.querySelector(".pr-stats"),o=JSON.parse(localStorage.getItem("sbgcui_stats"),((e,t)=>"date"==e?new Date(t):t));t.innerText="Записать",n.innerText="Сравнить",t.addEventListener("click",(e=>{confirm("Сохранить вашу статистику на текущий момент? \nЭто действие перезапишет сохранённую ранее статистику.")&&U(oe.guid).then((e=>{let t=new Date;localStorage.setItem("sbgcui_stats",JSON.stringify({date:t,stats:e})),i.innerText=`Последняя запись: \n${t.toLocaleString()}`}))})),n.addEventListener("click",(e=>{let t=JSON.parse(localStorage.getItem("sbgcui_stats"),((e,t)=>"date"==e?new Date(t):t));if(!t){let e=Q("Вы ещё не сохраняли свою статистику.");return e.options.className="error-toast",void e.showToast()}U(oe.guid).then((e=>{let n=new Date-t.date,i=["day","hr","min","sec"],s="",o="";[864e5,36e5,6e4,1e3].forEach(((e,t)=>{let o=Math.trunc(n/e);o&&(s+=`${s.length?", ":""}${o} ${i[t]+(o>1?"s":"")}`,n-=o*e)}));for(let n in e){let i=e[n]-t.stats[n];if(i){let e,t=i>0;switch(n){case"discoveries":case"captures":case"level":case"cores_deployed":case"cores_destroyed":case"lines_destroyed":case"unique_captures":case"unique_visits":case"owned_points":e=n.charAt(0).toUpperCase()+n.slice(1).replace("_"," ");break;case"xp":e="XP";break;case"guard_line":e="Longest line ownership";break;case"guard_point":e="Longest point ownership";break;case"lines":e="Lines drawn";break;case"max_line":e="Longest drawn line (m)";break;case"neutralizes":e="Points neutralized";break;default:n.match(/created_at|name|player|team/)||(e=n)}e&&(o+=`\n                <p class="sbgcui_compare_stats-diff-wrp">\n                  <span>${e}:</span>\n                  <span class="sbgcui_compare_stats-diff-value${t?"Pos":"Neg"}">\n                    ${t?"+":""}${i}\n                  </span>\n                </p>\n              `)}}let r=Q(o.length?`Ваша статистика с ${t.date.toLocaleString()}<br>(${s})<br>${o}`:"Ничего не изменилось с прошлого сохранения.","bottom center",2e4);r.options.className="sbgcui_compare_stats-toast",r.showToast()}))})),o&&(i.innerText=`Последнее сохранение: \n${o.date.toLocaleString()}`),i.classList.add("sbgcui_compare_stats-timestamp"),e.classList.add("sbgcui_compare_stats"),e.append(i,t,n),O.insertBefore(e,s),O.addEventListener("profilePopupOpened",(t=>{k.innerText==oe.name?e.classList.remove("sbgcui_hidden"):e.classList.add("sbgcui_hidden")}))}if(window.navigator.userAgent.toLowerCase().includes("wv")){let e=document.querySelector(".game-menu"),t=document.createElement("button");t.classList.add("fa-solid","fa-rotate"),t.addEventListener("click",(e=>{window.location.reload()})),e.appendChild(t)}E.addEventListener("click",(e=>{if(E.hasAttribute("sbgcui_clicks")){let e=+E.getAttribute("sbgcui_clicks");if(e+1==5){let e=document.querySelector(".i-stat"),t=document.querySelector(".info.popup").dataset.guid,n=document.createElement("span");n.innerText=`GUID: ${t}`,n.addEventListener("click",(e=>{window.navigator.clipboard.writeText(`https://3d.sytes.net/?point=${t}`).then((e=>{Q("Ссылка на точку скопирована в буфер обмена.").showToast()}))})),e.prepend(n),x.addEventListener("pointPopupClosed",(e=>{n.remove(),E.setAttribute("sbgcui_clicks",0)}))}E.setAttribute("sbgcui_clicks",e+1)}else E.setAttribute("sbgcui_clicks",1)})),"vibrate"in window.navigator&&document.body.addEventListener("click",(e=>{r.vibration.buttons&&"BUTTON"==e.target.nodeName&&(window.navigator.vibrate(0),window.navigator.vibrate(50))}));{function e(e,t){return e?new o(e,t):t}var ge=JSON.parse(localStorage.getItem("sbgcui_favorites"),e)||{};Object.defineProperty(ge,"save",{value:function(){let e={};for(let t in this)this[t].isActive&&(e[t]=this[t]);localStorage.setItem("sbgcui_favorites",JSON.stringify(e))}});{let e=JSON.parse(localStorage.getItem("sbgcui_pointsSubscriptions")),t=JSON.parse(localStorage.getItem("sbgcui_reminders"));if(e){for(let n of e){let e=t[n];ge[n]=new o(n,e)}ge.save(),localStorage.removeItem("sbgcui_pointsSubscriptions"),localStorage.removeItem("sbgcui_reminders")}}{let e=document.createElement("button"),t=x.dataset.guid;e.classList.add("sbgcui_button_reset","sbgcui_point_star","fa-"+(ge[t]?.isActive?"solid":"regular"),"fa-star"),e.addEventListener("click",(t=>{let n=x.dataset.guid,i=C.innerText;if(e.classList.contains("fa-solid"))ge[n].isActive=0,e.classList.replace("fa-solid","fa-regular");else{if(n in ge)ge[n].isActive=1;else{let e=JSON.parse(localStorage.getItem("cooldowns"))||{},t=0==e[n]?.c?e[n].t:null;ge[n]=new o(n,t,i)}e.classList.replace("fa-regular","fa-solid"),!z()&&"Notification"in window&&"default"==Notification.permission&&Notification.requestPermission()}ge.save()})),x.addEventListener("pointPopupOpened",(t=>{let n=x.dataset.guid;ge[n]?.isActive?e.classList.replace("fa-regular","fa-solid"):e.classList.replace("fa-solid","fa-regular")})),w.appendChild(e)}{let e=document.createElement("button"),t=document.createElement("div"),n=document.createElement("h3"),i=document.createElement("ul"),s=!1;function o(){let e=[];if(i.innerHTML="",0!=Object.keys(ge).length){for(let t in ge)if(ge[t].isActive){let n=document.createElement("li"),i=document.createElement("a"),o=document.createElement("span"),r=document.createElement("button"),a=document.createElement("div");o.innerText=ge[t].name,i.appendChild(o),i.setAttribute("href",`/?point=${t}`),r.classList.add("sbgcui_button_reset","sbgcui_favs-li-delete","fa-solid","fa-circle-xmark"),r.addEventListener("click",(e=>{ge[t].isActive=0,ge.save(),n.removeAttribute("sbgcui_active",""),n.classList.add("sbgcui_hidden")})),a.classList.add("sbgcui_favs-li-data"),n.classList.add("sbgcui_favs-li"),n.setAttribute("sbgcui_active","");let l=ge[t].isActive&&ge[t].cooldown,c=ge[t].discoveriesLeft;if(l){i.setAttribute("sbgcui_cooldown",ge[t].timer),i.sbgcuiCooldown=ge[t].cooldown;let e=setInterval((()=>{s&&ge[t].isActive&&ge[t].cooldown?i.setAttribute("sbgcui_cooldown",ge[t].timer):clearInterval(e)}),1e3)}else c&&(i.setAttribute("sbgcui_discoveries",c),i.discoveriesLeft=c);n.append(r,i,a),e.push(n),W(t).then((e=>{e&&(o.innerText=`[${e.l}] ${i.innerText}`,i.style.color=e.te==oe.team?"var(--sbgcui-branding-color)":`var(--team-${e.te})`,a.innerHTML=`${Math.round(e.e)}% @ ${e.co}<br>${e.li.i}↓ ${e.li.o}↑`)}))}e.sort(((e,t)=>(e=e.childNodes[1].sbgcuiCooldown||e.childNodes[1].discoveriesLeft,t=t.childNodes[1].sbgcuiCooldown||t.childNodes[1].discoveriesLeft,null==e?1:null==t?-1:e-t))),i.append(...e)}}t.classList.add("sbgcui_favs","sbgcui_hidden"),n.classList.add("sbgcui_favs-header"),i.classList.add("sbgcui_favs-content"),n.innerText="Избранные точки",t.append(n,i),e.classList.add("sbgcui_button_reset","sbgcui_favs_star","fa-solid","fa-star"),e.addEventListener("click",(()=>{o(),t.classList.toggle("sbgcui_hidden"),s=!s})),document.body.addEventListener("click",(e=>{!s||e.target.closest(".sbgcui_favs")||e.target.closest(".sbgcui_favs_star")||(t.classList.add("sbgcui_hidden"),s=!1)})),le.addItem(e,2),document.body.appendChild(t)}}f.addEventListener("click",(e=>{if(!e.target.classList.contains("inventory__ic-view"))return;let t=e.target.closest(".inventory__item").dataset.ref;t&&confirm('Открыть карточку точки? Нажмите "Отмена" для перехода к месту на карте.')&&(location.href=`/?point=${t}`)}));{let e=document.createElement("span"),t=document.createElement("span");e.classList.add("sbgcui_no_loot","fa-solid","fa-droplet-slash"),t.classList.add("sbgcui_no_refs","fa-solid","fa-link-slash"),m.append(e,t),m.addEventListener("click",(e=>{if(e.target==m)l=new n(1,1);else{let t=!e.target.classList.contains("sbgcui_no_loot"),i=!e.target.classList.contains("sbgcui_no_refs");l=new n(t,i)}}))}{function n(e){return e.every((e=>e.classList.contains("loaded")))}function i(e){let t=JSON.parse(localStorage.getItem("refs-cache"))||{};return e.every((e=>t[e.dataset.ref]?.t>Date.now()))}function s(n,i){let s;switch(i){case"name":return s=new RegExp(/\(x[0-9]{1,}\)\s(?:"|«)?([\s\S]+)/i),n.querySelector(".inventory__item-title").innerText.match(s)[1];case"level":return s=new RegExp(/level-([0-9]{1,2})/),+n.querySelector(".inventory__item-descr > span").style.color.match(s)?.[1]||0;case"team":return s=new RegExp(/team-([1-3])/),+n.querySelector(".inventory__item-title").style.color.match(s)?.[1]||0;case"energy":return+n.querySelector(".inventory__item-descr").childNodes[4].nodeValue.replace(",",".");case"distance":s=new RegExp(`([0-9]+?(?:${e}[0-9]+)?(?:\\${t}[0-9]+)?)\\s(cm|m|km|см|м|км)`,"i");let i=n.querySelector(".inventory__item-descr").lastChild.textContent,[o,r,a]=i.match(s);return r=r.replace(e,"").replace(t,"."),parseFloat(r)/(["cm","см"].includes(a)?1e5:["m","м"].includes(a)?1e3:1);case"amount":return s=new RegExp(/^\(x([0-9]{1,})\)\s/i),+n.querySelector(".inventory__item-title").innerText.match(s)[1]}}function o(e,t){let n=s(e,"name"),i=s(t,"name");return n.localeCompare(i)}function r(e,t){e.sort(((e,n)=>{let i=s(e,t),r=s(n,t);switch(t){case"name":return i.localeCompare(r);case"team":return i==r?o(e,n):i==oe.team?-1:r==oe.team?1:i-r;case"energy":let t=s(e,"team"),a=s(n,"team");return t==a?i==r?o(e,n):i-r:t==oe.team?-1:a==oe.team?1:i==r?o(e,n):i-r;default:return i-r}}))}function a(){if(r(u,g),f.replaceChildren(...u),h.removeAttribute("disabled"),f.classList.remove("sbgcui_refs_list-blur"),S){let e;performance.mark(E),e=Q(`Загрузка и сортировка заняли ${+(performance.measure(w,_,E).duration/1e3).toFixed(1)} сек. <br><br>Уникальных рефов: ${f.childNodes.length}.`,"top left",-1),e.options.className="sbgcui_toast-selection",e.showToast(),c()}}function l(e){e.isTrusted&&(clearInterval(d),f.removeEventListener("refsListLoaded",a),h.value="none",h.removeAttribute("disabled"),f.classList.remove("sbgcui_refs_list-blur"))}function c(){S=!1,performance.clearMarks(_),performance.clearMarks(E),performance.clearMeasures(w),b.removeAttribute("sbgcui_measurement_mode")}let d,u,g,p=document.querySelector(".inventory__controls"),m=document.querySelector("#inventory-delete"),h=document.createElement("select"),y=document.createElement("button"),_="sbgcui_refs_sort_begin",E="sbgcui_refs_sort_end",w="sbgcui_refs_sort_measure",S=!1;y.classList.add("fa-solid","fa-sort","sbgcui_button_reset","sbgcui_refs-sort-button"),h.classList.add("sbgcui_refs-sort-select"),[["Сортировка","none"],["По названию","name"],["По уровню","level"],["По команде","team"],["По заряду","energy"],["По дистанции","distance"],["По количеству","amount"]].forEach((e=>{let t=document.createElement("option");t.innerText=e[0],t.value=e[1],h.appendChild(t)})),h.addEventListener("change",(e=>{let t=new Event("scroll");if(Object.defineProperty(t,"target",{value:{scrollTop:0,clientHeight:f.clientHeight}}),u=Array.from(f.children),g=e.target.value,"none"!=g)if(f.scrollTop=0,f.classList.remove("sbgcui_refs-reverse"),h.setAttribute("disabled",""),!g.match(/name|amount/)&&!n(u)||S){let e=.9*f.offsetHeight;if(f.classList.add("sbgcui_refs_list-blur"),S&&(n(u)&&document.querySelector('.inventory__tab[data-type="3"]')?.click(),localStorage.removeItem("refs-cache"),performance.mark(_)),i(u))for(let e=0;e<=f.scrollHeight;e+=f.offsetHeight/2)t.target.scrollTop=e,f.dispatchEvent(t);else d=setInterval((()=>{t.target.scrollTop<=f.scrollHeight?(t.target.scrollTop+=e,f.dispatchEvent(t)):(clearInterval(d),t.target.scrollTop=f.scrollHeight,f.dispatchEvent(t))}),10);f.addEventListener("refsListLoaded",a,{once:!0})}else r(u,g),f.replaceChildren(...u),h.removeAttribute("disabled")})),document.querySelector(".inventory__tabs").addEventListener("click",l),b.addEventListener("click",l),v.addEventListener("inventoryPopupOpened",c),b.addEventListener("touchstart",(()=>{let e=Date.now(),t=setTimeout((()=>{let e;e=Q("Режим измерения производительности. <br><br>\n\t\t\t\t\t\tВыберите тип сортировки для измерения скорости загрузки данных. <br><br>\n\t\t\t\t\t\tКэш рефов будет очищен. <br><br>\n\t\t\t\t\t\tДля отмены операции закройте инвентарь.","bottom center",-1),e.options.className="sbgcui_toast-selection",e.showToast(),S=!0,b.setAttribute("sbgcui_measurement_mode","")}),2e3);b.addEventListener("touchend",(()=>{Date.now()-e<1e3&&clearTimeout(t)}),{once:!0})})),y.addEventListener("click",(()=>{f.classList.toggle("sbgcui_refs-reverse"),f.scrollTop=-f.scrollHeight})),p.insertBefore(h,m),p.appendChild(y)}{class e extends ol.Feature{constructor(e){super(e),this.addEventListener("change",(()=>{if(!this.id_||!this.style_)return;let{inner:e,outer:t,outerTop:n,outerBottom:i,text:s}=r.pointHighlighting,o=this.style_;this.addStyle(o,"inner",1,this.isMarkerNeeded(e)),this.addStyle(o,"outer",2,this.isMarkerNeeded(t)),this.addStyle(o,"outerTop",3,this.isMarkerNeeded(n)),this.addStyle(o,"outerBottom",4,this.isMarkerNeeded(i)),this.addStyle(o,null,5,!1,this.textToRender(s))}))}isMarkerNeeded(e){switch(e){case"fav":return this.id_ in ge;case"ref":return this.cachedRefsGuids.includes(this.id_);case"uniqc":return G.c.has(this.id_);case"uniqv":return G.v.has(this.id_);case"cores":return 6==j[this.id_]?.cores;case"highlevel":return j[this.id_]?.level>=8;default:return!1}}textToRender(e){switch(e){case"energy":let e=j[this.id_]?.energy;return e>0?String(Math.round(10*e)/10):null;case"level":let t=j[this.id_]?.level;return"number"==typeof t?String(t):null;case"lines":let n=j[this.id_]?.lines.sum;return n>0?String(n):null;case"refsAmount":let i=this.cachedRefsAmounts[this.id_];return i>0?String(i):null;default:return null}}addStyle(e,t,n,i,s){1==i?(e[n]=e[0].clone(),e[n].renderer_=this[`${t}MarkerRenderer`]):(e[n]=new ol.style.Style({}),e[n].text_=s?new ol.style.Text({font:"14px Manrope",offsetY:e[1].renderer_?-20:0,text:s,fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#FFF",width:3})}):void 0)}innerMarkerRenderer(e,t){const n=t.context,[[i,s],[o,a]]=e,l=Math.sqrt((o-i)**2+(a-s)**2)/3;n.fillStyle=r.pointHighlighting.innerColor,n.beginPath(),n.arc(i,s,l,0,2*Math.PI),n.fill()}outerMarkerRenderer(e,t){const n=t.context,[[i,s],[o,a]]=e,l=1.3*Math.sqrt((o-i)**2+(a-s)**2);n.lineWidth=4,n.strokeStyle=r.pointHighlighting.outerColor,n.beginPath(),n.arc(i,s,l,0,2*Math.PI),n.stroke()}outerTopMarkerRenderer(e,t){const n=t.context,[[i,s],[o,a]]=e,l=1.3*Math.sqrt((o-i)**2+(a-s)**2);n.lineWidth=4,n.strokeStyle=r.pointHighlighting.outerTopColor,n.beginPath(),n.arc(i,s,l,Math.PI/180*195,Math.PI/180*345),n.stroke()}outerBottomMarkerRenderer(e,t){const n=t.context,[[i,s],[o,a]]=e,l=1.3*Math.sqrt((o-i)**2+(a-s)**2);n.lineWidth=4,n.strokeStyle=r.pointHighlighting.outerBottomColor,n.beginPath(),n.arc(i,s,l,Math.PI/180*15,Math.PI/180*165),n.stroke()}get cachedRefsGuids(){return JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>3==e.t)).map((e=>e.l))}get cachedRefsAmounts(){return Object.fromEntries(JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>3==e.t)).map((e=>[e.l,e.a])))}}ol.Feature=e}{function e(){let e=[...g.children].find((e=>e.classList.contains("is-active"))),t=(JSON.parse(localStorage.getItem("inventory-cache"))||[]).find((t=>t.g==e.dataset.guid)).l,n=window.Catalysers[t].range;var i;playerFeature.getStyle()[3].getGeometry().setRadius(n*(i=i||1/ol.proj.getPointResolution("EPSG:3857",1,map.getView().getCenter(),"m"))),playerFeature.getStyle()[3].getStroke().setColor(`${r.mapFilters.brandingColor}70`),playerFeature.changed()}function t(){playerFeature.getStyle()[3].getGeometry().setRadius(0),playerFeature.changed()}g.addEventListener("activeSlideChanged",e),u.addEventListener("attackSliderOpened",e),u.addEventListener("attackSliderClosed",t)}{let e=document.createElement("button");e.classList.add("fa-solid","fa-rotate"),e.addEventListener("click",(()=>{map.getView().setCenter([0,0]),setTimeout((()=>map.getView().setCenter(playerFeature.getGeometry().getCoordinates())),1)})),le.addItem(e,3)}{const e=document.createElement("button"),t=document.createElement("div"),n=document.createElement("div"),i=map.getListeners("click")[0],s=200;let o,r,a=!1,l=[];function c(e){if(!a)return;const t=e.target.getAttribute("sbgcui_guid"),n=o.find((e=>e.getId()==t));n.set("sbgcui_chosenFeature",!0,!0),r.pixel=map.getPixelFromCoordinate(n.getGeometry().getCoordinates()),d(),setTimeout((()=>{i(r)}),s)}function d(){t.childNodes.forEach((e=>{e.classList.remove("sbgcui_cluster-iconWrapper-fullWidth")})),n.classList.remove("sbgcui_cluster-overlay-blur"),setTimeout((()=>{n.classList.add("sbgcui_hidden"),a=!1}),s)}function u(e){r=e,o=map.getFeaturesAtPixel(r.pixel,{hitTolerance:15,layerFilter:e=>"points"==e.get("name")});let t=o.slice();t.length<=1?(t[0]?.set("sbgcui_chosenFeature",!0,!0),i(r)):(t.length>8&&(t=t.reduceRight(g,[])),m(t),p(),l=t)}function g(e,t,n){const i=8-e.length<=n,s=e.length<8,o=l.includes(t);return s?(o&&i||e.push(t),e):e}function p(){n.classList.remove("sbgcui_hidden"),setTimeout((()=>{n.classList.add("sbgcui_cluster-overlay-blur"),a=!0}),10)}function m(e){const n=360/e.length;t.innerHTML="",e.forEach(((e,i)=>{const s=e.getId(),o=document.createElement("div"),r=document.createElement("div"),a=document.createElement("div");W(s,!1).then((e=>{o.style.backgroundImage=e.i?`url("https://lh3.googleusercontent.com/${e.i}=s60")`:"unset",o.style.borderColor=`var(--team-${e.te||0})`,o.style.boxShadow=`0 0 20px 3px var(--team-${e.te||0}), 0 0 5px 2px black`,o.style.setProperty("--sbgcui-point-title",`"${e.t}"`),o.style.setProperty("--sbgcui-point-level",`"${e.l}"`)})),a.classList.add("sbgcui_cluster-iconWrapper"),o.classList.add("sbgcui_cluster-icon"),r.classList.add("sbgcui_cluster-line"),a.style.transform=`rotate(${n*i}deg)`,o.style.transform=`rotate(${-n*i}deg)`,a.append(o,r),t.appendChild(a),setTimeout((()=>{a.classList.add("sbgcui_cluster-iconWrapper-fullWidth")}),10),o.setAttribute("sbgcui_guid",s),o.addEventListener("click",c)}))}e.classList.add("sbgcui_button_reset","sbgcui_cluster-close","fa-solid","fa-circle-xmark"),t.classList.add("sbgcui_cluster-center"),n.classList.add("sbgcui_cluster-overlay","sbgcui_hidden"),n.append(t,e),document.body.appendChild(n),e.addEventListener("click",d),map.un("click",i),map.on("click",u)}}Element.prototype.append=function(){"https://3d.sytes.net/script.js"==arguments[0].src&&Array.prototype.shift.apply(arguments),originalAppend.apply(this,arguments)},fetch("/script.js").then((e=>e.text())).then((e=>{window.addEventListener("load",(()=>{class t extends ol.Map{constructor(e){super(e),map=this,window.dispatchEvent(new Event("mapReady"))}forEachFeatureAtPixel(e,t,n={}){const i=t.toString().includes("showInfo(");if(n.hitTolerance=15,i){const i=(e,n)=>{e.get("sbgcui_chosenFeature")&&(t(e,n),e.unset("sbgcui_chosenFeature",!0))};super.forEachFeatureAtPixel(e,i,n)}else super.forEachFeatureAtPixel(e,t,n)}}class n extends ol.Feature{constructor(e){super(e)}setStyle(e){if(e&&null==playerFeature&&3==e.length&&e[0].image_?.iconImage_.src_.match(/\/icons\/player/)){let t=e[1].getGeometry().setCenter;e[1].getGeometry().setCenter=n=>{t.call(e[1].getGeometry(),n),e[3].getGeometry().setCenter(n)},e[3]=new ol.style.Style({geometry:new ol.geom.Circle(ol.proj.fromLonLat([0,0]),0),stroke:new ol.style.Stroke({color:"#CCCCCC33",width:4})}),playerFeature=this}super.setStyle(e)}}ol.Map=t,ol.Feature=n;let i=document.createElement("script");e=(e=(e=e.replace("const Catalysers = [","window.Catalysers = [")).replace("const TeamColors = [","window.TeamColors = [")).replace("const persist = [","const persist = [/^sbgcui_/, "),i.textContent=e,document.head.appendChild(i)}))})).catch((e=>{alert(`Произошла ошибка при загрузке основного скрипта. ${e.message}`)})),window.addEventListener("mapReady",main);