// ==UserScript==
// @name         SBG CUI
// @namespace    https://sbg-game.ru/app/
// @version      1.14.76
// @downloadURL  https://nicko-v.github.io/sbg-cui/index.min.js
// @updateURL    https://nicko-v.github.io/sbg-cui/index.min.js
// @description  SBG Custom UI
// @author       NV
// @match        https://sbg-game.ru/app/*
// @run-at       document-idle
// @grant        none
// @iconURL      https://nicko-v.github.io/sbg-cui/assets/img/tm_script_logo.png
// ==/UserScript==
!async function(){"use strict";if(window.location.pathname.startsWith("/login"))return;if(document.querySelector('[src="intel.js"]'))return;if(window.stop(),document.open(),0==/firefox/i.test(window.navigator.userAgent))for(let e=0;e<=100;e+=1)window.navigator.geolocation.clearWatch(e);const e=[],t=t=>{e.push({timestamp:Date.now(),messages:t})},n=e=>function(...n){return t(n.map((e=>e?.message?`${e.message}${e.stack?"<br>"+e.stack:""}`:e.toString()))),e(...n)};window.cl=console.log,console.log=n(console.log),console.warn=n(console.warn),console.error=n(console.error),window.onerror=(e,n,o,s,i)=>{t([i.message,`Line: ${o}, column: ${s}`])};const o="https://nicko-v.github.io/sbg-cui",s=window.innerHeight/2*.7,{ACTIONS_REWARDS:i,CORES_ENERGY:a,CORES_LIMITS:r,LINES_LIMIT:c,DISCOVERY_COOLDOWN:l,HIGHLEVEL_MARKER:d,HIT_TOLERANCE:u,INVENTORY_LIMIT:g,INVIEW_MARKERS_MAX_ZOOM:m,INVIEW_POINTS_DATA_TTL:p,INVIEW_POINTS_LIMIT:h,ITEMS_TYPES:f,LATEST_KNOWN_VERSION:b,LEVEL_TARGETS:v,MAX_DISPLAYED_CLUSTER:y,MIN_FREE_SPACE:w,PLAYER_RANGE:E,TILE_CACHE_SIZE:L,POSSIBLE_LINES_DISTANCE_LIMIT:_,BLAST_ANIMATION_DURATION:S}=await fetch(`${o}/const.json`).then((e=>e.json())).catch((e=>{window.alert(`Ошибка при получении ${o}/const.json.\n\n${e.message}`)})),x={},C={},k={},T="cdb"==JSON.parse(localStorage.getItem("settings"))?.base,I=matchMedia("(prefers-color-scheme: dark)").matches,A=window.matchMedia("(orientation: portrait)");let P,q,O,M,N,D="true"==localStorage.getItem("follow");window.addEventListener("dbReady",(function(){fetch("/app").then((e=>e.text())).then((e=>{e=(e=e.replace(/<script class="mobile-check">.+?<\/script>/,"")).replace(/(<script src="\/packages\/js\/ol\.js")(>)/,"$1 onload=\"window.dispatchEvent(new Event('olReady'))\"$2"),document.write(e),document.close()})).catch((e=>{console.log("SBG CUI: Ошибка при получении страницы.",e)}))})),window.addEventListener("olReady",(()=>{!function(){class e extends ol.Map{constructor(e){super(e),P=this,M=e.layers.filter((e=>"lines"==e.get("name")))[1]?.getSource(),window.dispatchEvent(new Event("mapReady"))}forEachFeatureAtPixel(e,t,n={}){const o=t.toString().includes("piv.push");if(n.hitTolerance=isFinite(n.hitTolerance)?n.hitTolerance:u,o){const o=(e,n)=>{e.get("sbgcui_chosenFeature")&&(t(e,n),e.unset("sbgcui_chosenFeature",!0))};super.forEachFeatureAtPixel(e,o,n)}else super.forEachFeatureAtPixel(e,t,n)}}class t extends ol.Feature{setStyle(e){if(e&&null==O&&3==e.length&&e[0].image_?.iconImage_.src_.match(/\/assets\/player/)){let t=e[1].getGeometry().setCenter;e[1].getGeometry().setCenter=n=>{t.call(e[1].getGeometry(),n),e[3].getGeometry().setCenter(n)},e[3]=new ol.style.Style({geometry:new ol.geom.Circle(ol.proj.fromLonLat([0,0]),0),stroke:new ol.style.Stroke({color:"#CCCCCC33",width:4})}),O=this}super.setStyle(e)}get blastRange(){return this==O?this.getStyle()[3].getGeometry():void 0}}class n extends ol.Feature{}class o extends ol.View{constructor(e){A.matches&&(e.padding=[s,0,0,0]),super(e),q=this}fitBlastRange(e){const t=this.getZoom(),n=q.get("isZoomChanged")?t:17;e?this.set("blastRangeZoom",t):(this.removePadding(),this.fit(O.blastRange,{callback:this.fitBlastRange.bind(this),duration:0,maxZoom:n}))}fitTempLine(e,t){this.removePadding(),this.fit(e,{duration:0,maxZoom:17,padding:t})}setTopPadding(){A.matches&&(this.padding=[s,0,0,0])}setBottomPadding(){A.matches&&(this.padding=[0,0,s,0])}removePadding(){this.padding=[0,0,0,0]}}class i extends ol.layer.Tile{constructor(e){e.preload=1/0,super(e)}}class a extends ol.source.XYZ{constructor(e){super({...e,...g})}}class r extends ol.source.OSM{constructor(e){super({...e,...g})}}class c extends ol.source.StadiaMaps{constructor(e){super({...e,...g})}}function l(e,t){const n=e.getTileCoord().join(),o=e.key;N.transaction("tiles","readonly").objectStore("tiles").get(n).addEventListener("success",(s=>{const i=s.target.result||{},a=i[o];null==a?fetch(t).then((e=>{if(e.ok)return e.blob();throw new Error(`[HTTP ${e.status}] Не удалось загрузить тайл ${n}.`)})).then((t=>{d(e,t),N.transaction("tiles","readwrite").objectStore("tiles").put({[o]:t,...i},n)})).catch((e=>{console.log("SBG CUI: Ошибка при получении тайла.",e)})):d(e,a)}))}function d(e,t){const n=e.getImage(),o=URL.createObjectURL(t);n.addEventListener("load",(()=>{URL.revokeObjectURL(o)})),n.src=o}const g={cacheSize:L,tileLoadFunction:l};ol.Map=e,ol.View=o,ol.Feature=t,ol.PointFeature=n,ol.layer.Tile=i,ol.source.XYZ=a,ol.source.OSM=r,ol.source.StadiaMaps=c}(),function(){function e(e){switch(o+=1,e){case"const Catalysers":return"window.Catalysers";case"const TeamColors":return"window.TeamColors";case"new ol.Feature({":return"new ol.PointFeature({";case"constrainResolution: true":return"constrainResolution: false";case"movePlayer([coords.longitude, coords.latitude])":return`${e};\n\t\t\t\t\t\t\t\t\twindow.dispatchEvent(new Event('playerMove'));\n\t\t\t\t\t\t\t\t\tif (!document.querySelector('.info.popup').classList.contains('hidden')) {\n\t\t\t\t\t\t\t\t\t\tmanageControls();\n          \t\t\t\t\t$('#i-stat__distance').text(distanceToString(getDistance(point_state.info.c)));\n\t\t\t\t\t\t\t\t\t}`;case"$('body').empty()":return"movePlayer([0,0]); undefined?";case"const attack_slider":return"window.attack_slider";case"const deploy_slider":return"window.deploy_slider";case"const draw_slider":return"window.draw_slider";case"closePopup($('.info'))":return"$('.info').addClass('hidden');";case"if (new_val < 1) new_val = 1":return"if (new_val < 1) new_val = max";case"if ($('.attack-slider-wrp').hasClass('hidden')) {":return`${e}return;`;case"explodeRange(item.l)":return`window.highlightFeature(player_feature, undefined, { once: true, duration: ${S}, radius: Catalysers[item.l].range, color: '#FF0000', width: 5 + item.l / 2 })`;case"$('[name=\"baselayer\"]').on('change', e":return"$('.layers-config__list').on('change', '[name=\"baselayer\"]', e";case"hour: '2-digit'":return`${e}, hourCycle: 'h23', second: '2-digit'`;case"view.setCenter(ol.proj.fromLonLat(entry.c))":return`${e}; window.sbgcuiHighlightFeature(undefined, entry.c);`;case"function initCompass() {":return DeviceOrientationEvent?`${e}return;`:e;case"testuser":return"NickolayV";case"timers.info_controls = setInterval(() => {":return"timers.info_controls = setTimeout(() => {";case"function update() {":return`${e} if (guid !== $('.info').attr('data-guid')) { return; }`;case"delete cooldowns[guid]":return`${e}; manageControls();`;case"function closeDrawSlider() {":return`${e} window.closePopupDecorator(closePopup);`;case"makeEntry(e, data)":return"window.makeEntryDec(e, data, makeEntry)";case"view.calculateExtent(map.getSize()":return`view.calculateExtent([map.getSize()[0], map.getSize()[1] + ${s}]`;case"z: view.getZoom()":return"z: Math.floor(view.getZoom())";case"if (area < 1)":return"if (area < 0)";case"makeItemTitle(item)":return"makeShortItemTitle(item)";case"if (type == 'osm') {":return"if (type.startsWith('stadia')) { source=new ol.source.StadiaMaps({ layer:'stamen_'+type.split('_')[1] })} else if (type == 'osm') {";case"class Bitfield":return"window.openProfile = openProfile; window.requestEntities = requestEntities; window.showInfo = showInfo; window.Bitfield = class Bitfield";default:return o-=1,e}}const t=new RegExp(["(const Catalysers)","(const TeamColors)","((new ol\\.Feature\\({(?=\\s+?geometry: new ol\\.geom\\.Point\\(mpos\\))))","(constrainResolution: true)","(movePlayer\\(\\[coords\\.longitude, coords\\.latitude\\]\\))","(\\$\\('body'\\)\\.empty\\(\\))","(const attack_slider)","(const deploy_slider)","(const draw_slider)","(closePopup\\(\\$\\('\\.info'\\)\\))","(if \\(new_val < 1\\) new_val = 1)","(if \\(\\$\\('\\.attack-slider-wrp'\\)\\.hasClass\\('hidden'\\)\\) {)","(explodeRange\\(item\\.l\\))","(\\$\\('\\[name=\"baselayer\"\\]'\\)\\.on\\('change', e)","(hour: '2-digit')","(view\\.setCenter\\(ol\\.proj\\.fromLonLat\\(entry\\.c\\)\\))","(function initCompass\\(\\) {)","(testuser)","(timers\\.info_controls = setInterval\\(\\(\\) => {)","(function update\\(\\) {)","(delete cooldowns\\[guid\\](?=\\s+?localStorage\\.setItem))","(function closeDrawSlider\\(\\) {)","(makeEntry\\(e, data\\)(?!\\s{))","(view\\.calculateExtent\\(map\\.getSize\\(\\))","(z: view\\.getZoom\\(\\))","(if \\(area < 1\\))","(makeItemTitle\\(item\\)(?!\\s{))","(if \\(type == 'osm'\\) {)","(class Bitfield)"].join("|"),"g"),n=33;let o=0;fetch("/app/script.js").then((e=>e.text())).then((s=>{const i=document.createElement("script");if(i.textContent=s.replace(t,e),o!=n)throw new Error(`SBG CUI: Сделано замен: ${o} вместо ${n}.`);document.head.appendChild(i)})).catch((e=>{alert(`SBG CUI: Ошибка при загрузке основного скрипта. ${e.message}`),console.log("SBG CUI: Ошибка при загрузке основного скрипта.",e)}))}()})),window.addEventListener("mapReady",(async function(){try{const ee=Intl.NumberFormat(i18next.language).formatToParts(1111)[1].value,te=Intl.NumberFormat(i18next.language).formatToParts(1.1)[1].value;class ne{constructor(e,t){this.loot=e,this.refs=t}get isActive(){return!(this.loot&&this.refs)}}class oe{constructor(e){this.coords=e.c,this.guid=e.g,this.team=e.te,this.title=e.t,this.owner=e.o,this.possibleLines=void 0,this.lines={in:e.li.i,out:e.li.o},this.regionsAmount=e.r,this.cores={},this.image=`https://lh3.googleusercontent.com/${e.i}`,this.isVisited=e.u.v,this.isCaptured=e.u.c,fe.removeAttribute("sbgcui-possible-lines"),this.updateCores(e.co),this.owner==t.name&&this.getCaptureDate()}static calculateTotalEnergy(e){if(0==Object.keys(e).length)return 0;let t=0,n=0;for(let o in e)t+=a[e[o].level],n+=e[o].energy;return n/t*100}get emptySlots(){return 6-Object.keys(this.cores).length}get hasEmptySlots(){return this.emptySlots>0}get playerCores(){let e={};for(let n in this.cores){let o=this.cores[n];o.owner==t.name&&(o.level in e?e[o.level]+=1:e[o.level]=1)}return e}get energy(){return oe.calculateTotalEnergy(this.cores)}get energyFormatted(){return Et.format(this.energy)}get coresAmount(){return Object.keys(this.cores).length}get level(){const e=Object.values(this.cores).reduce(((e,t)=>e+t.level),0),t=6-this.coresAmount;return Math.trunc((e+t)/6)}get linesAmount(){return this.lines.in+this.lines.out}get destroyReward(){return i.destroy.core*this.coresAmount+i.destroy.line*this.linesAmount+i.destroy.region*this.regionsAmount}get selectedCoreGuid(){return Ce.querySelector(".selected")?.dataset.guid}get isOutgoingLinesLimitReached(){return this.lines.out>=c.out}get isPossibleLinesRequestNeeded(){return null==this.possibleLines&&0==this.hasEmptySlots&&0==this.isOutgoingLinesLimitReached&&this.team==t.team&&Jt(this.coords)<=_}async getPossibleLines(){const e=JSON.parse(localStorage.getItem("settings")).exref??!1,t="/api/draw?"+new URLSearchParams([["guid",this.guid],["position[]",this.coords[0]],["position[]",this.coords[1]],["exref",e],["sbgcuiPossibleLinesCheck",""]]).toString(),n={headers:Lt,method:"GET"},o=await fetch(t,n);return(await o.json()).data.map((e=>({guid:e.p,title:e.t,distance:e.d})))}getCaptureDate(){N.transaction("logs","readonly").objectStore("logs").index("action_type").getAll("capture").addEventListener("success",(e=>{const t=e.target.result.filter((e=>e.point==this.guid)),n=t[t.length-1];if(0==t.length)return;const o={guid:this.guid,date:new Date(n.timestamp)},s=new CustomEvent("pointCaptureDateFound",{detail:o});window.dispatchEvent(s)}))}updateCores(e){e.forEach((e=>{this.cores[e.g]={energy:e.e,level:e.l,owner:e.o}}));const n=new Event("pointRepaired");if(Pe.dispatchEvent(n),0==this.team&&1==e.length){this.team=t.team;const e={guid:this.guid,date:new Date},n=new CustomEvent("pointCaptured",{detail:e});window.dispatchEvent(n)}this.isPossibleLinesRequestNeeded&&this.getPossibleLines().then((e=>{this.possibleLines=e,fe.setAttribute("sbgcui-possible-lines",this.possibleLines.length)}))}updateDrawings(e,t){this.lines.out+=1,this.regionsAmount+=t,this.possibleLines=this.possibleLines.filter((t=>t.guid!=e)),fe.setAttribute("sbgcui-possible-lines",this.possibleLines.length),xe.innerText=this.lines.out,Be.innerText=this.regionsAmount,Pe.dispatchEvent(new Event("lineDrawn"))}selectCore(e,n){let o,s=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>1==e.t&&!ut.has(e.g))).sort(((e,t)=>e.l-t.l)),i=this.playerCores;switch(e){case"min":o=n?s.find((e=>e.l>n&&(i[e.l]||0)<r[e.l]&&e.l<=t.level)):s.find((e=>(i[e.l]||0)<r[e.l]&&e.l<=t.level));break;case"max":o=s.findLast((e=>e.l<=t.level&&(i[e.l]||0)<r[e.l]));break}Nt(me.querySelector(`[data-guid="${o?.g}"]:not(.is-active)`))}}class se{constructor(e){this.cores=e.co??e.coresAmount,this.energy=e.e??e.energy,this.guid=e.g??e.guid,this.level=e.l??e.level,this.lines={in:e.li?.i??e.lines.in,out:e.li?.o??e.lines.out},this.timestamp=Date.now()}update(e){this.cores=e.co??e.coresAmount??this.cores,this.energy=e.e??e.energy??this.energy,this.guid=e.g??e.guid??this.guid,this.level=e.l??e.level??this.level,this.lines={in:e.li?.i??e.lines?.in??this.lines.in,out:e.li?.o??e.lines?.out??this.lines.out},this.timestamp=Date.now(),wt.getFeatureById(this.guid)?.changed()}get linesAmount(){return this.lines.in+this.lines.out}}class ie extends ol.control.Control{#e=document.createElement("button");#t=!1;#n=document.createElement("div");constructor(e){const t=document.createElement("div");t.classList.add("ol-unselectable","ol-control","sbgcui_toolbar-control"),super({element:t}),this.name=e,this.#e.classList.add("fa","fa-solid-angle-up"),this.#e.addEventListener("click",this.handleExpand.bind(this)),this.#n.classList.add("sbgcui_toolbar"),gt?this.expand():this.collapse(),t.append(this.#n,this.#e)}addItem(e,t){e.style.order=t,this.#n.appendChild(e)}collapse(){this.#e.classList.remove("fa-rotate-180"),this.#e.style.opacity=1,this.#n.classList.add("sbgcui_hidden"),this.#t=!1,N.transaction("state","readwrite").objectStore("state").put(!1,`is${this.name}Opened`)}expand(){this.#e.classList.add("fa-rotate-180"),this.#e.style.opacity=.5,this.#n.classList.remove("sbgcui_hidden"),this.#t=!0,N.transaction("state","readwrite").objectStore("state").put(!0,`is${this.name}Opened`)}handleExpand(){this.#t?this.collapse():this.expand()}}class ae{#o;#s;constructor(e,t,n){this.guid=e,this.name=n||e,this.cooldown=t,this.discoveriesLeft=void 0,this.timeoutID=void 0,this.isActive=1,n||this.#i()}#i(){Ct(this.guid).then((e=>{this.name=e.t})).catch((e=>{console.log("SBG CUI: Ошибка при получении данных точки.",e)}))}#a(){if(this.isActive)if(!qt()&&"Notification"in window&&"granted"==Notification.permission){new Notification(message,{icon:"/icons/icon_512.png"})}else this.showCooldownNotifToast(),"vibrate"in window.navigator&&x.vibration.notifications&&(window.navigator.vibrate(0),window.navigator.vibrate([500,300,500,300,500]))}#r(){this.#a(),this.cooldown=null}#c(e){let t=e-Date.now();clearTimeout(this.timeoutID),this.timeoutID=setTimeout(this.#r.bind(this),t)}hideCooldownNotifToast(){null!=this.#s&&(this.#s.hideToast(),this.#s=void 0)}showCooldownNotifToast(){this.#s=Dt(`"${this.name}": <br>точка остыла.`,"top left",-1,"sbgcui_toast-selection"),this.#s.showToast()}toJSON(){return this.cooldown>Date.now()?this.cooldown:null}get hasActiveCooldown(){return this.cooldown-Date.now()>0}get cooldown(){return this.#o}get timer(){if(!this.cooldown)return"";let e=new Date(this.cooldown-Date.now());if(e<0)return"";return new Intl.DateTimeFormat("ru-RU",{hour:"numeric",minute:"numeric",second:"numeric",timeZone:"UTC"}).format(e)}set cooldown(e){this.#o=e>Date.now()?e:null,this.#o&&(this.discoveriesLeft=void 0,this.#c(this.#o))}}class re{constructor(e,t,n){null==n?(this.time={request:Date.now(),response:void 0},this.request={url:e,options:t},this.status=void 0,this.statusText=void 0,this.response=void 0,this.error=void 0):Object.assign(this,n)}static preCachedLogs=[];static storageName="sbgcui_network-log";static replacer(e,t){if("authorization"==e)return"hidden";if("string"==typeof t)try{return JSON.parse(t)}catch(e){return t}return t}static get fullLog(){let e=JSON.parse(sessionStorage.getItem(re.storageName))??[];return e=e.map((e=>new re(void 0,void 0,e))),e.push(...re.preCachedLogs),e}save(){if(re.preCachedLogs.push(this),re.preCachedLogs.length>=100){const e=JSON.parse(sessionStorage.getItem(re.storageName))??[];try{sessionStorage.setItem(re.storageName,JSON.stringify([...e,...re.preCachedLogs])),re.preCachedLogs=[]}catch(e){sessionStorage.removeItem(re.storageName)}}}setResponse(e){this.time.response=Date.now(),this.response=JSON.parse(JSON.stringify(e))}setStatus(e,t){this.status=e,this.statusText=t}setError(e){switch(null!=this.status&&null==this.time.response&&(this.time.response=Date.now()),typeof e){case"object":this.error={name:e.name,message:e.message};break;case"string":this.error={message:e};break}}get isApiError(){return null!=this.response?.error}get formattedRequest(){return JSON.stringify(this.request,re.replacer,2)}get formattedResponse(){return JSON.stringify(this.response,re.replacer,2)}get formattedError(){let e="";return this.error.name&&(e+=`[${this.error.name}] `),this.error.message&&(e+=`${this.error.message}`),e}get responseTime(){return this.time.response-this.time.request}}window.fetch=Qt(window.fetch),window.Toastify=(Q=window.Toastify,function(e){if(null!=e.text){const t=e.text.replace(/\.$/,""),n=i18next.t("popups.point.range").replace(/\.$/,""),o=i18next.t("popups.network-fail").replace(/\.$/,""),s=i18next.t("popups.lines-none").replace(/\.$/,"");switch(t){case n:e.gravity="top",e.position="right";break;case o:e.gravity="top",e.position="center";break;case s:e.className="error-toast";break}}return 0==e.className?.startsWith("sbgcui_")&&(e.selector=null),Q.defaults.oldestFirst=e.oldestFirst??!0,e.style={fontSize:"0.8em"},Q(e)});const ce=document.documentElement,le=document.querySelector("#attack-menu"),de=document.querySelector(".attack-slider-wrp"),ue=document.querySelector(".bottom-container"),ge=document.querySelector("#catalysers-list"),me=document.querySelector("#cores-list"),pe=document.querySelector(".deploy-slider-wrp"),he=document.querySelector("#discover"),fe=document.querySelector("#draw"),be=document.querySelector(".draw-slider-wrp"),ve=document.querySelector("#inventory__close"),ye=document.querySelector("#ops"),we=document.querySelector(".inventory__content"),Ee=document.querySelector(".inventory.popup"),Le=document.querySelector("#self-info__inv"),_e=document.querySelector(".leaderboard.popup"),Se=document.querySelector("#notifs-menu"),xe=document.querySelector("#i-stat__line-out"),Ce=document.querySelector(".i-stat__cores"),ke=document.createElement("span"),Te=document.querySelector("#i-image"),$e=document.querySelector(".i-image-box"),Ie=document.querySelector("#i-level"),Ae=document.querySelector("#i-stat__owner"),Pe=document.querySelector(".info.popup"),qe=document.querySelector(".info.popup > .popup-close"),Oe=document.querySelector("#i-title"),Me=document.querySelector("#pr-name"),Ne=document.querySelector(".profile.popup"),De=document.querySelector(".profile.popup > .popup-close"),Re=document.querySelector("#i-ref"),Fe=document.querySelector("#refs-list"),je=document.querySelector(".pr-stat__age > .pr-stat-val"),Be=document.querySelector("#i-stat__region"),Ge=document.querySelector("#self-info__exp"),He=document.querySelector("#self-info__explv"),Ue=document.querySelector("#self-info__name"),Je=document.querySelector(".topleft-container"),ze=document.querySelector("#toggle-follow"),Ve=document.querySelector('meta[name="viewport"]'),Ze=document.querySelector(".xp-diff"),We=document.querySelector(".ol-zoom");let Ye,Xe,Ke=!Ee.classList.contains("hidden"),Qe=!Pe.classList.contains("hidden"),et=!Ne.classList.contains("hidden"),tt=!de.classList.contains("hidden"),nt=!be.classList.contains("hidden"),ot=!_e.classList.contains("hidden"),st=!1,it=!1,at=!1,rt=!1,ct=!1,lt=!1,dt={},{excludedCores:ut,isMainToolbarOpened:gt,isRotationLocked:mt,isStarMode:pt,lastUsedCatalyser:ht,starModeTarget:ft,versionWarns:bt}=C;const vt={c:new Set,v:new Set},yt={},wt=P.getLayers().getArray().find((e=>"points"==e.get("name"))).getSource(),Et=new Intl.NumberFormat(i18next.language,{maximumFractionDigits:1}),Lt={authorization:`Bearer ${localStorage.getItem("auth")}`,"accept-language":i18next.language};let _t;async function St(){const e={headers:Lt,method:"GET"},t=await fetch("/api/self",e),n=await t.json(),o=t.headers.get("SBG-Version");return _t=o,n}async function xt(e,t){const n="/api/profile?"+(e?"guid="+e:"name="+t),o={headers:Lt,method:"GET"},s=await fetch(n,o);return await s.json()}async function Ct(e,t=!0){const n=`/api/point?guid=${e}${t?"&status=1":""}`,o={headers:Lt,method:"GET"},s=await fetch(n,o);return(await s.json()).data}async function kt(){const e={headers:Lt,method:"GET"},t=await fetch("/api/inventory",e);return(await t.json()).i}async function Tt(e){const t=ol.proj.toLonLat(O.getGeometry().getCoordinates()),n={headers:{...Lt,"content-type":"application/json"},method:"POST",body:JSON.stringify({guid:e,position:t})},o=await fetch("/api/repair",n);return await o.json()}async function $t(e,t){const n={headers:{...Lt,"content-type":"application/json"},method:"DELETE",body:JSON.stringify({selection:e,tab:t})},o=await fetch("/api/inventory",n);return await o.json()}async function It(e){const t=`${o}/assets/html/${e}.html`,n=await fetch(t);if(200!=n.status)throw new Error(`Ошибка при загрузке ресурса "${e}.html" (${n.status})`);const s=await n.text();return(new DOMParser).parseFromString(s,"text/html").body.firstChild}async function At(e=!1,n=[]){if(lt)return[];lt=!0;const o=x.maxAmountInBag,s={};try{const i=await kt(),a=i.reduce(((e,t)=>e+t.a),0),r=g-a>=w,c=n.some((e=>e.isFiltered)),{allied:l,hostile:d}=o.references,u={};let m=[],p={},h=1/0,b="";if(r&&!e&&!c)return[];if(!r||e){const e=0==l&&0==d,n=-1==l&&-1==d;if(!e&&!n){const e=i.filter((e=>3==e.t));m=await Promise.all(e.map((e=>Ct(e.l)))),p=Object.fromEntries(m.map((e=>[e.g,e.te])))}i.forEach((i=>{const{t:a,l:r,l:c,a:l,g:d}=i;if(a>f.length-1)return;const u=f[a];let g=-1,m=0;if("references"==u){if(pt&&c==ft?.guid)g=-1;else if(k[c]?.isActive)g=-1;else if(n)g=-1;else if(e)g=0;else if(Object.keys(p).length){const e=p[c],n=e==t.team?"allied":"hostile";g=void 0===e?-1:o[u][n]}}else g=o[u]?.[r]??-1;-1!=g&&l>g&&(m=l-g),m>0&&(s[a]=s[a]??{},s[a][d]={amount:m})}))}if(n.forEach((e=>{const{amount:t,isFiltered:n,guid:o,type:a}=e;if(n){const e=i.find((e=>e.g==o))?.a;s[a]=s[a]??{},s[a][o]=s[a][o]??{amount:0},s[a][o].amount=Math.min(s[a][o].amount+t,e??1/0),s[a][o].uncached=t,s[a][o].filtered=t}else null!=s[a]?.[o]&&(s[a][o].uncached=t)})),0==Object.keys(s).length)return[];for(let e in s){const t=Object.entries(s[e]),n=Object.fromEntries(t.map((e=>[e[0],e[1].amount]))),o=await $t(n,e);"count"in o?(o.count.total<h&&(h=o.count.total),u[e]=u[e]??0,u[e]+=t.reduce(((e,t)=>e+(t[1].amount-(t[1].filtered??0))),0)):delete s[e]}for(let e in u){if(u[e]>0){const t=i18next.t(`items.types.${f[e].slice(0,-1)}`);b+=`<br><span style="background: var(--sbgcui-branding-color); margin-right: 5px;" class="item-icon type-${e}"></span>x${u[e]} ${t}`}}b.length&&Rt(`Удалено: ${b}`),isFinite(h)&&(Le.innerText=h,ye.style.color.match("accent")&&h<g&&(ye.style.color="")),Ot(s)}catch(e){Rt(`Ошибка при проверке или очистке инвентаря. <br>${e.message}`,void 0,void 0,"error-toast"),console.log("SBG CUI: Ошибка при удалении предметов.",e)}finally{return lt=!1,s}}function Pt(e,t){const n=JSON.stringify(e),o={status:t.status,statusText:t.statusText,headers:t.headers},s=new Response(n,o);return Object.defineProperty(s,"url",{value:t.url,enumerable:!0}),s}function qt(){return"maxTouchPoints"in window.navigator?window.navigator.maxTouchPoints>0:"msMaxTouchPoints"in window.navigator?window.navigator.msMaxTouchPoints>0:"orientation"in window||/\b(BlackBerry|webOS|iPhone|IEMobile|Android|Windows Phone|iPad|iPod)\b/i.test(window.navigator.userAgent)}function Ot(e){let t=JSON.parse(localStorage.getItem("inventory-cache"))||[];for(let n in e)for(let o in e[n]){const s=e[n][o],i=t.find((e=>e.g==o)),a=s.amount-(s.uncached??0),r=1==n?pe:2==n?de:void 0;if(i&&(i.a-=a),null!=r&&a>0){const e=r.querySelector(`li[data-guid="${o}"]`);if(null==e)continue;const t=e.querySelector(`li[data-guid="${o}"] > .${1==n?"cores":"catalysers"}-list__amount`),s=+t.innerText.slice(1);s-a>0?t.innerText="x"+(s-a):(e.remove(),window[(r==de?"attack":"deploy")+"_slider"].refresh())}}t=t.filter((e=>e.a>0)),localStorage.setItem("inventory-cache",JSON.stringify(t))}function Mt(e){let n,o=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>2==e.t&&e.l<=t.level)).sort(((e,t)=>e.l-t.l));switch(e){case"latest":if(n=de.querySelector(`[data-guid="${ht}"]`),n)break;case"max":n=de.querySelector(`[data-guid="${o[o.length-1].g}"]`);break}return n}function Nt(e){let t=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0}),n=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0}),o=new MouseEvent("click",{bubbles:!0,cancelable:!0});e?.dispatchEvent(t),e?.dispatchEvent(n),e?.dispatchEvent(o)}function Dt(e="",t="top left",n=3e3,o="interaction-toast",s=!0){let i=t.split(/\s+/),a=Toastify({node:e instanceof Element?e:void 0,text:e instanceof Element?void 0:e,duration:n,gravity:i[0],position:i[1],escapeMarkup:!1,className:o,oldestFirst:s});return a.options.id=Math.round(1e5*Math.random()),a.options.onClick=()=>a.hideToast(),a}function Rt(...e){Dt(...e).showToast()}function Ft(e){let t=new Intl.NumberFormat("en-GB"),n=0;for(let o=0;o<v.length;o+=1)if(n+=v[o],n>e)return Ge.innerText=n!=1/0?`${t.format(e-(n-v[o]))} / ${t.format(v[o])}`:t.format(e),void(He.innerText=o+1)}function jt(e){let t,n=/ya-title=.*?,\sya-dock=.*?(?=,|$)/;switch(e){case"map":t=getComputedStyle(Ue).color;break;case"profile":t=getComputedStyle(Me).color,Ne.style.borderColor=t;break;case"point_level":t=getComputedStyle(Ie).color,Pe.style.background=x.ui.pointBgImage?`radial-gradient(circle, rgba(0,0,0,0.3) 65%, ${t} 100%)`:"",Pe.style.borderColor=t,Oe.style.color=t;break;case"point_team":t=getComputedStyle(Ae).color,Pe.style.background=x.ui.pointBgImage?`radial-gradient(circle, rgba(0,0,0,0.3) 65%, ${t} 100%)`:"",Pe.style.borderColor=t,Oe.style.color=t;break;default:t="";break}var o;t=(o=t)?`#${o.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map((e=>parseInt(e,10).toString(16).padStart(2,"0"))).join("")}`:"",X.content=t,Ve.content.match(n)?Ve.content=Ve.content.replace(n,`ya-title=${t}, ya-dock=${t}`):Ve.content+=`, ya-title=${t}, ya-dock=${t}`}function Bt(e){if(0==e)return;let t=document.createElement("span");t.classList.add("sbgcui_xpdiff"),t.innerText=`+${e}xp`,K.appendChild(t),setTimeout((e=>{t.classList.add("sbgcui_xpdiff-out")}),100),setTimeout((e=>{K.removeChild(t)}),3e3)}function Gt(e,t=!0){return t?`#${[...e].filter(((e,t)=>t%2)).join("")}`:`#${[...e].map(((e,t,n)=>t%2?e:n[t-1])).join("")}`}function Ht(e){return[...e].map((e=>"#"==e?e:e+e)).join("")}function Ut(e,t){return e*(t=t||1/ol.proj.getPointResolution("EPSG:3857",1,q.getCenter(),"m"))}function Jt(e,t=O.getGeometry().getCoordinates()){const n=new ol.geom.LineString([t,ol.proj.fromLonLat(e)]);return ol.sphere.getLength(n)}function zt(e,t){return Jt(t??ol.proj.toLonLat(e.getGeometry().getCoordinates()))<E}function Vt(e){const t=Date.parse(e),n=Date.now();return Math.trunc((n-t)/1e3/60/60/24)}function Zt(){Je.classList.add("sbgcui_hidden"),ue.classList.add("sbgcui_hidden"),We.childNodes.forEach((e=>{!e.matches(".ol-zoom-in, .ol-zoom-out, #toggle-follow")&&e.classList.add("sbgcui_hidden")})),We.style.bottom="50%",P.removeControl(T)}function Wt(){Je.classList.remove("sbgcui_hidden"),ue.classList.remove("sbgcui_hidden"),We.childNodes.forEach((e=>{e.classList.remove("sbgcui_hidden")})),We.style.bottom="",P.addControl(T)}function Yt(e){const t=Date.now();N.transaction("logs","readwrite").objectStore("logs").put({timestamp:t,...e})}function Xt(e){const t=ol.proj.fromLonLat(e);D&&Nt(ze),document.querySelectorAll(".popup").forEach((e=>{e.classList.add("hidden")})),q.adjustCenter([0,s/-2]),q.setCenter(t),q.setZoom(17)}function Kt(e,t=[],n){function o(){ol.Observable.unByKey(g),I.removeFeature(c)}n={once:!1,radius:20,duration:1500,color:"#CCBB00",width:5,...n};let s=Date.now();const i=null!=e?e.getGeometry().getCoordinates():ol.proj.fromLonLat(t),a=q.getResolution(),r=new ol.geom.Point(i),c=new ol.Feature({geometry:r}),l=new ol.style.Stroke({color:n.color,width:n.width}),d=new ol.style.Circle({opacity:1,radius:0,stroke:l}),u=new ol.style.Style({image:d}),g=R.on("postrender",(function(e){const t=e.frameState.time-s;if(t<n.duration){const o=ol.render.getVectorContext(e),s=t/n.duration,i=ol.easing.easeOut(s)*(Ut(n.radius)/a),u=ol.easing.easeOut(1-s);l.setWidth(n.width*(1-s)),d.setRadius(i),d.setOpacity(u),d.setStroke(l),c.changed(),o.drawGeometry(r)}else{if(1==n.once)return void o();s=Date.now()}P.render()}));c.set("type","highlighter"),c.setStyle(u),I.addFeature(c),P.once("click",o)}function Qt(e){return async function(t,n){return new Promise(((o,s)=>{const i=new URL(window.location.origin+t);let a;switch(i.pathname){case"/api/attack2":const e=JSON.parse(n.body).guid,t=JSON.parse(localStorage.getItem("inventory-cache")),s=`Использовать "${i18next.t("items.brooms_one")}"?`;if(a=void 0!==t.find((t=>4==t.t&&t.g==e)),a&&!confirm(s))return o(),void de.dispatchEvent(new Event("attackSliderOpened"));break;case"/api/inview":if(it)return void o();let r=Object.values(x.pointHighlighting).find((e=>e.match(/uniqc|uniqv/)));if(r){const e="uniqc"==r?4:2;i.searchParams.set("h",e)}const c=JSON.parse(localStorage.getItem("map-config")),l=Bitfield.from(c.l);l.change(1,1),l.change(2,1),i.searchParams.set("l",l.toString());break}const r=new re(i.pathname+i.search,n);e(i.pathname+i.search,n).then((async e=>{if(r.setStatus(e.status,e.statusText),!i.pathname.match(/^\/api\//))return o(e),r.setResponse("--- data not stored ---"),void r.save();e.clone().json().then((async t=>{switch(r.setResponse(t),r.save(),i.pathname){case"/api/point":if("data"in t&&null==i.searchParams.get("status")){const e=t.data,n=e.g;dt=new oe(e),null==yt[n]?dt.coresAmount>0&&(yt[n]=new se(dt)):yt[n].update(dt)}break;case"/api/deploy":if("data"in t){const e=t.data.co;dt.updateCores(e),dt.selectCore(x.autoSelect.deploy);const{coords:n,guid:o,level:s,title:i,isCaptured:a}=dt;Yt({type:1==e.length?a?"capture":"uniqcap":"deploy",coords:n,level:s,point:o,title:i}),null==yt[o]?yt[o]=new se(dt):yt[o].update(dt)}else if("c"in t){dt.updateCores([t.c],t.l),dt.selectCore(x.autoSelect.upgrade,t.c.l);const{coords:e,level:n,guid:o,title:s}=dt;Yt({type:"upgrade",coords:e,level:n,point:o,title:s})}break;case"/api/attack2":if(ht=JSON.parse(n.body).guid,N.transaction("state","readwrite").objectStore("state").put(ht,"lastUsedCatalyser"),"c"in t){const e=t.c.filter((e=>0==e.energy)).map((e=>e.guid));if(e.length>0){const n=t.l.length,o=t.r.length,s=t.xp.diff,i=Math.trunc(Math.max(...t.l.map((e=>Date.now()-new Date(e.created_at))),0)/1e3/60/60/24),r=Math.trunc(Math.max(...t.r.map((e=>Date.now()-new Date(e.created_at))),0)/1e3/60/60/24);Yt({type:a?"broom":"destroy",points:e,lines:n,regions:o,oldestLineDays:i,oldestRegionDays:r,xp:s}),e.forEach((e=>{const t=e.guid;delete yt[t]}))}t.c.forEach((e=>{e.guid in yt&&(yt[e.guid].energy=100*e.energy)}))}break;case"/api/discover":const s=JSON.parse(n.body).guid;if(s in k&&k[s].hideCooldownNotifToast(),"loot"in t){let n=t.loot;Yt({type:"discover",point:s,title:dt.title,level:dt.level,loot:n.map((e=>({t:e.t,l:3==e.t?void 0:e.l,a:e.a})))}),t.loot.sort(((e,t)=>e.t==t.t?e.t<3&&t.t<3?t.l-e.l:e.t<3?e.t:t.t:e.t-t.t)),n=n.map((e=>{const t={guid:e.g,type:e.t,amount:e.a};return(0==Ye.refs&&3==e.t||0==Ye.loot&&(1==e.t||2==e.t))&&(t.isFiltered=!0),t})),n.some((e=>e.isFiltered))&&(t.loot=t.loot.filter((e=>Ye.refs?3==e.t||4==e.t:3!=e.t)));const i=await At(!1,n);t.loot.forEach((e=>{e.a-=i[e.t]?.[e.g]?.amount??0})),t.loot=t.loot.filter((e=>e.a>0)),t.loot.find((e=>3==e.t))&&window.dispatchEvent(new Event("refAquired"));const a=Pt(t,e);o(a)}if("burnout"in t||"cooldown"in t){let e,n=Date.now();if(t.burnout<=20)e=t.burnout;else if(t.cooldown<=l||t.burnout<n)break;if(s in k){if(e){k[s].discoveriesLeft=e;break}if(k[s].hasActiveCooldown)break;let o=t.burnout||n+1e3*t.cooldown;k[s].cooldown=o,k.save()}}break;case"/api/inview":const r=t.p,c=+i.searchParams.get("z"),d=JSON.parse(localStorage.getItem("map-config")),u=i.searchParams.get("l");if(d.l==u)o(e);else{const n=Bitfield.from(d.l);0==n.get(1)&&(t.l=[]),0==n.get(2)&&(t.r=[]);const s=Pt(t,e);o(s)}const g=i.searchParams.get("h"),f=null!=g,b=null!=Object.values(x.pointHighlighting).find((e=>e.match(/cores|energy|highlevel|level/)));if(!r)break;if(b&&c>=m){let e=r.filter((e=>(!e.t&&delete yt[e.g],0!=e.t)));if(e.length<=h){(e.map((e=>e.g))||[]).forEach((e=>{Date.now()-yt[e]?.timestamp<p||Ct(e).then((t=>{yt[e]=new se(t)})).catch((()=>{yt[e]={timestamp:Date.now()}}))}))}}f&&r?.forEach((e=>{const t=4==g?"c":"v";e.h?vt[t].add(e.g):vt[t].delete(e.g)}));break;case"/api/draw":if("line"in t){const{from:e,to:o}=JSON.parse(n.body),s=t.reg.map((e=>e.a)),i=e==dt.guid?dt.title:void 0,a=dt.possibleLines.find((e=>e.guid==o))?.title,r=dt.possibleLines.find((e=>e.guid==o))?.distance;Yt({type:"draw",from:e,to:o,fromTitle:i,toTitle:a,distance:r,regions:s}),dt.updateDrawings(o,s.length),yt[e]?.update({lines:{out:yt[e].lines.out+1}})}else if("data"in t){const s=null!=i.searchParams.get("sbgcuiPossibleLinesCheck");let{minDistance:a,maxDistance:r,hideLastFavRef:c}=x.drawing;if(a=-1==a?-1/0:+a,r=-1==r?1/0:+r,pt&&ft&&ft.guid!=Pe.dataset.guid&&/get/i.test(n.method)){const e=t.data.find((e=>e.p==ft.guid)),n=t.data.length-(e?1:0);if(t.data=e?[e]:[],n>0&&0==s){Dt(`Точк${1==n?"а":"и"} (${n}) скрыт${1==n?"а":"ы"}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tиз списка, так как вы находитесь в режиме рисования "Звезда".`,"top left",void 0,"sbgcui_toast-selection").showToast()}}if(isFinite(a)||isFinite(r)){const e=t.data.filter((e=>e.d<=r&&e.d>=a)),n=t.data.length-e.length;if(t.data=e,n>0&&0==s){Dt(`Точк${1==n?"а":"и"} (${n}) скрыт${1==n?"а":"ы"}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tиз списка согласно настройкам ограничения дальности рисования\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(${isFinite(a)?"мин. "+a+" м":""}${isFinite(a+r)?", ":""}${isFinite(r)?"макс. "+r+" м":""}).`,"top left",void 0,"sbgcui_toast-selection").showToast()}}if(c){let e=0;if(t.data=t.data.filter((t=>!(t.p in k&&k[t.p].isActive&&1==t.a)||(e+=1,!1))),e>0&&0==s){Dt(`Точк${1==e?"а":"и"} (${e}) скрыт${1==e?"а":"ы"}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tиз списка согласно настройке сохранения последних сносок от избранных точек.`,"top left",void 0,"sbgcui_toast-selection").showToast()}}const l=Pt(t,e);o(l)}break;case"/api/profile":"name"in t&&je.style.setProperty("--sbgcui-reg-date",Vt(t.created_at));break;case"/api/repair":if("data"in t){const e=JSON.parse(n.body).guid;if(Qe&&dt.updateCores(t.data),e in yt){const n=t.data.reduce(((e,t)=>(e[t.g]={energy:t.e,level:t.l},e)),{}),o=oe.calculateTotalEnergy(n);yt[e]?.update({energy:o})}}break;case"/api/score":if("score"in t){const[e,n]=t.score,o=document.querySelectorAll(".score__table > tbody td:first-of-type"),s=document.querySelectorAll(".score__table > tbody td:last-of-type");delete e.check,delete n.check;const[i,a]=[e,n].map((e=>Object.fromEntries(Object.entries(e).sort(((e,t)=>t[1]-e[1])).map(((e,t)=>[e[0],t])))));o.forEach(((e,t)=>{e.style.gridArea=`p${i[0==t?"r":1==t?"g":"b"]}`})),s.forEach(((e,t)=>{e.style.gridArea=`r${a[0==t?"r":1==t?"g":"b"]}`}))}break;case"/api/leaderboard":if(!("d"in t))break;const v=t.d.reduce(((e,t)=>(e[t.t]=e[t.t]??0,e[t.t]+=t.s,e)),[]),y=v.findIndex((e=>e==Math.max(...v.flat())));_e.style.setProperty("--sbgcui-top-team",`var(--team-${y})`);break;default:return void o(e)}})).catch((e=>{console.log("SBG CUI: Ошибка при обработке ответа сервера.",e),r.setError(e),r.save()})).finally((()=>{o(e)}))})).catch((e=>{r.setError(e),r.save(),s(e)}))}))}}function en(e){switch(x.drawing.returnToPointInfo){case"off":e($(Pe));break;case"always":Pe.classList.remove("hidden");break;case"discoverable":const t=dt.guid,n=wt.getFeatureById(t),o=JSON.parse(localStorage.getItem("cooldowns"))[t]?.t||0,s=zt(n,dt.coords),i=new Date(o)-Date.now()<=0;s&&i?Pe.classList.remove("hidden"):e($(Pe));break}}function tn(e){const t=N.transaction("tiles","readwrite").objectStore("tiles"),n=e.target;n.disabled=!0,n.innerText=i18next.t("sbgcui.calculatingTilesCache"),t.getAll().addEventListener("success",(e=>{const o=new Set,s=e.target.result.reduce(((e,t)=>{const n=Object.keys(t),s=Object.values(t);return n.forEach((e=>{o.add(e)})),e.amount+=n.length,e.size+=s.reduce(((e,t)=>e+=t.size),0),e}),{amount:0,size:0}),i=s.amount,a=+(s.size/1024/1024).toFixed(1),r=i18next.t("sbgcui.clearTilesCacheConfirm",{amount:i,size:a,baselayers:o.size});confirm(r)&&t.clear(),n.disabled=!1,n.innerText=i18next.t("sbgcui.clearTilesCache")}))}pt=pt&&null!=ft,window.closePopupDecorator=en,window.sbgcuiHighlightFeature=Kt;{const e=await St(),n=N.transaction("state","readwrite").objectStore("state");if(b!=_t){if(bt<2){const e=`Текущая версия игры (${_t}) не соответствует последней известной версии (${b}). Возможна некорректная работа.`;Dt(e,void 0,void 0,"error-toast").showToast(),n.put(bt+1,"versionWarns")}}else n.put(0,"versionWarns");var t={name:e.n,team:e.t,exp:{total:e.x,current:e.x-v.slice(0,e.l-1).reduce(((e,t)=>t+e),0),goal:v[e.l-1],get percentage(){return this.goal==1/0?100:this.current/this.goal*100},set string(e){[this.current,this.goal=1/0]=e.replace(/\s|,/g,"").split("/")}},auth:localStorage.getItem("auth"),guid:e.g,feature:O,teamColor:getComputedStyle(ce).getPropertyValue(`--team-${e.t}`),get level(){return this._level},set level(e){this._level=+e.split("").filter((e=>e.match(/[0-9]/))).join("")},_level:e.l}}{let{mapFilters:e,ui:n}=x,s=document.createElement("style"),i=document.createElement("link"),a=document.createElement("link"),r=document.createElement("link");s.innerHTML=`\n      \t\t:root {\n      \t\t  --sbgcui-player-exp-percentage: ${t.exp.percentage}%;\n      \t\t  --sbgcui-inventory-limit: "${g}";\n      \t\t  --sbgcui-invert: ${e.invert};\n      \t\t  --sbgcui-hueRotate: ${e.hueRotate}deg;\n      \t\t  --sbgcui-brightness: ${e.brightness};\n      \t\t  --sbgcui-grayscale: ${e.grayscale};\n      \t\t  --sbgcui-sepia: ${e.sepia};\n      \t\t  --sbgcui-blur: ${e.blur}px;\n      \t\t  --sbgcui-point-bg: #ccc;\n      \t\t  --sbgcui-point-image: '';\n      \t\t  --sbgcui-point-image-blur: ${n.pointBgImageBlur?2:0}px;\n      \t\t  --sbgcui-point-btns-rtl: ${n.pointBtnsRtl?"rtl":"ltr"};\n\t\t\t\t\t\t--sbgcui-show-speedometer: ${n.speedometer};\n\t\t\t\t\t\t--sbgcui-branding-color: ${"custom"==e.branding?e.brandingColor:t.teamColor};\n\t\t\t\t\t\t--team-${t.team}: var(--sbgcui-branding-color);\n      \t\t}\n  \t\t\t`,"custom"==e.branding&&(window.TeamColors[t.team].fill=e.brandingColor+"80",window.TeamColors[t.team].stroke=Gt(e.brandingColor)),[i,a,r].forEach((e=>e.setAttribute("rel","stylesheet"))),i.setAttribute("href",`${o}/styles.min.css`),a.setAttribute("href",`${o}/assets/fontawesome/css/fa.min.css`),r.setAttribute("href",`${o}/assets/fontawesome/css/fa-svg.min.css`),document.head.append(s,a,r,i)}new MutationObserver(((e,n)=>{n.disconnect(),t.level=He.textContent,He.innerText=(t.level<=9?"0":"")+t.level,n.observe(He,{childList:!0})})).observe(He,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointLevelChanged",{bubbles:!0});Ie.dispatchEvent(t)})).observe(Ie,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointOwnerChanged",{bubbles:!0});Ae.dispatchEvent(t)})).observe(Ae,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointCoresUpdated",{bubbles:!0});Ce.dispatchEvent(t)})).observe(Ce,{childList:!0}),new MutationObserver((e=>{let t;e[0].target.classList.contains("hidden")?(t=new Event("pointPopupClosed"),Qe=!1):e[0].oldValue?.includes("hidden")&&(t=new Event("pointPopupOpened"),Qe=!0),t&&e[0].target.dispatchEvent(t)})).observe(Pe,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),new MutationObserver((e=>{let t;e[0].target.classList.contains("hidden")?(t=new Event("leaderboardPopupClosed"),ot=!1):e[0].oldValue?.includes("hidden")&&(t=new Event("leaderboardPopupOpened"),ot=!0),t&&e[0].target.dispatchEvent(t)})).observe(_e,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),new MutationObserver((e=>{et=!e[0].target.classList.contains("hidden");let t=new Event(et?"profilePopupOpened":"profilePopupClosed",{bubbles:!0});e[0].target.dispatchEvent(t)})).observe(Ne,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{Ke=!e[0].target.classList.contains("hidden");let t=new Event(Ke?"inventoryPopupOpened":"inventoryPopupClosed");e[0].target.dispatchEvent(t)})).observe(Ee,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{tt=!e[0].target.classList.contains("hidden");let t=new Event(tt?"attackSliderOpened":"attackSliderClosed");e[0].target.dispatchEvent(t)})).observe(de,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{nt=!e[0].target.classList.contains("hidden");let t=new Event(nt?"drawSliderOpened":"drawSliderClosed");e[0].target.dispatchEvent(t)})).observe(be,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{Bt(e.find((e=>e.addedNodes.length)).addedNodes[0].data.match(/\d+/)[0])})).observe(Ze,{childList:!0}),new MutationObserver((()=>{if(Array.from(document.querySelectorAll('.inventory__content[data-tab="3"] > .inventory__item')).every((e=>e.classList.contains("loaded")))){let e=new Event("refsListLoaded");we.dispatchEvent(e)}})).observe(we,{subtree:!0,attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{if(!tt)return;const t=[...e].filter((e=>"attributes"==e.type)),n=[...e].filter((e=>"childList"==e.type)),o=t.some((e=>e.oldValue.includes("is-active")&&!e.target.classList.contains("is-active"))),s=n.length>0&&n.every((e=>1==e.addedNodes.length&&0==e.removedNodes.length));if(o||s){let e=new Event("activeSlideChanged");ge.dispatchEvent(e)}})).observe(ge,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"],attributeOldValue:!0}),new MutationObserver((e=>{let t=new Event("coresListUpdated");me.dispatchEvent(t)})).observe(me,{childList:!0}),new MutationObserver((e=>{D="true"==ze.dataset.active,n.setActive(!D)})).observe(ze,{attributes:!0,attributeFilter:["data-active"]});le.addEventListener("click",(()=>{le.classList.toggle("sbgcui_attack-menu-rotate")})),Pe.addEventListener("pointPopupOpened",(()=>{let e=JSON.parse(localStorage.getItem("settings"))||{};x.ui.pointBgImage?(ce.style.setProperty("--sbgcui-point-image",e.imghid?"":`url("${dt.image}")`),Pe.classList.add("sbgcui_point-popup-bg"),Te.classList.add("sbgcui_no_bg_image")):(ce.style.setProperty("--sbgcui-point-image",""),Pe.style.backgroundImage="",Pe.classList.remove("sbgcui_point-popup-bg"),Te.classList.remove("sbgcui_no_bg_image")),ke.innerText=`${dt.energyFormatted}% @ ${dt.coresAmount}`})),Pe.addEventListener("pointRepaired",(()=>{ke.innerText=`${dt.energyFormatted}% @ ${dt.coresAmount}`})),document.addEventListener("backbutton",(()=>(et?Nt(qe):Qe&&Nt(De),!1))),document.querySelector('.inventory__tab[data-tab="3"]').addEventListener("click",(()=>{let e=document.querySelector('.inventory__tab[data-tab="3"] > .inventory__tab-counter'),t=JSON.parse(localStorage.getItem("inventory-cache")).reduce(((e,t)=>3==t.t?e+t.a:e),0),n=we.childNodes.length;e.innerText=n,setTimeout((()=>{e.innerText=t}),1e3)})),ze.addEventListener("touchstart",(()=>{let e=Date.now(),n=setTimeout((function e(n){n||q.animate({center:t.feature.getGeometry().getCoordinates()},{zoom:17},{rotation:0},e)}),500);this.addEventListener("touchend",(()=>{Date.now()-e<1e3&&clearTimeout(n)}),{once:!0})})),be.addEventListener("drawSliderOpened",(()=>{q.setBottomPadding(),q.set("beforeDrawZoom",q.getZoom()),Zt(),window.draw_slider.emit("active",{slide:be.querySelector(".splide__slide.is-active")})})),be.addEventListener("drawSliderClosed",(()=>{const e=O.getGeometry().getCoordinates(),t=q.get("beforeDrawZoom")||17;q.setTopPadding(),q.setCenter(e),q.setZoom(t),Wt()})),A.addEventListener("change",(()=>{A.matches?q.setTopPadding():q.removePadding(),q.setCenter(O.getGeometry().getCoordinates())})),window.addEventListener("refAquired",(()=>{Re.classList.add("sbgcui_heartBeat")})),Re.addEventListener("animationend",(()=>{Re.classList.remove("sbgcui_heartBeat")})),Pe.addEventListener("pointPopupClosed",(()=>{Re.classList.remove("sbgcui_heartBeat")}));{const e=document.querySelector("#ops"),n=document.querySelector(".ol-rotate"),o=document.querySelector("#layers"),s=document.querySelector("#attack-slider-close"),i=document.createElement("div"),a=document.createElement("span"),r=document.querySelector("#i-stat__owner").parentElement,c=document.querySelector(".attack-slider-highlevel"),l=document.querySelectorAll(".popup-close, #inventory__close"),d=fe.childNodes[0],u=document.createElement("span");de.prepend(c),document.querySelectorAll('[data-i18n="self-info.name"], [data-i18n="self-info.xp"], [data-i18n="units.pts-xp"], [data-i18n="self-info.inventory"], [data-i18n="self-info.position"]').forEach((e=>{e.remove()})),document.querySelectorAll(".self-info__entry").forEach((e=>{let t=[];e.childNodes.forEach((e=>{3==e.nodeType&&t.push(e)})),t.forEach((e=>{e.remove()}))})),document.querySelector(".i-stat__tools").remove(),s.remove(),le.childNodes[0].remove(),o.innerText="",o.classList.add("fa","fa-solid-layer-group"),Se.innerText="",Se.classList.add("fa","fa-solid-envelope"),We.append(n,ze,Se,o),ze.innerText="",ze.classList.add("fa","fa-solid-location-crosschairs"),ue.appendChild(e),e.replaceChildren(Le),He.innerText=(t.level<=9?"0":"")+t.level,i.classList.add("i-stat__entry"),a.innerText=i18next.t("info.energy"),ke.id="i-stat__energy",i.append(a,": ",ke),r.after(i),u.appendChild(d),fe.appendChild(u),l.forEach((e=>{e.closest(".info, .inventory, .leaderboard, .notifs, .profile, .settings")&&(e.innerHTML="",e.classList.add("sbgcui_button_reset","fa","fa-solid-xmark"))})),i18next.addResources("ru","main",{"notifs.text":"нейтрализована $1$","sbgcui.point":"Точка","sbgcui.points":"Точки","sbgcui.line":"Линия","sbgcui.lines":"Линии","sbgcui.region":"Регион","sbgcui.regions":"Регионы","sbgcui.oldestLineDays":"Самая старая линия (дн.)","sbgcui.oldestRegionDays":"Самый старый регион (дн.)","sbgcui.refsShort":"СНК","sbgcui.max":"Макс.","sbgcui.total":"Всего","sbgcui.area":"Площадь","sbgcui.distance":"Расстояние","sbgcui.clearTilesCache":"Очистить кэш","sbgcui.clearTilesCacheConfirm":"Очистить кэш тайлов карты? \n{{amount}} тайлов от {{baselayers}} подложек. Всего {{size}} МБ занято.","sbgcui.calculatingTilesCache":"Подсчёт...","sbgcui.captured":"Захвачена: {{date}} ({{uptime}} дн.)"}),i18next.addResources("en","main",{"notifs.text":"neutralized by $1$","sbgcui.point":"Point","sbgcui.points":"Points","sbgcui.line":"Line","sbgcui.lines":"Lines","sbgcui.region":"Region","sbgcui.regions":"Regions","sbgcui.oldestLineDays":"Oldest line (days)","sbgcui.oldestRegionDays":"Oldest region (days)","sbgcui.refsShort":"REF","sbgcui.max":"Max","sbgcui.total":"Total","sbgcui.area":"Area","sbgcui.distance":"Distance","sbgcui.clearTilesCache":"Clear cache","sbgcui.clearTilesCacheConfirm":"Clear map tiles cache? \n{{amount}} tiles from {{baselayers}} baselayers. Total {{size}} MB used.","sbgcui.calculatingTilesCache":"Calculating...","sbgcui.captured":"Captured: {{date}} ({{uptime}} d.)"}),i18next.addResources(i18next.resolvedLanguage,"main",{"items.catalyser-short":"{{level}}","items.core-short":"{{level}}"}),["cm","m","km","sqm","sqkm"].forEach((e=>{const t=`units.${e}`;let n=i18next.getResource(i18next.resolvedLanguage,"main",t);n=n.replace(/(maximumFractionDigits:\s)(\d)/,"$1$2; minimumFractionDigits: $2"),i18next.addResource(i18next.resolvedLanguage,"main",t,n)})),window.attack_slider.options={speed:200},window.deploy_slider.options={speed:200},window.draw_slider.options={height:"120px",pagination:!0,speed:200},window.highlightFeature=Kt,Ve.setAttribute("content",Ve.getAttribute("content")+", shrink-to-fit=no");const g=JSON.parse(localStorage.getItem("map-config"));g.h=0,localStorage.setItem("map-config",JSON.stringify(g))}{let e,t;var n,L,S,T=new ie("MainToolbar");const o=P.getControls();P.getInteractions().forEach((e=>{switch(e.constructor){case ol.interaction.DragPan:n=e;break;case ol.interaction.DoubleClickZoom:L=e;break;case ol.interaction.PinchRotate:S=e;break}})),n.setActive("true"!=ze.dataset.active),L.setActive(Boolean(x.ui.doubleClickZoom)),o.forEach((n=>{switch(n.constructor){case ol.control.Attribution:e=n;break;case ol.control.Rotate:t=n;break}})),P.removeControl(e),P.removeControl(t),P.addControl(T);const s=document.createElement("label"),i=document.createElement("label");[s,i].forEach(((e,t)=>{const n=document.createElement("input"),o=document.createElement("span"),s=0==t?"Watercolor":"Toner",i=JSON.parse(localStorage.getItem("settings")).base==`stadia_${s.toLowerCase()}`;e.classList.add("layers-config__entry"),n.type="radio",n.name="baselayer",n.value=`stadia_${s.toLowerCase()}`,n.checked=i,o.innerText=`Stadia ${s}`,e.append(n," ",o)})),document.querySelector('input[value="osm"]').parentElement.after(s,i);const a=document.createElement("button"),r=document.querySelector(".layers-config__buttons");a.innerText=i18next.t("sbgcui.clearTilesCache"),a.addEventListener("click",tn),r.appendChild(a);var I=new ol.source.Vector,R=new ol.layer.Vector({source:I,name:"sbgcui_points",minZoom:15,className:"ol-layer__sbgcui_points",zIndex:9});P.addLayer(R),q.setRotation(x.ui.restoreRotation?C.viewRotation??0:0)}{let e=document.createElement("div"),n=document.createElement("div"),o=document.querySelector("#self-info__exp");new MutationObserver((()=>{t.exp.string=o.textContent,ce.style.setProperty("--sbgcui-player-exp-percentage",`${t.exp.percentage}%`)})).observe(o,{childList:!0}),e.classList.add("sbgcui_xpProgressBar"),n.classList.add("sbgcui_xpProgressBarFiller"),o.parentElement.prepend(e),e.append(o,n)}de.addEventListener("attackSliderOpened",(()=>{Nt(Mt(x.autoSelect.attack))})),Ce.addEventListener("click",(e=>{if(e.target.classList.contains("selected")){const t=e.target.dataset.guid,n=dt.cores[t].level;dt.selectCore(x.autoSelect.upgrade,n)}})),me.addEventListener("touchstart",(e=>{let t=e.target.closest(".is-active.splide__slide");if(null==t)return;let n=Date.now(),o=t.dataset.guid,s=setTimeout((()=>{let e;ut.has(o)?(ut.delete(o),t.removeAttribute("sbgcui-excluded-core"),e=Dt("Теперь ядро доступно для автовыбора.")):(ut.add(o),t.setAttribute("sbgcui-excluded-core",""),e=Dt("Ядро больше не участвует в автовыборе.")),e.showToast(),N.transaction("state","readwrite").objectStore("state").put(ut,"excludedCores")}),2e3);t.addEventListener("touchend",(()=>{Date.now()-n<2e3&&clearTimeout(s)}),{once:!0})})),me.addEventListener("coresListUpdated",(()=>{me.childNodes.forEach((e=>{ut.has(e.dataset.guid)&&e.setAttribute("sbgcui-excluded-core","")}));const e=dt.selectedCoreGuid;if(null!=e){const t=dt.cores[e].level;dt.selectCore(x.autoSelect.upgrade,t)}else dt.selectCore(x.autoSelect.deploy)}));{function e(e,n,o){return n.te==t.team&&(e.style.setProperty("--sbgcui-energy",`${n.e}%`),n.e<100&&(e.style.setProperty("--sbgcui-display-r-button","flex"),e.setAttribute("sbgcui-repairable",""))),o(e,n)}function n(e,t){Tt(e).then((o=>{if(o.error)throw new Error(o.error);if(o.data){const[s,i]=o.data.reduce(((e,t)=>[e[0]+t.e,e[1]+a[t.l]]),[0,0]),r=document.querySelector(`.inventory__item[data-ref="${e}"] .inventory__item-left`).querySelector(".inventory__item-descr").childNodes[4],c=Math.floor(s/i*100),l=JSON.parse(localStorage.getItem("refs-cache"));t.style.setProperty("--sbgcui-energy",`${c}%`),r&&(r.nodeValue=c),Ft(o.xp.cur),Bt(o.xp.diff),l[e]&&(l[e].e=c,localStorage.setItem("refs-cache",JSON.stringify(l))),100!=c&&n(...arguments)}})).catch((e=>{Dt(`Ошибка при зарядке. <br>${e.message}`,void 0,void 0,"error-toast").showToast(),console.log("SBG CUI: Ошибка при зарядке.",e),e.message.match(/полностью|вражеской|fully|enemy/)?t.style.setProperty("--sbgcui-display-r-button","none"):t.style.setProperty("--sbgcui-display-r-button","flex")}))}function o(e){if("KeyR"!=e.code)return;const t=document.querySelector(".inventory__item[sbgcui-repairable]"),o=t?.dataset.ref;null!=t&&(n(o,t),t.scrollIntoView(),t.removeAttribute("sbgcui-repairable"),t.style.setProperty("--sbgcui-display-r-button","none"))}window.makeEntryDec=e,we.addEventListener("click",(e=>{if(!e.currentTarget.matches('.inventory__content[data-tab="3"]'))return;if(!e.target.closest(".inventory__item-controls"))return;if(!e.target.closest(".inventory__item.loaded"))return;if(e.offsetX<50)return;const t=e.target.closest(".inventory__item")?.dataset.ref,o=e.target.closest(".inventory__item");o.style.setProperty("--sbgcui-display-r-button","none"),n(t,o)})),Ee.addEventListener("inventoryPopupOpened",(()=>{document.addEventListener("keyup",o)})),Ee.addEventListener("inventoryPopupClosed",(()=>{document.removeEventListener("keyup",o)}))}{function e(e){(null==e||e.target.matches("summary"))&&F.querySelectorAll("details").forEach((t=>{null!=e&&t==e.target.closest("details")||t.removeAttribute("open")}))}function n(){B.value=Gt(B.value,!1)}function o(e){"default"==j.value&&(j.value="custom"),ce.style.setProperty("--sbgcui-branding-color",Gt(e.target.value))}function s(e){"default"==e.target.value?(B.value=Ht(t.teamColor),ce.style.setProperty("--sbgcui-branding-color",t.teamColor)):(B.value=mapFilters.brandingColor,ce.style.setProperty("--sbgcui-branding-color",mapFilters.brandingColor))}function i(n){n.preventDefault(),n.stopPropagation();const{mapFilters:o,ui:s}=x;for(let e in o)E(e,o[e]);ce.style.setProperty("--sbgcui-point-btns-rtl",s.pointBtnsRtl?"rtl":"ltr"),ce.style.setProperty("--sbgcui-point-image-blur",s.pointBgImageBlur?"2px":"0px"),ce.style.setProperty("--sbgcui-show-speedometer",s.speedometer),ce.style.setProperty("--sbgcui-branding-color","custom"==o.branding?o.brandingColor:t.teamColor),window.TeamColors[t.team].fill=`${"custom"==o.branding?o.brandingColor:Ht(t.teamColor)}80`,window.TeamColors[t.team].stroke="custom"==o.branding?Gt(o.brandingColor):t.teamColor,L.setActive(Boolean(s.doubleClickZoom)),!x.tinting.map||Qe||et||jt("map"),e(),y(),F.classList.add("sbgcui_hidden"),st=!1}function a(e){const{name:t,value:n}=e.target;E(t.split("_")[1],n)}function r(e){e.preventDefault(),confirm("Произвести очистку инвентаря согласно настройкам?")&&At(!0)}function c(e){e.preventDefault();try{const t=new FormData(e.target),n=Object.fromEntries(t);for(let e in n){const t=e.split("_"),o=t[0];if("maxAmountInBag"==o){const o=t[1],s=t[2],i=S(n[e])?+n[e]:-1;x.maxAmountInBag[o][s]=i}else{const s=t[1],i=n[e];x[o][s]=isNaN(+i)?i:+i}}for(let e in x)N.transaction("config","readwrite").objectStore("config").put(x[e],e);Rt("Настройки сохранены"),window.dispatchEvent(new Event("configUpdated"))}catch(e){Rt(`Ошибка при сохранении настроек. <br>${e.message}`,void 0,void 0,"error-toast"),console.log("SBG CUI: Ошибка при сохранении настроек.",e)}}function l(e){e.target.checked?jt("map"):jt("")}function u(e){const t=e.target,n=t.value;switch(t){case V:_([Z,z]);break;case Z:case z:_([V]);break}if(/^uniq(c|v)$/.test(n)){_(Y.filter((e=>e!=t)),n)}}function g(e){e.target.select()}function m(e){const t=e.target;S(t.value)||(t.value=-1,t.setAttribute("data-amount",t.value))}function p(e){const t=e.target;t.setAttribute("data-amount",t.value)}function h(e){const t=e.target.value;e.target.setAttribute("label",`${-1==t?"∞":Math.round(t/1e3)} сек.`)}function f(e){const t=e.target.value;e.target.setAttribute("label",t/1e3+" сек.")}function b(e){e.target.checked?W.removeAttribute("disabled"):(W.checked=0,W.setAttribute("disabled",""))}function v(){F.classList.toggle("sbgcui_hidden"),st=!st}function y(){F.querySelectorAll('input:not([type="hidden"]), select').forEach((e=>{const t=e.name.split("_").reduce(((e,t)=>e[t]),x);switch(e.type){case"color":case"number":case"range":case"select-one":e.value=t;break;case"checkbox":e.checked=t;break;case"radio":e.checked=e.value==t;break}})),[...H,U,J].forEach((e=>{e.dispatchEvent(new Event("input"))}))}function E(e,t){const n="blur"==e?"px":"hueRotate"==e?"deg":"";ce.style.setProperty(`--sbgcui-${e}`,`${t}${n}`)}function _(e,t){e.forEach((e=>{switch(t){case"uniqc":"uniqv"==e.value&&(e.value="off");break;case"uniqv":"uniqc"==e.value&&(e.value="off");break;default:e.value="off"}}))}const S=e=>!(""==e||"-0"==e||0==Number.isInteger(+e)||+e<-1);try{var F=await It("settings"),j=F.querySelector('select[name="mapFilters_branding"]'),B=F.querySelector('input[name="mapFilters_brandingColor"]');const t=F.querySelector("#sbgcui_settings-close"),v=F.querySelectorAll('input[data-role="colorfilter"]'),E=F.querySelector("#sbgcui_forceclear"),L=F.querySelectorAll('option[value="highlevel"]');var G=F.querySelector('select[name="pointHighlighting_inner"]');const _=F.querySelector("#tinting_map");var H=F.querySelectorAll('.sbgcui_settings-maxamounts input[name^="maxAmountInBag"]');const S=F.querySelector("#sbgcui_min_free_space");var U=F.querySelector('input[name="notifications_duration"]'),J=F.querySelector('input[name="notifications_interval"]'),z=F.querySelector('select[name="pointHighlighting_outerBottom"]'),V=F.querySelector('select[name="pointHighlighting_outer"]'),Z=F.querySelector('select[name="pointHighlighting_outerTop"]');const x=F.querySelector("#ui_pointBgImage");var W=F.querySelector("#ui_pointBgImageBlur");const C=F.querySelector(".sbgcui_settings-version"),k=F.querySelector("#vibration_notifications").closest("details");var Y=[G,V,z,Z];S.innerText=w,C.innerText="v1.14.76",L.forEach((e=>{e.innerText+=` ${d}+`})),"vibrate"in window.navigator||k.classList.add("sbgcui_hidden"),B.addEventListener("change",n),B.addEventListener("input",o),j.addEventListener("change",s),t.addEventListener("click",i),E.addEventListener("click",r),_.addEventListener("change",l),U.addEventListener("input",h),J.addEventListener("input",f),x.addEventListener("change",b),F.addEventListener("click",e),F.addEventListener("submit",c),v.forEach((e=>{e.addEventListener("input",a)})),Y.forEach((e=>{e.addEventListener("change",u)})),H.forEach((e=>{e.addEventListener("focus",g),e.addEventListener("change",m),e.addEventListener("input",p)})),y(),Je.appendChild(F)}catch(e){console.log("SBG CUI: Ошибка при создании меню настроек.",e)}const C=document.createElement("button");C.classList.add("fa","fa-solid-gears"),C.addEventListener("click",v),T.addItem(C,1)}{var X=document.createElement("meta");X.name="theme-color",document.head.appendChild(X);let e=x.tinting;+e.map&&jt("map"),Ne.addEventListener("profilePopupOpened",(t=>{+e.profile?jt("profile"):jt("")})),Pe.addEventListener("pointPopupOpened",(t=>{"off"!=e.point?jt(`point_${e.point}`):jt("")})),Ie.addEventListener("pointLevelChanged",(t=>{"level"==e.point&&jt("point_level")})),Ae.addEventListener("pointOwnerChanged",(t=>{"team"==e.point&&jt("point_team")})),Pe.addEventListener("pointPopupClosed",(t=>{et?+e.profile&&jt("profile"):+e.map?jt("map"):jt(""),Pe.style.borderColor="",Oe.style.color=""})),Ne.addEventListener("profilePopupClosed",(t=>{Qe?"off"!=e.point&&jt(`point_${e.point}`):+e.map?jt("map"):jt(""),Ne.style.borderColor=""}))}var K=document.createElement("div");K.classList.add("sbgcui_xpdiff-wrapper"),document.body.appendChild(K);{function e(){const e=Me.innerText,n=e==t.name;confirm(`Сохранить ${n?"вашу ":""}статистику ${n?"":"игрока "}на текущий момент? \nЭто действие перезапишет сохранённую ранее статистику.`)&&xt(null,e).then((e=>{const t=Date.now(),n=new Date(t).toLocaleString();N.transaction("stats","readwrite").objectStore("stats").put({...e,timestamp:t}),r.innerText=`Последнее сохранение: \n${n}`}))}function n(){const e=Me.innerText,n=e==t.name;N.transaction("stats","readonly").objectStore("stats").get(e).addEventListener("success",(t=>{const o=t.target.result;if(null!=o)xt(null,e).then((e=>{let t=Date.now()-o.timestamp,s=["day","hr","min","sec"],i="",a="";[864e5,36e5,6e4,1e3].forEach(((e,n)=>{let o=Math.trunc(t/e);o&&(i+=`${i.length?", ":""}${o} ${s[n]+(o>1?"s":"")}`,t-=o*e)}));for(let t in e){let n=e[t]-o[t];if(n){let e,o=n>0;switch(t){case"max_region":case"regions_area":e=i18next.t(`profile.stats.${t}`),n=i18next.t("units.sqkm",{count:n});break;case"xp":e=i18next.t("profile.stats.total-xp");break;case"level":e=i18next.t("profile.level");break;default:e=i18next.t(`profile.stats.${t}`)}e&&(a+=`\n\t\t\t\t\t\t\t\t\t<p class="sbgcui_compare_stats-diff-wrp">\n\t\t\t\t\t\t\t\t\t\t<span>${e}:</span>\n\t\t\t\t\t\t\t\t\t\t<span class="sbgcui_compare_stats-diff-value${o?"Pos":"Neg"}">\n\t\t\t\t\t\t\t\t\t\t\t${o?"+":""}${n}\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t`)}}let r=Dt(a.length?`${n?"Ваша с":"С"}татистика ${n?"":"игрока "}с ${new Date(o.timestamp).toLocaleString()}<br>(${i})<br>${a}`:"Ничего не изменилось с прошлого сохранения.","bottom center",-1,"sbgcui_compare_stats-toast");r.showToast(),r.toastElement.style.setProperty("--sbgcui-toast-color",`var(--team-${e.team})`)}));else{Dt(`Вы ещё не сохраняли ${n?"свою ":""}статистику${n?"":" этого игрока"}.`,void 0,void 0,"error-toast").showToast()}}))}function o(){const e=Me.innerText;N.transaction("stats","readonly").objectStore("stats").get(e).addEventListener("success",(e=>{const t=e.target.result;if(null!=t){const e=new Date(t.timestamp).toLocaleString();r.innerText=`Последнее сохранение: \n${e}`}else r.innerText=""}))}let s=document.createElement("div"),i=document.createElement("button"),a=document.createElement("button"),r=document.createElement("span"),c=document.querySelector(".pr-stats");i.innerText="Записать",a.innerText="Сравнить",r.classList.add("sbgcui_compare_stats-timestamp"),s.classList.add("sbgcui_compare_stats"),s.append(r,i,a),Ne.insertBefore(s,c),i.addEventListener("click",e),a.addEventListener("click",n),Ne.addEventListener("profilePopupOpened",o)}if(window.navigator.userAgent.toLowerCase().includes("wv")){let e=document.querySelector(".game-menu"),t=document.createElement("button");t.classList.add("fa","fa-solid-rotate"),t.addEventListener("click",(e=>{window.location.reload()})),e.appendChild(t)}Te.addEventListener("click",(e=>{if(Te.hasAttribute("sbgcui_clicks")){let e=+Te.getAttribute("sbgcui_clicks");if(e+1==5){let e=document.querySelector(".i-stat"),t=Pe.dataset.guid,n=document.createElement("span");n.innerText=`GUID: ${t}`,n.addEventListener("click",(e=>{window.navigator.clipboard.writeText(`${window.location.origin+window.location.pathname}?point=${t}`).then((e=>{Dt("Ссылка на точку скопирована в буфер обмена.").showToast()}))})),Pe.insertBefore(n,e),Pe.addEventListener("pointPopupClosed",(e=>{n.remove(),Te.setAttribute("sbgcui_clicks",0)}))}Te.setAttribute("sbgcui_clicks",e+1)}else Te.setAttribute("sbgcui_clicks",1)})),"vibrate"in window.navigator&&document.body.addEventListener("click",(e=>{x.vibration.buttons&&"BUTTON"==e.target.nodeName&&(window.navigator.vibrate(0),window.navigator.vibrate(50))}));for(let e in k)k[e]=new ae(e,k[e].cooldown);Object.defineProperty(k,"save",{value:function(){const e=N.transaction("favorites","readwrite").objectStore("favorites");for(let t in this)if(this[t].isActive){const n=this[t].cooldown>Date.now()?this[t].cooldown:null;e.put({guid:t,cooldown:n})}else e.delete(t)}});{let e=document.createElement("button"),t=Pe.dataset.guid;e.classList.add("sbgcui_button_reset","sbgcui_point_star","fa",`fa-${k[t]?.isActive?"solid":"regular"}-star`),e.addEventListener("click",(t=>{let n=Pe.dataset.guid,o=Oe.innerText;if(e.classList.contains("fa-solid-star"))k[n].isActive=0,e.classList.replace("fa-solid-star","fa-regular-star");else{if(n in k)k[n].isActive=1;else{let e=JSON.parse(localStorage.getItem("cooldowns"))||{},t=0==e[n]?.c?e[n].t:null;k[n]=new ae(n,t,o)}e.classList.replace("fa-regular-star","fa-solid-star"),!qt()&&"Notification"in window&&"default"==Notification.permission&&Notification.requestPermission()}k.save()})),Pe.addEventListener("pointPopupOpened",(t=>{let n=Pe.dataset.guid;k[n]?.isActive?e.classList.replace("fa-regular-star","fa-solid-star"):e.classList.replace("fa-solid-star","fa-regular-star")})),$e.appendChild(e)}{let e=document.createElement("button"),n=document.createElement("div"),o=document.createElement("header"),s=document.createElement("h3"),i=document.createElement("h6"),a=document.createElement("ul");function r(){if(0==Object.keys(k).length)return;let e=[];const n=Object.entries(k).filter((e=>e[1].isActive)).sort(((e,t)=>e[1].name.localeCompare(t[1].name))).map((e=>e[0]));a.innerHTML="",n.forEach((n=>{let o=document.createElement("li"),s=document.createElement("span"),i=document.createElement("span"),a=document.createElement("button"),r=document.createElement("div");i.innerText=k[n].name,s.appendChild(i),s.addEventListener("click",(()=>{window.showInfo(n)})),a.classList.add("sbgcui_button_reset","sbgcui_favs-li-delete","fa","fa-solid-circle-xmark"),a.addEventListener("click",(e=>{k[n].isActive=0,k.save(),o.removeAttribute("sbgcui_active",""),o.classList.add("sbgcui_hidden")})),r.classList.add("sbgcui_favs-li-data"),o.classList.add("sbgcui_favs-li"),o.setAttribute("sbgcui_active","");let c=k[n].isActive&&k[n].cooldown,l=k[n].discoveriesLeft;if(c){s.setAttribute("sbgcui_cooldown",k[n].timer),s.sbgcuiCooldown=k[n].cooldown;let e=setInterval((()=>{rt&&k[n].isActive&&k[n].cooldown?s.setAttribute("sbgcui_cooldown",k[n].timer):clearInterval(e)}),1e3)}else l&&(s.setAttribute("sbgcui_discoveries",l),s.discoveriesLeft=l);o.append(a,s,r),e.push(o),Ct(n).then((e=>{if(!e)return;const{co:n,g:o,l:a,li:c,t:l,te:d}=e,u=Math.round(e.e),g=JSON.parse(localStorage.getItem("inventory-cache")),m=d==t.team,p=g.find((e=>e.l==o))?.a??0;i.innerText=`[${a}] ${l}`,s.style.color=m?"var(--sbgcui-branding-color)":`var(--team-${d})`,r.innerHTML=`${u}% @ ${n}<br>${c.i}↓ ${c.o}↑ / ${i18next.t("sbgcui.refsShort")}: ${p}`}))})),e.sort(((e,t)=>(e=e.childNodes[1].sbgcuiCooldown||e.childNodes[1].discoveriesLeft,t=t.childNodes[1].sbgcuiCooldown||t.childNodes[1].discoveriesLeft,null==e?1:null==t?-1:e-t))),a.append(...e)}n.classList.add("sbgcui_favs","sbgcui_hidden"),o.classList.add("sbgcui_favs-header"),s.classList.add("sbgcui_favs-header-title"),i.classList.add("sbgcui_favs-header-subtitle"),a.classList.add("sbgcui_favs-content"),s.innerText="Избранные точки",i.innerText="Быстрый доступ к важным точкам, уведомления об их остывании и защита от автоудаления сносок.",o.append(s,i),n.append(o,a),e.classList.add("fa","fa-solid-star","sbgcui_favs_star"),e.addEventListener("click",(()=>{r(),n.classList.toggle("sbgcui_hidden"),rt=!rt})),document.body.addEventListener("click",(e=>{!rt||e.target.closest(".info.popup")||e.target.closest(".sbgcui_favs")||e.target.closest(".sbgcui_favs_star")||(n.classList.add("sbgcui_hidden"),rt=!1)})),T.addItem(e,2),document.body.appendChild(n)}we.addEventListener("click",(e=>{if(!e.target.classList.contains("inventory__ic-view"))return;let t=e.target.closest(".inventory__item").dataset.ref;t&&confirm('Открыть карточку точки? Либо нажмите "Отмена" для перехода к месту на карте.')&&window.showInfo(t)}));{let e=document.createElement("span"),t=document.createElement("span");e.classList.add("sbgcui_no_loot","fa","fa-solid-droplet-slash"),t.classList.add("sbgcui_no_refs","fa","fa-solid-link-slash"),he.append(e,t),he.addEventListener("click",(e=>{if(e.target==he)Ye=new ne(1,1);else{let t=!e.target.classList.contains("sbgcui_no_loot"),n=!e.target.classList.contains("sbgcui_no_refs");Ye=new ne(t,n)}}))}{function e(e){return e.every((e=>e.classList.contains("loaded")))}function n(e){let t=JSON.parse(localStorage.getItem("refs-cache"))||{};return e.every((e=>t[e.dataset.ref]?.t>Date.now()))}function o(e,t){let n;switch(t){case"name":return n=new RegExp(/\(x[0-9]{1,}\)\s(?:"|«)?([\s\S]+)/i),e.querySelector(".inventory__item-title").innerText.match(n)[1];case"level":return n=new RegExp(/level-([0-9]{1,2})/),+e.querySelector(".inventory__item-descr > span").style.color.match(n)?.[1]||0;case"team":return n=new RegExp(/team-([1-3])/),+e.querySelector(".inventory__item-title").style.color.match(n)?.[1]||0;case"energy":return+e.querySelector(".inventory__item-descr").childNodes[4].nodeValue.replace(",",".");case"distance":n=new RegExp(`([0-9]+?(?:${ee}[0-9]+)?(?:\\${te}[0-9]+)?)\\s(cm|m|km|см|м|км)`,"i");let t=e.querySelector(".inventory__item-descr").lastChild.textContent,[o,s,i]=t.match(n);return s=s.replace(ee,"").replace(te,"."),parseFloat(s)/(["cm","см"].includes(i)?1e5:["m","м"].includes(i)?1e3:1);case"amount":return n=new RegExp(/^\(x([0-9]{1,})\)\s/i),+e.querySelector(".inventory__item-title").innerText.match(n)[1]}}function s(e,t){let n=o(e,"name"),s=o(t,"name");return n.localeCompare(s)}function i(e,n){e.sort(((e,i)=>{let a=o(e,n),r=o(i,n);switch(n){case"name":return a.localeCompare(r);case"team":return a==r?s(e,i):a==t.team?-1:r==t.team?1:a-r;case"energy":let n=o(e,"team"),c=o(i,"team");return n==c?a==r?s(e,i):a-r:n==t.team?-1:c==t.team?1:a==r?s(e,i):a-r;default:return a-r}}))}function a(){if(i(d,u),we.replaceChildren(...d),p.removeAttribute("disabled"),we.classList.remove("sbgcui_refs_list-blur"),y){let e;performance.mark(b),console.log(`SBG CUI: Загрузка и сортировка сносок закончены: ${(new Date).toLocaleTimeString()}`);e=Dt(`Загрузка и сортировка заняли ${+(performance.measure(v,f,b).duration/1e3).toFixed(1)} сек. <br><br>Уникальных сносок: ${we.childNodes.length}.`,void 0,-1,"sbgcui_toast-selection"),e.showToast(),c()}}function r(e){e.isTrusted&&(clearInterval(l),we.removeEventListener("refsListLoaded",a),p.value="none",p.removeAttribute("disabled"),we.classList.remove("sbgcui_refs_list-blur"))}function c(){y=!1,performance.clearMarks(f),performance.clearMarks(b),performance.clearMeasures(v),ve.removeAttribute("sbgcui_measurement_mode")}let l,d,u,g=document.querySelector(".inventory__controls"),m=document.querySelector("#inventory-delete"),p=document.createElement("select"),h=document.createElement("button"),f="sbgcui_refs_sort_begin",b="sbgcui_refs_sort_end",v="sbgcui_refs_sort_measure",y=!1;h.classList.add("fa","fa-solid-sort","sbgcui_button_reset","sbgcui_refs-sort-button"),p.classList.add("sbgcui_refs-sort-select"),[["Сортировка","none"],["По названию","name"],["По уровню","level"],["По команде","team"],["По заряду","energy"],["По дистанции","distance"],["По количеству","amount"]].forEach((e=>{let t=document.createElement("option");t.innerText=e[0],t.value=e[1],p.appendChild(t)})),p.addEventListener("change",(t=>{let o=new Event("scroll");if(Object.defineProperty(o,"target",{value:{scrollTop:0,clientHeight:we.clientHeight}}),d=Array.from(we.children),u=t.target.value,"none"!=u)if(we.scrollTop=0,we.classList.remove("sbgcui_refs-reverse"),p.setAttribute("disabled",""),!u.match(/name|amount/)&&!e(d)||y){let t=.9*we.offsetHeight;if(we.classList.add("sbgcui_refs_list-blur"),y&&(e(d)&&document.querySelector('.inventory__tab[data-tab="3"]')?.click(),localStorage.removeItem("refs-cache"),performance.mark(f),console.log(`SBG CUI: Загрузка и сортировка сносок начаты: ${(new Date).toLocaleTimeString()}`)),n(d))for(let e=0;e<=we.scrollHeight;e+=we.offsetHeight/2)o.target.scrollTop=e,we.dispatchEvent(o);else l=setInterval((()=>{o.target.scrollTop<=we.scrollHeight?(o.target.scrollTop+=t,we.dispatchEvent(o)):(clearInterval(l),o.target.scrollTop=we.scrollHeight,we.dispatchEvent(o))}),10);we.addEventListener("refsListLoaded",a,{once:!0})}else i(d,u),we.replaceChildren(...d),p.removeAttribute("disabled")})),document.querySelector(".inventory__tabs").addEventListener("click",r),ve.addEventListener("click",r),Ee.addEventListener("inventoryPopupOpened",c),ve.addEventListener("touchstart",(()=>{let e=Date.now(),t=setTimeout((()=>{let e;e=Dt("Режим измерения производительности. <br><br>\n\t\t\t\t\t\tВыберите тип сортировки для измерения скорости загрузки данных. <br><br>\n\t\t\t\t\t\tКэш сносок будет очищен. <br><br>\n\t\t\t\t\t\tДля отмены операции закройте инвентарь.","bottom center",-1,"sbgcui_toast-selection"),e.showToast(),y=!0,ve.setAttribute("sbgcui_measurement_mode","")}),2e3);ve.addEventListener("touchend",(()=>{Date.now()-e<1e3&&clearTimeout(t)}),{once:!0})})),h.addEventListener("click",(()=>{we.classList.toggle("sbgcui_refs-reverse"),we.scrollTop=-we.scrollHeight})),g.insertBefore(p,m),g.appendChild(h)}{class e extends ol.Feature{constructor(e){super(e),this.addEventListener("change",(()=>{if(!this.id_||!this.style_)return;let{inner:e,outer:t,outerTop:n,outerBottom:o,text:s}=x.pointHighlighting,i=this.style_;this.addStyle(i,"inner",1,this.isMarkerNeeded(e)),this.addStyle(i,"outer",2,this.isMarkerNeeded(t)),this.addStyle(i,"outerTop",3,this.isMarkerNeeded(n)),this.addStyle(i,"outerBottom",4,this.isMarkerNeeded(o)),this.addStyle(i,null,5,!1,this.textToRender(s))}))}isMarkerNeeded(e){switch(e){case"fav":return this.id_ in k;case"ref":return this.cachedRefsGuids.includes(this.id_);case"uniqc":return vt.c.has(this.id_);case"uniqv":return vt.v.has(this.id_);case"cores":return 6==yt[this.id_]?.cores;case"highlevel":return yt[this.id_]?.level>=d;default:return!1}}textToRender(e){switch(e){case"energy":let e=yt[this.id_]?.energy;return e>0?String(Math.round(10*e)/10):null;case"level":let t=yt[this.id_]?.level;return"number"==typeof t?String(t):null;case"lines":let n=yt[this.id_]?.linesAmount;return n>0?String(n):null;case"refsAmount":let o=this.cachedRefsAmounts[this.id_];return o>0?String(o):null;default:return null}}addStyle(e,t,n,o,s){1==o?(e[n]=e[0].clone(),e[n].renderer_=this[`${t}MarkerRenderer`]):(e[n]=new ol.style.Style({}),e[n].text_=s?new ol.style.Text({font:"14px Manrope",offsetY:e[1].renderer_?-20:0,text:s,fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#FFF",width:3})}):void 0)}innerMarkerRenderer(e,t){const n=t.context,[[o,s],[i,a]]=e,r=Math.sqrt((i-o)**2+(a-s)**2)/3;n.fillStyle=x.pointHighlighting.innerColor,n.beginPath(),n.arc(o,s,r,0,2*Math.PI),n.fill()}outerMarkerRenderer(e,t){const n=t.context,[[o,s],[i,a]]=e,r=1.3*Math.sqrt((i-o)**2+(a-s)**2);n.lineWidth=4,n.strokeStyle=x.pointHighlighting.outerColor,n.beginPath(),n.arc(o,s,r,0,2*Math.PI),n.stroke()}outerTopMarkerRenderer(e,t){const n=t.context,[[o,s],[i,a]]=e,r=1.3*Math.sqrt((i-o)**2+(a-s)**2);n.lineWidth=4,n.strokeStyle=x.pointHighlighting.outerTopColor,n.beginPath(),n.arc(o,s,r,Math.PI/180*195,Math.PI/180*345),n.stroke()}outerBottomMarkerRenderer(e,t){const n=t.context,[[o,s],[i,a]]=e,r=1.3*Math.sqrt((i-o)**2+(a-s)**2);n.lineWidth=4,n.strokeStyle=x.pointHighlighting.outerBottomColor,n.beginPath(),n.arc(o,s,r,Math.PI/180*15,Math.PI/180*165),n.stroke()}get cachedRefsGuids(){return JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>3==e.t)).map((e=>e.l))}get cachedRefsAmounts(){return Object.fromEntries(JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>3==e.t)).map((e=>[e.l,e.a])))}}ol.PointFeature=e}{function e(){const e=[...ge.children].find((e=>e.classList.contains("is-active"))),t=(JSON.parse(localStorage.getItem("inventory-cache"))||[]).find((t=>t.g==e.dataset.guid)),n=t.l,o=2==t.t?window.Catalysers[n].range:4==t.t?E:0;O.getStyle()[3].getGeometry().setRadius(Ut(o)),O.getStyle()[3].getStroke().setColor(`${x.mapFilters.brandingColor}70`),O.changed(),D&&q.fitBlastRange()}function t(){const e=q.getZoom(),{beforeAttackZoom:t,blastRangeZoom:o}=q.getProperties();i=e==o?t:e,O.getStyle()[3].getGeometry().setRadius(0),O.changed(),D&&n()}function n(e){e||(q.setTopPadding(),q.animate({center:O.getGeometry().getCoordinates(),zoom:i,duration:0},n))}function o(){q.setProperties({beforeAttackZoom:q.getZoom(),isZoomChanged:!1})}function s(e){const t=e.target.matches(".ol-zoom-in, .ol-zoom-out");tt&&t&&q.set("isZoomChanged",!0)}let i;de.addEventListener("attackSliderOpened",o),ge.addEventListener("activeSlideChanged",e),de.addEventListener("attackSliderClosed",t),We.addEventListener("click",s)}{let e=document.createElement("button");e.classList.add("fa","fa-solid-rotate"),e.addEventListener("click",(()=>{window.requestEntities()})),T.addItem(e,3)}{const e=new ol.Geolocation({projection:q.getProjection(),tracking:!0,trackingOptions:{enableHighAccuracy:!0}}),t=document.createElement("span");t.classList.add("sbgcui_speed"),document.querySelector(".self-info").appendChild(t),e.on("change:speed",(()=>{const n=e.getSpeed()||0;t.innerText=(3.6*n).toFixed(2)+" km/h"}))}{const e=document.createElement("button"),t="conic-gradient(\n\t\t\t\t\t#0000 var(--sbgcui-cluster-cooldown, 100%),\n\t\t\t\t\tvar(--sbgcui-cluster-team, #000) var(--sbgcui-cluster-cooldown, 100%) calc(var(--sbgcui-cluster-cooldown, 100%) + 1%),\n\t\t\t\t\t#0007 var(--sbgcui-cluster-cooldown, 100%) 100%\n\t\t\t\t\t)",n=document.createElement("div"),o=document.createElement("div"),s=P.getListeners("click")[0],i=200;let a,r,c=[],d=[];function g(e){if(!ct)return;const t=e.target.getAttribute("sbgcui_guid"),n=a.find((e=>e.getId()==t));m(),setTimeout((()=>{window.showInfo(n.getId()),Kt(n,void 0,{once:!0})}),i)}function m(){n.childNodes.forEach((e=>{e.classList.remove("sbgcui_cluster-iconWrapper-fullWidth")})),o.classList.remove("sbgcui_cluster-overlay-blur"),setTimeout((()=>{o.classList.add("sbgcui_hidden"),d.forEach((e=>{clearInterval(e)})),ct=!1}),i)}function p(e){r=e,a=P.getFeaturesAtPixel(r.pixel,{hitTolerance:u,layerFilter:e=>"points"==e.get("name")});let t=a.slice();if(t.length<=1||r.isSilent){const e=t[0];null!=e&&(e.set("sbgcui_chosenFeature",!0,!0),Kt(e,void 0,{once:!0})),s(r)}else b(t),t.length>y&&(t=t.reduceRight(h,[])),v(t),f(),c=t}function h(e,t,n){const o=y-e.length<=n,s=e.length<y,i=c.includes(t);return s?(i&&o||e.push(t),e):e}function f(){o.classList.remove("sbgcui_hidden"),setTimeout((()=>{o.classList.add("sbgcui_cluster-overlay-blur"),ct=!0}),10),d=[]}function b(e){const t=e.map((e=>e.getGeometry().getCoordinates())),n=[t.reduce(((e,t)=>e+t[0]),0)/t.length,t.reduce(((e,t)=>e+t[1]),0)/t.length];e.sort((function(e,t){const o=e.getGeometry().getCoordinates(),s=t.getGeometry().getCoordinates();let i=Math.atan2(o[1]-n[1],o[0]-n[0]),a=Math.atan2(s[1]-n[1],s[0]-n[0]);return i<0&&(i+=2*Math.PI),a<0&&(a+=2*Math.PI),i=(2.5*Math.PI-i)%(2*Math.PI),a=(2.5*Math.PI-a)%(2*Math.PI),i-a}))}function v(e){const o=360/e.length;n.innerHTML="",e.forEach(((e,s)=>{const i=e.getId(),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),l=JSON.parse(localStorage.getItem("cooldowns"))?.[i]?.t;if(l){w(a,l);const e=setInterval((()=>{w(a,l,e)}),1e3);d.push(e),a.style.backgroundImage=t}Ct(i,!1).then((e=>{const t=`url("https://lh3.googleusercontent.com/${e.i}=s60")`;a.style.backgroundImage+=a.style.backgroundImage.length?", ":"",a.style.backgroundImage+=t,a.style.borderColor=`var(--team-${e.te||0})`,a.style.boxShadow=`0 0 20px 3px var(--team-${e.te||0}), 0 0 5px 2px black`,a.style.setProperty("--sbgcui-point-title",`"${e.t.replaceAll('"',"\\22 ")}"`),a.style.setProperty("--sbgcui-point-level",`"${e.l}"`),a.style.setProperty("--sbgcui-cluster-team",`var(--team-${e.te})`)})),c.classList.add("sbgcui_cluster-iconWrapper"),a.classList.add("sbgcui_cluster-icon"),r.classList.add("sbgcui_cluster-line"),c.style.transform=`rotate(${o*s}deg)`,a.style.transform=`rotate(${-o*s}deg)`,c.append(a,r),n.appendChild(c),setTimeout((()=>{c.classList.add("sbgcui_cluster-iconWrapper-fullWidth")}),10),a.setAttribute("sbgcui_guid",i),a.addEventListener("click",g)}))}function w(e,t,n){const o=(t-Date.now())/1e3,s=Math.trunc(100-o/l*100);o<=l&&o>=0?e.style.setProperty("--sbgcui-cluster-cooldown",`${s}%`):(clearInterval(n),e.style.removeProperty("--sbgcui-cluster-cooldown"))}e.classList.add("sbgcui_button_reset","sbgcui_cluster-close","fa","fa-solid-circle-xmark"),n.classList.add("sbgcui_cluster-center"),o.classList.add("sbgcui_cluster-overlay","sbgcui_hidden"),o.append(n,e),document.body.appendChild(o),e.addEventListener("click",m),P.un("click",s),P.on("click",p)}{const e=document.createElement("button");function t(){const t=`Использовать предыдущую сохранённую точку "${ft?.name}" в качестве центра звезды?`;let o;pt=!pt,N.transaction("state","readwrite").objectStore("state").put(pt,"isStarMode"),pt?(e.style.opacity=1,e.classList.add("fa-fade"),ft&&confirm(t)?(e.classList.remove("fa-fade"),o=`Включён режим рисования "Звезда". <br /><br />\n\t\t\t\t\t\t\t\t\t\tТочка "<span style="color: var(--selection)">${ft.name}</span>" будет считаться центром звезды. <br /><br />\n\t\t\t\t\t\t\t\t\t\tСноски от прочих точек будут скрыты в списке рисования.`):(Pe.addEventListener("pointPopupOpened",n,{once:!0}),o='Включён режим рисования "Звезда". <br /><br />\n\t\t\t\t\t\t\t\t\tСледующая открытая точка будет считаться центром звезды. <br /><br />\n\t\t\t\t\t\t\t\t\tСноски от прочих точек будут скрыты в списке рисования.')):(e.style.opacity=.5,e.classList.remove("fa-fade"),Pe.removeEventListener("pointPopupOpened",n),o='Режим рисования "Звезда" отключён.');Dt(o,void 0,pt?6e3:void 0,"sbgcui_toast-selection").showToast()}function n(){ft={guid:Pe.dataset.guid,name:Oe.innerText},N.transaction("state","readwrite").objectStore("state").put(ft,"starModeTarget"),e.classList.remove("fa-fade");Dt(`Точка "<span style="color: var(--selection)">${Oe.innerText}</span>" выбрана центром для рисования звезды.`,void 0,void 0,"sbgcui_toast-selection").showToast()}e.classList.add("fa","fa-solid-asterisk"),e.style.opacity=pt?1:.5,e.addEventListener("click",t),T.addItem(e,4)}{const e=document.createElement("i"),t=new Set;let n=[];function o(e){const t=e.getId();return null==yt[t]||yt[t].cores<6}function s(e){const t=e.getId(),n=Date.now(),o=JSON.parse(localStorage.getItem("cooldowns"))?.[t];return null==o?.t||o.t<=n&&o.c>0}function i(){const e=O.getGeometry().getCoordinates(),t=P.getPixelFromCoordinate(e),n=q.getResolution(),o=Ut(E)/n;return P.getFeaturesAtPixel(t,{hitTolerance:o,layerFilter:e=>"points"==e.get("name")}).filter((e=>zt(e)))}function a(e){"KeyN"==e.code&&d()}function r(){window.removeEventListener("playerMove",u)}function c(){u(),window.addEventListener("playerMove",u)}function l(){!(Array.from(document.querySelectorAll(".popup")).some((e=>!e.classList.contains("hidden")))||nt||tt||ct||st||rt||at||it)&&d(!0)}function d(e){const n=i();null!=dt.guid&&t.add(dt.guid);const a=n.every((e=>t.has(e.getId()))),r=n.every((e=>!t.has(e.getId())));if(a){if(e)return;t.clear()}else r&&t.clear();const c=n.filter((e=>e.getId()!==dt.guid&&!t.has(e.getId()))),l=c.find(o)??c.find(s)??c[0];null!=l&&(t.add(l.getId()),Pe.classList.add("hidden"),window.showInfo(l.getId()),Kt(l,void 0,{once:!0}))}function u(){i().length>1?e.classList.remove("sbgcui_hidden"):e.classList.add("sbgcui_hidden")}function g(){C.isAutoShowPoints=!C.isAutoShowPoints,N.transaction("state","readwrite").objectStore("state").put(C.isAutoShowPoints,"isAutoShowPoints"),C.isAutoShowPoints?b():f(),Rt((C.isAutoShowPoints?"В":"От")+"ключено открытие точки при приближении к ней.")}function m(){if(Object.isSealed(n)||0==n.length)return;if(!n.every(((e,t,n)=>e.x<=n[t-1]?.x||0==t)))return;const e=n.map((e=>e.x)),t=n.map((e=>e.y)),o=Math.min(...e),s=Math.max(...e),i=Math.min(...t);Math.max(...t)-i>70||s-o<50||d()}function p(e){if(Object.isSealed(n))return;const{clientX:t,clientY:o}=e.touches.item(0);n.push({x:t,y:o})}function h(e){n=[],(e.touches.length>1||null!==e.touches.item(0).target.closest(".deploy-slider-wrp"))&&Object.seal(n)}function f(){v.style.opacity=.5,v.classList.remove("fa-fade"),window.removeEventListener("playerMove",l)}function b(){v.style.opacity=1,v.classList.add("fa-fade"),window.addEventListener("playerMove",l)}e.classList.add("sbgcui_swipe-cards-arrow","fa","fa-solid-angles-left"),document.querySelector(".i-stat").appendChild(e),Pe.addEventListener("pointPopupOpened",c),Pe.addEventListener("pointPopupClosed",r),Pe.addEventListener("touchstart",h),Pe.addEventListener("touchmove",p),Pe.addEventListener("touchend",m),document.addEventListener("keydown",a);const v=document.createElement("button");v.classList.add("fa","fa-solid-arrows-to-dot"),v.addEventListener("click",g),C.isAutoShowPoints?b():f(),T.addItem(v,7)}{const e=document.querySelector(".pr-buttons"),n=document.createElement("button");async function o(){const e=await xt(null,Me.innerText),o=await xt(null,t.name),i=i18next.getResourceBundle(i18next.resolvedLanguage).profile.stats,a=document.querySelectorAll(".pr-stat-title");n.toggleAttribute("sbgcui_self_stats"),n.classList.toggle("fa-solid-scale-unbalanced"),n.classList.toggle("fa-solid-scale-unbalanced-flip"),a.forEach((t=>{const a=t.innerText;let r=Object.entries(i).find((e=>e[1]==a))[0];if(r=r.replace("total-xp","xp").replace("playing-since","created_at"),n.hasAttribute("sbgcui_self_stats")){const n="created_at"==r?Date.parse(o[r])-Date.parse(e[r]):e[r]-o[r],i=n>0?"red":n<0?"green":"";t.nextSibling.innerText=s(r,o[r]),t.nextSibling.style.setProperty("--sbgcui-diff-color",i)}else t.nextSibling.innerText=s(r,e[r]),t.nextSibling.style.removeProperty("--sbgcui-diff-color")})),je.style.setProperty("--sbgcui-reg-date",Vt(n.hasAttribute("sbgcui_self_stats")?o.created_at:e.created_at))}function s(e,t){i18next.resolvedLanguage;const n=new Intl.NumberFormat(i18next.language);if(/^guard_/.test(e))return i18next.t("units.n-days",{count:t});switch(e){case"max_line":return t<1e3?i18next.t("units.m",{count:t}):i18next.t("units.km",{count:t/1e3});case"max_region":case"regions_area":return i18next.t("units.sqkm",{count:t});case"xp":return`${n.format(t)} ${i18next.t("units.pts-xp")}`;case"created_at":return new Date(t).toLocaleDateString(i18next.language,{day:"numeric",month:"long",year:"numeric"});default:return n.format(t)}}function i(){t.name==Me.innerText?n.classList.add("sbgcui_hidden"):n.classList.remove("sbgcui_hidden"),n.removeAttribute("sbgcui_self_stats")}function a(){const e=document.querySelectorAll(".pr-stat-val");n.removeAttribute("sbgcui_self_stats"),n.classList.replace("fa-solid-scale-unbalanced-flip","fa-solid-scale-unbalanced"),e.forEach((e=>{e.style.removeProperty("--sbgcui-diff-color")}))}n.classList.add("fa","fa-solid-scale-unbalanced","sbgcui_profile-compare"),n.addEventListener("click",o),Ne.addEventListener("profilePopupOpened",i),Ne.addEventListener("profilePopupClosed",a),e.appendChild(n)}{function e(){const e=M?.getFeatures()[0].getGeometry(),t=[10,0,window.innerHeight-be.getBoundingClientRect().y+30,0];null!=e&&q.fitTempLine(e,t)}function t(){const e=[...Fe.childNodes].reverse();Fe.replaceChildren(...e),window.draw_slider.refresh(),s.classList.toggle("fa-solid-arrow-down-short-wide"),s.classList.toggle("fa-solid-arrow-down-wide-short")}function n(){s.classList.replace("fa-solid-arrow-down-wide-short","fa-solid-arrow-down-short-wide")}const o=document.createElement("button"),s=document.createElement("button"),i=document.querySelector(".draw-slider-buttons");o.classList.add("fa","fa-solid-up-right-and-down-left-from-center","sbgcui_drawslider_fit"),s.classList.add("fa","fa-solid-arrow-down-short-wide","fa-rotate-270","sbgcui_drawslider_sort"),o.addEventListener("click",e),s.addEventListener("click",t),be.addEventListener("drawSliderOpened",n),i.append(s,o)}{function e(){o.innerText=`${s}: ${i.format(dt.destroyReward)} ${i18next.t("units.pts-xp")}`}const t=document.querySelector(".info.popup .i-buttons"),n=document.querySelector(".info.popup .i-stat"),o=document.createElement("div"),s=i18next.language.includes("ru")?"Награда":"Reward",i=new Intl.NumberFormat(i18next.language);o.classList.add("i-stat__entry"),n.insertBefore(o,t),Pe.addEventListener("pointPopupOpened",e),Pe.addEventListener("pointRepaired",e),Pe.addEventListener("lineDrawn",e)}try{const e=await It("zero-point-info"),t=new ol.Feature({geometry:new ol.geom.Point([0,0])});e.addEventListener("click",(()=>{e.classList.add("sbgcui_hidden")})),document.body.appendChild(e),t.setId("sbgcui_zeroPoint"),t.setStyle(new ol.style.Style({geometry:new ol.geom.Circle([0,0],30),fill:new ol.style.Fill({color:"#BB7100"}),stroke:new ol.style.Stroke({color:window.TeamColors[3].stroke,width:5}),text:new ol.style.Text({font:"30px Manrope",text:"?",fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#FFF",width:3})})})),P.on("click",(n=>{P.getFeaturesAtPixel(n.pixel,{layerFilter:e=>"sbgcui_points"==e.get("name")}).includes(t)&&setTimeout((()=>e.classList.remove("sbgcui_hidden")),100)})),I.addFeature(t)}catch(e){console.log("SBG CUI: Ошибка (точка [0, 0]).",e)}{function e(){Dt("Нажмите на регион чтобы узнать, сколько их в этом месте.",void 0,void 0,"sbgcui_toast-selection").showToast(),P.un("click",t),P.once("click",t)}function t(e){const t=P.getFeaturesAtPixel(e.pixel,{layerFilter:e=>"regions"==e.get("name")}),n=t.map((e=>ol.sphere.getArea(e.getGeometry()))),o=Math.min(...n),s=Math.max(...n),i=i18next.t("units.sqkm",{count:o/1e6}),a=i18next.t("units.sqkm",{count:s/1e6});let r=`Количество регионов в точке: ${t.length}.`;1==t.length&&(r+=`\n\nПлощадь региона: ${a}.`),t.length>1&&(r+=`\n\nПлощадь самого большого региона: ${a}.\nПлощадь самого маленького региона: ${i}.`),alert(r)}const n=document.createElement("button");n.classList.add("fa","fa-brands-stack-overflow"),n.addEventListener("click",e),T.addItem(n,5)}{function e(e){const{date:n,guid:s}=e.detail,i=o.format(n),a=Math.floor((Date.now()-n)/1e3/60/60/24);s==dt.guid&&x.ui.pointDischargeTimeout&&(t.innerText=i18next.t("sbgcui.captured",{date:i,uptime:a}))}const t=document.createElement("span"),n={year:"2-digit",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",hourCycle:"h23"},o=new Intl.DateTimeFormat("ru-RU",n);t.classList.add("sbgcui_discharge_timeout"),document.querySelector(".i-stat").appendChild(t),Pe.addEventListener("pointPopupOpened",(()=>{t.innerText="~"})),window.addEventListener("pointCaptureDateFound",e),window.addEventListener("pointCaptured",e)}{let e=null,t=[];const n=document.createElement("button"),o=document.getElementById("map");function s(e,t){const n=P.getPixelFromCoordinate(q.getCenter()),o=Math.atan2(e[1]-n[1],e[0]-n[0]),s=Math.atan2(t[1]-n[1],t[0]-n[0]),i=P.getCoordinateFromPixel(n);q.adjustRotation(s-o,i)}function i(e){e||q.animate({rotation:0},i)}function a(e){e&&(mt=!mt),mt&&i(),S.setActive(!mt),n.setAttribute("sbgcui_locked",mt),N.transaction("state","readwrite").objectStore("state").put(mt,"isRotationLocked")}function r(n){mt||D&&"CANVAS"==n.target.nodeName&&(n.targetTouches.length>1||(e=[n.targetTouches[0].clientX,n.targetTouches[0].clientY],t=[]))}function c(n){if(n.preventDefault(),null==e)return;const o=[n.targetTouches[0].clientX,n.targetTouches[0].clientY];s(e,o),e=o,t.push(o)}function l(){0!=t.length&&window.requestEntities(),e=null,N.transaction("state","readwrite").objectStore("state").put(q.getRotation(),"viewRotation")}function d(){const e=q.getAnimating();D&&!e&&q.setCenter(O.getGeometry().getCoordinates()),n.style.setProperty("--sbgcui_angle",180*q.getRotation()/Math.PI+"deg")}N.transaction("state","readwrite").objectStore("state").get("isRotationLocked").addEventListener("success",(e=>{mt=e.target.result,a()})),n.classList.add("fa","fa-solid-compass","sbgcui_lock_rotation"),n.addEventListener("click",a),ze.before(n),o.addEventListener("touchstart",r),o.addEventListener("touchmove",c),o.addEventListener("touchend",l),q.on("change:rotation",d)}{const e=document.createElement("button");e.classList.add("fa","fa-solid-map-location-dot","sbgcui_button_reset","sbgcui_jumpToButton"),e.addEventListener("click",(()=>{Xt(dt.coords),Kt(void 0,dt.coords)})),Pe.appendChild(e);try{function t(e,t){const[n,o]=ol.proj.toLonLat(O.getGeometry().getCoordinates()),[s,i]=dt.coords;let a;switch(e){case"yamaps":a=`yandexmaps://maps.yandex.ru/?rtext=${o},${n}~${i},${s}&rtt=${t}`;break;case"yanavi":a=`yandexnavi://build_route_on_map?lat_from=${o}&lon_from=${n}&lat_to=${i}&lon_to=${s}`;break;case"dgis":a=`dgis://2gis.ru/routeSearch/rsType/${t}/from/${n},${o}/to/${s},${i}`;break;case"gmaps":a=`https://www.google.com/maps/dir/?api=1&origin=${o},${n}&destination=${i},${s}&travelmode=${t}`;break}return a}function n(e){const t=e.currentTarget.dataset.app,n=e.target.dataset.routetype;if("LI"==e.target.nodeName){if(e.target.hasAttribute("data-selected"))return delete e.target.dataset.selected,delete d.dataset.app,void delete d.dataset.routetype;i.querySelectorAll("li[data-selected]").forEach((e=>{delete e.dataset.selected})),e.target.dataset.selected="",d.dataset.app=t,d.dataset.routetype=n}}function o(){i.classList.add("sbgcui_hidden")}function s(){i.classList.toggle("sbgcui_hidden")}const i=await It("navigate"),a=i.querySelector(".sbgcui_navigate-coords"),r=i.querySelector("form"),c=i.querySelectorAll("menu"),[l,d]=i.querySelectorAll(".sbgcui_navigate-form-buttons > button"),u=document.createElement("button");u.classList.add("fa","fa-solid-route","sbgcui_button_reset","sbgcui_navbutton"),u.addEventListener("click",s),Pe.appendChild(u),Pe.addEventListener("pointPopupOpened",(()=>{a.innerText=dt.coords.slice().reverse().join(", ")})),a.addEventListener("click",(()=>{window.navigator.clipboard.writeText(a.innerText).then((()=>{Dt("Координаты скопированы в буфер обмена.").showToast()}))})),r.addEventListener("submit",(e=>{e.preventDefault()})),c.forEach((e=>{e.addEventListener("click",n)})),l.addEventListener("click",o),d.addEventListener("click",(()=>{const e=t(d.dataset.app,d.dataset.routetype);null!=e&&(window.location.href=e,o())})),qe.addEventListener("click",o),e.addEventListener("click",o),document.body.appendChild(i)}catch(e){console.log("SBG CUI: Ошибка (меню навигации к точке).",e)}}{function e(e){const o=e.webkitCompassHeading;if(Math.abs(n-o)>3){const e=o*Math.PI/180;t.setRotation(e+q.getRotation()),O.changed(),n=o}}const t=O.getStyle()[0].getImage();let n=0;DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission&&(document.body.addEventListener("click",(()=>{DeviceOrientationEvent.requestPermission()}),{once:!0}),window.addEventListener("deviceorientation",e))}{function e(){if(0==h)return;const e=h%10==1?"ки":"ек";let t;switch(p%10){case 1:t="ку";break;case 2:case 3:case 4:t="ки";break;default:t="ок";break}if(!confirm(`Удалить ${p} ссыл${t} от ${h} точ${e}?`))return;const n=s.getFeatures().filter((e=>1==e.get("isSelected"))),o={3:{}};n.forEach((e=>{const t=e.getId(),n=e.get("amount");o[3][t]={amount:n}}));const i=Object.entries(o[3]);$t(Object.fromEntries(i.map((e=>[e[0],e[1].amount]))),3).then((e=>{if("error"in e)throw e.error;const t=e.count.total;Le.innerText=t,ye.style.color.match("accent")&&t<g&&(ye.style.color=""),Ot(o),h=0,p=0,n.forEach((e=>{s.removeFeature(e)})),d.style.setProperty("--sbgcui-overall-refs-to-del",'"0"'),d.style.setProperty("--sbgcui-unique-refs-to-del",'"0"')})).catch((e=>{Dt(`Ошибка при удалении ссылок. <br>${e?.message||e}`,void 0,void 0,"error-toast").showToast(),console.log("SBG CUI: Ошибка при удалении ссылок.",e)}))}function t(){s.clear(!0),a.classList.add("sbgcui_hidden"),d.classList.add("sbgcui_hidden"),Wt(),it=!1,p=0,h=0,P.un("click",n),q.setZoom(m),window.requestEntities()}function n(e){P.forEachFeatureAtPixel(e.pixel,(function(e){const{amount:t,isSelected:n}=e.getProperties();e.set("isSelected",!n),p+=t*(n?-1:1),h+=n?-1:1,d.style.setProperty("--sbgcui-overall-refs-to-del",`"${p}"`),d.style.setProperty("--sbgcui-unique-refs-to-del",`"${h}"`)}),{hitTolerance:0,layerFilter:e=>"sbgcui_points_with_refs"==e.get("name")})}function o(){kt().then((e=>{const t=e.filter((e=>3==e.t)),o=P.getAllLayers();m=q.getZoom(),it=!0,a.classList.remove("sbgcui_hidden"),d.classList.remove("sbgcui_hidden"),Ee.classList.add("hidden"),de.classList.contains("hidden")||Nt(le),Zt(),d.style.setProperty("--sbgcui-overall-refs-to-del",'"0"'),d.style.setProperty("--sbgcui-unique-refs-to-del",'"0"'),o.forEach((e=>{/^(lines|points|regions)/.test(e.get("name"))&&e.getSource().clear()})),t.forEach((e=>{const{a:t,c:n,g:o,l:i,ti:a}=e,r=ol.proj.fromLonLat(n),c=new ol.Feature({geometry:new ol.geom.Point(r)});c.setId(o),c.setProperties({amount:t,mapCoords:r,pointGuid:i,title:a}),s.addFeature(c),Ct(i).then((e=>{c.set("team",+e.te)}))})),P.on("click",n)})).catch((e=>{console.log("SBG CUI: Ошибка при получении инвентаря.",e)}))}const s=new ol.source.Vector,i=new ol.layer.Vector({className:"ol-layer__sbgcui_points_with_refs",declutter:!0,minZoom:0,name:"sbgcui_points_with_refs",source:s,style:(e,t)=>{const{amount:n,isSelected:o,mapCoords:s,team:i,title:a}=e.getProperties(),r=q.getZoom(),c=r>=16?20:20*t/2.5;return[new ol.style.Style({geometry:new ol.geom.Circle(s,o?1.4*c:c),fill:new ol.style.Fill({color:o?"#BB7100":null==i?"#11111180":0==i?"#66666680":window.TeamColors[i].fill}),stroke:new ol.style.Stroke({color:null==i?"#66666680":0==i?"#CCCCCC80":window.TeamColors[i].stroke,width:o?4:3}),zIndex:o?3:1}),new ol.style.Style({text:new ol.style.Text({fill:new ol.style.Fill({color:"#000"}),font:(r>=15?14:12)+"px Manrope",stroke:new ol.style.Stroke({color:"#FFF",width:3}),text:r>=15?String(n):null}),zIndex:2}),new ol.style.Style({text:new ol.style.Text({fill:new ol.style.Fill({color:"#000"}),font:"12px Manrope",offsetY:25/t,stroke:new ol.style.Stroke({color:"#FFF",width:3}),text:r>=17?a.length<=12?a:a.slice(0,10).trim()+"...":null,textBaseline:"top"}),zIndex:2})]},zIndex:8}),a=document.createElement("button"),r=document.querySelector(".inventory__controls"),c=document.querySelector("#inventory-delete"),l=document.createElement("button"),d=document.createElement("button"),u=document.createElement("div");let m,p=0,h=0;a.id="sbgcui_hide_viewer",a.classList.add("sbgcui_button_reset","sbgcui_hidden","fa","fa-solid-xmark"),l.classList.add("sbgcui_show_viewer"),l.innerText="На карте",d.classList.add("sbgcui_button_reset","sbgcui_hidden","fa","fa-solid-trash"),d.id="sbgcui_batch_remove",l.addEventListener("click",o),a.addEventListener("click",t),d.addEventListener("click",e),r.insertBefore(l,c),u.append(a,d),document.body.appendChild(u),P.addLayer(i)}sessionStorage.removeItem(re.storageName);try{function t(){const e=E.getAttribute("min"),t=E.dataset.totalentries,n=Math.floor((Date.now()-new Date(e))/1e3/60/60/24);if(0!=t){if(confirm(`Очистить всю историю действий? \nВы удалите ${t} записей за последние ${n} дней (с ${e}).`)&&confirm("Подтвердите удаление истории действий за всё время.")){N.transaction("logs","readwrite").objectStore("logs").clear().addEventListener("success",(()=>{alert("История действий очищена."),a()}))}}else alert("Записей не обнаружено.")}function n(){b.innerHTML="",v.innerHTML="",[L,x,S].forEach((e=>e.classList.remove("sbgcui_hidden"))),f.classList.add("sbgcui_hidden")}function o(){y.setAttribute("active",""),w.removeAttribute("active"),v.classList.add("sbgcui_hidden"),b.classList.remove("sbgcui_hidden"),b.innerHTML="",v.innerHTML="",e.forEach((e=>{const t=document.createElement("p"),n=document.createElement("span"),o=document.createElement("div");t.classList.add("sbgcui_log-content-entry"),n.classList.add("sbgcui_log-content-entry-time"),o.classList.add("sbgcui_log-content-entry-description");n.innerText=new Date(e.timestamp).toLocaleString(i18next.language,{hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3,hourCycle:"h23"}).replace(/,|\./,":"),o.innerHTML=e.messages.join("<br>"),t.append(n,o),b.prepend(t)}))}function s(){w.setAttribute("active",""),y.removeAttribute("active"),b.classList.add("sbgcui_hidden"),v.classList.remove("sbgcui_hidden"),b.innerHTML="",v.innerHTML="",re.fullLog.forEach((e=>{const t=document.createElement("details"),n=document.createElement("summary"),o=document.createElement("pre"),s=document.createElement("pre"),i=document.createElement("pre"),a=document.createElement("span"),r=document.createElement("span"),c=document.createElement("span"),l=document.createElement("span");n.innerText=`[${new Date(e.time.request).toLocaleString(i18next.language,{hour:"2-digit",minute:"2-digit",second:"2-digit",fractionalSecondDigits:3,hourCycle:"h23"}).replace(/,|\./,":")}] [${e.status??"???"}] ${e.request.url}`,a.innerText="REQUEST:",o.append(a,e.formattedRequest),null!=e.status&&(r.innerText="RESPONSE:",l.innerText=`${e.responseTime} ms [${e.status}] ${e.statusText}`,s.append(r,l,null==e.response?"":e.formattedResponse)),null!=e.error&&(c.innerText="ERROR:",i.append(c,e.formattedError)),(null==e.response||null!=e.error||e.status>=400)&&n.setAttribute("error",""),e.isApiError&&n.setAttribute("api-error",""),t.append(n,o,s,i),v.prepend(t)}))}function i(){f.classList.contains("sbgcui_hidden")?([L,x,S].forEach((e=>e.classList.add("sbgcui_hidden"))),f.classList.remove("sbgcui_hidden"),o()):n()}function a(){g.classList.add("sbgcui_hidden"),S.innerHTML="",n(),at=!1}function r(){N.transaction("logs","readonly").objectStore("logs").getAllKeys().addEventListener("success",(e=>{const t=60*(new Date).getTimezoneOffset()*1e3,n=e.target.result,o=n[0]||Date.now(),s=n[n.length-1]||Date.now(),i=new Date(o-t).toISOString().slice(0,10),a=new Date(s-t).toISOString().slice(0,10);E.setAttribute("min",i),E.setAttribute("max",a),E.setAttribute("value",a),E.setAttribute("data-totalEntries",n.length),E.value=a,E.dispatchEvent(new Event("change")),g.classList.remove("sbgcui_hidden")})),at=!0}function c(){const e=new Date(E.value).setHours(0,0,0,0),t=new Date(E.value).setHours(23,59,59,999),n=IDBKeyRange.bound(e,t),o=N.transaction("logs","readonly").objectStore("logs").getAll(n);S.innerHTML="",S.setAttribute("data-searchInProgress",""),x.dataset.totalentries=0,o.addEventListener("success",(e=>{const t=e.target.result;if(0==t.length)return void S.removeAttribute("data-searchInProgress");const n={},o=[];t.reverse(),t.map((e=>{switch(e.type){case"capture":case"uniqcap":case"deploy":case"upgrade":case"discover":n[e.point]=n[e.point]||e.title;break;case"draw":n[e.from]=n[e.fromTitle]||e.fromTitle,n[e.to]=n[e.toTitle]||e.toTitle;break;case"destroy":case"broom":e.points.forEach((e=>{n[e]=n[e]||void 0}));break}}));for(let e in n)null==n[e]&&o.push(e);const s=o.map((e=>Ct(e)));Promise.all(s).then((e=>{S.removeAttribute("data-searchInProgress"),e.forEach((e=>{n[e.g]=e.t})),t.forEach((e=>{const t=document.createElement("p"),o=document.createElement("span"),s=document.createElement("div");t.classList.add("sbgcui_log-content-entry"),o.classList.add("sbgcui_log-content-entry-time"),s.classList.add("sbgcui_log-content-entry-description"),t.style.setProperty("--action-type",`"${e.type}"`),t.style.setProperty("--action-color",`var(--${e.type})`),t.setAttribute("data-action",e.type);switch(o.innerText=new Date(e.timestamp).toLocaleString(i18next.language,{hour:"2-digit",minute:"2-digit",second:"2-digit",hourCycle:"h23"}),e.type){case"capture":case"uniqcap":case"deploy":case"upgrade":case"discover":{const t=document.createElement("a");if(t.innerText=n[e.point]||e.point,t.innerText+=null!=e.level?` [${"discover"==e.type?"":"^"}${e.level}]`:"",t.setAttribute("data-guid",e.point),s.appendChild(t),e.loot?.length>0){const t=document.createElement("div");t.classList.add("sbgcui_log-content-entry-description-loot"),e.loot.forEach((e=>{const n=document.createElement("span"),o=document.createElement("span"),s=document.createElement("span");switch(e.t){case 1:case 2:n.classList.add("item-icon",`type-${e.t}`),n.style.backgroundColor=`var(--level-${e.l})`,o.innerText=`${e.l}\nx${e.a}`;break;case 3:n.innerText=`${i18next.t("sbgcui.refsShort")}`,o.innerText=`\nx${e.a}`;break;default:n.classList.add("item-icon",`type-${e.t}`,`rarity-${e.l}`),n.style.backgroundColor="var(--text)",o.innerText=`\nx${e.a}`;break}s.append(n,o),t.appendChild(s)})),s.appendChild(t)}break}case"draw":{const t=document.createElement("a"),o=document.createElement("a"),i=document.createElement("span"),a=e.distance,r=i18next.t("units."+(a>=1e3?"km":"m"),{count:a>=1e3?a/1e3:a}),c=e.regions instanceof Array?e.regions.length:e.regions;if(t.innerText=n[e.from],o.innerText=n[e.to],t.setAttribute("data-guid",e.from),o.setAttribute("data-guid",e.to),i.classList.add("sbgcui_log-content-entry-description-fromto"),i.append(t,"->",o),s.appendChild(i),null!=a&&s.append(`${i18next.t("sbgcui.distance")}: ${r}`,document.createElement("br")),c>0){if(s.append(`${i18next.t("sbgcui.region"+(c>1?"s":""))}: ${c}`),"number"==typeof e.regions)break;const t=e.regions.map((e=>"number"==typeof e?e:e.a)),n=i18next.t("units.sqkm",{count:Math.max(...t)}),o=i18next.t("units.sqkm",{count:t.reduce(((e,t)=>e+t),0)});if(1==c)s.append(`. ${i18next.t("sbgcui.area")}: ${n}`);else{const e=document.createElement("br");s.append(e,`${i18next.t("sbgcui.max")}: ${n}, ${i18next.t("sbgcui.total").toLowerCase()}: ${o}`)}}break}case"destroy":case"broom":{const{points:t,oldestLineDays:o,oldestRegionDays:i,xp:a}=e,r=e.lines instanceof Array?e.lines.length:e.lines,c=e.regions instanceof Array?e.regions.length:e.regions,l=`${i18next.t("sbgcui.line"+(r>1?"s":""))}: ${r}`,d=`${i18next.t("sbgcui.region"+(c>1?"s":""))}: ${c}`,u=`${i18next.t("sbgcui.oldestLineDays")}: ${o}`,g=`${i18next.t("sbgcui.oldestRegionDays")}: ${i}`;s.innerText=i18next.t("sbgcui.point"+(t.length>1?"s":""))+": ",t.forEach(((e,o)=>{const i=document.createElement("a");i.innerText=n[e]||e,i.setAttribute("data-guid",e),s.appendChild(i),o<t.length-1&&s.append(", ")})),r>0&&(s.appendChild(document.createElement("br")),s.append(l),c>0&&s.append(`, ${d.toLowerCase()}`),null!=a&&s.append(`. XP: ${a}`),o>0&&s.append(document.createElement("br"),u),c>0&&i>0&&s.append(document.createElement("br"),g));break}}C.hiddenLogs.has(e.type)?t.setAttribute("data-hidden",""):x.dataset.totalentries=+x.dataset.totalentries+1,t.append(o,s),S.appendChild(t)}))})).catch((e=>{console.log("SBG CUI: Ошибка при получении данных точек (логи).",e),S.removeAttribute("data-searchInProgress")}))})),o.addEventListener("error",(()=>{S.removeAttribute("data-searchInProgress")}))}function l(e){const t=e.target.dataset.guid;null!=t&&window.showInfo(t)}function d(e){if(!e.target.dataset.hasOwnProperty("action"))return;const t=e.target,n=t.dataset.action,o=document.querySelectorAll(`.sbgcui_log-content-entry[data-action="${n}"]`);t.toggleAttribute("data-hidden"),o.forEach((e=>{e.toggleAttribute("data-hidden")}));t.hasAttribute("data-hidden")?(C.hiddenLogs.add(n),x.dataset.totalentries=+x.dataset.totalentries-o.length):(C.hiddenLogs.delete(n),x.dataset.totalentries=+x.dataset.totalentries+o.length);N.transaction("state","readwrite").objectStore("state").put(C.hiddenLogs,"hiddenLogs")}function u(e){if(null==e.target.closest("pre"))return;const t=e.target.closest("details")?.innerText?.replace(/^(\[.+\])(.+?)(\n)/,"$1$3");window.navigator.clipboard.writeText(t).then((()=>{Rt("Выбранный лог скопирован в буфер обмена.")}))}const g=await It("log"),m=g.querySelector(".sbgcui_log-close"),p=g.querySelector(".sbgcui_log-buttons-trash"),h=g.querySelector(".sbgcui_log-buttons-dev"),f=g.querySelector(".sbgcui_log-dev"),b=g.querySelector(".sbgcui_log-dev-console"),v=g.querySelector(".sbgcui_log-dev-network"),y=g.querySelector(".sbgcui_log-dev-tabs-console"),w=g.querySelector(".sbgcui_log-dev-tabs-network"),E=g.querySelector('input[type="date"]'),L=g.querySelector(".sbgcui_log-header"),_=document.querySelector(".info > .sbgcui_jumpToButton"),S=g.querySelector(".sbgcui_log-content"),x=g.querySelector(".sbgcui_log-tags"),k=document.createElement("button");C.hiddenLogs=C.hiddenLogs||new Set,k.classList.add("fa","fa-solid-table-list"),[...x.children].forEach((e=>{const t=e.dataset.action;C.hiddenLogs.has(t)&&e.setAttribute("data-hidden","")})),k.addEventListener("click",r),m.addEventListener("click",a),p.addEventListener("click",t),h.addEventListener("click",i),y.addEventListener("click",o),w.addEventListener("click",s),_.addEventListener("click",a),x.addEventListener("click",d),S.addEventListener("click",l),E.addEventListener("keydown",(e=>{e.preventDefault()})),E.addEventListener("change",c),v.addEventListener("click",u),T.addItem(k,6),document.body.appendChild(g)}catch(e){console.log("SBG CUI: Ошибка (логи).",e)}{async function e(e){return fetch("/api/notifs"+(null==e?"":"?latest="+e),{headers:{authorization:`Bearer ${t.auth}`,"accept-language":i18next.language},method:"GET"}).then((e=>e.json())).then((e=>e.count??e.list))}async function n(){const{status:t,duration:n,onClick:o}=x.notifications;"off"!=t&&("fav"==t&&0==Object.keys(k).length||(d=await e(Xe),d>0&&(u=await e(),Xe=u[0].ti,u.slice(0,d).reverse().forEach((e=>{const{g:i,na:a,ta:l,ti:d,c:g,t:m}=e,p=new Date(d).toLocaleString(i18next.language,{hour:"2-digit",minute:"2-digit",second:"2-digit",hourCycle:"h23"});if("fav"==t&&!(i in k))return;const h=Dt(s(a,l,p,m),"bottom left",n,"sbgcui_destroy_notif_toast",!1);h.options.selector=r,h.options.callback=()=>{const e=+new Date(localStorage.getItem("latest-notif"));+new Date(d)>e&&localStorage.setItem("latest-notif",d),d==u[0].ti&&Se.removeAttribute("data-count"),c.delete(h)},"jumpto"==o&&(h.options.close=!0,h.options.onClick=()=>{h.hideToast(),Xt(g),Kt(void 0,g)}),c.add(h),h.showToast()})))))}function o(){c.forEach((e=>{e.hideToast()}))}function s(e,t,n,o){const s=document.createElement("div"),i=document.createElement("span"),a=document.createElement("span"),r=document.createElement("span"),c=document.createElement("span");return s.classList.add("sbgcui_destroy_notif_toast-content"),a.style.color=`var(--team-${t})`,a.innerText=e,r.innerText=`@ ${n}`,c.innerText=o,i.append(a,r),s.append(i,c),s}function i(){l!=x.notifications.interval&&(clearInterval(g),l=x.notifications.interval,g=setInterval(n,l))}const a=document.createElement("button"),r=document.createElement("div"),c=new Set;r.classList.add("sbgcui_destroy_notifs"),a.classList.add("sbgcui_button_reset","sbgcui_destroy_notifs-closeall"),a.innerText="Закрыть всё",r.appendChild(a),document.body.appendChild(r);let l=x.notifications.interval,d=0,u=await e();Xe=u[0]?.ti??new Date(0).toISOString();let g=setInterval(n,l);window.addEventListener("configUpdated",i),Se.addEventListener("click",o),a.addEventListener("click",o)}{const e=document.querySelector(".inventory__manage-amount input"),t=document.querySelector(".inventory .inventory__ma-buttons"),n=[10,50,100],o=document.createElement("div");n.forEach((e=>{const t=document.createElement("span");t.innerText=e,t.dataset.amount=e,o.appendChild(t)})),o.addEventListener("click",(t=>{const n=t.target.dataset.amount,o=+e.max;null!=n&&(e.value=n>o?o:n)})),o.classList.add("sbgcui_inventory__ma-shortcuts"),t.before(o)}{const e=document.createElement("button");function t(){const e=prompt("Введите имя игрока (чувствительно к регистру): ");null!=e&&window.openProfile(e)}e.classList.add("fa","fa-solid-magnifying-glass","sbgcui_button_reset","sbgcui_playerSearchButton"),e.addEventListener("click",t),_e.appendChild(e)}}catch(e){console.log("SBG CUI: Ошибка в main.",e)}var Q}));const R=indexedDB.open("CUI",9);R.addEventListener("upgradeneeded",(e=>{const t={maxAmountInBag:{cores:{1:-1,2:-1,3:-1,4:-1,5:-1,6:-1,7:-1,8:-1,9:-1,10:-1},catalysers:{1:-1,2:-1,3:-1,4:-1,5:-1,6:-1,7:-1,8:-1,9:-1,10:-1},references:{allied:-1,hostile:-1}},autoSelect:{deploy:"max",upgrade:"min",attack:"latest"},mapFilters:{invert:I&&!T?1:0,hueRotate:I?180:0,brightness:I?.75:1,grayscale:I?1:0,sepia:1,blur:0,branding:"default",brandingColor:"#CCCCCC"},tinting:{map:1,point:"level",profile:1},vibration:{buttons:1,notifications:1},ui:{doubleClickZoom:0,restoreRotation:1,pointBgImage:1,pointBtnsRtl:0,pointBgImageBlur:1,pointDischargeTimeout:1,speedometer:1},pointHighlighting:{inner:"uniqc",outer:"off",outerTop:"cores",outerBottom:"highlevel",text:"refsAmount",innerColor:"#E87100",outerColor:"#E87100",outerTopColor:"#EB4DBF",outerBottomColor:"#28C4F4"},drawing:{returnToPointInfo:"discoverable",minDistance:-1,maxDistance:-1,hideLastFavRef:0},notifications:{status:"all",onClick:"jumpto",interval:3e4,duration:-1}},{newVersion:n,oldVersion:o}=e;N=e.target.result,0==o?function(){N.createObjectStore("config"),N.createObjectStore("logs",{keyPath:"timestamp"}),N.createObjectStore("state"),N.createObjectStore("stats",{keyPath:"name"}),N.createObjectStore("tiles"),N.createObjectStore("favorites",{keyPath:"guid"});const n=e.target.transaction,o=n.objectStore("config"),s=n.objectStore("logs"),i=n.objectStore("state");for(let e in t)o.add(t[e],e);s.createIndex("action_type","type"),i.add(new Set,"excludedCores"),i.add(!0,"isMainToolbarOpened"),i.add(!1,"isRotationLocked"),i.add(!1,"isStarMode"),i.add(null,"lastUsedCatalyser"),i.add(null,"starModeTarget"),i.add(0,"versionWarns"),i.add(!1,"isAutoShowPoints")}():function(){const s={2:()=>{N.createObjectStore("logs",{keyPath:"timestamp"})},3:()=>{const t=e.target.transaction.objectStore("logs");t.clear(),t.createIndex("action_type","type")},4:()=>{const{base:t,theme:n}=JSON.parse(localStorage.getItem("settings"))||{},o=`${t}_${n}`;e.target.transaction.objectStore("state").add(o,"baselayer"),N.createObjectStore("tiles")},5:()=>{e.target.transaction.objectStore("config").put(t.notifications,"notifications")},6:()=>{const t=e.target.transaction.objectStore("config");t.get("maxAmountInBag").addEventListener("success",(e=>{const n=e.target.result;["I","II","III","IV","V","VI","VII","VIII","IX","X"].forEach(((e,t)=>{const o=t+1;n.catalysers[o]=n.catalysers[e],n.cores[o]=n.cores[e],delete n.catalysers[e],delete n.cores[e]})),t.put(n,"maxAmountInBag")}))},7:()=>{const t=e.target.transaction.objectStore("config");t.get("drawing").addEventListener("success",(e=>{const n=e.target.result;n.hideLastFavRef=0,t.put(n,"drawing")}))},8:()=>{const t=e.target.transaction.objectStore("state"),n=e.target.transaction.objectStore("tiles");t.delete("baselayer"),n.clear()},9:()=>{const t=e.target.transaction.objectStore("config");t.get("drawing").addEventListener("success",(e=>{const n=e.target.result;n.returnToPointInfo="discoverable",t.put(n,"drawing")}))}};for(let e in s)e>o&&e<=n&&s[e]()}()})),R.addEventListener("success",(e=>{function t(e){const t=e.target.source.name,n=e.target.result;let o;switch(t){case"config":o=x;break;case"state":o=C;break;case"favorites":o=k;break;default:return}null!=n&&(o[n.key]=n.value,n.continue())}null==N&&(N=e.target.result),N.addEventListener("versionchange",(()=>{N.close(),window.location.reload()})),N.addEventListener("error",(e=>{console.log("SBG CUI: Ошибка при работе с БД.",e.target.error)}));const n=N.transaction(["config","favorites","state","tiles"],"readonly");n.addEventListener("complete",(()=>{window.dispatchEvent(new Event("dbReady"))}));[n.objectStore("config").openCursor(),n.objectStore("favorites").openCursor(),n.objectStore("state").openCursor()].forEach((e=>{e.addEventListener("success",t)})),function(){if("function"!=typeof navigator.storage?.estimate)return;const e=e=>e>=1024**3?+(e/1024**3).toFixed(2)+" GB":+(e/1048576).toFixed(1)+" MB";navigator.storage.estimate().then((({quota:t,usage:n})=>{console.log(`Storage quota: ${e(t)}, usage: ${e(n)}.`)}))}()})),R.addEventListener("error",(e=>{console.log("SBG CUI: Ошибка открытия базы данных",e.target.error)}))}();