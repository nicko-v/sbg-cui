// ==UserScript==
// @name         SBG CUI
// @namespace    https://sbg-game.ru/app/
// @version      1.14.15
// @downloadURL  https://nicko-v.github.io/sbg-cui/index.min.js
// @updateURL    https://nicko-v.github.io/sbg-cui/index.min.js
// @description  SBG Custom UI
// @author       NV
// @match        https://sbg-game.ru/app/*
// @run-at       document-idle
// @grant        none
// @iconURL      https://nicko-v.github.io/sbg-cui/assets/img/tm_script_logo.png
// ==/UserScript==
!function(){"use strict";if(window.location.pathname.startsWith("/login"))return;if(document.querySelector('[src="intel.js"]'))return;if(window.cuiStatus="loading",window.stop(),document.open(),0==/firefox/i.test(window.navigator.userAgent))for(let e=0;e<=100;e+=1)window.navigator.geolocation.clearWatch(e);const e=[],t=t=>{e.push({timestamp:Date.now(),messages:t})},n=e=>function(...n){return t(n.map((e=>e?.message?`${e.message}${e.stack?"<br>"+e.stack:""}`:e.toString()))),e(...n)};console.log=n(console.log),console.warn=n(console.warn),console.error=n(console.error),window.onerror=(e,n,o,i,s)=>{t([s.message,`Line: ${o}, column: ${i}`])};const o={region:125,line:45,core:10},i=[0,500,750,1e3,1500,2e3,2500,3500,4e3,5250,6500],s=[0,6,6,4,4,3,3,2,2,1,1],a="https://nicko-v.github.io/sbg-cui",r=3e3,c=["","cores","catalysers","references","brooms"],l="0.4.2-2",d=[1500,5e3,12500,25e3,6e4,125e3,35e4,675e3,1e6,1/0],u=window.innerHeight/2*.7,g={},m={},p={},h="cdb"==JSON.parse(localStorage.getItem("settings"))?.base,f=matchMedia("(prefers-color-scheme: dark)").matches,b=window.matchMedia("(orientation: portrait)");let v,y,w,_,E,L="true"==localStorage.getItem("follow");window.addEventListener("dbReady",(function(){fetch("/app").then((e=>e.text())).then((e=>{e=(e=e.replace(/<script class="mobile-check">.+?<\/script>/,"")).replace(/(<script src="https:\/\/cdn.jsdelivr.net\/npm\/ol@.+?)(>)/,"$1 onload=\"window.dispatchEvent(new Event('olReady'))\"$2"),document.write(e),document.close()})).catch((e=>{}))})),window.addEventListener("olReady",(()=>{!function(){class e extends ol.Map{constructor(e){super(e),v=this,_=e.layers.filter((e=>"lines"==e.get("name")))[1]?.getSource(),window.dispatchEvent(new Event("mapReady"))}forEachFeatureAtPixel(e,t,n={}){const o=t.toString().includes("piv.push");if(n.hitTolerance=isFinite(n.hitTolerance)?n.hitTolerance:15,o){const o=(e,n)=>{e.get("sbgcui_chosenFeature")&&(t(e,n),e.unset("sbgcui_chosenFeature",!0))};super.forEachFeatureAtPixel(e,o,n)}else super.forEachFeatureAtPixel(e,t,n)}}class t extends ol.Feature{setStyle(e){if(e&&null==w&&3==e.length&&e[0].image_?.iconImage_.src_.match(/\/assets\/player/)){let t=e[1].getGeometry().setCenter;e[1].getGeometry().setCenter=n=>{t.call(e[1].getGeometry(),n),e[3].getGeometry().setCenter(n)},e[3]=new ol.style.Style({geometry:new ol.geom.Circle(ol.proj.fromLonLat([0,0]),0),stroke:new ol.style.Stroke({color:"#CCCCCC33",width:4})}),w=this}super.setStyle(e)}get blastRange(){return this==w?this.getStyle()[3].getGeometry():void 0}}class n extends ol.View{constructor(e){b.matches&&(e.padding=[u,0,0,0]),super(e),y=this}fitBlastRange(e){const t=this.getZoom(),n=y.get("isZoomChanged")?t:17;e?this.set("blastRangeZoom",t):(this.removePadding(),this.fit(w.blastRange,{callback:this.fitBlastRange.bind(this),duration:0,maxZoom:n}))}fitTempLine(e,t){this.removePadding(),this.fit(e,{duration:0,maxZoom:17,padding:t})}setTopPadding(){b.matches&&(this.padding=[u,0,0,0])}setBottomPadding(){b.matches&&(this.padding=[0,0,u,0])}removePadding(){this.padding=[0,0,0,0]}}class o extends ol.layer.Tile{constructor(e){e.preload=1/0,super(e)}}class i extends ol.source.XYZ{constructor(e){super({...e,...l})}}class s extends ol.source.OSM{constructor(e){super({...e,...l})}}class a extends ol.source.StadiaMaps{constructor(e){super({...e,...l})}}function r(e,t){const n=e.getTileCoord().join();E.transaction("tiles","readonly").objectStore("tiles").get(n).addEventListener("success",(o=>{const i=o.target.result;null==i?fetch(t).then((e=>{if(e.ok)return e.blob();throw new Error(`[${e.status}] Не удалось загрузить тайл ${n}.`)})).then((t=>{c(e,t),E.transaction("tiles","readwrite").objectStore("tiles").put(t,n)})).catch((e=>{})):c(e,i)}))}function c(e,t){const n=e.getImage(),o=URL.createObjectURL(t);n.addEventListener("load",(()=>{URL.revokeObjectURL(o)})),n.src=o}const l={cacheSize:2048,tileLoadFunction:r};ol.Map=e,ol.Feature=t,ol.View=n,ol.layer.Tile=o,ol.source.XYZ=i,ol.source.OSM=s,ol.source.StadiaMaps=a}(),function(){function e(e){switch(o+=1,e){case"const Catalysers":return"window.Catalysers";case"const TeamColors":return"window.TeamColors";case"if (zoom % 1 != 0)":return`//${e}`;case"if (getSettings('plrhid') == true) $('.ol-layer__player').addClass('hidden')":return`${e};}\n\t\t\t\t\t\t\t\t\tif (!document.querySelector('.info.popup').classList.contains('hidden')) {\n\t\t\t\t\t\t\t\t\t\tmanageControls();\n          \t\t\t\t\t$('#i-stat__distance').text(distanceToString(getDistance(point_state.info.c)));\n\t\t\t\t\t\t\t\t\t}{`;case"const attack_slider":return"window.attack_slider";case"const deploy_slider":return"window.deploy_slider";case"const draw_slider":return"window.draw_slider";case"if ($('.attack-slider-wrp').hasClass('hidden')) {":return`${e}return;`;case"$('[name=\"baselayer\"]').on('change', e":return"$('.layers-config__list').on('change', '[name=\"baselayer\"]', e";case"hour: '2-digit'":return`${e}, hourCycle: 'h23', second: '2-digit'`;case"function initCompass() {":return DeviceOrientationEvent?`${e}return;`:e;case"testuser":return"NickolayV";case"timers.info_controls = setInterval(() => {":return"timers.info_controls = setTimeout(() => {";case"delete cooldowns[guid]":return`${e}; manageControls();`;case"makeEntry(e, data)":return"window.makeEntryDec(e, data, makeEntry)";case"makeItemTitle(item)":return"makeShortItemTitle(item)";case"view.calculateExtent(map.getSize()":return`view.calculateExtent([map.getSize()[0], map.getSize()[1] + ${u}]`;case"z: view.getZoom()":return"z: Math.floor(view.getZoom())";case"if (area < 1)":return"if (area < 0)";case"if (type == 'osm') {":return"if (type.startsWith('stadia')) { source=new ol.source.StadiaMaps({ layer:'stamen_'+type.split('_')[1] })} else if (type == 'osm') {";case"class Bitfield":return"window.requestEntities = requestEntities; window.showInfo = showInfo; window.Bitfield = class Bitfield";default:return o-=1,e}}const t=new RegExp(["(const Catalysers)","(const TeamColors)","(if \\(zoom % 1 != 0\\))","(if \\(getSettings\\('plrhid'\\) == true\\) \\$\\('\\.ol-layer__player'\\)\\.addClass\\('hidden'\\))","(const attack_slider)","(const deploy_slider)","(const draw_slider)","(if \\(\\$\\('\\.attack-slider-wrp'\\).hasClass\\('hidden'\\)\\) {)","(\\$\\('\\[name=\"baselayer\"\\]'\\)\\.on\\('change', e)","(hour: '2-digit')","(function initCompass\\(\\) {)","(testuser)","(timers\\.info_controls = setInterval\\(\\(\\) => {)","(delete cooldowns\\[guid\\](?=\\s+?localStorage\\.setItem))","(makeEntry\\(e, data\\)(?!\\s{))","(makeItemTitle\\(item\\)(?!\\s{))","(view\\.calculateExtent\\(map\\.getSize\\(\\))","(z: view.getZoom\\(\\))","(if \\(area < 1\\))","(if \\(type == 'osm'\\) {)","(class Bitfield)"].join("|"),"g"),n=22;let o=0;fetch("/app/script.js").then((e=>e.text())).then((i=>{const s=document.createElement("script");if(s.textContent=i.replace(t,e),o!=n)throw new Error(`SBG CUI: Сделано замен: ${o} вместо ${n}.`);document.head.appendChild(s)})).catch((e=>{alert(`SBG CUI: Ошибка при загрузке основного скрипта. ${e.message}`)}))}()})),window.addEventListener("mapReady",(async function(){try{const T=Intl.NumberFormat(i18next.language).formatToParts(1111)[1].value,I=Intl.NumberFormat(i18next.language).formatToParts(1.1)[1].value;class P{constructor(e,t){this.loot=e,this.refs=t}get isActive(){return!(this.loot&&this.refs)}}class q{constructor(e){this.coords=e.c,this.guid=e.g,this.level=e.l,this.team=e.te,this.title=e.t,this.possibleLines=[],this.lines={in:e.li.i,out:e.li.o},this.regionsAmount=e.r,this.cores={},this.image=`https://lh3.googleusercontent.com/${e.i}`,this.update(e.co)}get emptySlots(){return 6-Object.keys(this.cores)}get isEmptySlots(){return this.emptySlots>0}get playerCores(){let e={};for(let t in this.cores){let o=this.cores[t];o.owner==n.name&&(o.level in e?e[o.level]+=1:e[o.level]=1)}return e}get energy(){if(0==Object.keys(this.cores).length)return 0;let e=0,t=0;for(let n in this.cores)e+=i[this.cores[n].level],t+=this.cores[n].energy;return t/e*100}get energyFormatted(){return Fe.format(this.energy)}get mostChargedCatalyserEnergy(){let e=Math.max(...Object.values(this.cores).map((e=>e.energy/i[e.level]*100)));return isFinite(e)?e:null}get dischargeTimeout(){const e=this.mostChargedCatalyserEnergy,t=new Intl.RelativeTimeFormat(i18next.language,{style:"short"});if(null==e)return"";let n=e/.6*60*60*1e3,o=["day","hour"],i="";return[864e5,36e5].forEach(((e,s)=>{const a=Math.trunc(n/e),r=t.formatToParts(a,o[s]),c=`${r[1].value}${r[2].value}`;a&&(i+=`${i.length?", ":""}${c}`,n-=a*e)})),i}get coresAmount(){return Object.keys(this.cores).length}get linesAmount(){return this.lines.in+this.lines.out}get destroyReward(){return o.core*this.coresAmount+o.line*this.linesAmount+o.region*this.regionsAmount}update(e){e.forEach((e=>{this.cores[e.g]={energy:e.e,level:e.l,owner:e.o}}));const t=new Event("pointRepaired");se.dispatchEvent(t)}selectCore(e,t){let o,i=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>1==e.t&&!Te.has(e.g))).sort(((e,t)=>e.l-t.l)),a=this.playerCores;switch(e){case"min":o=t?i.find((e=>e.l>t&&(a[e.l]||0)<s[e.l]&&e.l<=n.level)):i.find((e=>(a[e.l]||0)<s[e.l]&&e.l<=n.level));break;case"max":o=i.findLast((e=>e.l<=n.level&&(a[e.l]||0)<s[e.l]));break}Ke(z.querySelector(`[data-guid="${o?.g}"]:not(.is-active)`))}}class A extends ol.control.Control{#e=document.createElement("button");#t=!1;#n=document.createElement("div");constructor(e){const t=document.createElement("div");t.classList.add("ol-unselectable","ol-control","sbgcui_toolbar-control"),super({element:t}),this.name=e,this.#e.classList.add("fa","fa-solid-angle-up"),this.#e.addEventListener("click",this.handleExpand.bind(this)),this.#n.classList.add("sbgcui_toolbar"),Ie?this.expand():this.collapse(),t.append(this.#n,this.#e)}addItem(e,t){e.style.order=t,this.#n.appendChild(e)}collapse(){this.#e.classList.remove("fa-rotate-180"),this.#e.style.opacity=1,this.#n.classList.add("sbgcui_hidden"),this.#t=!1,E.transaction("state","readwrite").objectStore("state").put(!1,`is${this.name}Opened`)}expand(){this.#e.classList.add("fa-rotate-180"),this.#e.style.opacity=.5,this.#n.classList.remove("sbgcui_hidden"),this.#t=!0,E.transaction("state","readwrite").objectStore("state").put(!0,`is${this.name}Opened`)}handleExpand(){this.#t?this.collapse():this.expand()}}class O{#o;constructor(e,t,n){this.guid=e,this.name=n||e,this.cooldown=t,this.discoveriesLeft=void 0,this.timeoutID=void 0,this.isActive=1,n||this.#i()}#i(){Ne(this.guid).then((e=>{this.name=e.t})).catch((e=>{}))}#s(){if(!this.isActive)return;let e=`"${this.name}": точка остыла.`;if(!Je()&&"Notification"in window&&"granted"==Notification.permission){new Notification(e,{icon:"/icons/icon_512.png"})}else{Qe(e,"top left",-1,"sbgcui_toast-selection").showToast(),"vibrate"in window.navigator&&g.vibration.notifications&&(window.navigator.vibrate(0),window.navigator.vibrate([500,300,500,300,500]))}}#a(){this.#s(),this.cooldown=null}#r(e){let t=e-Date.now();clearTimeout(this.timeoutID),this.timeoutID=setTimeout(this.#a.bind(this),t)}toJSON(){return this.cooldown>Date.now()?this.cooldown:null}get hasActiveCooldown(){return this.cooldown-Date.now()>0}get cooldown(){return this.#o}get timer(){if(!this.cooldown)return"";let e=new Date(this.cooldown-Date.now());if(e<0)return"";return new Intl.DateTimeFormat("ru-RU",{hour:"numeric",minute:"numeric",second:"numeric",timeZone:"UTC"}).format(e)}set cooldown(e){this.#o=e>Date.now()?e:null,this.#o&&(this.discoveriesLeft=void 0,this.#r(this.#o))}}window.fetch=ut(window.fetch),window.Toastify=($=window.Toastify,function(e){return e.selector=null,e.style={fontSize:"0.8em"},$(e)});let M,F,j=document.documentElement,B=document.querySelector("#attack-menu"),D=document.querySelector(".attack-slider-wrp"),N=document.querySelector(".bottom-container"),R=document.querySelector(".draw-slider-wrp"),H=document.querySelector(".deploy-slider-wrp"),G=document.querySelector("#catalysers-list"),z=document.querySelector("#cores-list"),V=document.querySelector("#refs-list"),Z=document.querySelector("#discover"),J=document.querySelector("#ops"),U=document.querySelector("#inventory__close"),W=document.querySelector(".inventory__content"),X=document.querySelector(".inventory.popup"),Y=document.querySelector("#self-info__inv"),K=document.querySelector(".i-stat__cores"),Q=document.querySelector("#i-image"),ee=document.querySelector(".i-image-box"),te=document.createElement("span"),ne=document.querySelector("#i-level"),oe=document.querySelector("#i-stat__owner"),ie=document.querySelector("#i-title"),se=document.querySelector(".info.popup"),ae=document.querySelector(".info.popup > .popup-close"),re=document.querySelector("#pr-name"),ce=document.querySelector(".profile.popup"),le=document.querySelector(".profile.popup > .popup-close"),de=document.querySelector(".pr-stat__age > .pr-stat-val"),ue=document.querySelector("#self-info__exp"),ge=document.querySelector("#self-info__explv"),me=document.querySelector("#self-info__name"),pe=document.querySelector(".topleft-container"),he=document.querySelector("#toggle-follow"),fe=document.querySelector('meta[name="viewport"]'),be=document.querySelector(".xp-diff"),ve=document.querySelector(".ol-zoom"),ye=!X.classList.contains("hidden"),we=!se.classList.contains("hidden"),_e=!ce.classList.contains("hidden"),Ee=!D.classList.contains("hidden"),Le=!R.classList.contains("hidden"),xe=!1,Se={},ke={c:new Set,v:new Set},Ce={},$e=[],{excludedCores:Te,isMainToolbarOpened:Ie,isRotationLocked:Pe,isStarMode:qe,lastUsedCatalyser:Ae,starModeTarget:Oe,versionWarns:Me}=m,Fe=new Intl.NumberFormat(i18next.language,{maximumFractionDigits:1}),je={I:1,II:2,III:3,IV:4,V:5,VI:6,VII:7,VIII:8,IX:9,X:10,toDecimal(e){return this[e]},toRoman(e){return Object.keys(this).find((t=>this[t]==e))}};async function Be(){return fetch("/api/self",{headers:{authorization:`Bearer ${localStorage.getItem("auth")}`,"accept-language":i18next.language},method:"GET"}).then((e=>e.json().then((t=>({version:e.headers.get("SBG-Version"),name:t.n,team:t.t,exp:t.x,lvl:t.l,guid:t.g}))))).catch((e=>{}))}async function De(e,t){return fetch("/api/profile?"+(e?"guid="+e:"name="+t),{headers:{authorization:`Bearer ${localStorage.getItem("auth")}`,"accept-language":i18next.language},method:"GET"}).then((e=>e.json())).catch((e=>{}))}async function Ne(e,t=!0){return fetch(`/api/point?guid=${e}${t?"&status=1":""}`,{headers:{authorization:`Bearer ${n.auth}`,"accept-language":i18next.language},method:"GET"}).then((e=>e.json())).then((e=>e.data))}async function Re(){return fetch("/api/inventory",{headers:{authorization:`Bearer ${n.auth}`,"accept-language":i18next.language},method:"GET","accept-language":i18next.language}).then((e=>e.json())).then((e=>e.i))}async function He(e=!1,t=[]){let o=g.maxAmountInBag;Re().then((n=>{const i=n.reduce(((e,t)=>e+t.a),0),s=r-i>=100,{allied:a,hostile:c}=o.references;if(s&&!e&&0==t.length)throw{silent:!0};if(!s||e){if(-1==a&&-1==c||0==a&&0==c)return[n,t,[]];const e=n.map((e=>3==e.t?Ne(e.l):void 0)).filter((e=>e));return Promise.all([n,t,...e])}return[[],t,[]]})).then((([e,t,...i])=>{let s={};i.forEach((e=>{s[e.g]={team:e.te}}));let a=e.map((({t:e,l:t,a:i,g:a})=>{if(e>c.length-1)return;let r=-1,l=0,d=c[e];if("references"==d){if(qe&&t==Oe?.guid)r=-1;else if(p[t]?.isActive)r=-1;else if(-1==o.references.allied&&-1==o.references.hostile)r=-1;else if(0==o.references.allied&&0==o.references.hostile)r=0;else if(Object.keys(s).length){let e=s[t].team==n.team?"allied":"hostile";r=o[d][e]}}else r=o[d]?.[je.toRoman(t)];return-1!=r&&i>r&&(l=i-r),{guid:a,type:e,amount:l}})).filter((e=>e?.amount>0));return t.forEach((e=>{const t=a.find((t=>t.guid==e.guid));t?(t.amount+=e.amount,t.filtered=e.amount):a.push({...e,filtered:e.amount})})),Promise.all([a,Ge(a)])})).then((([e,t])=>{if(!e.length)return;let n=t.reduce(((e,t)=>t.count.total<e?t.count.total:e),1/0);if(isFinite(n)&&(Y.innerText=n,J.style.color.match("accent")&&n<r&&(J.style.color="")),Ue(e),e=e.reduce(((e,t)=>{const n=t.amount-(t.filtered??0);return 0!=n&&(e.hasOwnProperty(t.type)||(e[t.type]=0),e[t.type]+=n),e}),{}),Object.entries(e).every((e=>0==e[1])))return;let o="";for(let t in e){const n=i18next.t(`items.types.${c[t].slice(0,-1)}`);o+=`<br><span style="background: var(--sbgcui-branding-color); margin-right: 5px;" class="item-icon type-${t}"></span>x${e[t]} ${n}`}Qe(`Удалено: ${o}`).showToast()})).catch((e=>{if(e.silent)return;Qe(`Ошибка при проверке или очистке инвентаря. <br>${e.message}`,void 0,void 0,"error-toast").showToast()}))}async function Ge(e){let t=e.reduce(((e,t)=>(e.hasOwnProperty(t.type)||(e[t.type]={}),e[t.type][t.guid]=t.amount,e)),{});return Promise.all(Object.keys(t).map((async e=>fetch("/api/inventory",{headers:{authorization:`Bearer ${n.auth}`,"accept-language":i18next.language,"content-type":"application/json"},body:JSON.stringify({selection:t[e],tab:e}),method:"DELETE"}).then((e=>e.json())))))}async function ze(e){return fetch("/api/repair",{headers:{authorization:`Bearer ${n.auth}`,"accept-language":i18next.language,"content-type":"application/x-www-form-urlencoded; charset=UTF-8"},body:`guid=${e}&position%5B%5D=0.0&position%5B%5D=0.0`,method:"POST"}).then((e=>e.json()))}async function Ve(e){return fetch(`${a}/assets/html/${e}.html`).then((t=>{if(200!=t.status)throw new Error(`Ошибка при загрузке ресурса "${e}.html" (${t.status})`);return t.text()})).then((e=>(new DOMParser).parseFromString(e,"text/html").body.firstChild))}function Ze(e,t){const n=JSON.stringify(e),o={status:t.status,statusText:t.statusText,headers:t.headers},i=new Response(n,o);return Object.defineProperty(i,"url",{value:t.url,enumerable:!0}),i}function Je(){return"maxTouchPoints"in window.navigator?window.navigator.maxTouchPoints>0:"msMaxTouchPoints"in window.navigator?window.navigator.msMaxTouchPoints>0:"orientation"in window||/\b(BlackBerry|webOS|iPhone|IEMobile|Android|Windows Phone|iPad|iPod)\b/i.test(window.navigator.userAgent)}function Ue(e){let t=JSON.parse(localStorage.getItem("inventory-cache"))||[];e.forEach((e=>{const n=t.find((t=>t.g==e.guid)),o=e.amount-(e.filtered??0),i=1==e.type?H:2==e.type?D:void 0;if(n&&(n.a-=o),null!=i&&o>0){const t=i.querySelector(`li[data-guid="${e.guid}"]`);if(null==t)return;const n=t.querySelector(`li[data-guid="${e.guid}"] > .${1==e.type?"cores":"catalysers"}-list__amount`),s=+n.innerText.slice(1);s-o>0?n.innerText="x"+(s-o):(t.remove(),window[(i==D?"attack":"deploy")+"_slider"].refresh())}})),t=t.filter((e=>e.a>0)),localStorage.setItem("inventory-cache",JSON.stringify(t))}function We(){function e(e,t){let n=document.createElement("details");n.classList.add("sbgcui_settings-section");let o=document.createElement("summary");o.classList.add("sbgcui_settings-title"),o.innerText=e;let i=document.createElement("h6");return i.classList.add("sbgcui_settings-subtitle"),i.innerHTML=t,n.appendChild(o),n.appendChild(i),n}function t(e,t,n,o,i){let s="checkbox"==e,a=document.createElement("div"),r=document.createElement("label"),c=document.createElement("input");if(a.classList.add("sbgcui_settings-input_wrp"),c.id=s?t:t+Math.random().toString().slice(2),c.name=t,c.type=e,c.value=s?1:i,c.checked=n,r.htmlFor=c.id,r.innerText=o,s){let e=document.createElement("input");e.name=t,e.type="hidden",e.value=0,a.appendChild(e)}return a.append(c,r),a}function o(e,t,n,o,i,s,a,r){let c=document.createElement("div"),l=document.createElement("label"),d=document.createElement("input");return c.classList.add("sbgcui_settings-range_input_wrp"),d.type=e,d.name=t,d.min=n,d.max=o,d.step=i,d.value=s,l.innerText=a,null!=r&&d.addEventListener("input",r),c.append(l,d),c}function i(e,t){let n=document.createElement("input");return n.type="color",n.name=e,n.value=t,n}function s(e,t=[],n,o){let i=document.createElement("h5"),s=document.createElement("select"),a=document.createElement("div");return i.classList.add("sbgcui_settings-dropdown-title"),i.innerText=e,t.forEach((e=>{let t=document.createElement("option");t.innerText=e[0],t.value=e[1],s.appendChild(t)})),s.name=n,s.value=o,a.classList.add("sbgcui_settings-dropdown_wrapper"),a.append(i,s),a}function a(e,t,n){let o=document.createElement("h5"),i=document.createElement("input"),s=document.createElement("div");return o.classList.add("sbgcui_settings-textfield-title"),o.innerText=e,i.name=t,i.type="number",i.min=-1,i.value=n,s.classList.add("sbgcui_settings-textfield_wrapper"),s.append(o,i),s}let r=document.createElement("form");r.classList.add("sbgcui_settings","sbgcui_hidden");let c=document.createElement("span");c.classList.add("sbgcui_settings-version"),c.innerText="v1.14.15";let l=document.createElement("h3");l.classList.add("sbgcui_settings-header"),l.innerText="Настройки";let d=document.createElement("button");d.innerText="Сохранить";let u=document.createElement("button");u.innerText="Закрыть",u.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),Xe()}));let m=document.createElement("div");m.classList.add("sbgcui_settings-buttons_wrp"),m.append(d,u);let p=[function(t){let n=e("Автоудаление",'Когда в инвентаре останется меньше 100 мест, будут удалены предметы, превышающие указанное количество. <br>Значение "-1" предотвращает удаление.'),o=document.createElement("button");o.classList.add("sbgcui_settings-forceclear"),o.innerText="Очистить сейчас",o.addEventListener("click",(function(e){e.preventDefault(),confirm("Произвести очистку инвентаря согласно настройкам?")&&He(!0)})),n.appendChild(o);for(let e in t){let o=document.createElement("section"),i=document.createElement("h4"),s=document.createElement("h6"),a=document.createElement("div");switch(o.classList.add("sbgcui_settings-subsection"),i.classList.add("sbgcui_settings-title"),s.classList.add("sbgcui_settings-subtitle"),a.classList.add("sbgcui_settings-maxamounts"),e){case"cores":i.innerText="Ядра";break;case"catalysers":i.innerText="Катализаторы";break;case"references":i.innerText="Сноски",s.innerHTML="Сноски от избранных точек удаляться не будут.<br>Для добавления в избранное нажмите звезду на карточке точки.";break}for(let n in t[e]){let o=document.createElement("div"),i=document.createElement("label"),s=document.createElement("input");o.classList.add("sbgcui_settings-amount_input_wrp"),i.classList.add("sbgcui_settings-amount_label"),s.classList.add("sbgcui_settings-amount_input"),"references"==e?(i.innerText="allied"==n?"Свои:":"Чужие:",i.classList.add(`sbgcui_settings-amount_label_${n}`)):(i.innerText=n+":",i.style.color=`var(--level-${je.toDecimal(n)})`),s.name=`maxAmountInBag_${e}_${n}`,s.type="number",s.min=-1,s.value=t[e][n],o.append(i,s),a.appendChild(o)}o.append(i,s,a),n.appendChild(o)}return n}(g.maxAmountInBag),function(t){let n=e("Автовыбор","Можно автоматически выбирать самый мощный катализатор при атаке, самое маленькое ядро при деплое или следующий уровень ядра при каждом апгрейде. Вы можете исключить конкретное ядро из автовыбора: нажмите на него в карусели и удерживайте 1 секунду до появления уведомления."),o=document.createElement("section"),i=s("Катализатор при атаке:",[["Самый мощный","max"],["Последний использованный","latest"]],"autoSelect_attack",t.attack),a=s("Ядро при деплое:",[["Наименьшее","min"],["Наибольшее","max"],["Вручную","off"]],"autoSelect_deploy",t.deploy),r=s("Ядро при апгрейде:",[["Наименьшее","min"],["Наибольшее","max"],["Вручную","off"]],"autoSelect_upgrade",t.upgrade);return o.classList.add("sbgcui_settings-subsection"),o.append(i,a,r),n.appendChild(o),n}(g.autoSelect),function(t){let a=e("Цветовая схема","Настройте цвет своей команды и оттенок карты."),r=document.createElement("section"),c=e=>{!function(e,t){let n=e.split("_")[1],o="blur"==n?"px":"hueRotate"==n?"deg":"";j.style.setProperty(`--sbgcui-${n}`,`${t}${o}`)}(e.target.name,e.target.value)},l=o("range","mapFilters_invert",0,1,.01,+t.invert,"Инверсия",c),d=o("range","mapFilters_hueRotate",0,360,1,+t.hueRotate,"Цветность",c),u=o("range","mapFilters_brightness",0,5,.01,+t.brightness,"Яркость",c),g=o("range","mapFilters_grayscale",0,1,.01,+t.grayscale,"Оттенок серого",c),m=o("range","mapFilters_sepia",0,1,.01,+t.sepia,"Сепия",c),p=o("range","mapFilters_blur",0,4,.1,+t.blur,"Размытие",c),h=s("Цвет вашей команды:",[["Стандартный","default"],["Собственный","custom"]],"mapFilters_branding",t.branding),f=i("mapFilters_brandingColor","custom"==t.branding?t.brandingColor:it(n.teamColor)),b=h.querySelector("select");return b.addEventListener("change",(e=>{"default"==e.target.value?(f.value=it(n.teamColor),j.style.setProperty("--sbgcui-branding-color",n.teamColor)):(f.value=t.brandingColor,j.style.setProperty("--sbgcui-branding-color",t.brandingColor))})),f.addEventListener("input",(e=>{"default"==b.value&&(b.value="custom"),j.style.setProperty("--sbgcui-branding-color",ot(e.target.value))})),f.addEventListener("change",(()=>{f.value=ot(f.value,!1)})),h.appendChild(f),r.classList.add("sbgcui_settings-subsection"),r.append(h,l,d,u,g,m,p),a.appendChild(r),a}(g.mapFilters),function(n){let o=e("Тонирование","Интерфейс браузера будет окрашиваться в зависимости от того, что происходит на экране."),i=document.createElement("section"),a=t("checkbox","tinting_map",+n.map,"При просмотре карты"),r=t("checkbox","tinting_profile",+n.profile,"При просмотре профиля");a.addEventListener("change",(e=>{e.target.checked?tt("map"):tt("")}));let c=s("При просмотре точки:",[["Цвет уровня","level"],["Цвет команды","team"],["Нет","off"]],"tinting_point",n.point);return i.classList.add("sbgcui_settings-subsection"),i.append(a,r,c),o.appendChild(i),o}(g.tinting),function(n){let o=e("Вибрация","Устройство будет откликаться на ваши действия. Может потребоваться выдача соответствующего разрешения в браузере или системе."),i=document.createElement("section"),s=t("checkbox","vibration_buttons",+n.buttons,"При нажатии кнопок"),a=t("checkbox","vibration_notifications",+n.notifications,"При уведомлениях");return i.classList.add("sbgcui_settings-subsection"),i.append(s,a),o.appendChild(i),"vibrate"in window.navigator||o.classList.add("sbgcui_hidden"),o}(g.vibration),function(n){let o=e("Интерфейс","Некоторые аспекты дизайна можно отключить или изменить для большего удобства."),i=document.createElement("section"),s=t("checkbox","ui_doubleClickZoom",+n.doubleClickZoom,"Зум карты по двойному нажатию"),a=t("checkbox","ui_pointBgImage",+n.pointBgImage,"Фото точки вместо фона"),r=t("checkbox","ui_pointBgImageBlur",+n.pointBgImageBlur,"Размытие фонового фото"),c=t("checkbox","ui_pointBtnsRtl",+n.pointBtnsRtl,"Отразить кнопки в карточке точки"),l=t("checkbox","ui_pointDischargeTimeout",+n.pointDischargeTimeout,"Показывать примерное время разрядки точки"),d=t("checkbox","ui_speedometer",+n.speedometer,"Показывать скорость движения");return a.addEventListener("click",(e=>{"ui_pointBgImage"==e.target.id&&(e.target.checked?r.childNodes[1].removeAttribute("disabled"):(r.childNodes[1].checked=0,r.childNodes[1].setAttribute("disabled","")))})),i.classList.add("sbgcui_settings-subsection"),i.append(s,a,r,c,l,d),o.appendChild(i),o}(g.ui),function(t){function n(e,t){e.forEach((e=>{switch(t){case"uniqc":"uniqv"==e.value&&(e.value="off");break;case"uniqv":"uniqc"==e.value&&(e.value="off");break;default:e.value="off"}}))}let o=e("Подсветка точек","Точки на карте могут отображать несколько маркеров, например кольцо снаружи точки, кружок внутри неё или текст рядом. Выберите, что будет обозначать каждый из них."),a=document.createElement("section"),r=i("pointHighlighting_innerColor",t.innerColor),c=i("pointHighlighting_outerColor",t.outerColor),l=i("pointHighlighting_outerTopColor",t.outerTopColor),d=i("pointHighlighting_outerBottomColor",t.outerBottomColor),u=[["Нет","off"],["Уровень 9+","highlevel"],["Избранная","fav"],["Имеется реф","ref"],["Не захвачена","uniqc"],["Не исследована","uniqv"],["Полностью проставлена","cores"]],g=s("Внутренний маркер (точка):",u,"pointHighlighting_inner",t.inner),m=s("Наружный маркер (кольцо):",u,"pointHighlighting_outer",t.outer),p=s("Наружный маркер (верхнее полукольцо):",u,"pointHighlighting_outerTop",t.outerTop),h=s("Наружный маркер (нижнее полукольцо):",u,"pointHighlighting_outerBottom",t.outerBottom),f=s("Текстовый маркер:",[["Нет","off"],["Уровень","level"],["Энергия","energy"],["Линии вх. + исх.","lines"],["Количество рефов","refsAmount"]],"pointHighlighting_text",t.text),b=g.querySelector("select"),v=m.querySelector("select"),y=p.querySelector("select"),w=h.querySelector("select"),_=[b,v,y,w];return _.forEach((e=>{e.addEventListener("change",(t=>{switch(t.target){case v:n([y,w]);break;case y:case w:n([v]);break}if(["uniqc","uniqv"].includes(t.target.value)){n(_.filter((t=>t!=e)),t.target.value)}}))})),g.appendChild(r),m.appendChild(c),p.appendChild(l),h.appendChild(d),a.classList.add("sbgcui_settings-subsection"),a.append(g,m,p,h,f),o.appendChild(a),o}(g.pointHighlighting),function(t){const n=e("Рисование",'Настройки, касающиеся рисования линий. Значение "-1" в текстовом поле отключает ограничение.'),o=document.createElement("section"),i=a("Скрывать рефы ближе, чем (м):","drawing_minDistance",t.minDistance),s=a("Скрывать рефы дальше, чем (м):","drawing_maxDistance",t.maxDistance);return o.classList.add("sbgcui_settings-subsection"),o.append(i,s),n.appendChild(o),n}(g.drawing),function(t){const n=e("Уведомления","Показ всплывающих уведомлений о том, что ваша точка была кем-то уничтожена."),i=document.createElement("section"),a=s("Статус уведомлений:",[["Все точки","all"],["Избранные","fav"],["Отключены","off"]],"notifications_status",t.status),r=s("При нажатии на уведомление:",[["Закрыть","close"],["Место на карте","jumpto"]],"notifications_onClick",t.onClick||"jumpto"),c=o("range","notifications_interval",5e3,1e5,1e3,t.interval,"Интервал проверки",(e=>{const t=e.target.value;e.target.setAttribute("label",t/1e3+" сек.")})),l=o("range","notifications_duration",-1,6e4,1e3,t.duration,"Время показа",(e=>{const t=e.target.value;e.target.setAttribute("label",`${-1==t?"∞":Math.round(t/1e3)} сек.`)}));return i.classList.add("sbgcui_settings-subsection"),i.append(a,r,c,l),n.appendChild(i),n}(g.notifications)];return p.forEach((e=>{e.addEventListener("click",(e=>{p.forEach((t=>{e.currentTarget!=t&&t.removeAttribute("open")}))}))})),r.append(c,l,...p,m),r.addEventListener("submit",(e=>{e.preventDefault();try{let t=new FormData(e.target),n=Object.fromEntries(t);for(let e in n){let t=e.split("_");if("maxAmountInBag"==t[0])g.maxAmountInBag[t[1]][t[2]]=Number.isInteger(+n[e])?n[e]:-1;else if(t[0].match(/autoSelect|mapFilters|tinting|vibration|ui|pointHighlighting|drawing|notifications/)){let o=n[e];g[t[0]][t[1]]=isNaN(+o)?o:+o}}for(let e in g)E.transaction("config","readwrite").objectStore("config").put(g[e],e);Qe("Настройки сохранены").showToast()}catch(e){Qe(`Ошибка при сохранении настроек. <br>${e.message}`,void 0,void 0,"error-toast").showToast()}})),r}function Xe(){let{mapFilters:e,ui:t}=g;for(let t in e){let n="blur"==t?"px":"hueRotate"==t?"deg":"";j.style.setProperty(`--sbgcui-${t}`,`${e[t]}${n}`)}j.style.setProperty("--sbgcui-point-btns-rtl",t.pointBtnsRtl?"rtl":"ltr"),j.style.setProperty("--sbgcui-point-image-blur",t.pointBgImageBlur?"2px":"0px"),j.style.setProperty("--sbgcui-show-speedometer",t.speedometer),j.style.setProperty("--sbgcui-branding-color","custom"==e.branding?e.brandingColor:n.teamColor),window.TeamColors[n.team].fill=`${"custom"==e.branding?e.brandingColor:it(n.teamColor)}80`,window.TeamColors[n.team].stroke="custom"==e.branding?ot(e.brandingColor):n.teamColor,f.setActive(Boolean(t.doubleClickZoom)),!+g.tinting.map||we||_e||tt("map"),document.querySelector(".sbgcui_settings").classList.add("sbgcui_hidden"),document.querySelectorAll(".sbgcui_settings > details").forEach((e=>{e.open=!1})),document.querySelectorAll('.sbgcui_settings input:not([type="hidden"]), .sbgcui_settings select').forEach((e=>{let t=e.name.split("_").reduce(((e,t)=>e[t]),g);switch(e.type){case"number":case"range":e.value=+t;break;case"color":e.value=t;break;case"checkbox":e.checked=+t;break;case"radio":e.checked=e.value==t;break;case"select-one":e.value=t;break}}))}function Ye(e){let t,o=JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>2==e.t&&e.l<=n.level)).sort(((e,t)=>e.l-t.l));switch(e){case"latest":if(t=D.querySelector(`[data-guid="${Ae}"]`),t)break;case"max":t=D.querySelector(`[data-guid="${o[o.length-1].g}"]`);break}return t}function Ke(e){let t=new MouseEvent("mousedown",{bubbles:!0,cancelable:!0}),n=new MouseEvent("mouseup",{bubbles:!0,cancelable:!0}),o=new MouseEvent("click",{bubbles:!0,cancelable:!0});e?.dispatchEvent(t),e?.dispatchEvent(n),e?.dispatchEvent(o)}function Qe(e="",t="top left",n=3e3,o="interaction-toast"){let i=t.split(/\s+/),s=Toastify({text:e,duration:n,gravity:i[0],position:i[1],escapeMarkup:!1,className:o});return s.options.id=Math.round(1e5*Math.random()),s.options.onClick=()=>s.hideToast(),s}function et(e){let t=new Intl.NumberFormat("en-GB"),n=0;for(let o=0;o<d.length;o+=1)if(n+=d[o],n>e)return ue.innerText=n!=1/0?`${t.format(e-(n-d[o]))} / ${t.format(d[o])}`:t.format(e),void(ge.innerText=o+1)}function tt(e){let t,n=/ya-title=.*?,\sya-dock=.*?(?=,|$)/;switch(e){case"map":t=getComputedStyle(me).color;break;case"profile":t=getComputedStyle(re).color,ce.style.borderColor=t;break;case"point_level":t=getComputedStyle(ne).color,se.style.borderColor=t,ie.style.color=t;break;case"point_team":t=getComputedStyle(oe).color,se.style.borderColor=t,ie.style.color=t;break;default:t="";break}var o;t=(o=t)?`#${o.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/).slice(1).map((e=>parseInt(e,10).toString(16).padStart(2,"0"))).join("")}`:"",k.content=t,fe.content.match(n)?fe.content=fe.content.replace(n,`ya-title=${t}, ya-dock=${t}`):fe.content+=`, ya-title=${t}, ya-dock=${t}`}function nt(e){if(0==e)return;let t=document.createElement("span");t.classList.add("sbgcui_xpdiff"),t.innerText=`+${e}xp`,C.appendChild(t),setTimeout((e=>{t.classList.add("sbgcui_xpdiff-out")}),100),setTimeout((e=>{C.removeChild(t)}),3e3)}function ot(e,t=!0){return t?`#${[...e].filter(((e,t)=>t%2)).join("")}`:`#${[...e].map(((e,t,n)=>t%2?e:n[t-1])).join("")}`}function it(e){return[...e].map((e=>"#"==e?e:e+e)).join("")}function st(e,t){return e*(t=t||1/ol.proj.getPointResolution("EPSG:3857",1,y.getCenter(),"m"))}function at(e){const t=Date.parse(e),n=Date.now();return Math.trunc((n-t)/1e3/60/60/24)}function rt(){pe.classList.add("sbgcui_hidden"),N.classList.add("sbgcui_hidden"),ve.childNodes.forEach((e=>{!e.matches(".ol-zoom-in, .ol-zoom-out, #toggle-follow")&&e.classList.add("sbgcui_hidden")})),ve.style.bottom="50%",v.removeControl(S)}function ct(){pe.classList.remove("sbgcui_hidden"),N.classList.remove("sbgcui_hidden"),ve.childNodes.forEach((e=>{e.classList.remove("sbgcui_hidden")})),ve.style.bottom="",v.addControl(S)}function lt(e){const t=Date.now();E.transaction("logs","readwrite").objectStore("logs").put({timestamp:t,...e})}function dt(e){L&&Ke(he),document.querySelectorAll(".popup").forEach((e=>{e.classList.add("hidden")})),y.setCenter(ol.proj.fromLonLat(e)),y.adjustCenter([0,u/-2])}function ut(e){return async function(t,n){return new Promise(((o,i)=>{const s=new URL(window.location.origin+t);let a;switch(s.pathname){case"/api/attack2":const e=JSON.parse(n.body).guid,t=JSON.parse(localStorage.getItem("inventory-cache")),i=`Использовать "${i18next.t("items.brooms_one")}"?`;if(a=void 0!==t.find((t=>4==t.t&&t.g==e)),a&&!confirm(i))return o(),void D.dispatchEvent(new Event("attackSliderOpened"));break;case"/api/inview":if(xe)return void o();let r=Object.values(g.pointHighlighting).find((e=>e.match(/uniqc|uniqv/)));if(r){const e="uniqc"==r?4:2;s.searchParams.set("h",e)}const c=JSON.parse(localStorage.getItem("map-config")),l=Bitfield.from(c.l);l.change(1,1),l.change(2,1),s.searchParams.set("l",l.toString());break}e(s.pathname+s.search,n).then((async e=>{if(!s.pathname.match(/^\/api\//))return void o(e);e.clone().json().then((async t=>{switch(s.pathname){case"/api/point":"data"in t&&null==s.searchParams.get("status")&&(Se=new q(t.data));break;case"/api/deploy":if("data"in t){const e=1==t.data.co.length?"capture":"deploy";Se.update(t.data.co,t.data.l),Se.selectCore(g.autoSelect.deploy),lt({type:e,coords:Se.coords,point:Se.guid,title:Se.title})}else"c"in t&&(Se.update([t.c],t.l),Se.selectCore(g.autoSelect.upgrade,t.c.l),lt({type:"upgrade",coords:Se.coords,point:Se.guid,title:Se.title}));break;case"/api/attack2":if(Ae=JSON.parse(n.body).guid,E.transaction("state","readwrite").objectStore("state").put(Ae,"lastUsedCatalyser"),"c"in t){const e=t.c.filter((e=>0==e.energy)).map((e=>e.guid));if(e.length>0){const n=t.l.length,o=t.r.length,i=t.xp.diff;lt({type:a?"broom":"destroy",points:e,lines:n,regions:o,xp:i})}}break;case"/api/discover":let i=[];if("loot"in t&&(lt({type:"discover",point:Se.guid,title:Se.title}),M.isActive&&(i=t.loot.filter((e=>M.refs?3!=e.t&&4!=e.t:3==e.t)).map((e=>({guid:e.g,type:e.t,amount:e.a}))),0!=i.length))){t.loot=t.loot.filter((e=>M.refs?3==e.t:3!=e.t));const n=Ze(t,e);o(n)}if(He(!1,i),"burnout"in t||"cooldown"in t){let e,o,i=Date.now();if(t.burnout<=20)e=t.burnout;else if(t.cooldown<=90||t.burnout<i)break;try{o=JSON.parse(n.body).guid}catch{o=new URLSearchParams(n.body).get("guid")}if(o in p){if(e){p[o].discoveriesLeft=e;break}if(p[o].hasActiveCooldown)break;let n=t.burnout||i+1e3*t.cooldown;p[o].cooldown=n,p.save()}}break;case"/api/inview":const r=t.p,c=t.r,l=+s.searchParams.get("z"),d=JSON.parse(localStorage.getItem("map-config")),u=s.searchParams.get("l");if($e=c.map((e=>e.c[0].slice(0,3))),d.l==u)o(e);else{const n=Bitfield.from(d.l);0==n.get(1)&&(t.l=[]),0==n.get(2)&&(t.r=[]);const i=Ze(t,e);o(i)}const m=s.searchParams.get("h"),h=null!=m,f=null!=Object.values(g.pointHighlighting).find((e=>e.match(/cores|highlevel|level/)));if(!r)break;if(f&&l>=16){let e=r.filter((e=>(!e.t&&delete Ce[e.g],0!=e.t)));if(e.length<=100){(e.map((e=>e.g))||[]).forEach((e=>{Date.now()-Ce[e]?.timestamp<7e3||Ne(e).then((t=>{Ce[e]={cores:t.co,lines:{in:t.li.i,out:t.li.o,get sum(){return this.in+this.out}},energy:t.e,level:t.l,timestamp:Date.now()}})).catch((()=>{Ce[e]={timestamp:Date.now()}}))}))}}h&&r?.forEach((e=>{const t=4==m?"c":"v";e.h?ke[t].add(e.g):ke[t].delete(e.g)}));break;case"/api/draw":if("line"in t){const{from:e,to:o}=JSON.parse(n.body),i=t.reg.map((e=>e.a)),s=e==Se.guid?Se.title:void 0,a=Se.possibleLines.find((e=>e.guid==o))?.title,r=Se.possibleLines.find((e=>e.guid==o))?.distance;lt({type:"draw",from:e,to:o,fromTitle:s,toTitle:a,distance:r,regions:i})}else if("data"in t){let{minDistance:i,maxDistance:s}=g.drawing;if(i=-1==i?-1/0:+i,s=-1==s?1/0:+s,qe&&Oe&&Oe.guid!=se.dataset.guid&&"get"==n.method){const n=t.data.find((e=>e.p==Oe.guid)),i=t.data.length-(n?1:0);if(t.data=n?[n]:[],i>0){Qe(`Точк${1==i?"а":"и"} (${i}) скрыт${1==i?"а":"ы"}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tиз списка, так как вы находитесь в режиме рисования "Звезда".`,"top left",void 0,"sbgcui_toast-selection").showToast()}const s=Ze(t,e);Se.possibleLines=t.data.map((e=>({guid:e.p,title:e.t}))),o(s);break}if(isFinite(i)||isFinite(s)){const n=t.data.filter((e=>e.d<=s&&e.d>=i)),a=t.data.length-n.length;if(a>0){Qe(`Точк${1==a?"а":"и"} (${a}) скрыт${1==a?"а":"ы"}\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tиз списка согласно настройкам ограничения дальности рисования\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t(${isFinite(i)?"мин. "+i+" м":""}${isFinite(i+s)?", ":""}${isFinite(s)?"макс. "+s+" м":""}).`,"top left",void 0,"sbgcui_toast-selection").showToast(),t.data=n}const r=Ze(t,e);o(r)}Se.possibleLines=t.data.map((e=>({guid:e.p,title:e.t,distance:e.d})))}break;case"/api/profile":"name"in t&&de.style.setProperty("--sbgcui-reg-date",at(t.created_at));break;case"/api/repair":"data"in t&&we&&Se.update(t.data);break;case"/api/score":if("score"in t){const[e,n]=t.score,o=document.querySelectorAll(".score__table > tbody td:first-of-type"),i=document.querySelectorAll(".score__table > tbody td:last-of-type");delete e.check,delete n.check;const[s,a]=[e,n].map((e=>Object.fromEntries(Object.entries(e).sort(((e,t)=>t[1]-e[1])).map(((e,t)=>[e[0],t])))));o.forEach(((e,t)=>{e.style.gridArea=`p${s[0==t?"r":1==t?"g":"b"]}`})),i.forEach(((e,t)=>{e.style.gridArea=`r${a[0==t?"r":1==t?"g":"b"]}`}))}break;default:return void o(e)}})).catch((e=>{})).finally((()=>{o(e)}))})).catch((e=>{i(e)}))}))}}qe=qe&&null!=Oe;{var t=await Be();const e=E.transaction("state","readwrite").objectStore("state");if(l!=t.version){if(Me<2){const n=`Текущая версия игры (${t.version}) не соответствует последней известной версии (0.4.2-2). Возможна некорректная работа.`;Qe(n,void 0,void 0,"error-toast").showToast(),e.put(Me+1,"versionWarns")}}else e.put(0,"versionWarns");var n={name:t.name,team:t.team,exp:{total:t.exp,current:t.exp-d.slice(0,t.lvl-1).reduce(((e,t)=>t+e),0),goal:d[t.lvl-1],get percentage(){return this.goal==1/0?100:this.current/this.goal*100},set string(e){[this.current,this.goal=1/0]=e.replace(/\s|,/g,"").split("/")}},auth:localStorage.getItem("auth"),guid:t.guid,feature:w,teamColor:getComputedStyle(j).getPropertyValue(`--team-${t.team}`),get level(){return this._level},set level(e){this._level=+e.split("").filter((e=>e.match(/[0-9]/))).join("")},_level:t.lvl}}{let{mapFilters:e,ui:t}=g,o=document.createElement("style"),i=document.createElement("link"),s=document.createElement("link"),r=document.createElement("link");o.innerHTML=`\n      :root {\n        --sbgcui-player-exp-percentage: ${n.exp.percentage}%;\n        --sbgcui-inventory-limit: " / 3000";\n        --sbgcui-invert: ${e.invert};\n        --sbgcui-hueRotate: ${e.hueRotate}deg;\n        --sbgcui-brightness: ${e.brightness};\n        --sbgcui-grayscale: ${e.grayscale};\n        --sbgcui-sepia: ${e.sepia};\n        --sbgcui-blur: ${e.blur}px;\n        --sbgcui-point-bg: #ccc;\n        --sbgcui-point-image: '';\n        --sbgcui-point-image-blur: ${t.pointBgImageBlur?2:0}px;\n        --sbgcui-point-btns-rtl: ${t.pointBtnsRtl?"rtl":"ltr"};\n\t\t\t\t--sbgcui-show-speedometer: ${t.speedometer};\n\t\t\t\t--sbgcui-branding-color: ${"custom"==e.branding?e.brandingColor:n.teamColor};\n\t\t\t\t--team-${n.team}: var(--sbgcui-branding-color);\n      }\n  \t`,"custom"==e.branding&&(window.TeamColors[n.team].fill=e.brandingColor+"80",window.TeamColors[n.team].stroke=ot(e.brandingColor)),[i,s,r].forEach((e=>e.setAttribute("rel","stylesheet"))),i.setAttribute("href",`${a}/styles.min.css`),s.setAttribute("href",`${a}/assets/fontawesome/css/fa.min.css`),r.setAttribute("href",`${a}/assets/fontawesome/css/fa-svg.min.css`),document.head.append(o,s,r,i)}new MutationObserver(((e,t)=>{t.disconnect(),n.level=ge.textContent,ge.innerText=(n.level<=9?"0":"")+n.level,t.observe(ge,{childList:!0})})).observe(ge,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointLevelChanged",{bubbles:!0});ne.dispatchEvent(t)})).observe(ne,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointOwnerChanged",{bubbles:!0});oe.dispatchEvent(t)})).observe(oe,{childList:!0}),new MutationObserver((e=>{let t=new Event("pointCoresUpdated",{bubbles:!0});K.dispatchEvent(t)})).observe(K,{childList:!0}),new MutationObserver((e=>{let t;e[0].target.classList.contains("hidden")?(t=new Event("pointPopupClosed"),we=!1):e[0].oldValue?.includes("hidden")&&(t=new Event("pointPopupOpened"),we=!0),t&&e[0].target.dispatchEvent(t)})).observe(se,{attributes:!0,attributeOldValue:!0,attributeFilter:["class"]}),new MutationObserver((e=>{_e=!e[0].target.classList.contains("hidden");let t=new Event(_e?"profilePopupOpened":"profilePopupClosed",{bubbles:!0});e[0].target.dispatchEvent(t)})).observe(ce,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{ye=!e[0].target.classList.contains("hidden");let t=new Event(ye?"inventoryPopupOpened":"inventoryPopupClosed");e[0].target.dispatchEvent(t)})).observe(X,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{Ee=!e[0].target.classList.contains("hidden");let t=new Event(Ee?"attackSliderOpened":"attackSliderClosed");e[0].target.dispatchEvent(t)})).observe(D,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{Le=!e[0].target.classList.contains("hidden");let t=new Event(Le?"drawSliderOpened":"drawSliderClosed");e[0].target.dispatchEvent(t)})).observe(R,{attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{nt(e.find((e=>e.addedNodes.length)).addedNodes[0].data.match(/\d+/)[0])})).observe(be,{childList:!0}),new MutationObserver((()=>{if(Array.from(document.querySelectorAll('.inventory__content[data-tab="3"] > .inventory__item')).every((e=>e.classList.contains("loaded")))){let e=new Event("refsListLoaded");W.dispatchEvent(e)}})).observe(W,{subtree:!0,attributes:!0,attributeFilter:["class"]}),new MutationObserver((e=>{if(!Ee)return;const t=[...e].filter((e=>"attributes"==e.type)),n=[...e].filter((e=>"childList"==e.type)),o=t.some((e=>e.oldValue.includes("is-active")&&!e.target.classList.contains("is-active"))),i=n.length>0&&n.every((e=>1==e.addedNodes.length&&0==e.removedNodes.length));if(o||i){let e=new Event("activeSlideChanged");G.dispatchEvent(e)}})).observe(G,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class"],attributeOldValue:!0}),new MutationObserver((e=>{let t=new Event("coresListUpdated");z.dispatchEvent(t)})).observe(z,{childList:!0}),new MutationObserver((e=>{L="true"==he.dataset.active,h.setActive(!L)})).observe(he,{attributes:!0,attributeFilter:["data-active"]});B.addEventListener("click",(()=>{B.classList.toggle("sbgcui_attack-menu-rotate")})),se.addEventListener("pointPopupOpened",(()=>{let e=JSON.parse(localStorage.getItem("settings"))||{};g.ui.pointBgImage?(j.style.setProperty("--sbgcui-point-image",e.imghid?"":`url("${Se.image}")`),se.classList.add("sbgcui_point-popup-bg"),Q.classList.add("sbgcui_no_bg_image")):(j.style.setProperty("--sbgcui-point-image",""),se.style.backgroundImage="",se.classList.remove("sbgcui_point-popup-bg"),Q.classList.remove("sbgcui_no_bg_image")),te.innerText=`${Se.energyFormatted}% @ ${Se.coresAmount}`})),se.addEventListener("pointRepaired",(()=>{te.innerText=`${Se.energyFormatted}% @ ${Se.coresAmount}`})),document.addEventListener("backbutton",(()=>(_e?Ke(ae):we&&Ke(le),!1))),document.querySelector('.inventory__tab[data-tab="3"]').addEventListener("click",(e=>{let t=document.querySelector('.inventory__tab[data-tab="3"] > .inventory__tab-counter'),n=JSON.parse(localStorage.getItem("inventory-cache")).reduce(((e,t)=>3==t.t?e+t.a:e),0),o=W.childNodes.length;t.innerText=o,setTimeout((()=>{t.innerText=n}),1e3)})),he.addEventListener("touchstart",(()=>{let e=Date.now(),t=setTimeout((function e(t){t||y.animate({center:n.feature.getGeometry().getCoordinates()},{zoom:17},{rotation:0},e)}),500);this.addEventListener("touchend",(()=>{Date.now()-e<1e3&&clearTimeout(t)}),{once:!0})})),R.addEventListener("drawSliderOpened",(()=>{y.setBottomPadding(),y.set("beforeDrawZoom",y.getZoom()),rt(),window.draw_slider.emit("active",{slide:R.querySelector(".splide__slide.is-active")})})),R.addEventListener("drawSliderClosed",(()=>{const e=w.getGeometry().getCoordinates(),t=y.get("beforeDrawZoom")||17;y.setTopPadding(),y.setCenter(e),y.setZoom(t),ct()})),b.addEventListener("change",(()=>{b.matches?y.setTopPadding():y.removePadding(),y.setCenter(w.getGeometry().getCoordinates())})),v.getAllLayers()[0].on("change",(()=>{const{base:e,theme:t}=JSON.parse(localStorage.getItem("settings"))||{},n=`${e}_${t}`;if(m.baselayer!=n){const e=E.transaction(["state","tiles"],"readwrite"),t=e.objectStore("state"),o=e.objectStore("tiles");t.put(n,"baselayer"),o.clear(),m.baselayer=n}}));{const e=document.querySelector("#ops"),t=document.querySelector(".ol-rotate"),o=document.querySelector("#layers"),i=document.querySelector("#notifs-menu"),s=document.querySelector("#attack-slider-close"),a=document.createElement("div"),r=document.createElement("span"),c=document.querySelector("#i-stat__owner").parentElement,l=document.querySelector(".attack-slider-highlevel"),d=document.querySelectorAll(".popup-close, #inventory__close");D.prepend(l),document.querySelectorAll('[data-i18n="self-info.name"], [data-i18n="self-info.xp"], [data-i18n="units.pts-xp"], [data-i18n="self-info.inventory"], [data-i18n="self-info.position"]').forEach((e=>{e.remove()})),document.querySelectorAll(".self-info__entry").forEach((e=>{let t=[];e.childNodes.forEach((e=>{3==e.nodeType&&t.push(e)})),t.forEach((e=>{e.remove()}))})),document.querySelector(".i-stat__tools").remove(),s.remove(),B.childNodes[0].remove(),o.innerText="",o.classList.add("fa","fa-solid-layer-group"),i.innerText="",i.classList.add("fa","fa-solid-envelope"),ve.append(t,he,i,o),he.innerText="",he.classList.add("fa","fa-solid-location-crosschairs"),N.appendChild(e),e.replaceChildren("INVENTORY",Y),ge.innerText=(n.level<=9?"0":"")+n.level,a.classList.add("i-stat__entry"),r.innerText=i18next.t("info.energy"),te.id="i-stat__energy",a.append(r,": ",te),c.after(a),d.forEach((e=>{e.closest(".info, .inventory, .leaderboard, .notifs, .profile, .settings")&&(e.innerHTML="",e.classList.add("sbgcui_button_reset","fa","fa-solid-xmark"))})),i18next.addResources("ru","main",{"notifs.text":"нейтрализована $1$","sbgcui.point":"Точка","sbgcui.points":"Точки","sbgcui.line":"Линия","sbgcui.lines":"Линии","sbgcui.region":"Регион","sbgcui.regions":"Регионы","sbgcui.max":"Макс.","sbgcui.total":"Всего","sbgcui.area":"Площадь","sbgcui.distance":"Расстояние"}),i18next.addResources("en","main",{"notifs.text":"нейтрализована $1$","sbgcui.point":"Point","sbgcui.points":"Points","sbgcui.line":"Line","sbgcui.lines":"Lines","sbgcui.region":"Region","sbgcui.regions":"Regions","sbgcui.max":"Max","sbgcui.total":"Total","sbgcui.area":"Area","sbgcui.distance":"Distance"}),i18next.addResources(i18next.resolvedLanguage,"main",{"items.catalyser-short":"{{level}}","items.core-short":"{{level}}"}),window.draw_slider.options={height:"120px",pagination:!0},fe.setAttribute("content",fe.getAttribute("content")+", shrink-to-fit=no")}{let e,t;var h,f,x,S=new A("MainToolbar");const n=v.getControls();v.getInteractions().forEach((e=>{switch(e.constructor){case ol.interaction.DragPan:h=e;break;case ol.interaction.DoubleClickZoom:f=e;break;case ol.interaction.PinchRotate:x=e;break}})),h.setActive("true"!=he.dataset.active),f.setActive(Boolean(g.ui.doubleClickZoom)),n.forEach((n=>{switch(n.constructor){case ol.control.Attribution:e=n;break;case ol.control.Rotate:t=n;break}})),v.removeControl(e),v.removeControl(t),v.addControl(S);const o=document.createElement("label"),i=document.createElement("label");[o,i].forEach(((e,t)=>{const n=document.createElement("input"),o=document.createElement("span"),i=0==t?"Watercolor":"Toner",s=JSON.parse(localStorage.getItem("settings")).base==`stadia_${i.toLowerCase()}`;e.classList.add("layers-config__entry"),n.type="radio",n.name="baselayer",n.value=`stadia_${i.toLowerCase()}`,n.checked=s,o.innerText=`Stadia ${i}`,e.append(n," ",o)})),document.querySelector('input[value="osm"]').parentElement.after(o,i)}{let e=document.createElement("div"),t=document.createElement("div"),o=document.querySelector("#self-info__exp");new MutationObserver((()=>{n.exp.string=o.textContent,j.style.setProperty("--sbgcui-player-exp-percentage",`${n.exp.percentage}%`)})).observe(o,{childList:!0}),e.classList.add("sbgcui_xpProgressBar"),t.classList.add("sbgcui_xpProgressBarFiller"),o.parentElement.prepend(e),e.append(o,t)}D.addEventListener("attackSliderOpened",(()=>{Ke(Ye(g.autoSelect.attack))})),K.addEventListener("click",(e=>{if(e.target.classList.contains("selected")){let t=e.target.innerText.match(/^[0-9]{1,2}$/)?+e.target.innerText:je.toDecimal(e.target.innerText);Se.selectCore(g.autoSelect.upgrade,t)}})),z.addEventListener("touchstart",(e=>{let t=e.target.closest(".is-active.splide__slide");if(null==t)return;let n=Date.now(),o=t.dataset.guid,i=setTimeout((()=>{let e;Te.has(o)?(Te.delete(o),t.removeAttribute("sbgcui-excluded-core"),e=Qe("Теперь ядро доступно для автовыбора.")):(Te.add(o),t.setAttribute("sbgcui-excluded-core",""),e=Qe("Ядро больше не участвует в автовыборе.")),e.showToast(),E.transaction("state","readwrite").objectStore("state").put(Te,"excludedCores")}),1e3);t.addEventListener("touchend",(()=>{Date.now()-n<1e3&&clearTimeout(i)}),{once:!0})})),z.addEventListener("coresListUpdated",(()=>{z.childNodes.forEach((e=>{Te.has(e.dataset.guid)&&e.setAttribute("sbgcui-excluded-core","")})),Se.selectCore(g.autoSelect.deploy)}));{function e(e,t,o){return t.te==n.team&&(e.style.setProperty("--sbgcui-energy",`${t.e}%`),t.e<100&&e.style.setProperty("--sbgcui-display-r-button","flex")),o(e,t)}function t(e,n){ze(e).then((o=>{if(o.error)throw new Error(o.error);if(o.data){const[s,a]=o.data.reduce(((e,t)=>[e[0]+t.e,e[1]+i[t.l]]),[0,0]),r=document.querySelector(`.inventory__item[data-ref="${e}"] .inventory__item-left`).querySelector(".inventory__item-descr").childNodes[4],c=Math.floor(s/a*100),l=JSON.parse(localStorage.getItem("refs-cache"));n.style.setProperty("--sbgcui-energy",`${c}%`),r&&(r.nodeValue=c),et(o.xp.cur),nt(o.xp.diff),l[e]&&(l[e].e=c,localStorage.setItem("refs-cache",JSON.stringify(l))),100!=c&&t(...arguments)}})).catch((e=>{Qe(`Ошибка при зарядке. <br>${e.message}`,void 0,void 0,"error-toast").showToast(),e.message.match(/полностью|вражеской|fully|enemy/)?n.style.setProperty("--sbgcui-display-r-button","none"):n.style.setProperty("--sbgcui-display-r-button","flex")}))}window.makeEntryDec=e,W.addEventListener("click",(e=>{if(!e.currentTarget.matches('.inventory__content[data-tab="3"]'))return;if(!e.target.closest(".inventory__item-controls"))return;if(!e.target.closest(".inventory__item.loaded"))return;if(e.offsetX<50)return;const n=e.target.closest(".inventory__item")?.dataset.ref,o=e.target.closest(".inventory__item");o.style.setProperty("--sbgcui-display-r-button","none"),t(n,o)}))}{let e=!1,t=We();pe.appendChild(t);let n=document.createElement("button");n.classList.add("fa","fa-solid-gears"),n.addEventListener("click",(()=>{t.classList.toggle("sbgcui_hidden"),e=!e})),S.addItem(n,1),document.body.addEventListener("click",(t=>{e&&t.target!=n&&!t.target.closest(".sbgcui_settings")&&(Xe(),e=!1)}))}{var k=document.createElement("meta");k.name="theme-color",document.head.appendChild(k);let e=g.tinting;+e.map&&tt("map"),ce.addEventListener("profilePopupOpened",(t=>{+e.profile?tt("profile"):tt("")})),se.addEventListener("pointPopupOpened",(t=>{"off"!=e.point?tt(`point_${e.point}`):tt("")})),ne.addEventListener("pointLevelChanged",(t=>{"level"==e.point&&tt("point_level")})),oe.addEventListener("pointOwnerChanged",(t=>{"team"==e.point&&tt("point_team")})),se.addEventListener("pointPopupClosed",(t=>{_e?+e.profile&&tt("profile"):+e.map?tt("map"):tt(""),se.style.borderColor="",ie.style.color=""})),ce.addEventListener("profilePopupClosed",(t=>{we?"off"!=e.point&&tt(`point_${e.point}`):+e.map?tt("map"):tt(""),ce.style.borderColor=""}))}var C=document.createElement("div");C.classList.add("sbgcui_xpdiff-wrapper"),document.body.appendChild(C);{function e(){const e=re.innerText,t=e==n.name;confirm(`Сохранить ${t?"вашу ":""}статистику ${t?"":"игрока "}на текущий момент? \nЭто действие перезапишет сохранённую ранее статистику.`)&&De(null,e).then((e=>{const t=Date.now(),n=new Date(t).toLocaleString();E.transaction("stats","readwrite").objectStore("stats").put({...e,timestamp:t}),r.innerText=`Последнее сохранение: \n${n}`}))}function t(){const e=re.innerText,t=e==n.name;E.transaction("stats","readonly").objectStore("stats").get(e).addEventListener("success",(n=>{const o=n.target.result;if(null!=o)De(null,e).then((e=>{let n=Date.now()-o.timestamp,i=["day","hr","min","sec"],s="",a="";[864e5,36e5,6e4,1e3].forEach(((e,t)=>{let o=Math.trunc(n/e);o&&(s+=`${s.length?", ":""}${o} ${i[t]+(o>1?"s":"")}`,n-=o*e)}));for(let t in e){let n=e[t]-o[t];if(n){let e,o=n>0;switch(t){case"max_region":case"regions_area":e=i18next.t(`profile.stats.${t}`),n=i18next.t("units.sqkm",{count:n});break;case"xp":e=i18next.t("profile.stats.total-xp");break;case"level":e=i18next.t("profile.level");break;default:e=i18next.t(`profile.stats.${t}`)}e&&(a+=`\n\t\t\t\t\t\t\t\t\t<p class="sbgcui_compare_stats-diff-wrp">\n\t\t\t\t\t\t\t\t\t\t<span>${e}:</span>\n\t\t\t\t\t\t\t\t\t\t<span class="sbgcui_compare_stats-diff-value${o?"Pos":"Neg"}">\n\t\t\t\t\t\t\t\t\t\t\t${o?"+":""}${n}\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t`)}}let r=Qe(a.length?`${t?"Ваша с":"С"}татистика ${t?"":"игрока "}с ${new Date(o.timestamp).toLocaleString()}<br>(${s})<br>${a}`:"Ничего не изменилось с прошлого сохранения.","bottom center",-1,"sbgcui_compare_stats-toast");r.showToast(),r.toastElement.style.setProperty("--sbgcui-toast-color",`var(--team-${e.team})`)}));else{Qe(`Вы ещё не сохраняли ${t?"свою ":""}статистику${t?"":" этого игрока"}.`,void 0,void 0,"error-toast").showToast()}}))}function o(){const e=re.innerText;E.transaction("stats","readonly").objectStore("stats").get(e).addEventListener("success",(e=>{const t=e.target.result;if(null!=t){const e=new Date(t.timestamp).toLocaleString();r.innerText=`Последнее сохранение: \n${e}`}else r.innerText=""}))}let i=document.createElement("div"),s=document.createElement("button"),a=document.createElement("button"),r=document.createElement("span"),c=document.querySelector(".pr-stats");s.innerText="Записать",a.innerText="Сравнить",r.classList.add("sbgcui_compare_stats-timestamp"),i.classList.add("sbgcui_compare_stats"),i.append(r,s,a),ce.insertBefore(i,c),s.addEventListener("click",e),a.addEventListener("click",t),ce.addEventListener("profilePopupOpened",o)}if(window.navigator.userAgent.toLowerCase().includes("wv")){let e=document.querySelector(".game-menu"),t=document.createElement("button");t.classList.add("fa","fa-solid-rotate"),t.addEventListener("click",(e=>{window.location.reload()})),e.appendChild(t)}Q.addEventListener("click",(e=>{if(Q.hasAttribute("sbgcui_clicks")){let e=+Q.getAttribute("sbgcui_clicks");if(e+1==5){let e=document.querySelector(".i-stat"),t=se.dataset.guid,n=document.createElement("span");n.innerText=`GUID: ${t}`,n.addEventListener("click",(e=>{window.navigator.clipboard.writeText(`${window.location.origin+window.location.pathname}?point=${t}`).then((e=>{Qe("Ссылка на точку скопирована в буфер обмена.").showToast()}))})),se.insertBefore(n,e),se.addEventListener("pointPopupClosed",(e=>{n.remove(),Q.setAttribute("sbgcui_clicks",0)}))}Q.setAttribute("sbgcui_clicks",e+1)}else Q.setAttribute("sbgcui_clicks",1)})),"vibrate"in window.navigator&&document.body.addEventListener("click",(e=>{g.vibration.buttons&&"BUTTON"==e.target.nodeName&&(window.navigator.vibrate(0),window.navigator.vibrate(50))}));for(let e in p)p[e]=new O(e,p[e].cooldown);Object.defineProperty(p,"save",{value:function(){const e=E.transaction("favorites","readwrite").objectStore("favorites");for(let t in this)if(this[t].isActive){const n=this[t].cooldown>Date.now()?this[t].cooldown:null;e.put({guid:t,cooldown:n})}else e.delete(t)}});{let e=document.createElement("button"),t=se.dataset.guid;e.classList.add("sbgcui_button_reset","sbgcui_point_star","fa",`fa-${p[t]?.isActive?"solid":"regular"}-star`),e.addEventListener("click",(t=>{let n=se.dataset.guid,o=ie.innerText;if(e.classList.contains("fa-solid-star"))p[n].isActive=0,e.classList.replace("fa-solid-star","fa-regular-star");else{if(n in p)p[n].isActive=1;else{let e=JSON.parse(localStorage.getItem("cooldowns"))||{},t=0==e[n]?.c?e[n].t:null;p[n]=new O(n,t,o)}e.classList.replace("fa-regular-star","fa-solid-star"),!Je()&&"Notification"in window&&"default"==Notification.permission&&Notification.requestPermission()}p.save()})),se.addEventListener("pointPopupOpened",(t=>{let n=se.dataset.guid;p[n]?.isActive?e.classList.replace("fa-regular-star","fa-solid-star"):e.classList.replace("fa-solid-star","fa-regular-star")})),ee.appendChild(e)}{let e=document.createElement("button"),t=document.createElement("div"),o=document.createElement("h3"),i=document.createElement("h6"),s=document.createElement("ul"),a=!1;function r(){let e=[];if(s.innerHTML="",0!=Object.keys(p).length){for(let t in p)if(p[t].isActive){let o=document.createElement("li"),i=document.createElement("a"),s=document.createElement("span"),r=document.createElement("button"),c=document.createElement("div");s.innerText=p[t].name,i.appendChild(s),i.setAttribute("href",`/app/?point=${t}`),r.classList.add("sbgcui_button_reset","sbgcui_favs-li-delete","fa","fa-solid-circle-xmark"),r.addEventListener("click",(e=>{p[t].isActive=0,p.save(),o.removeAttribute("sbgcui_active",""),o.classList.add("sbgcui_hidden")})),c.classList.add("sbgcui_favs-li-data"),o.classList.add("sbgcui_favs-li"),o.setAttribute("sbgcui_active","");let l=p[t].isActive&&p[t].cooldown,d=p[t].discoveriesLeft;if(l){i.setAttribute("sbgcui_cooldown",p[t].timer),i.sbgcuiCooldown=p[t].cooldown;let e=setInterval((()=>{a&&p[t].isActive&&p[t].cooldown?i.setAttribute("sbgcui_cooldown",p[t].timer):clearInterval(e)}),1e3)}else d&&(i.setAttribute("sbgcui_discoveries",d),i.discoveriesLeft=d);o.append(r,i,c),e.push(o),Ne(t).then((e=>{e&&(s.innerText=`[${e.l}] ${i.innerText}`,i.style.color=e.te==n.team?"var(--sbgcui-branding-color)":`var(--team-${e.te})`,c.innerHTML=`${Math.round(e.e)}% @ ${e.co}<br>${e.li.i}↓ ${e.li.o}↑`)}))}e.sort(((e,t)=>(e=e.childNodes[1].sbgcuiCooldown||e.childNodes[1].discoveriesLeft,t=t.childNodes[1].sbgcuiCooldown||t.childNodes[1].discoveriesLeft,null==e?1:null==t?-1:e-t))),s.append(...e)}}t.classList.add("sbgcui_favs","sbgcui_hidden"),o.classList.add("sbgcui_favs-header"),i.classList.add("sbgcui_favs-descr"),s.classList.add("sbgcui_favs-content"),o.innerText="Избранные точки",i.innerText="Быстрый доступ к важным точкам, уведомления об их остывании и защита от автоудаления сносок.",t.append(o,i,s),e.classList.add("fa","fa-solid-star","sbgcui_favs_star"),e.addEventListener("click",(()=>{r(),t.classList.toggle("sbgcui_hidden"),a=!a})),document.body.addEventListener("click",(e=>{!a||e.target.closest(".sbgcui_favs")||e.target.closest(".sbgcui_favs_star")||(t.classList.add("sbgcui_hidden"),a=!1)})),S.addItem(e,2),document.body.appendChild(t)}W.addEventListener("click",(e=>{if(!e.target.classList.contains("inventory__ic-view"))return;let t=e.target.closest(".inventory__item").dataset.ref;t&&confirm('Открыть карточку точки? Либо нажмите "Отмена" для перехода к месту на карте.')&&(window.location.href=`/app/?point=${t}`)}));{let e=document.createElement("span"),t=document.createElement("span");e.classList.add("sbgcui_no_loot","fa","fa-solid-droplet-slash"),t.classList.add("sbgcui_no_refs","fa","fa-solid-link-slash"),Z.append(e,t),Z.addEventListener("click",(e=>{if(e.target==Z)M=new P(1,1);else{let t=!e.target.classList.contains("sbgcui_no_loot"),n=!e.target.classList.contains("sbgcui_no_refs");M=new P(t,n)}}))}{function e(e){return e.every((e=>e.classList.contains("loaded")))}function t(e){let t=JSON.parse(localStorage.getItem("refs-cache"))||{};return e.every((e=>t[e.dataset.ref]?.t>Date.now()))}function o(e,t){let n;switch(t){case"name":return n=new RegExp(/\(x[0-9]{1,}\)\s(?:"|«)?([\s\S]+)/i),e.querySelector(".inventory__item-title").innerText.match(n)[1];case"level":return n=new RegExp(/level-([0-9]{1,2})/),+e.querySelector(".inventory__item-descr > span").style.color.match(n)?.[1]||0;case"team":return n=new RegExp(/team-([1-3])/),+e.querySelector(".inventory__item-title").style.color.match(n)?.[1]||0;case"energy":return+e.querySelector(".inventory__item-descr").childNodes[4].nodeValue.replace(",",".");case"distance":n=new RegExp(`([0-9]+?(?:${T}[0-9]+)?(?:\\${I}[0-9]+)?)\\s(cm|m|km|см|м|км)`,"i");let t=e.querySelector(".inventory__item-descr").lastChild.textContent,[o,i,s]=t.match(n);return i=i.replace(T,"").replace(I,"."),parseFloat(i)/(["cm","см"].includes(s)?1e5:["m","м"].includes(s)?1e3:1);case"amount":return n=new RegExp(/^\(x([0-9]{1,})\)\s/i),+e.querySelector(".inventory__item-title").innerText.match(n)[1]}}function i(e,t){let n=o(e,"name"),i=o(t,"name");return n.localeCompare(i)}function s(e,t){e.sort(((e,s)=>{let a=o(e,t),r=o(s,t);switch(t){case"name":return a.localeCompare(r);case"team":return a==r?i(e,s):a==n.team?-1:r==n.team?1:a-r;case"energy":let t=o(e,"team"),c=o(s,"team");return t==c?a==r?i(e,s):a-r:t==n.team?-1:c==n.team?1:a==r?i(e,s):a-r;default:return a-r}}))}function a(){if(s(d,u),W.replaceChildren(...d),p.removeAttribute("disabled"),W.classList.remove("sbgcui_refs_list-blur"),y){let e;performance.mark(b);e=Qe(`Загрузка и сортировка заняли ${+(performance.measure(v,f,b).duration/1e3).toFixed(1)} сек. <br><br>Уникальных рефов: ${W.childNodes.length}.`,void 0,-1,"sbgcui_toast-selection"),e.showToast(),c()}}function r(e){e.isTrusted&&(clearInterval(l),W.removeEventListener("refsListLoaded",a),p.value="none",p.removeAttribute("disabled"),W.classList.remove("sbgcui_refs_list-blur"))}function c(){y=!1,performance.clearMarks(f),performance.clearMarks(b),performance.clearMeasures(v),U.removeAttribute("sbgcui_measurement_mode")}let l,d,u,g=document.querySelector(".inventory__controls"),m=document.querySelector("#inventory-delete"),p=document.createElement("select"),h=document.createElement("button"),f="sbgcui_refs_sort_begin",b="sbgcui_refs_sort_end",v="sbgcui_refs_sort_measure",y=!1;h.classList.add("fa","fa-solid-sort","sbgcui_button_reset","sbgcui_refs-sort-button"),p.classList.add("sbgcui_refs-sort-select"),[["Сортировка","none"],["По названию","name"],["По уровню","level"],["По команде","team"],["По заряду","energy"],["По дистанции","distance"],["По количеству","amount"]].forEach((e=>{let t=document.createElement("option");t.innerText=e[0],t.value=e[1],p.appendChild(t)})),p.addEventListener("change",(n=>{let o=new Event("scroll");if(Object.defineProperty(o,"target",{value:{scrollTop:0,clientHeight:W.clientHeight}}),d=Array.from(W.children),u=n.target.value,"none"!=u)if(W.scrollTop=0,W.classList.remove("sbgcui_refs-reverse"),p.setAttribute("disabled",""),!u.match(/name|amount/)&&!e(d)||y){let n=.9*W.offsetHeight;if(W.classList.add("sbgcui_refs_list-blur"),y&&(e(d)&&document.querySelector('.inventory__tab[data-tab="3"]')?.click(),localStorage.removeItem("refs-cache"),performance.mark(f)),t(d))for(let e=0;e<=W.scrollHeight;e+=W.offsetHeight/2)o.target.scrollTop=e,W.dispatchEvent(o);else l=setInterval((()=>{o.target.scrollTop<=W.scrollHeight?(o.target.scrollTop+=n,W.dispatchEvent(o)):(clearInterval(l),o.target.scrollTop=W.scrollHeight,W.dispatchEvent(o))}),10);W.addEventListener("refsListLoaded",a,{once:!0})}else s(d,u),W.replaceChildren(...d),p.removeAttribute("disabled")})),document.querySelector(".inventory__tabs").addEventListener("click",r),U.addEventListener("click",r),X.addEventListener("inventoryPopupOpened",c),U.addEventListener("touchstart",(()=>{let e=Date.now(),t=setTimeout((()=>{let e;e=Qe("Режим измерения производительности. <br><br>\n\t\t\t\t\t\tВыберите тип сортировки для измерения скорости загрузки данных. <br><br>\n\t\t\t\t\t\tКэш рефов будет очищен. <br><br>\n\t\t\t\t\t\tДля отмены операции закройте инвентарь.","bottom center",-1,"sbgcui_toast-selection"),e.showToast(),y=!0,U.setAttribute("sbgcui_measurement_mode","")}),2e3);U.addEventListener("touchend",(()=>{Date.now()-e<1e3&&clearTimeout(t)}),{once:!0})})),h.addEventListener("click",(()=>{W.classList.toggle("sbgcui_refs-reverse"),W.scrollTop=-W.scrollHeight})),g.insertBefore(p,m),g.appendChild(h)}{class e extends ol.Feature{constructor(e){super(e),this.addEventListener("change",(()=>{if(!this.id_||!this.style_)return;let{inner:e,outer:t,outerTop:n,outerBottom:o,text:i}=g.pointHighlighting,s=this.style_;this.addStyle(s,"inner",1,this.isMarkerNeeded(e)),this.addStyle(s,"outer",2,this.isMarkerNeeded(t)),this.addStyle(s,"outerTop",3,this.isMarkerNeeded(n)),this.addStyle(s,"outerBottom",4,this.isMarkerNeeded(o)),this.addStyle(s,null,5,!1,this.textToRender(i))}))}isMarkerNeeded(e){switch(e){case"fav":return this.id_ in p;case"ref":return this.cachedRefsGuids.includes(this.id_);case"uniqc":return ke.c.has(this.id_);case"uniqv":return ke.v.has(this.id_);case"cores":return 6==Ce[this.id_]?.cores;case"highlevel":return Ce[this.id_]?.level>=9;default:return!1}}textToRender(e){switch(e){case"energy":let e=Ce[this.id_]?.energy;return e>0?String(Math.round(10*e)/10):null;case"level":let t=Ce[this.id_]?.level;return"number"==typeof t?String(t):null;case"lines":let n=Ce[this.id_]?.lines.sum;return n>0?String(n):null;case"refsAmount":let o=this.cachedRefsAmounts[this.id_];return o>0?String(o):null;default:return null}}addStyle(e,t,n,o,i){1==o?(e[n]=e[0].clone(),e[n].renderer_=this[`${t}MarkerRenderer`]):(e[n]=new ol.style.Style({}),e[n].text_=i?new ol.style.Text({font:"14px Manrope",offsetY:e[1].renderer_?-20:0,text:i,fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#FFF",width:3})}):void 0)}innerMarkerRenderer(e,t){const n=t.context,[[o,i],[s,a]]=e,r=Math.sqrt((s-o)**2+(a-i)**2)/3;n.fillStyle=g.pointHighlighting.innerColor,n.beginPath(),n.arc(o,i,r,0,2*Math.PI),n.fill()}outerMarkerRenderer(e,t){const n=t.context,[[o,i],[s,a]]=e,r=1.3*Math.sqrt((s-o)**2+(a-i)**2);n.lineWidth=4,n.strokeStyle=g.pointHighlighting.outerColor,n.beginPath(),n.arc(o,i,r,0,2*Math.PI),n.stroke()}outerTopMarkerRenderer(e,t){const n=t.context,[[o,i],[s,a]]=e,r=1.3*Math.sqrt((s-o)**2+(a-i)**2);n.lineWidth=4,n.strokeStyle=g.pointHighlighting.outerTopColor,n.beginPath(),n.arc(o,i,r,Math.PI/180*195,Math.PI/180*345),n.stroke()}outerBottomMarkerRenderer(e,t){const n=t.context,[[o,i],[s,a]]=e,r=1.3*Math.sqrt((s-o)**2+(a-i)**2);n.lineWidth=4,n.strokeStyle=g.pointHighlighting.outerBottomColor,n.beginPath(),n.arc(o,i,r,Math.PI/180*15,Math.PI/180*165),n.stroke()}get cachedRefsGuids(){return JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>3==e.t)).map((e=>e.l))}get cachedRefsAmounts(){return Object.fromEntries(JSON.parse(localStorage.getItem("inventory-cache")).filter((e=>3==e.t)).map((e=>[e.l,e.a])))}}ol.Feature=e}{function e(){const e=[...G.children].find((e=>e.classList.contains("is-active"))),t=(JSON.parse(localStorage.getItem("inventory-cache"))||[]).find((t=>t.g==e.dataset.guid)),n=t.l,o=2==t.t?window.Catalysers[n].range:4==t.t?45:0;w.getStyle()[3].getGeometry().setRadius(st(o)),w.getStyle()[3].getStroke().setColor(`${g.mapFilters.brandingColor}70`),w.changed(),L&&y.fitBlastRange()}function t(){const e=y.getZoom(),{beforeAttackZoom:t,blastRangeZoom:o}=y.getProperties();s=e==o?t:e,w.getStyle()[3].getGeometry().setRadius(0),w.changed(),L&&n()}function n(e){e||(y.setTopPadding(),y.animate({center:w.getGeometry().getCoordinates(),zoom:s,duration:0},n))}function o(){y.setProperties({beforeAttackZoom:y.getZoom(),isZoomChanged:!1})}function i(e){const t=e.target.matches(".ol-zoom-in, .ol-zoom-out");Ee&&t&&y.set("isZoomChanged",!0)}let s;D.addEventListener("attackSliderOpened",o),G.addEventListener("activeSlideChanged",e),D.addEventListener("attackSliderClosed",t),ve.addEventListener("click",i)}{let e=document.createElement("button");e.classList.add("fa","fa-solid-rotate"),e.addEventListener("click",(()=>{window.requestEntities()})),S.addItem(e,3)}{const e=new ol.Geolocation({projection:y.getProjection(),tracking:!0,trackingOptions:{enableHighAccuracy:!0}}),t=document.createElement("span");t.classList.add("sbgcui_speed"),document.querySelector(".self-info").appendChild(t),e.on("change:speed",(()=>{const n=e.getSpeed()||0;t.innerText=(3.6*n).toFixed(2)+" km/h"}))}{const e=document.createElement("button"),t="conic-gradient(\n\t\t\t#0000 var(--sbgcui-cluster-cooldown, 100%),\n\t\t\tvar(--sbgcui-cluster-team, #000) var(--sbgcui-cluster-cooldown, 100%) calc(var(--sbgcui-cluster-cooldown, 100%) + 1%),\n\t\t\t#0007 var(--sbgcui-cluster-cooldown, 100%) 100%\n\t\t\t)",n=document.createElement("div"),o=document.createElement("div"),i=v.getListeners("click")[0],s=200;let a,r,c=!1,l=[],d=[];function u(e){if(!c)return;const t=e.target.getAttribute("sbgcui_guid"),n=a.find((e=>e.getId()==t));n.set("sbgcui_chosenFeature",!0,!0),g(),setTimeout((()=>{r.pixel=v.getPixelFromCoordinate(n.getGeometry().getCoordinates()),i(r)}),s)}function g(){n.childNodes.forEach((e=>{e.classList.remove("sbgcui_cluster-iconWrapper-fullWidth")})),o.classList.remove("sbgcui_cluster-overlay-blur"),setTimeout((()=>{o.classList.add("sbgcui_hidden"),d.forEach((e=>{clearInterval(e)})),c=!1}),s)}function m(e){r=e,a=v.getFeaturesAtPixel(r.pixel,{hitTolerance:15,layerFilter:e=>"points"==e.get("name")});let t=a.slice();t.length<=1||r.isSilent?(t[0]?.set("sbgcui_chosenFeature",!0,!0),i(r)):(f(t),t.length>8&&(t=t.reduceRight(p,[])),b(t),h(),l=t)}function p(e,t,n){const o=8-e.length<=n,i=e.length<8,s=l.includes(t);return i?(s&&o||e.push(t),e):e}function h(){o.classList.remove("sbgcui_hidden"),setTimeout((()=>{o.classList.add("sbgcui_cluster-overlay-blur"),c=!0}),10),d=[]}function f(e){const t=e.map((e=>e.getGeometry().getCoordinates())),n=[t.reduce(((e,t)=>e+t[0]),0)/t.length,t.reduce(((e,t)=>e+t[1]),0)/t.length];e.sort((function(e,t){const o=e.getGeometry().getCoordinates(),i=t.getGeometry().getCoordinates();let s=Math.atan2(o[1]-n[1],o[0]-n[0]),a=Math.atan2(i[1]-n[1],i[0]-n[0]);return s<0&&(s+=2*Math.PI),a<0&&(a+=2*Math.PI),s=(2.5*Math.PI-s)%(2*Math.PI),a=(2.5*Math.PI-a)%(2*Math.PI),s-a}))}function b(e){const o=360/e.length;n.innerHTML="",e.forEach(((e,i)=>{const s=e.getId(),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),l=JSON.parse(localStorage.getItem("cooldowns"))?.[s]?.t;if(l){y(a,l);const e=setInterval((()=>{y(a,l,e)}),1e3);d.push(e),a.style.backgroundImage=t}Ne(s,!1).then((e=>{const t=`url("https://lh3.googleusercontent.com/${e.i}=s60")`;a.style.backgroundImage+=a.style.backgroundImage.length?", ":"",a.style.backgroundImage+=t,a.style.borderColor=`var(--team-${e.te||0})`,a.style.boxShadow=`0 0 20px 3px var(--team-${e.te||0}), 0 0 5px 2px black`,a.style.setProperty("--sbgcui-point-title",`"${e.t.replaceAll('"',"\\22 ")}"`),a.style.setProperty("--sbgcui-point-level",`"${e.l}"`),a.style.setProperty("--sbgcui-cluster-team",`var(--team-${e.te})`)})),c.classList.add("sbgcui_cluster-iconWrapper"),a.classList.add("sbgcui_cluster-icon"),r.classList.add("sbgcui_cluster-line"),c.style.transform=`rotate(${o*i}deg)`,a.style.transform=`rotate(${-o*i}deg)`,c.append(a,r),n.appendChild(c),setTimeout((()=>{c.classList.add("sbgcui_cluster-iconWrapper-fullWidth")}),10),a.setAttribute("sbgcui_guid",s),a.addEventListener("click",u)}))}function y(e,t,n){const o=(t-Date.now())/1e3,i=Math.trunc(100-o/90*100);o<=90&&o>=0?e.style.setProperty("--sbgcui-cluster-cooldown",`${i}%`):(clearInterval(n),e.style.removeProperty("--sbgcui-cluster-cooldown"))}e.classList.add("sbgcui_button_reset","sbgcui_cluster-close","fa","fa-solid-circle-xmark"),n.classList.add("sbgcui_cluster-center"),o.classList.add("sbgcui_cluster-overlay","sbgcui_hidden"),o.append(n,e),document.body.appendChild(o),e.addEventListener("click",g),v.un("click",i),v.on("click",m)}{const e=document.createElement("button");function t(){const t=`Использовать предыдущую сохранённую точку "${Oe?.name}" в качестве центра звезды?`;let o;qe=!qe,E.transaction("state","readwrite").objectStore("state").put(qe,"isStarMode"),qe?(e.style.opacity=1,e.classList.add("fa-fade"),Oe&&confirm(t)?(e.classList.remove("fa-fade"),o=`Включён режим рисования "Звезда". <br /><br />\n\t\t\t\t\t\t\t\t\t\tТочка "<span style="color: var(--selection)">${Oe.name}</span>" будет считаться центром звезды. <br /><br />\n\t\t\t\t\t\t\t\t\t\tРефы от прочих точек будут скрыты в списке рисования.`):(se.addEventListener("pointPopupOpened",n,{once:!0}),o='Включён режим рисования "Звезда". <br /><br />\n\t\t\t\t\t\t\t\t\tСледующая открытая точка будет считаться центром звезды. <br /><br />\n\t\t\t\t\t\t\t\t\tРефы от прочих точек будут скрыты в списке рисования.')):(e.style.opacity=.5,e.classList.remove("fa-fade"),se.removeEventListener("pointPopupOpened",n),o='Режим рисования "Звезда" отключён.');Qe(o,void 0,qe?6e3:void 0,"sbgcui_toast-selection").showToast()}function n(){Oe={guid:se.dataset.guid,name:ie.innerText},E.transaction("state","readwrite").objectStore("state").put(Oe,"starModeTarget"),e.classList.remove("fa-fade");Qe(`Точка "<span style="color: var(--selection)">${ie.innerText}</span>" выбрана центром для рисования звезды.`,void 0,void 0,"sbgcui_toast-selection").showToast()}e.classList.add("fa","fa-solid-asterisk"),e.style.opacity=qe?1:.5,e.addEventListener("click",t),S.addItem(e,4)}{const e=document.createElement("i"),t=new Set;let n=[];function o(e){const t=w.getGeometry().getCoordinates(),n=e.getGeometry().getCoordinates();return Math.sqrt(Math.pow(n[0]-t[0],2)+Math.pow(n[1]-t[1],2))<st(45)}function i(){const e=w.getGeometry().getCoordinates(),t=v.getPixelFromCoordinate(e),n=y.getResolution(),i=st(45)/n;return v.getFeaturesAtPixel(t,{hitTolerance:i,layerFilter:e=>"points"==e.get("name")}).filter(o)}function s(){w.un("change",r)}function a(){r(),w.on("change",r)}function r(){i().length>1?e.classList.remove("sbgcui_hidden"):e.classList.add("sbgcui_hidden")}function c(){if(Object.isSealed(n)||0==n.length)return;if(!n.every(((e,t,n)=>e.x<=n[t-1]?.x||0==t)))return;const e=n.map((e=>e.x)),o=n.map((e=>e.y)),s=Math.min(...e),a=Math.max(...e),r=Math.min(...o);if(Math.max(...o)-r>70)return;if(a-s<50)return;let c=i();t.add(Se.guid),(c.every((e=>t.has(e.getId())))||c.every((e=>!t.has(e.getId()))))&&t.clear();const l=c.find((e=>e.getId()!==Se.guid&&!t.has(e.getId())));if(null==l)return;t.add(l.getId());const d={type:"click"};d.pixel=v.getPixelFromCoordinate(l.getGeometry().getCoordinates()),d.originalEvent={},d.isSilent=!0,l.set("sbgcui_chosenFeature",!0,!0),se.classList.add("hidden"),v.dispatchEvent(d)}function l(e){if(Object.isSealed(n))return;const{clientX:t,clientY:o}=e.touches.item(0);n.push({x:t,y:o})}function d(e){n=[],(e.touches.length>1||null!==e.touches.item(0).target.closest(".deploy-slider-wrp"))&&Object.seal(n)}e.classList.add("sbgcui_swipe-cards-arrow","fa","fa-solid-angles-left"),document.querySelector(".i-stat").appendChild(e),se.addEventListener("pointPopupOpened",a),se.addEventListener("pointPopupClosed",s),se.addEventListener("touchstart",d),se.addEventListener("touchmove",l),se.addEventListener("touchend",c)}{const e=document.querySelector(".pr-buttons"),t=document.createElement("button");async function o(){const e=await De(null,re.innerText),o=await De(null,n.name),s=i18next.getResourceBundle(i18next.resolvedLanguage).profile.stats,a=document.querySelectorAll(".pr-stat-title");t.toggleAttribute("sbgcui_self_stats"),t.classList.toggle("fa-solid-scale-unbalanced"),t.classList.toggle("fa-solid-scale-unbalanced-flip"),a.forEach((n=>{const a=n.innerText;let r=Object.entries(s).find((e=>e[1]==a))[0];if(r=r.replace("total-xp","xp").replace("playing-since","created_at"),t.hasAttribute("sbgcui_self_stats")){const t="created_at"==r?Date.parse(o[r])-Date.parse(e[r]):e[r]-o[r],s=t>0?"red":t<0?"green":"";n.nextSibling.innerText=i(r,o[r]),n.nextSibling.style.setProperty("--sbgcui-diff-color",s)}else n.nextSibling.innerText=i(r,e[r]),n.nextSibling.style.removeProperty("--sbgcui-diff-color")})),de.style.setProperty("--sbgcui-reg-date",at(t.hasAttribute("sbgcui_self_stats")?o.created_at:e.created_at))}function i(e,t){i18next.resolvedLanguage;const n=new Intl.NumberFormat(i18next.language);if(/^guard_/.test(e))return i18next.t("units.n-days",{count:t});switch(e){case"max_line":return t<1e3?i18next.t("units.m",{count:t}):i18next.t("units.km",{count:t/1e3});case"max_region":case"regions_area":return i18next.t("units.sqkm",{count:t});case"xp":return`${n.format(t)} ${i18next.t("units.pts-xp")}`;case"created_at":return new Date(t).toLocaleDateString(i18next.language,{day:"numeric",month:"long",year:"numeric"});default:return n.format(t)}}function s(){n.name==re.innerText?t.classList.add("sbgcui_hidden"):t.classList.remove("sbgcui_hidden"),t.removeAttribute("sbgcui_self_stats")}function a(){const e=document.querySelectorAll(".pr-stat-val");t.removeAttribute("sbgcui_self_stats"),t.classList.replace("fa-solid-scale-unbalanced-flip","fa-solid-scale-unbalanced"),e.forEach((e=>{e.style.removeProperty("--sbgcui-diff-color")}))}t.classList.add("fa","fa-solid-scale-unbalanced","sbgcui_profile-compare"),t.addEventListener("click",o),ce.addEventListener("profilePopupOpened",s),ce.addEventListener("profilePopupClosed",a),e.appendChild(t)}{function e(){const e=_?.getFeatures()[0].getGeometry(),t=[10,0,window.innerHeight-R.getBoundingClientRect().y+30,0];null!=e&&y.fitTempLine(e,t)}function t(){const e=[...V.childNodes].reverse();V.replaceChildren(...e),window.draw_slider.refresh(),i.classList.toggle("fa-solid-arrow-down-short-wide"),i.classList.toggle("fa-solid-arrow-down-wide-short")}function n(){i.classList.replace("fa-solid-arrow-down-wide-short","fa-solid-arrow-down-short-wide")}const o=document.createElement("button"),i=document.createElement("button"),s=document.querySelector(".draw-slider-buttons");o.classList.add("fa","fa-solid-up-right-and-down-left-from-center","sbgcui_drawslider_fit"),i.classList.add("fa","fa-solid-arrow-down-short-wide","fa-rotate-270","sbgcui_drawslider_sort"),o.addEventListener("click",e),i.addEventListener("click",t),R.addEventListener("drawSliderOpened",n),s.append(i,o)}{function e(){o.innerText=`${i}: ${s.format(Se.destroyReward)} ${i18next.t("units.pts-xp")}`}const t=document.querySelector(".info.popup .i-buttons"),n=document.querySelector(".info.popup .i-stat"),o=document.createElement("div"),i=i18next.language.includes("ru")?"Награда":"Reward",s=new Intl.NumberFormat(i18next.language);o.classList.add("i-stat__entry"),n.insertBefore(o,t),se.addEventListener("pointPopupOpened",e)}{const e=new ol.source.Vector,t=new ol.layer.Vector({source:e,name:"sbgcui_points",minZoom:15,className:"ol-layer__sbgcui_points",zIndex:9});try{const t=await Ve("zero-point-info"),n=new ol.Feature({geometry:new ol.geom.Point([0,0])});t.addEventListener("click",(()=>{t.classList.add("sbgcui_hidden"),setTimeout((()=>{t.style.zIndex=0}),100)})),document.body.appendChild(t),n.setId("sbgcui_zeroPoint"),n.setStyle(new ol.style.Style({geometry:new ol.geom.Circle([0,0],30),fill:new ol.style.Fill({color:"#BB7100"}),stroke:new ol.style.Stroke({color:window.TeamColors[3].stroke,width:5}),text:new ol.style.Text({font:"30px Manrope",text:"?",fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#FFF",width:3})})})),v.on("click",(e=>{v.getFeaturesAtPixel(e.pixel,{layerFilter:e=>"sbgcui_points"==e.get("name")}).includes(n)&&(t.classList.remove("sbgcui_hidden"),setTimeout((()=>{t.style.zIndex=9}),100))})),e.addFeature(n)}catch(e){}v.addLayer(t)}{function e(){Qe("Нажмите на регион чтобы узнать, сколько их в этом месте.",void 0,void 0,"sbgcui_toast-selection").showToast(),v.un("click",t),v.once("click",t)}function t(e){const t=v.getFeaturesAtPixel(e.pixel,{layerFilter:e=>"regions"==e.get("name")}),n=t.map((e=>ol.sphere.getArea(e.getGeometry()))),o=Math.min(...n),i=Math.max(...n),s=i18next.t("units.sqkm",{count:o/1e6}),a=i18next.t("units.sqkm",{count:i/1e6});let r=`Количество регионов в точке: ${t.length}.`;1==t.length&&(r+=`\n\nПлощадь региона: ${a}.`),t.length>1&&(r+=`\n\nПлощадь самого большого региона: ${a}.\nПлощадь самого маленького региона: ${s}.`),alert(r)}const n=document.createElement("button");n.classList.add("fa","fa-brands-stack-overflow"),n.addEventListener("click",e),S.addItem(n,5)}{function e(){g.ui.pointDischargeTimeout&&(t.innerText=`(~${Se.dischargeTimeout})`)}const t=document.createElement("span");t.classList.add("sbgcui_discharge_timeout"),te.after(t),se.addEventListener("pointPopupOpened",e),se.addEventListener("pointRepaired",e)}{let e=null,t=[];const n=document.createElement("button"),o=document.getElementById("map");function i(e,t){const n=v.getPixelFromCoordinate(y.getCenter()),o=Math.atan2(e[1]-n[1],e[0]-n[0]),i=Math.atan2(t[1]-n[1],t[0]-n[0]),s=v.getCoordinateFromPixel(n);y.adjustRotation(i-o,s)}function s(e){e||y.animate({rotation:0},s)}function a(e){e&&(Pe=!Pe),Pe&&s(),x.setActive(!Pe),n.setAttribute("sbgcui_locked",Pe),E.transaction("state","readwrite").objectStore("state").put(Pe,"isRotationLocked")}function r(n){Pe||L&&"CANVAS"==n.target.nodeName&&(n.targetTouches.length>1||(e=[n.targetTouches[0].clientX,n.targetTouches[0].clientY],t=[]))}function c(n){if(n.preventDefault(),null==e)return;const o=[n.targetTouches[0].clientX,n.targetTouches[0].clientY];i(e,o),e=o,t.push(o)}function l(){0!=t.length&&window.requestEntities(),e=null}function d(){const e=y.getAnimating();L&&!e&&y.setCenter(w.getGeometry().getCoordinates()),n.style.setProperty("--sbgcui_angle",180*y.getRotation()/Math.PI+"deg")}E.transaction("state","readwrite").objectStore("state").get("isRotationLocked").addEventListener("success",(e=>{Pe=e.target.result,a()})),n.classList.add("fa","fa-solid-compass","sbgcui_lock_rotation"),n.addEventListener("click",a),he.before(n),o.addEventListener("touchstart",r),o.addEventListener("touchmove",c),o.addEventListener("touchend",l),y.on("change:rotation",d)}{const e=document.createElement("button");e.classList.add("fa","fa-solid-map-location-dot","sbgcui_button_reset","sbgcui_jumpToButton"),e.addEventListener("click",(()=>{dt(Se.coords)})),se.appendChild(e);try{if(window.navigator.userAgent.toLowerCase().includes("wv"))throw new Error;function t(e,t){const[n,o]=ol.proj.toLonLat(w.getGeometry().getCoordinates()),[i,s]=Se.coords;let a;switch(e){case"yamaps":a=`yandexmaps://maps.yandex.ru/?rtext=${o},${n}~${s},${i}&rtt=${t}`;break;case"yanavi":a=`yandexnavi://build_route_on_map?lat_from=${o}&lon_from=${n}&lat_to=${s}&lon_to=${i}`;break;case"dgis":a=`dgis://2gis.ru/routeSearch/rsType/${t}/from/${n},${o}/to/${i},${s}`;break;case"gmaps":a=`comgooglemaps://?saddr=${o},${n}&daddr=${s},${i}&directionsmode=${t}`;break}return a}function n(e){const t=e.currentTarget.dataset.app,n=e.target.dataset.routetype;if("LI"==e.target.nodeName){if(e.target.hasAttribute("data-selected"))return delete e.target.dataset.selected,delete d.dataset.app,void delete d.dataset.routetype;s.querySelectorAll("li[data-selected]").forEach((e=>{delete e.dataset.selected})),e.target.dataset.selected="",d.dataset.app=t,d.dataset.routetype=n}}function o(){s.classList.add("sbgcui_hidden")}function i(){s.classList.toggle("sbgcui_hidden")}const s=await Ve("navigate"),a=s.querySelector(".sbgcui_navigate-coords"),r=s.querySelector("form"),c=s.querySelectorAll("menu"),[l,d]=s.querySelectorAll(".sbgcui_navigate-form-buttons > button"),u=document.createElement("button");u.classList.add("fa","fa-solid-route","sbgcui_button_reset","sbgcui_navbutton"),u.addEventListener("click",i),se.appendChild(u),se.addEventListener("pointPopupOpened",(()=>{a.innerText=Se.coords.slice().reverse().join(", ")})),a.addEventListener("click",(()=>{window.navigator.clipboard.writeText(a.innerText).then((()=>{Qe("Координаты скопированы в буфер обмена.").showToast()}))})),r.addEventListener("submit",(e=>{e.preventDefault()})),c.forEach((e=>{e.addEventListener("click",n)})),l.addEventListener("click",o),d.addEventListener("click",(()=>{const e=t(d.dataset.app,d.dataset.routetype);null!=e&&(window.location.href=e,o())})),ae.addEventListener("click",o),e.addEventListener("click",o),document.body.appendChild(s)}catch(e){}}{function e(e){const o=e.webkitCompassHeading;if(Math.abs(n-o)>3){const e=o*Math.PI/180;t.setRotation(e+y.getRotation()),w.changed(),n=o}}const t=w.getStyle()[0].getImage();let n=0;DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission&&(document.body.addEventListener("click",(()=>{DeviceOrientationEvent.requestPermission()}),{once:!0}),window.addEventListener("deviceorientation",e))}{function e(){if(0==h)return;const e=h%10==1?"ки":"ек";let t;switch(p%10){case 1:t="ку";break;case 2:case 3:case 4:t="ки";break;default:t="ок";break}if(!confirm(`Удалить ${p} ссыл${t} от ${h} точ${e}?`))return;const n=i.getFeatures().filter((e=>1==e.get("isSelected"))),o=n.map((e=>({guid:e.getId(),type:3,amount:e.get("amount")})));Ge(o).then((e=>{const t=e[0];if("error"in t)throw t.error;const s=t.count.total;Y.innerText=s,J.style.color.match("accent")&&s<r&&(J.style.color=""),Ue(o),h=0,p=0,n.forEach((e=>{i.removeFeature(e)})),u.style.setProperty("--sbgcui-overall-refs-to-del",'"0"'),u.style.setProperty("--sbgcui-unique-refs-to-del",'"0"')})).catch((e=>{Qe(`Ошибка при удалении ссылок. <br>${e?.message||e}`,void 0,void 0,"error-toast").showToast()}))}function t(){i.clear(!0),a.classList.add("sbgcui_hidden"),u.classList.add("sbgcui_hidden"),ct(),xe=!1,p=0,h=0,v.un("click",n),y.setZoom(m),window.requestEntities()}function n(e){v.forEachFeatureAtPixel(e.pixel,(function(e){const{amount:t,isSelected:n}=e.getProperties();e.set("isSelected",!n),p+=t*(n?-1:1),h+=n?-1:1,u.style.setProperty("--sbgcui-overall-refs-to-del",`"${p}"`),u.style.setProperty("--sbgcui-unique-refs-to-del",`"${h}"`)}),{hitTolerance:0,layerFilter:e=>"sbgcui_points_with_refs"==e.get("name")})}function o(){Re().then((e=>{const t=e.filter((e=>3==e.t)),o=v.getAllLayers();m=y.getZoom(),xe=!0,a.classList.remove("sbgcui_hidden"),u.classList.remove("sbgcui_hidden"),X.classList.add("hidden"),D.classList.contains("hidden")||Ke(B),rt(),u.style.setProperty("--sbgcui-overall-refs-to-del",'"0"'),u.style.setProperty("--sbgcui-unique-refs-to-del",'"0"'),o.forEach((e=>{/^(lines|points|regions)/.test(e.get("name"))&&e.getSource().clear()})),t.forEach((e=>{const{a:t,c:n,g:o,l:s,ti:a}=e,r=ol.proj.fromLonLat(n),c=new ol.Feature({geometry:new ol.geom.Point(r)});c.setId(o),c.setProperties({amount:t,mapCoords:r,pointGuid:s,title:a}),i.addFeature(c)})),v.on("click",n)})).catch((e=>{}))}const i=new ol.source.Vector,s=new ol.layer.Vector({className:"ol-layer__sbgcui_points_with_refs",declutter:!0,minZoom:0,name:"sbgcui_points_with_refs",source:i,style:(e,t)=>{const{amount:n,isSelected:o,mapCoords:i,title:s}=e.getProperties(),a=y.getZoom(),r=a>=16?20:20*t/2.5;return[new ol.style.Style({geometry:new ol.geom.Circle(i,o?1.4*r:r),fill:new ol.style.Fill({color:o?"#BB7100":"#CCC"}),stroke:new ol.style.Stroke({color:window.TeamColors[3].stroke,width:3}),zIndex:o?3:1}),new ol.style.Style({text:new ol.style.Text({fill:new ol.style.Fill({color:"#000"}),font:(a>=15?16:12)+"px Manrope",stroke:new ol.style.Stroke({color:"#FFF",width:3}),text:a>=15?String(n):null}),zIndex:2}),new ol.style.Style({text:new ol.style.Text({fill:new ol.style.Fill({color:"#000"}),font:"12px Manrope",offsetY:25/t,stroke:new ol.style.Stroke({color:"#FFF",width:3}),text:a>=17?s.length<=12?s:s.slice(0,10).trim()+"...":null,textBaseline:"top"}),zIndex:2})]},zIndex:8}),a=document.createElement("button"),c=document.querySelector(".inventory__controls"),l=document.querySelector("#inventory-delete"),d=document.createElement("button"),u=document.createElement("button"),g=document.createElement("div");let m,p=0,h=0;a.id="sbgcui_hide_viewer",a.classList.add("sbgcui_button_reset","sbgcui_hidden","fa","fa-solid-xmark"),d.classList.add("sbgcui_show_viewer"),d.innerText="На карте",u.classList.add("sbgcui_button_reset","sbgcui_hidden","fa","fa-solid-trash"),u.id="sbgcui_batch_remove",d.addEventListener("click",o),a.addEventListener("click",t),u.addEventListener("click",e),c.insertBefore(d,l),g.append(a,u),document.body.appendChild(g),v.addLayer(s)}try{function t(){const e=p.getAttribute("min"),t=p.dataset.totalentries;if(0!=t){if(confirm(`Очистить всю историю действий? \nВы удалите ${t} записей с ${e}.`)&&confirm("Подтвердите удаление истории действий за всё время.")){E.transaction("logs","readwrite").objectStore("logs").clear().addEventListener("success",(()=>{alert("История действий очищена."),i()}))}}else alert("Записей не обнаружено.")}function n(){f.innerHTML="",[v,b,h].forEach((e=>e.classList.remove("sbgcui_hidden"))),f.classList.add("sbgcui_hidden")}function o(){f.classList.contains("sbgcui_hidden")?(e.forEach((e=>{const t=document.createElement("p"),n=document.createElement("span"),o=document.createElement("div");t.classList.add("sbgcui_log-content-entry"),n.classList.add("sbgcui_log-content-entry-time"),o.classList.add("sbgcui_log-content-entry-description"),n.innerText=new Date(e.timestamp).toLocaleString(i18next.language,{hour:"2-digit",minute:"2-digit",second:"2-digit",hourCycle:"h23"}),o.innerHTML=e.messages.join("<br>"),t.append(n,o),f.prepend(t)})),[v,b,h].forEach((e=>e.classList.add("sbgcui_hidden"))),f.classList.remove("sbgcui_hidden")):n()}function i(){l.classList.add("sbgcui_hidden"),h.innerHTML="",_=void 0,n()}function s(){E.transaction("logs","readonly").objectStore("logs").getAllKeys().addEventListener("success",(e=>{const t=60*(new Date).getTimezoneOffset()*1e3,n=e.target.result,o=n[0]||Date.now(),i=n[n.length-1]||Date.now(),s=new Date(o-t).toISOString().slice(0,10),a=new Date(i-t).toISOString().slice(0,10);p.setAttribute("min",s),p.setAttribute("max",a),p.setAttribute("value",a),p.setAttribute("data-totalEntries",n.length),p.value=a,p.dispatchEvent(new Event("change")),l.classList.remove("sbgcui_hidden")}))}function a(){const e=new Date(p.value).setHours(0,0,0,0),t=new Date(p.value).setHours(23,59,59,999),n=IDBKeyRange.bound(e,t),o=E.transaction("logs","readonly").objectStore("logs").getAll(n);h.innerHTML="",o.addEventListener("success",(e=>{const t=e.target.result;if(0==t.length)return;const n={},o=[];t.reverse(),t.map((e=>{switch(e.type){case"capture":case"deploy":case"upgrade":case"discover":n[e.point]=n[e.point]||e.title;break;case"draw":n[e.from]=n[e.fromTitle]||e.fromTitle,n[e.to]=n[e.toTitle]||e.toTitle;break;case"destroy":case"broom":e.points.forEach((e=>{n[e]=n[e]||void 0}));break}}));for(let e in n)null==n[e]&&o.push(e);const i=o.map((e=>Ne(e)));Promise.all(i).then((e=>{e.forEach((e=>{n[e.g]=e.t})),t.forEach((e=>{const t=document.createElement("p"),o=document.createElement("span"),i=document.createElement("div");t.classList.add("sbgcui_log-content-entry"),o.classList.add("sbgcui_log-content-entry-time"),i.classList.add("sbgcui_log-content-entry-description"),t.style.setProperty("--action-type",`"${e.type}"`),t.style.setProperty("--action-color",`var(--${e.type})`),t.setAttribute("data-action",e.type);switch(o.innerText=new Date(e.timestamp).toLocaleString(i18next.language,{hour:"2-digit",minute:"2-digit",second:"2-digit",hourCycle:"h23"}),e.type){case"capture":case"deploy":case"upgrade":case"discover":{const t=document.createElement("a");t.innerText=n[e.point]||e.point,t.setAttribute("data-guid",e.point),i.appendChild(t);break}case"draw":{const t=document.createElement("a"),o=document.createElement("a"),s=document.createElement("span"),a=e.distance,r=i18next.t("units."+(a>=1e3?"km":"m"),{count:a>=1e3?a/1e3:a}),c=e.regions instanceof Array?e.regions.length:e.regions;if(t.innerText=n[e.from],o.innerText=n[e.to],t.setAttribute("data-guid",e.from),o.setAttribute("data-guid",e.to),s.classList.add("sbgcui_log-content-entry-description-fromto"),s.append(t,"->",o),i.appendChild(s),null!=a&&i.append(`${i18next.t("sbgcui.distance")}: ${r}`,document.createElement("br")),c>0){if(i.append(`${i18next.t("sbgcui.region"+(c>1?"s":""))}: ${c}`),"number"==typeof e.regions)break;const t=e.regions.map((e=>"number"==typeof e?e:e.a)),n=i18next.t("units.sqkm",{count:Math.max(...t)}),o=i18next.t("units.sqkm",{count:t.reduce(((e,t)=>e+t),0)});if(1==c)i.append(`. ${i18next.t("sbgcui.area")}: ${n}`);else{const e=document.createElement("br");i.append(e,`${i18next.t("sbgcui.max")}: ${n}, ${i18next.t("sbgcui.total").toLowerCase()}: ${o}`)}}break}case"destroy":case"broom":{const t=e.points,o=e.lines instanceof Array?e.lines.length:e.lines,s=e.regions instanceof Array?e.regions.length:e.regions,a=e.xp,r=`${i18next.t("sbgcui.line"+(o>1?"s":""))}: ${o}`,c=`${i18next.t("sbgcui.region"+(s>1?"s":""))}: ${s}`;i.innerText=i18next.t("sbgcui.point"+(t.length>1?"s":""))+": ",t.forEach(((e,o)=>{const s=document.createElement("a");s.innerText=n[e]||e,s.setAttribute("data-guid",e),i.appendChild(s),o<t.length-1&&i.append(", ")})),o>0&&(i.appendChild(document.createElement("br")),i.append(r,s>0?`, ${c.toLowerCase()}`:"",null!=a?`. XP: ${a}`:""));break}}t.append(o,i),h.appendChild(t)}))})).catch((e=>{}))}))}function r(e){const t=e.target.dataset.guid;null!=t&&window.showInfo(t)}function c(e){if(!e.target.dataset.hasOwnProperty("action"))return;const t=e.target,n=t.dataset.action;t.hasAttribute("data-hidden")?(m.hiddenLogs.delete(n),t.removeAttribute("data-hidden")):(m.hiddenLogs.add(n),t.setAttribute("data-hidden",""));E.transaction("state","readwrite").objectStore("state").put(m.hiddenLogs,"hiddenLogs")}const l=await Ve("log"),d=l.querySelector(".sbgcui_log-close"),u=l.querySelector(".sbgcui_log-buttons-trash"),g=l.querySelector(".sbgcui_log-buttons-console"),p=l.querySelector('input[type="date"]'),h=l.querySelector(".sbgcui_log-content"),f=l.querySelector(".sbgcui_log-console"),b=l.querySelector(".sbgcui_log-tags"),v=l.querySelector(".sbgcui_log-header"),y=document.querySelector(".info > .sbgcui_jumpToButton"),w=document.createElement("button");let _;m.hiddenLogs=m.hiddenLogs||new Set,w.classList.add("fa","fa-solid-table-list"),[...b.children].forEach((e=>{const t=e.dataset.action;m.hiddenLogs.has(t)&&e.setAttribute("data-hidden","")})),w.addEventListener("click",s),d.addEventListener("click",i),u.addEventListener("click",t),g.addEventListener("click",o),y.addEventListener("click",i),b.addEventListener("click",c),h.addEventListener("click",r),p.addEventListener("keydown",(e=>{e.preventDefault()})),p.addEventListener("change",a),S.addItem(w,6),document.body.appendChild(l)}catch(e){}{async function e(e){return fetch("/api/notifs"+(null==e?"":"?latest="+e),{headers:{authorization:`Bearer ${n.auth}`,"accept-language":i18next.language},method:"GET"}).then((e=>e.json())).then((e=>e.count??e.list))}async function t(){const{status:t,duration:n,onClick:i}=g.notifications;if("off"!=t&&("fav"!=t||0!=Object.keys(p).length)&&(o=await e(F),o>0)){const s=await e();F=s[0].id,s.slice(0,o).reverse().forEach((e=>{const{g:o,na:s,ta:a,c:r,t:c}=e;if("fav"==t&&!(o in p))return;const l=Qe(`\n\t\t\t\t\t\t\t\t<span style="color: var(--team-${a})">${s}</span>\n\t\t\t\t\t\t\t\t<span>${c}</span>\n\t\t\t\t\t\t\t`,"bottom left",n,"sbgcui_destroy_notif_toast");"jumpto"==i&&(l.options.close=!0,l.options.onClick=()=>{l.hideToast(),dt(r)}),l.showToast()}))}}let o=0;const i=await e();F=i[0].id,setInterval(t,g.notifications.interval)}window.cuiStatus="loaded"}catch(e){}var $}));const x=indexedDB.open("CUI",5);x.addEventListener("upgradeneeded",(e=>{const t={maxAmountInBag:{cores:{I:-1,II:-1,III:-1,IV:-1,V:-1,VI:-1,VII:-1,VIII:-1,IX:-1,X:-1},catalysers:{I:-1,II:-1,III:-1,IV:-1,V:-1,VI:-1,VII:-1,VIII:-1,IX:-1,X:-1},references:{allied:-1,hostile:-1}},autoSelect:{deploy:"max",upgrade:"min",attack:"latest"},mapFilters:{invert:f&&!h?1:0,hueRotate:f?180:0,brightness:f?.75:1,grayscale:f?1:0,sepia:1,blur:0,branding:"default",brandingColor:"#CCCCCC"},tinting:{map:1,point:"level",profile:1},vibration:{buttons:1,notifications:1},ui:{doubleClickZoom:0,pointBgImage:1,pointBtnsRtl:0,pointBgImageBlur:1,pointDischargeTimeout:1,speedometer:1},pointHighlighting:{inner:"uniqc",outer:"off",outerTop:"cores",outerBottom:"highlevel",text:"refsAmount",innerColor:"#E87100",outerColor:"#E87100",outerTopColor:"#EB4DBF",outerBottomColor:"#28C4F4"},drawing:{minDistance:-1,maxDistance:-1},notifications:{status:"all",onClick:"jumpto",interval:3e4,duration:7e3}},{newVersion:n,oldVersion:o}=e;E=e.target.result,0==o&&function(){E.createObjectStore("config"),E.createObjectStore("state"),E.createObjectStore("stats",{keyPath:"name"}),E.createObjectStore("favorites",{keyPath:"guid"});const n=e.target.transaction,o=n.objectStore("config"),i=n.objectStore("state");for(let e in t)o.add(t[e],e);i.add(new Set,"excludedCores"),i.add(!0,"isMainToolbarOpened"),i.add(!1,"isRotationLocked"),i.add(!1,"isStarMode"),i.add(null,"lastUsedCatalyser"),i.add(null,"starModeTarget"),i.add(0,"versionWarns")}(),function(){const i={2:()=>{E.createObjectStore("logs",{keyPath:"timestamp"})},3:()=>{const t=e.target.transaction.objectStore("logs");t.clear(),t.createIndex("action_type","type")},4:()=>{const{base:t,theme:n}=JSON.parse(localStorage.getItem("settings"))||{},o=`${t}_${n}`;e.target.transaction.objectStore("state").add(o,"baselayer"),E.createObjectStore("tiles")},5:()=>{e.target.transaction.objectStore("config").put(t.notifications,"notifications")}};for(let e in i)e>o&&e<=n&&i[e]()}()})),x.addEventListener("success",(e=>{function t(e){const t=e.target.source.name,n=e.target.result;let o;switch(t){case"config":o=g;break;case"state":o=m;break;case"favorites":o=p;break;default:return}null!=n&&(o[n.key]=n.value,n.continue())}null==E&&(E=e.target.result),E.addEventListener("versionchange",(()=>{E.close(),window.location.reload()})),E.addEventListener("error",(e=>{}));const n=E.transaction(["config","state","favorites"],"readonly");n.addEventListener("complete",(()=>{window.dispatchEvent(new Event("dbReady"))}));[n.objectStore("config").openCursor(),n.objectStore("state").openCursor(),n.objectStore("favorites").openCursor()].forEach((e=>{e.addEventListener("success",t)}))})),x.addEventListener("error",(e=>{}))}();